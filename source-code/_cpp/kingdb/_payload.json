[{"data":1,"prerenderedAt":6234},["ShallowReactive",2],{"navigation":3,"/source-code/_cpp/kingdb":155,"/source-code/_cpp/kingdb-surround":6226},[4,35,86,92,119,125,149],{"title":5,"_path":6,"children":7},"心流思绪 / Heart Flows","/flows",[8,11,14,17,20,23,26,29,32],{"title":9,"_path":10},"📕 狮子的书单推荐","/flows/books",{"title":12,"_path":13},"🚝 四十二篇系列","/flows/fourty-two",{"title":15,"_path":16},"🌃 长夜梦","/flows/long-night-dream",{"title":18,"_path":19},"🌌 万物联结与幸福感","/flows/everything",{"title":21,"_path":22},"⌛ 偷取时间","/flows/stealing-time-from-god",{"title":24,"_path":25},"🌆 表达和孤独","/flows/expression-and-loneliness",{"title":27,"_path":28},"🌧️ 我的腼腆","/flows/shy",{"title":30,"_path":31},"🥛 新工作，喝新饮料","/flows/drinking-while-thinking",{"title":33,"_path":34},"📝 心流归档","/flows/archive",{"title":36,"_path":37,"children":38},"技术博客 / Coder","/articles",[39,41,44,47,50,53,56,59,62,65,68,71,74,77,80,83],{"title":40,"_path":37},"🦁 欢迎",{"title":42,"_path":43},"🥞 在 tailwind 中使用现代化 CSS Layers","/articles/tailwind-sass-and-css-layer",{"title":45,"_path":46},"💻 本地部署 Qwen 翻译网页","/articles/local-translator",{"title":48,"_path":49},"🧊 模板解析器轻考古","/articles/micro-templating",{"title":51,"_path":52},"Ⓜ️ Mini CSS Parser","/articles/mini-css-parser",{"title":54,"_path":55},"🚩 向AI咨询前端问题","/articles/use-gpt-learn-complex-frontend",{"title":57,"_path":58},"⛸️ 怎样定制复杂组件的自定义滚动条？","/articles/use-scrollbars",{"title":60,"_path":61},"⚖️ 统一多组件库的层叠顺序","/articles/zindex-manager",{"title":63,"_path":64},"🕷️ 滑动验证码破解思路","/articles/crack-the-slider",{"title":66,"_path":67},"🌟 探秘 CSS 光影效果","/articles/css-light-travel",{"title":69,"_path":70},"🍲 设计模式与 JS 魔法锅","/articles/design-patterns-and-js-magic-pot",{"title":72,"_path":73},"🌐 Anysort：灵活、优雅的多属性排序","/articles/anysort-2th",{"title":75,"_path":76},"💫 CSS 幻术 | 抗锯齿","/articles/css-poaa",{"title":78,"_path":79},"❓ 用纯CSS判断鼠标进入的方向","/articles/css-judge-direction",{"title":81,"_path":82},"📝 你本可以少写些 if-else","/articles/no-more-if-else",{"title":84,"_path":85},"📝 技术博客归档","/articles/archive",{"title":87,"_path":88,"children":89},"读书笔记 / Notes","/books",[90],{"title":91,"_path":88},"📕 读书笔记",{"title":93,"_path":94,"children":95},"吉他剧场 / Music","/music",[96,98,101,104,107,110,113,116],{"title":97,"_path":94},"🎸 FingerStyle！",{"title":99,"_path":100},"🌬️ 等待的风","/music/wind",{"title":102,"_path":103},"💕 约定的海洋","/music/ocean",{"title":105,"_path":106},"🎼 Wings~You are the Hero！","/music/wings-you-are-the-hero",{"title":108,"_path":109},"🌏 残酷天使的行动纲领","/music/eva",{"title":111,"_path":112},"🏔️ 奇跡の山","/music/miracle-mountain",{"title":114,"_path":115},"🍷 Wu Wei","/music/wu-wei",{"title":117,"_path":118},"🌅 无题","/music/untitled",{"title":120,"_path":121,"children":122},"知识地图 / Maps","/maps",[123],{"title":124,"_path":121},"🏁 知识地图",{"title":126,"_path":127,"children":128},"造物 / Make","/tools",[129,131,134,137,140,143,146],{"title":130,"_path":127},"🧰 工具收集",{"title":132,"_path":133},"📕 博客","/tools/blog",{"title":135,"_path":136},"🥥 Coconut","/tools/coconut",{"title":138,"_path":139},"🧶 网易云音乐歌单排序","/tools/netease-sorter",{"title":141,"_path":142},"🌐 AnySort","/tools/anysort",{"title":144,"_path":145},"⛸️ UseScrollbar","/tools/use-scrollbar",{"title":147,"_path":148},"👓 Crapto","/tools/crypto-inline",{"title":150,"_path":151,"children":152},"我 / About","/hire",[153],{"title":154,"_path":151},"📬 技术简历",{"_path":156,"_dir":157,"_draft":158,"_partial":159,"_locale":160,"title":161,"description":160,"body":162,"_type":6220,"_id":6221,"_source":6222,"_file":6223,"_stem":6224,"_extension":6225},"/source-code/_cpp/kingdb","_cpp",false,true,"","KingDB",{"type":163,"children":164,"toc":6214},"root",[165,173,179,185,201,206,230,235,240,245,1104,1109,1117,1122,1127,1132,1138,1143,1564,1569,1574,2024,2029,2130,2135,2140,2145,2683,2689,2694,2961,2967,2972,3217,3222,3235,3240,3507,3512,3517,4228,4233,4414,4418,4423,5041,5046,5051,5104,5109,5128,5501,5506,5671,5676,5681,6208],{"type":166,"tag":167,"props":168,"children":170},"element","h1",{"id":169},"kingdb",[171],{"type":172,"value":161},"text",{"type":166,"tag":174,"props":175,"children":177},"h2",{"id":176},"概述",[178],{"type":172,"value":176},{"type":166,"tag":180,"props":181,"children":182},"p",{},[183],{"type":172,"value":184},"源码分两部分，从相关的测试文件，到核心源码。参考 IKVS 系列文章给的架构图，核心源码的阅读顺序沿着 Put、Delete、Get 三个接口，由 Database 一路向 Buffer、Event Manager、Storage Engine、HSTable Manager、File System 相关、Index 前进。最好再看相关快照、迭代器、Multipart 等部分。期间如果遇到简单的帮助函数会先讲帮助函数。",{"type":166,"tag":180,"props":186,"children":187},{},[188,190,199],{"type":172,"value":189},"本来想从第一个 Git Commit 开始看起的。但我 checkout 过去之后，碰到了一堆编译问题，根本跑不通，索性就直接回到 master 来看最新代码了。本文章的源码快照见 ",{"type":166,"tag":191,"props":192,"children":196},"a",{"href":193,"rel":194},"https://github.com/goossaert/kingdb/tree/58994280e789fc7248d61371f03a6c04c844c197",[195],"nofollow",[197],{"type":172,"value":198},"KingDB@58994",{"type":172,"value":200},"。阅读源码前可以先看一下 KingDB 的 Readme：doc/kingdb.md 以及 doc/kingserver.md。",{"type":166,"tag":180,"props":202,"children":203},{},[204],{"type":172,"value":205},"下文可能出现的缩写：",{"type":166,"tag":207,"props":208,"children":209},"ul",{},[210,216],{"type":166,"tag":211,"props":212,"children":213},"li",{},[214],{"type":172,"value":215},"KDB：KingDB，泛指，有时指 KingDB 程序，有时指 KingDB 源码。",{"type":166,"tag":211,"props":217,"children":218},{},[219,221,228],{"type":172,"value":220},"IKVS：作者相关 KingDB 做的一些调研及笔记的博客系列。这个系列从 13 年开始写，现在还没写完... 见 ",{"type":166,"tag":191,"props":222,"children":225},{"href":223,"rel":224},"https://codecapsule.com/2012/11/07/ikvs-implementing-a-key-value-store-table-of-contents/",[195],[226],{"type":172,"value":227},"IKVS",{"type":172,"value":229},"。",{"type":166,"tag":180,"props":231,"children":232},{},[233],{"type":172,"value":234},"另，为了简便起见，下文给出的代码很可能并非原本的代码，而是截取或经过剔除后的部分代码。比如说，去除了某函数中的错误处理，使之代码更短，更容易展示。",{"type":166,"tag":174,"props":236,"children":238},{"id":237},"从测试开始",[239],{"type":172,"value":237},{"type":166,"tag":180,"props":241,"children":242},{},[243],{"type":172,"value":244},"Emmanuel 给了一个典型的 KDB 用户使用示例，见 unit-tests/kingdb_user.cc。通过此示例，能大概了解 KDB 的接口及如何使用该接口。创建数据库、存入、读取前都需要创建对应的参数配置 Options；这些动作通过 Status 对象来回传操作成功与否。",{"type":166,"tag":246,"props":247,"children":251},"pre",{"code":248,"language":249,"meta":160,"className":250,"style":160},"#include \u003Ckingdb/kdb.h>\n\nint main() {\n  kdb::Status s;\n  kdb::DatabaseOptions db_options;\n  kdb::Database db(db_options, \"mylocaldb\");\n  s = db.Open();\n  if (!s.IsOK()) {\n    fprintf(stderr, \"Could not open the database: %s\\n\", s.ToString().c_str());\n    exit(1);\n  }\n\n  std::string key1(\"key1\");\n  std::string value1(\"value1\");\n\n  kdb::WriteOptions write_options;\n  s = db.Put(write_options, key1, value1);\n\n  kdb::ReadOptions read_options;\n  std::string out_str;\n  s = db.Get(read_options, key1, &out_str);\n  if (s.IsOK() && out_str == \"value1\") {\n    printf(\"Data successfully stored and retrieved\\n\"); \n  } else {\n    printf(\"An error occurred\\n\"); \n  }\n\n  return 0;\n}\n","cpp","language-cpp shiki shiki-themes material-theme-lighter github-light github-dark monokai",[252],{"type":166,"tag":253,"props":254,"children":255},"code",{"__ignoreMap":160},[256,285,294,321,347,368,425,460,502,583,606,615,623,666,707,715,736,792,800,821,842,902,966,1006,1024,1061,1069,1077,1095],{"type":166,"tag":257,"props":258,"children":261},"span",{"class":259,"line":260},"line",1,[262,268,274,280],{"type":166,"tag":257,"props":263,"children":265},{"style":264},"--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-default:#D73A49;--shiki-default-font-style:inherit;--shiki-dark:#F97583;--shiki-dark-font-style:inherit;--shiki-sepia:#F92672;--shiki-sepia-font-style:inherit",[266],{"type":172,"value":267},"#include",{"type":166,"tag":257,"props":269,"children":271},{"style":270},"--shiki-light:#39ADB5;--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74",[272],{"type":172,"value":273}," \u003C",{"type":166,"tag":257,"props":275,"children":277},{"style":276},"--shiki-light:#91B859;--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74",[278],{"type":172,"value":279},"kingdb/kdb.h",{"type":166,"tag":257,"props":281,"children":282},{"style":270},[283],{"type":172,"value":284},">\n",{"type":166,"tag":257,"props":286,"children":288},{"class":259,"line":287},2,[289],{"type":166,"tag":257,"props":290,"children":291},{"emptyLinePlaceholder":159},[292],{"type":172,"value":293},"\n",{"type":166,"tag":257,"props":295,"children":297},{"class":259,"line":296},3,[298,304,310,316],{"type":166,"tag":257,"props":299,"children":301},{"style":300},"--shiki-light:#9C3EDA;--shiki-light-font-style:inherit;--shiki-default:#D73A49;--shiki-default-font-style:inherit;--shiki-dark:#F97583;--shiki-dark-font-style:inherit;--shiki-sepia:#66D9EF;--shiki-sepia-font-style:italic",[302],{"type":172,"value":303},"int",{"type":166,"tag":257,"props":305,"children":307},{"style":306},"--shiki-light:#6182B8;--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E",[308],{"type":172,"value":309}," main",{"type":166,"tag":257,"props":311,"children":313},{"style":312},"--shiki-light:#39ADB5;--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2",[314],{"type":172,"value":315},"()",{"type":166,"tag":257,"props":317,"children":318},{"style":312},[319],{"type":172,"value":320}," {\n",{"type":166,"tag":257,"props":322,"children":324},{"class":259,"line":323},4,[325,331,336,342],{"type":166,"tag":257,"props":326,"children":328},{"style":327},"--shiki-light:#E2931D;--shiki-light-text-decoration:inherit;--shiki-default:#6F42C1;--shiki-default-text-decoration:inherit;--shiki-dark:#B392F0;--shiki-dark-text-decoration:inherit;--shiki-sepia:#A6E22E;--shiki-sepia-text-decoration:underline",[329],{"type":172,"value":330},"  kdb",{"type":166,"tag":257,"props":332,"children":333},{"style":312},[334],{"type":172,"value":335},"::",{"type":166,"tag":257,"props":337,"children":339},{"style":338},"--shiki-light:#90A4AE;--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2",[340],{"type":172,"value":341},"Status s",{"type":166,"tag":257,"props":343,"children":344},{"style":312},[345],{"type":172,"value":346},";\n",{"type":166,"tag":257,"props":348,"children":350},{"class":259,"line":349},5,[351,355,359,364],{"type":166,"tag":257,"props":352,"children":353},{"style":327},[354],{"type":172,"value":330},{"type":166,"tag":257,"props":356,"children":357},{"style":312},[358],{"type":172,"value":335},{"type":166,"tag":257,"props":360,"children":361},{"style":338},[362],{"type":172,"value":363},"DatabaseOptions db_options",{"type":166,"tag":257,"props":365,"children":366},{"style":312},[367],{"type":172,"value":346},{"type":166,"tag":257,"props":369,"children":371},{"class":259,"line":370},6,[372,376,380,385,390,395,400,405,410,415,420],{"type":166,"tag":257,"props":373,"children":374},{"style":327},[375],{"type":172,"value":330},{"type":166,"tag":257,"props":377,"children":378},{"style":312},[379],{"type":172,"value":335},{"type":166,"tag":257,"props":381,"children":382},{"style":338},[383],{"type":172,"value":384},"Database ",{"type":166,"tag":257,"props":386,"children":387},{"style":306},[388],{"type":172,"value":389},"db",{"type":166,"tag":257,"props":391,"children":392},{"style":312},[393],{"type":172,"value":394},"(",{"type":166,"tag":257,"props":396,"children":397},{"style":338},[398],{"type":172,"value":399},"db_options",{"type":166,"tag":257,"props":401,"children":402},{"style":312},[403],{"type":172,"value":404},",",{"type":166,"tag":257,"props":406,"children":407},{"style":270},[408],{"type":172,"value":409}," \"",{"type":166,"tag":257,"props":411,"children":412},{"style":276},[413],{"type":172,"value":414},"mylocaldb",{"type":166,"tag":257,"props":416,"children":417},{"style":270},[418],{"type":172,"value":419},"\"",{"type":166,"tag":257,"props":421,"children":422},{"style":312},[423],{"type":172,"value":424},");\n",{"type":166,"tag":257,"props":426,"children":428},{"class":259,"line":427},7,[429,434,440,445,450,455],{"type":166,"tag":257,"props":430,"children":431},{"style":338},[432],{"type":172,"value":433},"  s ",{"type":166,"tag":257,"props":435,"children":437},{"style":436},"--shiki-light:#39ADB5;--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672",[438],{"type":172,"value":439},"=",{"type":166,"tag":257,"props":441,"children":442},{"style":338},[443],{"type":172,"value":444}," db",{"type":166,"tag":257,"props":446,"children":447},{"style":312},[448],{"type":172,"value":449},".",{"type":166,"tag":257,"props":451,"children":452},{"style":306},[453],{"type":172,"value":454},"Open",{"type":166,"tag":257,"props":456,"children":457},{"style":312},[458],{"type":172,"value":459},"();\n",{"type":166,"tag":257,"props":461,"children":463},{"class":259,"line":462},8,[464,469,474,479,484,488,493,498],{"type":166,"tag":257,"props":465,"children":466},{"style":264},[467],{"type":172,"value":468},"  if",{"type":166,"tag":257,"props":470,"children":471},{"style":312},[472],{"type":172,"value":473}," (",{"type":166,"tag":257,"props":475,"children":476},{"style":436},[477],{"type":172,"value":478},"!",{"type":166,"tag":257,"props":480,"children":481},{"style":338},[482],{"type":172,"value":483},"s",{"type":166,"tag":257,"props":485,"children":486},{"style":312},[487],{"type":172,"value":449},{"type":166,"tag":257,"props":489,"children":490},{"style":306},[491],{"type":172,"value":492},"IsOK",{"type":166,"tag":257,"props":494,"children":495},{"style":312},[496],{"type":172,"value":497},"())",{"type":166,"tag":257,"props":499,"children":500},{"style":312},[501],{"type":172,"value":320},{"type":166,"tag":257,"props":503,"children":505},{"class":259,"line":504},9,[506,511,515,521,525,529,534,540,546,550,554,559,563,568,573,578],{"type":166,"tag":257,"props":507,"children":508},{"style":306},[509],{"type":172,"value":510},"    fprintf",{"type":166,"tag":257,"props":512,"children":513},{"style":312},[514],{"type":172,"value":394},{"type":166,"tag":257,"props":516,"children":518},{"style":517},"--shiki-light:#E53935;--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2",[519],{"type":172,"value":520},"stderr",{"type":166,"tag":257,"props":522,"children":523},{"style":312},[524],{"type":172,"value":404},{"type":166,"tag":257,"props":526,"children":527},{"style":270},[528],{"type":172,"value":409},{"type":166,"tag":257,"props":530,"children":531},{"style":276},[532],{"type":172,"value":533},"Could not open the database: ",{"type":166,"tag":257,"props":535,"children":537},{"style":536},"--shiki-light:#E53935;--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF",[538],{"type":172,"value":539},"%s",{"type":166,"tag":257,"props":541,"children":543},{"style":542},"--shiki-light:#90A4AE;--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF",[544],{"type":172,"value":545},"\\n",{"type":166,"tag":257,"props":547,"children":548},{"style":270},[549],{"type":172,"value":419},{"type":166,"tag":257,"props":551,"children":552},{"style":312},[553],{"type":172,"value":404},{"type":166,"tag":257,"props":555,"children":556},{"style":338},[557],{"type":172,"value":558}," s",{"type":166,"tag":257,"props":560,"children":561},{"style":312},[562],{"type":172,"value":449},{"type":166,"tag":257,"props":564,"children":565},{"style":306},[566],{"type":172,"value":567},"ToString",{"type":166,"tag":257,"props":569,"children":570},{"style":312},[571],{"type":172,"value":572},"().",{"type":166,"tag":257,"props":574,"children":575},{"style":306},[576],{"type":172,"value":577},"c_str",{"type":166,"tag":257,"props":579,"children":580},{"style":312},[581],{"type":172,"value":582},"());\n",{"type":166,"tag":257,"props":584,"children":586},{"class":259,"line":585},10,[587,592,596,602],{"type":166,"tag":257,"props":588,"children":589},{"style":306},[590],{"type":172,"value":591},"    exit",{"type":166,"tag":257,"props":593,"children":594},{"style":312},[595],{"type":172,"value":394},{"type":166,"tag":257,"props":597,"children":599},{"style":598},"--shiki-light:#F76D47;--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF",[600],{"type":172,"value":601},"1",{"type":166,"tag":257,"props":603,"children":604},{"style":312},[605],{"type":172,"value":424},{"type":166,"tag":257,"props":607,"children":609},{"class":259,"line":608},11,[610],{"type":166,"tag":257,"props":611,"children":612},{"style":312},[613],{"type":172,"value":614},"  }\n",{"type":166,"tag":257,"props":616,"children":618},{"class":259,"line":617},12,[619],{"type":166,"tag":257,"props":620,"children":621},{"emptyLinePlaceholder":159},[622],{"type":172,"value":293},{"type":166,"tag":257,"props":624,"children":626},{"class":259,"line":625},13,[627,632,636,641,646,650,654,658,662],{"type":166,"tag":257,"props":628,"children":629},{"style":327},[630],{"type":172,"value":631},"  std",{"type":166,"tag":257,"props":633,"children":634},{"style":312},[635],{"type":172,"value":335},{"type":166,"tag":257,"props":637,"children":638},{"style":338},[639],{"type":172,"value":640},"string ",{"type":166,"tag":257,"props":642,"children":643},{"style":306},[644],{"type":172,"value":645},"key1",{"type":166,"tag":257,"props":647,"children":648},{"style":312},[649],{"type":172,"value":394},{"type":166,"tag":257,"props":651,"children":652},{"style":270},[653],{"type":172,"value":419},{"type":166,"tag":257,"props":655,"children":656},{"style":276},[657],{"type":172,"value":645},{"type":166,"tag":257,"props":659,"children":660},{"style":270},[661],{"type":172,"value":419},{"type":166,"tag":257,"props":663,"children":664},{"style":312},[665],{"type":172,"value":424},{"type":166,"tag":257,"props":667,"children":669},{"class":259,"line":668},14,[670,674,678,682,687,691,695,699,703],{"type":166,"tag":257,"props":671,"children":672},{"style":327},[673],{"type":172,"value":631},{"type":166,"tag":257,"props":675,"children":676},{"style":312},[677],{"type":172,"value":335},{"type":166,"tag":257,"props":679,"children":680},{"style":338},[681],{"type":172,"value":640},{"type":166,"tag":257,"props":683,"children":684},{"style":306},[685],{"type":172,"value":686},"value1",{"type":166,"tag":257,"props":688,"children":689},{"style":312},[690],{"type":172,"value":394},{"type":166,"tag":257,"props":692,"children":693},{"style":270},[694],{"type":172,"value":419},{"type":166,"tag":257,"props":696,"children":697},{"style":276},[698],{"type":172,"value":686},{"type":166,"tag":257,"props":700,"children":701},{"style":270},[702],{"type":172,"value":419},{"type":166,"tag":257,"props":704,"children":705},{"style":312},[706],{"type":172,"value":424},{"type":166,"tag":257,"props":708,"children":710},{"class":259,"line":709},15,[711],{"type":166,"tag":257,"props":712,"children":713},{"emptyLinePlaceholder":159},[714],{"type":172,"value":293},{"type":166,"tag":257,"props":716,"children":718},{"class":259,"line":717},16,[719,723,727,732],{"type":166,"tag":257,"props":720,"children":721},{"style":327},[722],{"type":172,"value":330},{"type":166,"tag":257,"props":724,"children":725},{"style":312},[726],{"type":172,"value":335},{"type":166,"tag":257,"props":728,"children":729},{"style":338},[730],{"type":172,"value":731},"WriteOptions write_options",{"type":166,"tag":257,"props":733,"children":734},{"style":312},[735],{"type":172,"value":346},{"type":166,"tag":257,"props":737,"children":739},{"class":259,"line":738},17,[740,744,748,752,756,761,765,770,774,779,783,788],{"type":166,"tag":257,"props":741,"children":742},{"style":338},[743],{"type":172,"value":433},{"type":166,"tag":257,"props":745,"children":746},{"style":436},[747],{"type":172,"value":439},{"type":166,"tag":257,"props":749,"children":750},{"style":338},[751],{"type":172,"value":444},{"type":166,"tag":257,"props":753,"children":754},{"style":312},[755],{"type":172,"value":449},{"type":166,"tag":257,"props":757,"children":758},{"style":306},[759],{"type":172,"value":760},"Put",{"type":166,"tag":257,"props":762,"children":763},{"style":312},[764],{"type":172,"value":394},{"type":166,"tag":257,"props":766,"children":767},{"style":338},[768],{"type":172,"value":769},"write_options",{"type":166,"tag":257,"props":771,"children":772},{"style":312},[773],{"type":172,"value":404},{"type":166,"tag":257,"props":775,"children":776},{"style":338},[777],{"type":172,"value":778}," key1",{"type":166,"tag":257,"props":780,"children":781},{"style":312},[782],{"type":172,"value":404},{"type":166,"tag":257,"props":784,"children":785},{"style":338},[786],{"type":172,"value":787}," value1",{"type":166,"tag":257,"props":789,"children":790},{"style":312},[791],{"type":172,"value":424},{"type":166,"tag":257,"props":793,"children":795},{"class":259,"line":794},18,[796],{"type":166,"tag":257,"props":797,"children":798},{"emptyLinePlaceholder":159},[799],{"type":172,"value":293},{"type":166,"tag":257,"props":801,"children":803},{"class":259,"line":802},19,[804,808,812,817],{"type":166,"tag":257,"props":805,"children":806},{"style":327},[807],{"type":172,"value":330},{"type":166,"tag":257,"props":809,"children":810},{"style":312},[811],{"type":172,"value":335},{"type":166,"tag":257,"props":813,"children":814},{"style":338},[815],{"type":172,"value":816},"ReadOptions read_options",{"type":166,"tag":257,"props":818,"children":819},{"style":312},[820],{"type":172,"value":346},{"type":166,"tag":257,"props":822,"children":824},{"class":259,"line":823},20,[825,829,833,838],{"type":166,"tag":257,"props":826,"children":827},{"style":327},[828],{"type":172,"value":631},{"type":166,"tag":257,"props":830,"children":831},{"style":312},[832],{"type":172,"value":335},{"type":166,"tag":257,"props":834,"children":835},{"style":338},[836],{"type":172,"value":837},"string out_str",{"type":166,"tag":257,"props":839,"children":840},{"style":312},[841],{"type":172,"value":346},{"type":166,"tag":257,"props":843,"children":845},{"class":259,"line":844},21,[846,850,854,858,862,867,871,876,880,884,888,893,898],{"type":166,"tag":257,"props":847,"children":848},{"style":338},[849],{"type":172,"value":433},{"type":166,"tag":257,"props":851,"children":852},{"style":436},[853],{"type":172,"value":439},{"type":166,"tag":257,"props":855,"children":856},{"style":338},[857],{"type":172,"value":444},{"type":166,"tag":257,"props":859,"children":860},{"style":312},[861],{"type":172,"value":449},{"type":166,"tag":257,"props":863,"children":864},{"style":306},[865],{"type":172,"value":866},"Get",{"type":166,"tag":257,"props":868,"children":869},{"style":312},[870],{"type":172,"value":394},{"type":166,"tag":257,"props":872,"children":873},{"style":338},[874],{"type":172,"value":875},"read_options",{"type":166,"tag":257,"props":877,"children":878},{"style":312},[879],{"type":172,"value":404},{"type":166,"tag":257,"props":881,"children":882},{"style":338},[883],{"type":172,"value":778},{"type":166,"tag":257,"props":885,"children":886},{"style":312},[887],{"type":172,"value":404},{"type":166,"tag":257,"props":889,"children":890},{"style":436},[891],{"type":172,"value":892}," &",{"type":166,"tag":257,"props":894,"children":895},{"style":338},[896],{"type":172,"value":897},"out_str",{"type":166,"tag":257,"props":899,"children":900},{"style":312},[901],{"type":172,"value":424},{"type":166,"tag":257,"props":903,"children":905},{"class":259,"line":904},22,[906,910,914,918,922,926,930,935,940,945,949,953,957,962],{"type":166,"tag":257,"props":907,"children":908},{"style":264},[909],{"type":172,"value":468},{"type":166,"tag":257,"props":911,"children":912},{"style":312},[913],{"type":172,"value":473},{"type":166,"tag":257,"props":915,"children":916},{"style":338},[917],{"type":172,"value":483},{"type":166,"tag":257,"props":919,"children":920},{"style":312},[921],{"type":172,"value":449},{"type":166,"tag":257,"props":923,"children":924},{"style":306},[925],{"type":172,"value":492},{"type":166,"tag":257,"props":927,"children":928},{"style":312},[929],{"type":172,"value":315},{"type":166,"tag":257,"props":931,"children":932},{"style":436},[933],{"type":172,"value":934}," &&",{"type":166,"tag":257,"props":936,"children":937},{"style":338},[938],{"type":172,"value":939}," out_str ",{"type":166,"tag":257,"props":941,"children":942},{"style":436},[943],{"type":172,"value":944},"==",{"type":166,"tag":257,"props":946,"children":947},{"style":270},[948],{"type":172,"value":409},{"type":166,"tag":257,"props":950,"children":951},{"style":276},[952],{"type":172,"value":686},{"type":166,"tag":257,"props":954,"children":955},{"style":270},[956],{"type":172,"value":419},{"type":166,"tag":257,"props":958,"children":959},{"style":312},[960],{"type":172,"value":961},")",{"type":166,"tag":257,"props":963,"children":964},{"style":312},[965],{"type":172,"value":320},{"type":166,"tag":257,"props":967,"children":969},{"class":259,"line":968},23,[970,975,979,983,988,992,996,1001],{"type":166,"tag":257,"props":971,"children":972},{"style":306},[973],{"type":172,"value":974},"    printf",{"type":166,"tag":257,"props":976,"children":977},{"style":312},[978],{"type":172,"value":394},{"type":166,"tag":257,"props":980,"children":981},{"style":270},[982],{"type":172,"value":419},{"type":166,"tag":257,"props":984,"children":985},{"style":276},[986],{"type":172,"value":987},"Data successfully stored and retrieved",{"type":166,"tag":257,"props":989,"children":990},{"style":542},[991],{"type":172,"value":545},{"type":166,"tag":257,"props":993,"children":994},{"style":270},[995],{"type":172,"value":419},{"type":166,"tag":257,"props":997,"children":998},{"style":312},[999],{"type":172,"value":1000},");",{"type":166,"tag":257,"props":1002,"children":1003},{"style":517},[1004],{"type":172,"value":1005}," \n",{"type":166,"tag":257,"props":1007,"children":1009},{"class":259,"line":1008},24,[1010,1015,1020],{"type":166,"tag":257,"props":1011,"children":1012},{"style":312},[1013],{"type":172,"value":1014},"  }",{"type":166,"tag":257,"props":1016,"children":1017},{"style":264},[1018],{"type":172,"value":1019}," else",{"type":166,"tag":257,"props":1021,"children":1022},{"style":312},[1023],{"type":172,"value":320},{"type":166,"tag":257,"props":1025,"children":1027},{"class":259,"line":1026},25,[1028,1032,1036,1040,1045,1049,1053,1057],{"type":166,"tag":257,"props":1029,"children":1030},{"style":306},[1031],{"type":172,"value":974},{"type":166,"tag":257,"props":1033,"children":1034},{"style":312},[1035],{"type":172,"value":394},{"type":166,"tag":257,"props":1037,"children":1038},{"style":270},[1039],{"type":172,"value":419},{"type":166,"tag":257,"props":1041,"children":1042},{"style":276},[1043],{"type":172,"value":1044},"An error occurred",{"type":166,"tag":257,"props":1046,"children":1047},{"style":542},[1048],{"type":172,"value":545},{"type":166,"tag":257,"props":1050,"children":1051},{"style":270},[1052],{"type":172,"value":419},{"type":166,"tag":257,"props":1054,"children":1055},{"style":312},[1056],{"type":172,"value":1000},{"type":166,"tag":257,"props":1058,"children":1059},{"style":517},[1060],{"type":172,"value":1005},{"type":166,"tag":257,"props":1062,"children":1064},{"class":259,"line":1063},26,[1065],{"type":166,"tag":257,"props":1066,"children":1067},{"style":312},[1068],{"type":172,"value":614},{"type":166,"tag":257,"props":1070,"children":1072},{"class":259,"line":1071},27,[1073],{"type":166,"tag":257,"props":1074,"children":1075},{"emptyLinePlaceholder":159},[1076],{"type":172,"value":293},{"type":166,"tag":257,"props":1078,"children":1080},{"class":259,"line":1079},28,[1081,1086,1091],{"type":166,"tag":257,"props":1082,"children":1083},{"style":264},[1084],{"type":172,"value":1085},"  return",{"type":166,"tag":257,"props":1087,"children":1088},{"style":598},[1089],{"type":172,"value":1090}," 0",{"type":166,"tag":257,"props":1092,"children":1093},{"style":312},[1094],{"type":172,"value":346},{"type":166,"tag":257,"props":1096,"children":1098},{"class":259,"line":1097},29,[1099],{"type":166,"tag":257,"props":1100,"children":1101},{"style":312},[1102],{"type":172,"value":1103},"}\n",{"type":166,"tag":180,"props":1105,"children":1106},{},[1107],{"type":172,"value":1108},"测试的入口文件是 unit-tests/test_db.cc。以我看过的 JS 库来看，这是一个基本的功能测试。编译好 KDB 之后，运行编译出的二进制文件 test_db 可以开始测试。测试结果输出到控制台，如下代码所示。",{"type":166,"tag":246,"props":1110,"children":1112},{"code":1111},"==== Test DBTest.CloseAndReopen\n==== Test DBTest.RepairInvalidDatabaseOptionFile\n==== Test DBTest.KeysWithNullBytes\n==== Test DBTest.TestStringInterface\nDatabase Options: Stage 0 - Incompressible data with LZ4 compression enabled\nDatabase Options: Stage 1 - Compressible data with LZ4 compression enabled\nDatabase Options: Stage 2 - Compression disabled\nDatabase Options: Stage 3 - 64-bit MurmurHash3\nDatabase Options: Stage 4 - Checksum verification with incompressible data\nDatabase Options: Stage 5 - Checksum verification with compressible data\nDatabase Options: Stage 6 - Checksum verification with compression disabled\nDatabase Options: Stage 7 - Synced writes\nDatabase Options: Stage 8 - Small-sized HSTables with compression disabled\nDatabase Options: Stage 9 - Small-sized HSTables with incompressible data and LZ4 compression\nDatabase Options: Stage 10 - Small-sized HSTables with compressible data and LZ4 compression\nDatabase Options: Stage 11 - Direct mode for Write Buffer (incompressible data with LZ4 compression enabled)\nDatabase Options: Stage 12 - Direct mode for Write Buffer (compressible data with LZ4 compression enabled)\n==== Test DBTest.MultipartReader\n// the same with last stages\n==== Test DBTest.SingleThreadSmallEntries\n// the same with last stages\n==== Test DBTest.SingleThreadSnapshot\n// the same with last stages\n==== Test DBTest.SingleThreadSmallEntriesCompaction\n// the same with last stages\n==== Test DBTest.SequentialIterator\n// the same with last stages\n==== Test DBTest.SingleThreadSingleLargeEntry\n// the same with last stages\n==== Test DBTest.FileUtil\nmysize: 268435456\nOK\n89 ms\nFree size: 944 GB\n==== PASSED 11 tests\n",[1113],{"type":166,"tag":253,"props":1114,"children":1115},{"__ignoreMap":160},[1116],{"type":172,"value":1111},{"type":166,"tag":180,"props":1118,"children":1119},{},[1120],{"type":172,"value":1121},"每个功能点如数据库初始化和关闭 CloseAndReopen、存入带结束符的键 KeysWithNullBytes 都使用对应继承了 DBTest 的测试类进行测试。涉及到与数据库交互的功能部分如 TestStringInterface 使用循环，遍历了所有数据库 Options 可以设置的情况（但是只是二维循环，没有测试参数间的组合）。即对应上文的 Stage 1、Stage 2...",{"type":166,"tag":180,"props":1123,"children":1124},{},[1125],{"type":172,"value":1126},"在 test_db 创建相应的测试类时，会自动调用测试套件（unit-tests/testharness.cc）中的 RegisterTest 把测试函数储存起来。以便运行测试时，通过读取环境变量来判断是否要跳过某类测试。",{"type":166,"tag":180,"props":1128,"children":1129},{},[1130],{"type":172,"value":1131},"测试代码的实现还有一些有意思的地方，以下提及。",{"type":166,"tag":1133,"props":1134,"children":1136},"h4",{"id":1135},"信号处理",[1137],{"type":172,"value":1135},{"type":166,"tag":180,"props":1139,"children":1140},{},[1141],{"type":172,"value":1142},"和数据库核心的入口函数一样，使用 signal 挂载了对 SIGSEGV、SIGABRT 信号的处理。这两个信号分别指代系统内存错误和系统中断。而处理函数非常简单，就是 IKVS 中提到的“let it die”风格：输出调用栈，立马结束程序。",{"type":166,"tag":246,"props":1144,"children":1146},{"code":1145,"language":249,"meta":160,"className":250,"style":160},"void handler(int sig) {\n  int depth_max = 20;\n  void *array[depth_max];\n  size_t depth;\n  // backtrace 将前 depth_max 层栈帧记录到 array 数组中，\n  // 再通过 backtrace_symbols_fd 输出到 stderr。\n  // 文档见：https://man7.org/linux/man-pages/man3/backtrace.3.html\n  depth = backtrace(array, depth_max);\n  fprintf(stderr, \"Error: signal %d:\\n\", sig);\n  backtrace_symbols_fd(array, depth, STDERR_FILENO);\n  exit(1);\n}\nint main() {\n  signal(SIGSEGV, handler);\n  signal(SIGABRT, handler);\n  return kdb::test::RunAllTests();\n}\n",[1147],{"type":166,"tag":253,"props":1148,"children":1149},{"__ignoreMap":160},[1150,1185,1211,1244,1261,1270,1278,1286,1324,1383,1420,1440,1447,1466,1495,1523,1557],{"type":166,"tag":257,"props":1151,"children":1152},{"class":259,"line":260},[1153,1158,1163,1167,1171,1177,1181],{"type":166,"tag":257,"props":1154,"children":1155},{"style":300},[1156],{"type":172,"value":1157},"void",{"type":166,"tag":257,"props":1159,"children":1160},{"style":306},[1161],{"type":172,"value":1162}," handler",{"type":166,"tag":257,"props":1164,"children":1165},{"style":312},[1166],{"type":172,"value":394},{"type":166,"tag":257,"props":1168,"children":1169},{"style":300},[1170],{"type":172,"value":303},{"type":166,"tag":257,"props":1172,"children":1174},{"style":1173},"--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-default:#E36209;--shiki-default-font-style:inherit;--shiki-dark:#FFAB70;--shiki-dark-font-style:inherit;--shiki-sepia:#FD971F;--shiki-sepia-font-style:italic",[1175],{"type":172,"value":1176}," sig",{"type":166,"tag":257,"props":1178,"children":1179},{"style":312},[1180],{"type":172,"value":961},{"type":166,"tag":257,"props":1182,"children":1183},{"style":312},[1184],{"type":172,"value":320},{"type":166,"tag":257,"props":1186,"children":1187},{"class":259,"line":287},[1188,1193,1198,1202,1207],{"type":166,"tag":257,"props":1189,"children":1190},{"style":300},[1191],{"type":172,"value":1192},"  int",{"type":166,"tag":257,"props":1194,"children":1195},{"style":338},[1196],{"type":172,"value":1197}," depth_max ",{"type":166,"tag":257,"props":1199,"children":1200},{"style":436},[1201],{"type":172,"value":439},{"type":166,"tag":257,"props":1203,"children":1204},{"style":598},[1205],{"type":172,"value":1206}," 20",{"type":166,"tag":257,"props":1208,"children":1209},{"style":312},[1210],{"type":172,"value":346},{"type":166,"tag":257,"props":1212,"children":1213},{"class":259,"line":296},[1214,1219,1224,1229,1234,1239],{"type":166,"tag":257,"props":1215,"children":1216},{"style":300},[1217],{"type":172,"value":1218},"  void",{"type":166,"tag":257,"props":1220,"children":1221},{"style":436},[1222],{"type":172,"value":1223}," *",{"type":166,"tag":257,"props":1225,"children":1226},{"style":338},[1227],{"type":172,"value":1228},"array",{"type":166,"tag":257,"props":1230,"children":1231},{"style":312},[1232],{"type":172,"value":1233},"[",{"type":166,"tag":257,"props":1235,"children":1236},{"style":338},[1237],{"type":172,"value":1238},"depth_max",{"type":166,"tag":257,"props":1240,"children":1241},{"style":312},[1242],{"type":172,"value":1243},"];\n",{"type":166,"tag":257,"props":1245,"children":1246},{"class":259,"line":323},[1247,1252,1257],{"type":166,"tag":257,"props":1248,"children":1249},{"style":300},[1250],{"type":172,"value":1251},"  size_t",{"type":166,"tag":257,"props":1253,"children":1254},{"style":338},[1255],{"type":172,"value":1256}," depth",{"type":166,"tag":257,"props":1258,"children":1259},{"style":312},[1260],{"type":172,"value":346},{"type":166,"tag":257,"props":1262,"children":1263},{"class":259,"line":349},[1264],{"type":166,"tag":257,"props":1265,"children":1267},{"style":1266},"--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-default:#6A737D;--shiki-default-font-style:inherit;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;--shiki-sepia:#88846F;--shiki-sepia-font-style:inherit",[1268],{"type":172,"value":1269},"  // backtrace 将前 depth_max 层栈帧记录到 array 数组中，\n",{"type":166,"tag":257,"props":1271,"children":1272},{"class":259,"line":370},[1273],{"type":166,"tag":257,"props":1274,"children":1275},{"style":1266},[1276],{"type":172,"value":1277},"  // 再通过 backtrace_symbols_fd 输出到 stderr。\n",{"type":166,"tag":257,"props":1279,"children":1280},{"class":259,"line":427},[1281],{"type":166,"tag":257,"props":1282,"children":1283},{"style":1266},[1284],{"type":172,"value":1285},"  // 文档见：https://man7.org/linux/man-pages/man3/backtrace.3.html\n",{"type":166,"tag":257,"props":1287,"children":1288},{"class":259,"line":462},[1289,1294,1298,1303,1307,1311,1315,1320],{"type":166,"tag":257,"props":1290,"children":1291},{"style":338},[1292],{"type":172,"value":1293},"  depth ",{"type":166,"tag":257,"props":1295,"children":1296},{"style":436},[1297],{"type":172,"value":439},{"type":166,"tag":257,"props":1299,"children":1300},{"style":306},[1301],{"type":172,"value":1302}," backtrace",{"type":166,"tag":257,"props":1304,"children":1305},{"style":312},[1306],{"type":172,"value":394},{"type":166,"tag":257,"props":1308,"children":1309},{"style":338},[1310],{"type":172,"value":1228},{"type":166,"tag":257,"props":1312,"children":1313},{"style":312},[1314],{"type":172,"value":404},{"type":166,"tag":257,"props":1316,"children":1317},{"style":338},[1318],{"type":172,"value":1319}," depth_max",{"type":166,"tag":257,"props":1321,"children":1322},{"style":312},[1323],{"type":172,"value":424},{"type":166,"tag":257,"props":1325,"children":1326},{"class":259,"line":504},[1327,1332,1336,1340,1344,1348,1353,1358,1363,1367,1371,1375,1379],{"type":166,"tag":257,"props":1328,"children":1329},{"style":306},[1330],{"type":172,"value":1331},"  fprintf",{"type":166,"tag":257,"props":1333,"children":1334},{"style":312},[1335],{"type":172,"value":394},{"type":166,"tag":257,"props":1337,"children":1338},{"style":338},[1339],{"type":172,"value":520},{"type":166,"tag":257,"props":1341,"children":1342},{"style":312},[1343],{"type":172,"value":404},{"type":166,"tag":257,"props":1345,"children":1346},{"style":270},[1347],{"type":172,"value":409},{"type":166,"tag":257,"props":1349,"children":1350},{"style":276},[1351],{"type":172,"value":1352},"Error: signal ",{"type":166,"tag":257,"props":1354,"children":1355},{"style":536},[1356],{"type":172,"value":1357},"%d",{"type":166,"tag":257,"props":1359,"children":1360},{"style":276},[1361],{"type":172,"value":1362},":",{"type":166,"tag":257,"props":1364,"children":1365},{"style":542},[1366],{"type":172,"value":545},{"type":166,"tag":257,"props":1368,"children":1369},{"style":270},[1370],{"type":172,"value":419},{"type":166,"tag":257,"props":1372,"children":1373},{"style":312},[1374],{"type":172,"value":404},{"type":166,"tag":257,"props":1376,"children":1377},{"style":338},[1378],{"type":172,"value":1176},{"type":166,"tag":257,"props":1380,"children":1381},{"style":312},[1382],{"type":172,"value":424},{"type":166,"tag":257,"props":1384,"children":1385},{"class":259,"line":585},[1386,1391,1395,1399,1403,1407,1411,1416],{"type":166,"tag":257,"props":1387,"children":1388},{"style":306},[1389],{"type":172,"value":1390},"  backtrace_symbols_fd",{"type":166,"tag":257,"props":1392,"children":1393},{"style":312},[1394],{"type":172,"value":394},{"type":166,"tag":257,"props":1396,"children":1397},{"style":338},[1398],{"type":172,"value":1228},{"type":166,"tag":257,"props":1400,"children":1401},{"style":312},[1402],{"type":172,"value":404},{"type":166,"tag":257,"props":1404,"children":1405},{"style":338},[1406],{"type":172,"value":1256},{"type":166,"tag":257,"props":1408,"children":1409},{"style":312},[1410],{"type":172,"value":404},{"type":166,"tag":257,"props":1412,"children":1413},{"style":338},[1414],{"type":172,"value":1415}," STDERR_FILENO",{"type":166,"tag":257,"props":1417,"children":1418},{"style":312},[1419],{"type":172,"value":424},{"type":166,"tag":257,"props":1421,"children":1422},{"class":259,"line":608},[1423,1428,1432,1436],{"type":166,"tag":257,"props":1424,"children":1425},{"style":306},[1426],{"type":172,"value":1427},"  exit",{"type":166,"tag":257,"props":1429,"children":1430},{"style":312},[1431],{"type":172,"value":394},{"type":166,"tag":257,"props":1433,"children":1434},{"style":598},[1435],{"type":172,"value":601},{"type":166,"tag":257,"props":1437,"children":1438},{"style":312},[1439],{"type":172,"value":424},{"type":166,"tag":257,"props":1441,"children":1442},{"class":259,"line":617},[1443],{"type":166,"tag":257,"props":1444,"children":1445},{"style":312},[1446],{"type":172,"value":1103},{"type":166,"tag":257,"props":1448,"children":1449},{"class":259,"line":625},[1450,1454,1458,1462],{"type":166,"tag":257,"props":1451,"children":1452},{"style":300},[1453],{"type":172,"value":303},{"type":166,"tag":257,"props":1455,"children":1456},{"style":306},[1457],{"type":172,"value":309},{"type":166,"tag":257,"props":1459,"children":1460},{"style":312},[1461],{"type":172,"value":315},{"type":166,"tag":257,"props":1463,"children":1464},{"style":312},[1465],{"type":172,"value":320},{"type":166,"tag":257,"props":1467,"children":1468},{"class":259,"line":668},[1469,1474,1478,1483,1487,1491],{"type":166,"tag":257,"props":1470,"children":1471},{"style":306},[1472],{"type":172,"value":1473},"  signal",{"type":166,"tag":257,"props":1475,"children":1476},{"style":312},[1477],{"type":172,"value":394},{"type":166,"tag":257,"props":1479,"children":1480},{"style":338},[1481],{"type":172,"value":1482},"SIGSEGV",{"type":166,"tag":257,"props":1484,"children":1485},{"style":312},[1486],{"type":172,"value":404},{"type":166,"tag":257,"props":1488,"children":1489},{"style":338},[1490],{"type":172,"value":1162},{"type":166,"tag":257,"props":1492,"children":1493},{"style":312},[1494],{"type":172,"value":424},{"type":166,"tag":257,"props":1496,"children":1497},{"class":259,"line":709},[1498,1502,1506,1511,1515,1519],{"type":166,"tag":257,"props":1499,"children":1500},{"style":306},[1501],{"type":172,"value":1473},{"type":166,"tag":257,"props":1503,"children":1504},{"style":312},[1505],{"type":172,"value":394},{"type":166,"tag":257,"props":1507,"children":1508},{"style":338},[1509],{"type":172,"value":1510},"SIGABRT",{"type":166,"tag":257,"props":1512,"children":1513},{"style":312},[1514],{"type":172,"value":404},{"type":166,"tag":257,"props":1516,"children":1517},{"style":338},[1518],{"type":172,"value":1162},{"type":166,"tag":257,"props":1520,"children":1521},{"style":312},[1522],{"type":172,"value":424},{"type":166,"tag":257,"props":1524,"children":1525},{"class":259,"line":717},[1526,1530,1535,1539,1544,1548,1553],{"type":166,"tag":257,"props":1527,"children":1528},{"style":264},[1529],{"type":172,"value":1085},{"type":166,"tag":257,"props":1531,"children":1532},{"style":327},[1533],{"type":172,"value":1534}," kdb",{"type":166,"tag":257,"props":1536,"children":1537},{"style":312},[1538],{"type":172,"value":335},{"type":166,"tag":257,"props":1540,"children":1541},{"style":327},[1542],{"type":172,"value":1543},"test",{"type":166,"tag":257,"props":1545,"children":1546},{"style":312},[1547],{"type":172,"value":335},{"type":166,"tag":257,"props":1549,"children":1550},{"style":306},[1551],{"type":172,"value":1552},"RunAllTests",{"type":166,"tag":257,"props":1554,"children":1555},{"style":312},[1556],{"type":172,"value":459},{"type":166,"tag":257,"props":1558,"children":1559},{"class":259,"line":738},[1560],{"type":166,"tag":257,"props":1561,"children":1562},{"style":312},[1563],{"type":172,"value":1103},{"type":166,"tag":1133,"props":1565,"children":1567},{"id":1566},"使用宏创建测试类",[1568],{"type":172,"value":1566},{"type":166,"tag":180,"props":1570,"children":1571},{},[1572],{"type":172,"value":1573},"test_db 中的类是使用宏定义的。如下代码，TEST 展开的新类，继承了 DBTest，实现了 _RunIt 接口以便调用测试函数。TCONCAT 宏顾名思义就是连接，使用标记黏贴运算符把两个字符串或实参连接在一起并视为一个新的标记。_Test_ 和 name 连接在一起后，就是新类的名称，如 _Test_CloseAndReopen。",{"type":166,"tag":246,"props":1575,"children":1577},{"code":1576,"language":249,"meta":160,"className":250,"style":160},"TEST(DBTest, CloseAndReopen) {\n  // ...\n}\n#define TEST(base,name)                                                 \\\nclass TCONCAT(_Test_,name) : public base {                              \\\n public:                                                                \\\n  void _Run();                                                          \\\n  static void _RunIt() {                                                \\\n    TCONCAT(_Test_,name) t;                                             \\\n    t._Run();                                                           \\\n  }                                                                     \\\n};                                                                      \\\nbool TCONCAT(_Test_ignored_,name) =                                     \\\n  ::kdb::test::RegisterTest(#base, #name, &TCONCAT(_Test_,name)::_RunIt); \\\n",[1578],{"type":166,"tag":253,"props":1579,"children":1580},{"__ignoreMap":160},[1581,1615,1623,1630,1670,1719,1737,1759,1792,1835,1861,1873,1886,1929],{"type":166,"tag":257,"props":1582,"children":1583},{"class":259,"line":260},[1584,1589,1593,1598,1602,1607,1611],{"type":166,"tag":257,"props":1585,"children":1586},{"style":306},[1587],{"type":172,"value":1588},"TEST",{"type":166,"tag":257,"props":1590,"children":1591},{"style":312},[1592],{"type":172,"value":394},{"type":166,"tag":257,"props":1594,"children":1595},{"style":338},[1596],{"type":172,"value":1597},"DBTest",{"type":166,"tag":257,"props":1599,"children":1600},{"style":312},[1601],{"type":172,"value":404},{"type":166,"tag":257,"props":1603,"children":1604},{"style":338},[1605],{"type":172,"value":1606}," CloseAndReopen",{"type":166,"tag":257,"props":1608,"children":1609},{"style":312},[1610],{"type":172,"value":961},{"type":166,"tag":257,"props":1612,"children":1613},{"style":312},[1614],{"type":172,"value":320},{"type":166,"tag":257,"props":1616,"children":1617},{"class":259,"line":287},[1618],{"type":166,"tag":257,"props":1619,"children":1620},{"style":1266},[1621],{"type":172,"value":1622},"  // ...\n",{"type":166,"tag":257,"props":1624,"children":1625},{"class":259,"line":296},[1626],{"type":166,"tag":257,"props":1627,"children":1628},{"style":312},[1629],{"type":172,"value":1103},{"type":166,"tag":257,"props":1631,"children":1632},{"class":259,"line":323},[1633,1638,1643,1647,1652,1656,1661,1665],{"type":166,"tag":257,"props":1634,"children":1635},{"style":264},[1636],{"type":172,"value":1637},"#define",{"type":166,"tag":257,"props":1639,"children":1640},{"style":306},[1641],{"type":172,"value":1642}," TEST",{"type":166,"tag":257,"props":1644,"children":1645},{"style":312},[1646],{"type":172,"value":394},{"type":166,"tag":257,"props":1648,"children":1649},{"style":1173},[1650],{"type":172,"value":1651},"base",{"type":166,"tag":257,"props":1653,"children":1654},{"style":312},[1655],{"type":172,"value":404},{"type":166,"tag":257,"props":1657,"children":1658},{"style":1173},[1659],{"type":172,"value":1660},"name",{"type":166,"tag":257,"props":1662,"children":1663},{"style":312},[1664],{"type":172,"value":961},{"type":166,"tag":257,"props":1666,"children":1667},{"style":542},[1668],{"type":172,"value":1669},"                                                 \\\n",{"type":166,"tag":257,"props":1671,"children":1672},{"class":259,"line":349},[1673,1678,1683,1687,1692,1696,1700,1704,1709,1714],{"type":166,"tag":257,"props":1674,"children":1675},{"style":300},[1676],{"type":172,"value":1677},"class",{"type":166,"tag":257,"props":1679,"children":1680},{"style":306},[1681],{"type":172,"value":1682}," TCONCAT",{"type":166,"tag":257,"props":1684,"children":1685},{"style":312},[1686],{"type":172,"value":394},{"type":166,"tag":257,"props":1688,"children":1689},{"style":327},[1690],{"type":172,"value":1691},"_Test_",{"type":166,"tag":257,"props":1693,"children":1694},{"style":312},[1695],{"type":172,"value":404},{"type":166,"tag":257,"props":1697,"children":1698},{"style":327},[1699],{"type":172,"value":1660},{"type":166,"tag":257,"props":1701,"children":1702},{"style":312},[1703],{"type":172,"value":961},{"type":166,"tag":257,"props":1705,"children":1706},{"style":338},[1707],{"type":172,"value":1708}," : public base ",{"type":166,"tag":257,"props":1710,"children":1711},{"style":312},[1712],{"type":172,"value":1713},"{",{"type":166,"tag":257,"props":1715,"children":1716},{"style":542},[1717],{"type":172,"value":1718},"                              \\\n",{"type":166,"tag":257,"props":1720,"children":1721},{"class":259,"line":370},[1722,1727,1732],{"type":166,"tag":257,"props":1723,"children":1724},{"style":300},[1725],{"type":172,"value":1726}," public",{"type":166,"tag":257,"props":1728,"children":1730},{"style":1729},"--shiki-light:#39ADB5;--shiki-light-font-style:inherit;--shiki-default:#D73A49;--shiki-default-font-style:inherit;--shiki-dark:#F97583;--shiki-dark-font-style:inherit;--shiki-sepia:#66D9EF;--shiki-sepia-font-style:italic",[1731],{"type":172,"value":1362},{"type":166,"tag":257,"props":1733,"children":1734},{"style":542},[1735],{"type":172,"value":1736},"                                                                \\\n",{"type":166,"tag":257,"props":1738,"children":1739},{"class":259,"line":427},[1740,1744,1749,1754],{"type":166,"tag":257,"props":1741,"children":1742},{"style":300},[1743],{"type":172,"value":1218},{"type":166,"tag":257,"props":1745,"children":1746},{"style":306},[1747],{"type":172,"value":1748}," _Run",{"type":166,"tag":257,"props":1750,"children":1751},{"style":312},[1752],{"type":172,"value":1753},"();",{"type":166,"tag":257,"props":1755,"children":1756},{"style":542},[1757],{"type":172,"value":1758},"                                                          \\\n",{"type":166,"tag":257,"props":1760,"children":1761},{"class":259,"line":462},[1762,1768,1773,1778,1782,1787],{"type":166,"tag":257,"props":1763,"children":1765},{"style":1764},"--shiki-light:#9C3EDA;--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672",[1766],{"type":172,"value":1767},"  static",{"type":166,"tag":257,"props":1769,"children":1770},{"style":300},[1771],{"type":172,"value":1772}," void",{"type":166,"tag":257,"props":1774,"children":1775},{"style":306},[1776],{"type":172,"value":1777}," _RunIt",{"type":166,"tag":257,"props":1779,"children":1780},{"style":312},[1781],{"type":172,"value":315},{"type":166,"tag":257,"props":1783,"children":1784},{"style":312},[1785],{"type":172,"value":1786}," {",{"type":166,"tag":257,"props":1788,"children":1789},{"style":542},[1790],{"type":172,"value":1791},"                                                \\\n",{"type":166,"tag":257,"props":1793,"children":1794},{"class":259,"line":504},[1795,1800,1804,1808,1812,1816,1820,1825,1830],{"type":166,"tag":257,"props":1796,"children":1797},{"style":306},[1798],{"type":172,"value":1799},"    TCONCAT",{"type":166,"tag":257,"props":1801,"children":1802},{"style":312},[1803],{"type":172,"value":394},{"type":166,"tag":257,"props":1805,"children":1806},{"style":517},[1807],{"type":172,"value":1691},{"type":166,"tag":257,"props":1809,"children":1810},{"style":312},[1811],{"type":172,"value":404},{"type":166,"tag":257,"props":1813,"children":1814},{"style":517},[1815],{"type":172,"value":1660},{"type":166,"tag":257,"props":1817,"children":1818},{"style":312},[1819],{"type":172,"value":961},{"type":166,"tag":257,"props":1821,"children":1822},{"style":517},[1823],{"type":172,"value":1824}," t",{"type":166,"tag":257,"props":1826,"children":1827},{"style":312},[1828],{"type":172,"value":1829},";",{"type":166,"tag":257,"props":1831,"children":1832},{"style":542},[1833],{"type":172,"value":1834},"                                             \\\n",{"type":166,"tag":257,"props":1836,"children":1837},{"class":259,"line":585},[1838,1843,1847,1852,1856],{"type":166,"tag":257,"props":1839,"children":1840},{"style":338},[1841],{"type":172,"value":1842},"    t",{"type":166,"tag":257,"props":1844,"children":1845},{"style":312},[1846],{"type":172,"value":449},{"type":166,"tag":257,"props":1848,"children":1849},{"style":306},[1850],{"type":172,"value":1851},"_Run",{"type":166,"tag":257,"props":1853,"children":1854},{"style":312},[1855],{"type":172,"value":1753},{"type":166,"tag":257,"props":1857,"children":1858},{"style":542},[1859],{"type":172,"value":1860},"                                                           \\\n",{"type":166,"tag":257,"props":1862,"children":1863},{"class":259,"line":608},[1864,1868],{"type":166,"tag":257,"props":1865,"children":1866},{"style":312},[1867],{"type":172,"value":1014},{"type":166,"tag":257,"props":1869,"children":1870},{"style":542},[1871],{"type":172,"value":1872},"                                                                     \\\n",{"type":166,"tag":257,"props":1874,"children":1875},{"class":259,"line":617},[1876,1881],{"type":166,"tag":257,"props":1877,"children":1878},{"style":312},[1879],{"type":172,"value":1880},"};",{"type":166,"tag":257,"props":1882,"children":1883},{"style":542},[1884],{"type":172,"value":1885},"                                                                      \\\n",{"type":166,"tag":257,"props":1887,"children":1888},{"class":259,"line":625},[1889,1894,1898,1902,1907,1911,1915,1919,1924],{"type":166,"tag":257,"props":1890,"children":1891},{"style":300},[1892],{"type":172,"value":1893},"bool",{"type":166,"tag":257,"props":1895,"children":1896},{"style":306},[1897],{"type":172,"value":1682},{"type":166,"tag":257,"props":1899,"children":1900},{"style":312},[1901],{"type":172,"value":394},{"type":166,"tag":257,"props":1903,"children":1904},{"style":327},[1905],{"type":172,"value":1906},"_Test_ignored_",{"type":166,"tag":257,"props":1908,"children":1909},{"style":312},[1910],{"type":172,"value":404},{"type":166,"tag":257,"props":1912,"children":1913},{"style":327},[1914],{"type":172,"value":1660},{"type":166,"tag":257,"props":1916,"children":1917},{"style":312},[1918],{"type":172,"value":961},{"type":166,"tag":257,"props":1920,"children":1921},{"style":436},[1922],{"type":172,"value":1923}," =",{"type":166,"tag":257,"props":1925,"children":1926},{"style":542},[1927],{"type":172,"value":1928},"                                     \\\n",{"type":166,"tag":257,"props":1930,"children":1931},{"class":259,"line":668},[1932,1937,1942,1946,1950,1954,1959,1963,1968,1972,1977,1981,1985,1990,1994,1998,2002,2006,2010,2015,2019],{"type":166,"tag":257,"props":1933,"children":1934},{"style":338},[1935],{"type":172,"value":1936},"  ::",{"type":166,"tag":257,"props":1938,"children":1939},{"style":327},[1940],{"type":172,"value":1941},"kdb",{"type":166,"tag":257,"props":1943,"children":1944},{"style":312},[1945],{"type":172,"value":335},{"type":166,"tag":257,"props":1947,"children":1948},{"style":327},[1949],{"type":172,"value":1543},{"type":166,"tag":257,"props":1951,"children":1952},{"style":312},[1953],{"type":172,"value":335},{"type":166,"tag":257,"props":1955,"children":1956},{"style":306},[1957],{"type":172,"value":1958},"RegisterTest",{"type":166,"tag":257,"props":1960,"children":1961},{"style":312},[1962],{"type":172,"value":394},{"type":166,"tag":257,"props":1964,"children":1965},{"style":338},[1966],{"type":172,"value":1967},"#base",{"type":166,"tag":257,"props":1969,"children":1970},{"style":312},[1971],{"type":172,"value":404},{"type":166,"tag":257,"props":1973,"children":1974},{"style":338},[1975],{"type":172,"value":1976}," #name",{"type":166,"tag":257,"props":1978,"children":1979},{"style":312},[1980],{"type":172,"value":404},{"type":166,"tag":257,"props":1982,"children":1983},{"style":436},[1984],{"type":172,"value":892},{"type":166,"tag":257,"props":1986,"children":1987},{"style":306},[1988],{"type":172,"value":1989},"TCONCAT",{"type":166,"tag":257,"props":1991,"children":1992},{"style":312},[1993],{"type":172,"value":394},{"type":166,"tag":257,"props":1995,"children":1996},{"style":338},[1997],{"type":172,"value":1691},{"type":166,"tag":257,"props":1999,"children":2000},{"style":312},[2001],{"type":172,"value":404},{"type":166,"tag":257,"props":2003,"children":2004},{"style":338},[2005],{"type":172,"value":1660},{"type":166,"tag":257,"props":2007,"children":2008},{"style":312},[2009],{"type":172,"value":961},{"type":166,"tag":257,"props":2011,"children":2012},{"style":338},[2013],{"type":172,"value":2014},"::_RunIt",{"type":166,"tag":257,"props":2016,"children":2017},{"style":312},[2018],{"type":172,"value":1000},{"type":166,"tag":257,"props":2020,"children":2021},{"style":542},[2022],{"type":172,"value":2023}," \\\n",{"type":166,"tag":180,"props":2025,"children":2026},{},[2027],{"type":172,"value":2028},"可是，既然有 TCONCAT，为什么还要定义一个 TCONCAT1 宏呢？",{"type":166,"tag":246,"props":2030,"children":2032},{"code":2031,"language":249,"meta":160,"className":250,"style":160},"#define TCONCAT(a,b) TCONCAT1(a,b)\n#define TCONCAT1(a,b) a##b\n",[2033],{"type":166,"tag":253,"props":2034,"children":2035},{"__ignoreMap":160},[2036,2094],{"type":166,"tag":257,"props":2037,"children":2038},{"class":259,"line":260},[2039,2043,2047,2051,2055,2059,2064,2068,2073,2077,2081,2085,2089],{"type":166,"tag":257,"props":2040,"children":2041},{"style":264},[2042],{"type":172,"value":1637},{"type":166,"tag":257,"props":2044,"children":2045},{"style":306},[2046],{"type":172,"value":1682},{"type":166,"tag":257,"props":2048,"children":2049},{"style":312},[2050],{"type":172,"value":394},{"type":166,"tag":257,"props":2052,"children":2053},{"style":1173},[2054],{"type":172,"value":191},{"type":166,"tag":257,"props":2056,"children":2057},{"style":312},[2058],{"type":172,"value":404},{"type":166,"tag":257,"props":2060,"children":2061},{"style":1173},[2062],{"type":172,"value":2063},"b",{"type":166,"tag":257,"props":2065,"children":2066},{"style":312},[2067],{"type":172,"value":961},{"type":166,"tag":257,"props":2069,"children":2070},{"style":306},[2071],{"type":172,"value":2072}," TCONCAT1",{"type":166,"tag":257,"props":2074,"children":2075},{"style":312},[2076],{"type":172,"value":394},{"type":166,"tag":257,"props":2078,"children":2079},{"style":338},[2080],{"type":172,"value":191},{"type":166,"tag":257,"props":2082,"children":2083},{"style":312},[2084],{"type":172,"value":404},{"type":166,"tag":257,"props":2086,"children":2087},{"style":338},[2088],{"type":172,"value":2063},{"type":166,"tag":257,"props":2090,"children":2091},{"style":312},[2092],{"type":172,"value":2093},")\n",{"type":166,"tag":257,"props":2095,"children":2096},{"class":259,"line":287},[2097,2101,2105,2109,2113,2117,2121,2125],{"type":166,"tag":257,"props":2098,"children":2099},{"style":264},[2100],{"type":172,"value":1637},{"type":166,"tag":257,"props":2102,"children":2103},{"style":306},[2104],{"type":172,"value":2072},{"type":166,"tag":257,"props":2106,"children":2107},{"style":312},[2108],{"type":172,"value":394},{"type":166,"tag":257,"props":2110,"children":2111},{"style":1173},[2112],{"type":172,"value":191},{"type":166,"tag":257,"props":2114,"children":2115},{"style":312},[2116],{"type":172,"value":404},{"type":166,"tag":257,"props":2118,"children":2119},{"style":1173},[2120],{"type":172,"value":2063},{"type":166,"tag":257,"props":2122,"children":2123},{"style":312},[2124],{"type":172,"value":961},{"type":166,"tag":257,"props":2126,"children":2127},{"style":338},[2128],{"type":172,"value":2129}," a##b\n",{"type":166,"tag":180,"props":2131,"children":2132},{},[2133],{"type":172,"value":2134},"这就要提到宏的一个特殊规则了，如果宏参数使用了字符串化运算符（#）或标记黏贴运算符（##），那么即便参数是宏也不会展开。所以需要一个间接宏 TCONCAT1，以达到先展开参数（如果参数是宏的化），再调用标记黏贴运算符的目的。从 test_db 可以看到，测试类的名词都不是宏，所以这里本不需要 TCONCAT1 这个间接宏。但是考虑到程序的健壮性，加上更好。",{"type":166,"tag":1133,"props":2136,"children":2138},{"id":2137},"断言宏",[2139],{"type":172,"value":2137},{"type":166,"tag":180,"props":2141,"children":2142},{},[2143],{"type":172,"value":2144},"测试代码中的断言也是使用的宏来定义的。相比 TCONCAT 简单很多了，但其特点是可以记录抛错的文件以及行号。以下代码实现了 ASSERT_EQ 的定义。Tester 用于记录宏展开时所在的文件 __FILE__、行号 __LINE__ 以及断言结果。一但断言失败，记录到 ok_ 成员变量中。在 Tester 析构时，会把相关信息一并打印出来。",{"type":166,"tag":246,"props":2146,"children":2148},{"code":2147,"language":249,"meta":160,"className":250,"style":160},"class Tester {\n#define BINARY_OP(name,op)                              \\\n  template \u003Cclass X, class Y>                           \\\n  Tester& name(const X& x, const Y& y) {                \\\n    if (! (x op y)) {                                   \\\n      ss_ \u003C\u003C \" failed: \" \u003C\u003C x \u003C\u003C (\" \" #op \" \") \u003C\u003C y;    \\\n      ok_ = false;                                      \\\n    }                                                   \\\n    return *this;                                       \\\n  }\n  BINARY_OP(IsEq, ==)\n#undef BINARY_OP\n}\n#define ASSERT_EQ(a,b) ::kdb::test::Tester(__FILE__, __LINE__).IsEq((a),(b))\n",[2149],{"type":166,"tag":253,"props":2150,"children":2151},{"__ignoreMap":160},[2152,2168,2205,2250,2325,2364,2450,2477,2490,2517,2524,2554,2567,2574],{"type":166,"tag":257,"props":2153,"children":2154},{"class":259,"line":260},[2155,2159,2164],{"type":166,"tag":257,"props":2156,"children":2157},{"style":300},[2158],{"type":172,"value":1677},{"type":166,"tag":257,"props":2160,"children":2161},{"style":327},[2162],{"type":172,"value":2163}," Tester",{"type":166,"tag":257,"props":2165,"children":2166},{"style":312},[2167],{"type":172,"value":320},{"type":166,"tag":257,"props":2169,"children":2170},{"class":259,"line":287},[2171,2175,2180,2184,2188,2192,2197,2201],{"type":166,"tag":257,"props":2172,"children":2173},{"style":264},[2174],{"type":172,"value":1637},{"type":166,"tag":257,"props":2176,"children":2177},{"style":306},[2178],{"type":172,"value":2179}," BINARY_OP",{"type":166,"tag":257,"props":2181,"children":2182},{"style":312},[2183],{"type":172,"value":394},{"type":166,"tag":257,"props":2185,"children":2186},{"style":1173},[2187],{"type":172,"value":1660},{"type":166,"tag":257,"props":2189,"children":2190},{"style":312},[2191],{"type":172,"value":404},{"type":166,"tag":257,"props":2193,"children":2194},{"style":1173},[2195],{"type":172,"value":2196},"op",{"type":166,"tag":257,"props":2198,"children":2199},{"style":312},[2200],{"type":172,"value":961},{"type":166,"tag":257,"props":2202,"children":2203},{"style":542},[2204],{"type":172,"value":1718},{"type":166,"tag":257,"props":2206,"children":2207},{"class":259,"line":296},[2208,2213,2217,2221,2226,2230,2235,2240,2245],{"type":166,"tag":257,"props":2209,"children":2210},{"style":300},[2211],{"type":172,"value":2212},"  template",{"type":166,"tag":257,"props":2214,"children":2215},{"style":312},[2216],{"type":172,"value":273},{"type":166,"tag":257,"props":2218,"children":2219},{"style":300},[2220],{"type":172,"value":1677},{"type":166,"tag":257,"props":2222,"children":2223},{"style":327},[2224],{"type":172,"value":2225}," X",{"type":166,"tag":257,"props":2227,"children":2228},{"style":312},[2229],{"type":172,"value":404},{"type":166,"tag":257,"props":2231,"children":2232},{"style":300},[2233],{"type":172,"value":2234}," class",{"type":166,"tag":257,"props":2236,"children":2237},{"style":327},[2238],{"type":172,"value":2239}," Y",{"type":166,"tag":257,"props":2241,"children":2242},{"style":312},[2243],{"type":172,"value":2244},">",{"type":166,"tag":257,"props":2246,"children":2247},{"style":542},[2248],{"type":172,"value":2249},"                           \\\n",{"type":166,"tag":257,"props":2251,"children":2252},{"class":259,"line":323},[2253,2258,2263,2268,2272,2277,2281,2285,2290,2294,2299,2303,2307,2312,2316,2320],{"type":166,"tag":257,"props":2254,"children":2255},{"style":327},[2256],{"type":172,"value":2257},"  Tester",{"type":166,"tag":257,"props":2259,"children":2260},{"style":1764},[2261],{"type":172,"value":2262},"&",{"type":166,"tag":257,"props":2264,"children":2265},{"style":306},[2266],{"type":172,"value":2267}," name",{"type":166,"tag":257,"props":2269,"children":2270},{"style":312},[2271],{"type":172,"value":394},{"type":166,"tag":257,"props":2273,"children":2274},{"style":1764},[2275],{"type":172,"value":2276},"const",{"type":166,"tag":257,"props":2278,"children":2279},{"style":327},[2280],{"type":172,"value":2225},{"type":166,"tag":257,"props":2282,"children":2283},{"style":1764},[2284],{"type":172,"value":2262},{"type":166,"tag":257,"props":2286,"children":2287},{"style":1173},[2288],{"type":172,"value":2289}," x",{"type":166,"tag":257,"props":2291,"children":2292},{"style":312},[2293],{"type":172,"value":404},{"type":166,"tag":257,"props":2295,"children":2296},{"style":1764},[2297],{"type":172,"value":2298}," const",{"type":166,"tag":257,"props":2300,"children":2301},{"style":327},[2302],{"type":172,"value":2239},{"type":166,"tag":257,"props":2304,"children":2305},{"style":1764},[2306],{"type":172,"value":2262},{"type":166,"tag":257,"props":2308,"children":2309},{"style":1173},[2310],{"type":172,"value":2311}," y",{"type":166,"tag":257,"props":2313,"children":2314},{"style":312},[2315],{"type":172,"value":961},{"type":166,"tag":257,"props":2317,"children":2318},{"style":312},[2319],{"type":172,"value":1786},{"type":166,"tag":257,"props":2321,"children":2322},{"style":542},[2323],{"type":172,"value":2324},"                \\\n",{"type":166,"tag":257,"props":2326,"children":2327},{"class":259,"line":349},[2328,2333,2337,2341,2345,2350,2355,2359],{"type":166,"tag":257,"props":2329,"children":2330},{"style":264},[2331],{"type":172,"value":2332},"    if",{"type":166,"tag":257,"props":2334,"children":2335},{"style":312},[2336],{"type":172,"value":473},{"type":166,"tag":257,"props":2338,"children":2339},{"style":436},[2340],{"type":172,"value":478},{"type":166,"tag":257,"props":2342,"children":2343},{"style":312},[2344],{"type":172,"value":473},{"type":166,"tag":257,"props":2346,"children":2347},{"style":517},[2348],{"type":172,"value":2349},"x op y",{"type":166,"tag":257,"props":2351,"children":2352},{"style":312},[2353],{"type":172,"value":2354},"))",{"type":166,"tag":257,"props":2356,"children":2357},{"style":312},[2358],{"type":172,"value":1786},{"type":166,"tag":257,"props":2360,"children":2361},{"style":542},[2362],{"type":172,"value":2363},"                                   \\\n",{"type":166,"tag":257,"props":2365,"children":2366},{"class":259,"line":370},[2367,2372,2377,2381,2386,2390,2395,2400,2404,2408,2412,2416,2421,2425,2429,2433,2437,2441,2445],{"type":166,"tag":257,"props":2368,"children":2369},{"style":517},[2370],{"type":172,"value":2371},"      ss_ ",{"type":166,"tag":257,"props":2373,"children":2374},{"style":436},[2375],{"type":172,"value":2376},"\u003C\u003C",{"type":166,"tag":257,"props":2378,"children":2379},{"style":270},[2380],{"type":172,"value":409},{"type":166,"tag":257,"props":2382,"children":2383},{"style":276},[2384],{"type":172,"value":2385}," failed: ",{"type":166,"tag":257,"props":2387,"children":2388},{"style":270},[2389],{"type":172,"value":419},{"type":166,"tag":257,"props":2391,"children":2392},{"style":436},[2393],{"type":172,"value":2394}," \u003C\u003C",{"type":166,"tag":257,"props":2396,"children":2397},{"style":517},[2398],{"type":172,"value":2399}," x ",{"type":166,"tag":257,"props":2401,"children":2402},{"style":436},[2403],{"type":172,"value":2376},{"type":166,"tag":257,"props":2405,"children":2406},{"style":312},[2407],{"type":172,"value":473},{"type":166,"tag":257,"props":2409,"children":2410},{"style":270},[2411],{"type":172,"value":419},{"type":166,"tag":257,"props":2413,"children":2414},{"style":270},[2415],{"type":172,"value":409},{"type":166,"tag":257,"props":2417,"children":2418},{"style":338},[2419],{"type":172,"value":2420}," #op",{"type":166,"tag":257,"props":2422,"children":2423},{"style":270},[2424],{"type":172,"value":409},{"type":166,"tag":257,"props":2426,"children":2427},{"style":270},[2428],{"type":172,"value":409},{"type":166,"tag":257,"props":2430,"children":2431},{"style":312},[2432],{"type":172,"value":961},{"type":166,"tag":257,"props":2434,"children":2435},{"style":436},[2436],{"type":172,"value":2394},{"type":166,"tag":257,"props":2438,"children":2439},{"style":517},[2440],{"type":172,"value":2311},{"type":166,"tag":257,"props":2442,"children":2443},{"style":312},[2444],{"type":172,"value":1829},{"type":166,"tag":257,"props":2446,"children":2447},{"style":542},[2448],{"type":172,"value":2449},"    \\\n",{"type":166,"tag":257,"props":2451,"children":2452},{"class":259,"line":427},[2453,2458,2462,2468,2472],{"type":166,"tag":257,"props":2454,"children":2455},{"style":517},[2456],{"type":172,"value":2457},"      ok_ ",{"type":166,"tag":257,"props":2459,"children":2460},{"style":436},[2461],{"type":172,"value":439},{"type":166,"tag":257,"props":2463,"children":2465},{"style":2464},"--shiki-light:#39ADB5;--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF",[2466],{"type":172,"value":2467}," false",{"type":166,"tag":257,"props":2469,"children":2470},{"style":312},[2471],{"type":172,"value":1829},{"type":166,"tag":257,"props":2473,"children":2474},{"style":542},[2475],{"type":172,"value":2476},"                                      \\\n",{"type":166,"tag":257,"props":2478,"children":2479},{"class":259,"line":462},[2480,2485],{"type":166,"tag":257,"props":2481,"children":2482},{"style":312},[2483],{"type":172,"value":2484},"    }",{"type":166,"tag":257,"props":2486,"children":2487},{"style":542},[2488],{"type":172,"value":2489},"                                                   \\\n",{"type":166,"tag":257,"props":2491,"children":2492},{"class":259,"line":504},[2493,2498,2502,2508,2512],{"type":166,"tag":257,"props":2494,"children":2495},{"style":264},[2496],{"type":172,"value":2497},"    return",{"type":166,"tag":257,"props":2499,"children":2500},{"style":436},[2501],{"type":172,"value":1223},{"type":166,"tag":257,"props":2503,"children":2505},{"style":2504},"--shiki-light:#39ADB5;--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F",[2506],{"type":172,"value":2507},"this",{"type":166,"tag":257,"props":2509,"children":2510},{"style":312},[2511],{"type":172,"value":1829},{"type":166,"tag":257,"props":2513,"children":2514},{"style":542},[2515],{"type":172,"value":2516},"                                       \\\n",{"type":166,"tag":257,"props":2518,"children":2519},{"class":259,"line":585},[2520],{"type":166,"tag":257,"props":2521,"children":2522},{"style":312},[2523],{"type":172,"value":614},{"type":166,"tag":257,"props":2525,"children":2526},{"class":259,"line":608},[2527,2532,2536,2541,2545,2550],{"type":166,"tag":257,"props":2528,"children":2529},{"style":306},[2530],{"type":172,"value":2531},"  BINARY_OP",{"type":166,"tag":257,"props":2533,"children":2534},{"style":312},[2535],{"type":172,"value":394},{"type":166,"tag":257,"props":2537,"children":2538},{"style":327},[2539],{"type":172,"value":2540},"IsEq",{"type":166,"tag":257,"props":2542,"children":2543},{"style":312},[2544],{"type":172,"value":404},{"type":166,"tag":257,"props":2546,"children":2547},{"style":436},[2548],{"type":172,"value":2549}," ==",{"type":166,"tag":257,"props":2551,"children":2552},{"style":312},[2553],{"type":172,"value":2093},{"type":166,"tag":257,"props":2555,"children":2556},{"class":259,"line":617},[2557,2562],{"type":166,"tag":257,"props":2558,"children":2559},{"style":264},[2560],{"type":172,"value":2561},"#undef",{"type":166,"tag":257,"props":2563,"children":2564},{"style":306},[2565],{"type":172,"value":2566}," BINARY_OP\n",{"type":166,"tag":257,"props":2568,"children":2569},{"class":259,"line":625},[2570],{"type":166,"tag":257,"props":2571,"children":2572},{"style":517},[2573],{"type":172,"value":1103},{"type":166,"tag":257,"props":2575,"children":2576},{"class":259,"line":668},[2577,2581,2586,2590,2594,2598,2602,2606,2611,2615,2619,2623,2627,2632,2636,2642,2646,2651,2656,2660,2665,2669,2674,2678],{"type":166,"tag":257,"props":2578,"children":2579},{"style":264},[2580],{"type":172,"value":1637},{"type":166,"tag":257,"props":2582,"children":2583},{"style":306},[2584],{"type":172,"value":2585}," ASSERT_EQ",{"type":166,"tag":257,"props":2587,"children":2588},{"style":312},[2589],{"type":172,"value":394},{"type":166,"tag":257,"props":2591,"children":2592},{"style":1173},[2593],{"type":172,"value":191},{"type":166,"tag":257,"props":2595,"children":2596},{"style":312},[2597],{"type":172,"value":404},{"type":166,"tag":257,"props":2599,"children":2600},{"style":1173},[2601],{"type":172,"value":2063},{"type":166,"tag":257,"props":2603,"children":2604},{"style":312},[2605],{"type":172,"value":961},{"type":166,"tag":257,"props":2607,"children":2608},{"style":517},[2609],{"type":172,"value":2610}," ::",{"type":166,"tag":257,"props":2612,"children":2613},{"style":327},[2614],{"type":172,"value":1941},{"type":166,"tag":257,"props":2616,"children":2617},{"style":312},[2618],{"type":172,"value":335},{"type":166,"tag":257,"props":2620,"children":2621},{"style":327},[2622],{"type":172,"value":1543},{"type":166,"tag":257,"props":2624,"children":2625},{"style":312},[2626],{"type":172,"value":335},{"type":166,"tag":257,"props":2628,"children":2629},{"style":306},[2630],{"type":172,"value":2631},"Tester",{"type":166,"tag":257,"props":2633,"children":2634},{"style":312},[2635],{"type":172,"value":394},{"type":166,"tag":257,"props":2637,"children":2639},{"style":2638},"--shiki-light:#E2931D;--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#F8F8F2",[2640],{"type":172,"value":2641},"__FILE__",{"type":166,"tag":257,"props":2643,"children":2644},{"style":312},[2645],{"type":172,"value":404},{"type":166,"tag":257,"props":2647,"children":2648},{"style":2638},[2649],{"type":172,"value":2650}," __LINE__",{"type":166,"tag":257,"props":2652,"children":2653},{"style":312},[2654],{"type":172,"value":2655},").",{"type":166,"tag":257,"props":2657,"children":2658},{"style":306},[2659],{"type":172,"value":2540},{"type":166,"tag":257,"props":2661,"children":2662},{"style":312},[2663],{"type":172,"value":2664},"((",{"type":166,"tag":257,"props":2666,"children":2667},{"style":517},[2668],{"type":172,"value":191},{"type":166,"tag":257,"props":2670,"children":2671},{"style":312},[2672],{"type":172,"value":2673},"),(",{"type":166,"tag":257,"props":2675,"children":2676},{"style":517},[2677],{"type":172,"value":2063},{"type":166,"tag":257,"props":2679,"children":2680},{"style":312},[2681],{"type":172,"value":2682},"))\n",{"type":166,"tag":1133,"props":2684,"children":2686},{"id":2685},"stringrepeatntimes",[2687],{"type":172,"value":2688},"string.repeat(ntimes)",{"type":166,"tag":180,"props":2690,"children":2691},{},[2692],{"type":172,"value":2693},"写 JavaScript 时经常用到 String 的原型方法 repeat，用来把 n 个内容重复的字符串拼接为一个新字符串。也许是 C++ 标准库没有提供相应的算法，KDB 使用了一种和 repeat 完全不一样的处理思路。KDB 使用 StringStream 填充一定位数内容，还可以不用考虑值的长度。",{"type":166,"tag":246,"props":2695,"children":2697},{"code":2696,"language":249,"meta":160,"className":250,"style":160},"std::stringstream ss;\nss \u003C\u003C std::setfill ('0') \u003C\u003C std::setw (16);\nss \u003C\u003C 1;\nss.str(); // result is: \"0000000000000001\"\nss \u003C\u003C std::setfill ('0') \u003C\u003C std::setw (16);\nss \u003C\u003C 1123;\nss.str(); // result is: \"0000000000001123\"\n",[2698],{"type":166,"tag":253,"props":2699,"children":2700},{"__ignoreMap":160},[2701,2722,2800,2820,2846,2917,2937],{"type":166,"tag":257,"props":2702,"children":2703},{"class":259,"line":260},[2704,2709,2713,2718],{"type":166,"tag":257,"props":2705,"children":2706},{"style":327},[2707],{"type":172,"value":2708},"std",{"type":166,"tag":257,"props":2710,"children":2711},{"style":312},[2712],{"type":172,"value":335},{"type":166,"tag":257,"props":2714,"children":2715},{"style":338},[2716],{"type":172,"value":2717},"stringstream ss",{"type":166,"tag":257,"props":2719,"children":2720},{"style":312},[2721],{"type":172,"value":346},{"type":166,"tag":257,"props":2723,"children":2724},{"class":259,"line":287},[2725,2730,2734,2739,2743,2748,2752,2757,2762,2766,2770,2774,2778,2782,2787,2791,2796],{"type":166,"tag":257,"props":2726,"children":2727},{"style":338},[2728],{"type":172,"value":2729},"ss ",{"type":166,"tag":257,"props":2731,"children":2732},{"style":436},[2733],{"type":172,"value":2376},{"type":166,"tag":257,"props":2735,"children":2736},{"style":327},[2737],{"type":172,"value":2738}," std",{"type":166,"tag":257,"props":2740,"children":2741},{"style":312},[2742],{"type":172,"value":335},{"type":166,"tag":257,"props":2744,"children":2745},{"style":306},[2746],{"type":172,"value":2747},"setfill",{"type":166,"tag":257,"props":2749,"children":2750},{"style":312},[2751],{"type":172,"value":473},{"type":166,"tag":257,"props":2753,"children":2754},{"style":270},[2755],{"type":172,"value":2756},"'",{"type":166,"tag":257,"props":2758,"children":2759},{"style":276},[2760],{"type":172,"value":2761},"0",{"type":166,"tag":257,"props":2763,"children":2764},{"style":270},[2765],{"type":172,"value":2756},{"type":166,"tag":257,"props":2767,"children":2768},{"style":312},[2769],{"type":172,"value":961},{"type":166,"tag":257,"props":2771,"children":2772},{"style":436},[2773],{"type":172,"value":2394},{"type":166,"tag":257,"props":2775,"children":2776},{"style":327},[2777],{"type":172,"value":2738},{"type":166,"tag":257,"props":2779,"children":2780},{"style":312},[2781],{"type":172,"value":335},{"type":166,"tag":257,"props":2783,"children":2784},{"style":306},[2785],{"type":172,"value":2786},"setw",{"type":166,"tag":257,"props":2788,"children":2789},{"style":312},[2790],{"type":172,"value":473},{"type":166,"tag":257,"props":2792,"children":2793},{"style":598},[2794],{"type":172,"value":2795},"16",{"type":166,"tag":257,"props":2797,"children":2798},{"style":312},[2799],{"type":172,"value":424},{"type":166,"tag":257,"props":2801,"children":2802},{"class":259,"line":296},[2803,2807,2811,2816],{"type":166,"tag":257,"props":2804,"children":2805},{"style":338},[2806],{"type":172,"value":2729},{"type":166,"tag":257,"props":2808,"children":2809},{"style":436},[2810],{"type":172,"value":2376},{"type":166,"tag":257,"props":2812,"children":2813},{"style":598},[2814],{"type":172,"value":2815}," 1",{"type":166,"tag":257,"props":2817,"children":2818},{"style":312},[2819],{"type":172,"value":346},{"type":166,"tag":257,"props":2821,"children":2822},{"class":259,"line":323},[2823,2828,2832,2837,2841],{"type":166,"tag":257,"props":2824,"children":2825},{"style":338},[2826],{"type":172,"value":2827},"ss",{"type":166,"tag":257,"props":2829,"children":2830},{"style":312},[2831],{"type":172,"value":449},{"type":166,"tag":257,"props":2833,"children":2834},{"style":306},[2835],{"type":172,"value":2836},"str",{"type":166,"tag":257,"props":2838,"children":2839},{"style":312},[2840],{"type":172,"value":1753},{"type":166,"tag":257,"props":2842,"children":2843},{"style":1266},[2844],{"type":172,"value":2845}," // result is: \"0000000000000001\"\n",{"type":166,"tag":257,"props":2847,"children":2848},{"class":259,"line":349},[2849,2853,2857,2861,2865,2869,2873,2877,2881,2885,2889,2893,2897,2901,2905,2909,2913],{"type":166,"tag":257,"props":2850,"children":2851},{"style":338},[2852],{"type":172,"value":2729},{"type":166,"tag":257,"props":2854,"children":2855},{"style":436},[2856],{"type":172,"value":2376},{"type":166,"tag":257,"props":2858,"children":2859},{"style":327},[2860],{"type":172,"value":2738},{"type":166,"tag":257,"props":2862,"children":2863},{"style":312},[2864],{"type":172,"value":335},{"type":166,"tag":257,"props":2866,"children":2867},{"style":306},[2868],{"type":172,"value":2747},{"type":166,"tag":257,"props":2870,"children":2871},{"style":312},[2872],{"type":172,"value":473},{"type":166,"tag":257,"props":2874,"children":2875},{"style":270},[2876],{"type":172,"value":2756},{"type":166,"tag":257,"props":2878,"children":2879},{"style":276},[2880],{"type":172,"value":2761},{"type":166,"tag":257,"props":2882,"children":2883},{"style":270},[2884],{"type":172,"value":2756},{"type":166,"tag":257,"props":2886,"children":2887},{"style":312},[2888],{"type":172,"value":961},{"type":166,"tag":257,"props":2890,"children":2891},{"style":436},[2892],{"type":172,"value":2394},{"type":166,"tag":257,"props":2894,"children":2895},{"style":327},[2896],{"type":172,"value":2738},{"type":166,"tag":257,"props":2898,"children":2899},{"style":312},[2900],{"type":172,"value":335},{"type":166,"tag":257,"props":2902,"children":2903},{"style":306},[2904],{"type":172,"value":2786},{"type":166,"tag":257,"props":2906,"children":2907},{"style":312},[2908],{"type":172,"value":473},{"type":166,"tag":257,"props":2910,"children":2911},{"style":598},[2912],{"type":172,"value":2795},{"type":166,"tag":257,"props":2914,"children":2915},{"style":312},[2916],{"type":172,"value":424},{"type":166,"tag":257,"props":2918,"children":2919},{"class":259,"line":370},[2920,2924,2928,2933],{"type":166,"tag":257,"props":2921,"children":2922},{"style":338},[2923],{"type":172,"value":2729},{"type":166,"tag":257,"props":2925,"children":2926},{"style":436},[2927],{"type":172,"value":2376},{"type":166,"tag":257,"props":2929,"children":2930},{"style":598},[2931],{"type":172,"value":2932}," 1123",{"type":166,"tag":257,"props":2934,"children":2935},{"style":312},[2936],{"type":172,"value":346},{"type":166,"tag":257,"props":2938,"children":2939},{"class":259,"line":427},[2940,2944,2948,2952,2956],{"type":166,"tag":257,"props":2941,"children":2942},{"style":338},[2943],{"type":172,"value":2827},{"type":166,"tag":257,"props":2945,"children":2946},{"style":312},[2947],{"type":172,"value":449},{"type":166,"tag":257,"props":2949,"children":2950},{"style":306},[2951],{"type":172,"value":2836},{"type":166,"tag":257,"props":2953,"children":2954},{"style":312},[2955],{"type":172,"value":1753},{"type":166,"tag":257,"props":2957,"children":2958},{"style":1266},[2959],{"type":172,"value":2960}," // result is: \"0000000000001123\"\n",{"type":166,"tag":1133,"props":2962,"children":2964},{"id":2963},"c-风格的随机数",[2965],{"type":172,"value":2966},"C++ 风格的随机数",{"type":166,"tag":180,"props":2968,"children":2969},{},[2970],{"type":172,"value":2971},"一个有意思的地方时，KDB 代码中随处可见 C 编程风格的源码。但是测试用例中生成随机数确实 C++ 风格的。",{"type":166,"tag":246,"props":2973,"children":2975},{"code":2974,"language":249,"meta":160,"className":250,"style":160},"std::mt19937 generator = std::mt19937();\nstd::uniform_int_distribution\u003Cint> random_dist(0,255);\n// ...\nfor (int i = 0; i \u003C size; i++) {\n  str[i] = static_cast\u003Cchar>(random_dist(generator));\n}\n",[2976],{"type":166,"tag":253,"props":2977,"children":2978},{"__ignoreMap":160},[2979,3016,3071,3079,3147,3210],{"type":166,"tag":257,"props":2980,"children":2981},{"class":259,"line":260},[2982,2986,2990,2995,2999,3003,3007,3012],{"type":166,"tag":257,"props":2983,"children":2984},{"style":327},[2985],{"type":172,"value":2708},{"type":166,"tag":257,"props":2987,"children":2988},{"style":312},[2989],{"type":172,"value":335},{"type":166,"tag":257,"props":2991,"children":2992},{"style":338},[2993],{"type":172,"value":2994},"mt19937 generator ",{"type":166,"tag":257,"props":2996,"children":2997},{"style":436},[2998],{"type":172,"value":439},{"type":166,"tag":257,"props":3000,"children":3001},{"style":327},[3002],{"type":172,"value":2738},{"type":166,"tag":257,"props":3004,"children":3005},{"style":312},[3006],{"type":172,"value":335},{"type":166,"tag":257,"props":3008,"children":3009},{"style":306},[3010],{"type":172,"value":3011},"mt19937",{"type":166,"tag":257,"props":3013,"children":3014},{"style":312},[3015],{"type":172,"value":459},{"type":166,"tag":257,"props":3017,"children":3018},{"class":259,"line":287},[3019,3023,3027,3032,3037,3041,3045,3050,3054,3058,3062,3067],{"type":166,"tag":257,"props":3020,"children":3021},{"style":327},[3022],{"type":172,"value":2708},{"type":166,"tag":257,"props":3024,"children":3025},{"style":312},[3026],{"type":172,"value":335},{"type":166,"tag":257,"props":3028,"children":3029},{"style":327},[3030],{"type":172,"value":3031},"uniform_int_distribution",{"type":166,"tag":257,"props":3033,"children":3034},{"style":312},[3035],{"type":172,"value":3036},"\u003C",{"type":166,"tag":257,"props":3038,"children":3039},{"style":300},[3040],{"type":172,"value":303},{"type":166,"tag":257,"props":3042,"children":3043},{"style":312},[3044],{"type":172,"value":2244},{"type":166,"tag":257,"props":3046,"children":3047},{"style":306},[3048],{"type":172,"value":3049}," random_dist",{"type":166,"tag":257,"props":3051,"children":3052},{"style":312},[3053],{"type":172,"value":394},{"type":166,"tag":257,"props":3055,"children":3056},{"style":598},[3057],{"type":172,"value":2761},{"type":166,"tag":257,"props":3059,"children":3060},{"style":312},[3061],{"type":172,"value":404},{"type":166,"tag":257,"props":3063,"children":3064},{"style":598},[3065],{"type":172,"value":3066},"255",{"type":166,"tag":257,"props":3068,"children":3069},{"style":312},[3070],{"type":172,"value":424},{"type":166,"tag":257,"props":3072,"children":3073},{"class":259,"line":296},[3074],{"type":166,"tag":257,"props":3075,"children":3076},{"style":1266},[3077],{"type":172,"value":3078},"// ...\n",{"type":166,"tag":257,"props":3080,"children":3081},{"class":259,"line":323},[3082,3087,3091,3095,3100,3104,3108,3112,3116,3120,3125,3129,3134,3139,3143],{"type":166,"tag":257,"props":3083,"children":3084},{"style":264},[3085],{"type":172,"value":3086},"for",{"type":166,"tag":257,"props":3088,"children":3089},{"style":312},[3090],{"type":172,"value":473},{"type":166,"tag":257,"props":3092,"children":3093},{"style":300},[3094],{"type":172,"value":303},{"type":166,"tag":257,"props":3096,"children":3097},{"style":338},[3098],{"type":172,"value":3099}," i ",{"type":166,"tag":257,"props":3101,"children":3102},{"style":436},[3103],{"type":172,"value":439},{"type":166,"tag":257,"props":3105,"children":3106},{"style":598},[3107],{"type":172,"value":1090},{"type":166,"tag":257,"props":3109,"children":3110},{"style":312},[3111],{"type":172,"value":1829},{"type":166,"tag":257,"props":3113,"children":3114},{"style":338},[3115],{"type":172,"value":3099},{"type":166,"tag":257,"props":3117,"children":3118},{"style":436},[3119],{"type":172,"value":3036},{"type":166,"tag":257,"props":3121,"children":3122},{"style":338},[3123],{"type":172,"value":3124}," size",{"type":166,"tag":257,"props":3126,"children":3127},{"style":312},[3128],{"type":172,"value":1829},{"type":166,"tag":257,"props":3130,"children":3131},{"style":338},[3132],{"type":172,"value":3133}," i",{"type":166,"tag":257,"props":3135,"children":3136},{"style":436},[3137],{"type":172,"value":3138},"++",{"type":166,"tag":257,"props":3140,"children":3141},{"style":312},[3142],{"type":172,"value":961},{"type":166,"tag":257,"props":3144,"children":3145},{"style":312},[3146],{"type":172,"value":320},{"type":166,"tag":257,"props":3148,"children":3149},{"class":259,"line":349},[3150,3155,3159,3164,3169,3173,3178,3183,3187,3191,3196,3200,3205],{"type":166,"tag":257,"props":3151,"children":3152},{"style":338},[3153],{"type":172,"value":3154},"  str",{"type":166,"tag":257,"props":3156,"children":3157},{"style":312},[3158],{"type":172,"value":1233},{"type":166,"tag":257,"props":3160,"children":3161},{"style":517},[3162],{"type":172,"value":3163},"i",{"type":166,"tag":257,"props":3165,"children":3166},{"style":312},[3167],{"type":172,"value":3168},"]",{"type":166,"tag":257,"props":3170,"children":3171},{"style":436},[3172],{"type":172,"value":1923},{"type":166,"tag":257,"props":3174,"children":3175},{"style":436},[3176],{"type":172,"value":3177}," static_cast\u003C",{"type":166,"tag":257,"props":3179,"children":3180},{"style":300},[3181],{"type":172,"value":3182},"char",{"type":166,"tag":257,"props":3184,"children":3185},{"style":436},[3186],{"type":172,"value":2244},{"type":166,"tag":257,"props":3188,"children":3189},{"style":312},[3190],{"type":172,"value":394},{"type":166,"tag":257,"props":3192,"children":3193},{"style":306},[3194],{"type":172,"value":3195},"random_dist",{"type":166,"tag":257,"props":3197,"children":3198},{"style":312},[3199],{"type":172,"value":394},{"type":166,"tag":257,"props":3201,"children":3202},{"style":517},[3203],{"type":172,"value":3204},"generator",{"type":166,"tag":257,"props":3206,"children":3207},{"style":312},[3208],{"type":172,"value":3209},"));\n",{"type":166,"tag":257,"props":3211,"children":3212},{"class":259,"line":370},[3213],{"type":166,"tag":257,"props":3214,"children":3215},{"style":312},[3216],{"type":172,"value":1103},{"type":166,"tag":174,"props":3218,"children":3220},{"id":3219},"接口层",[3221],{"type":172,"value":3219},{"type":166,"tag":180,"props":3223,"children":3224},{},[3225,3227,3233],{"type":172,"value":3226},"接口的声明位于 interface/kingdb.h，实现则是 interface/kingdb.cc。KingDB 类给 Database 和 Snapshot 定义了要求实现的 Get、Put、Delete、NewIterater、Open、Close、Flush、Compact、NewMultipartReader 接口。KDB 有自己的数据传输格式 ByteArray，诸如 Get、Put 这些接口在 KingDB 类中对应方法得到了重载，以实现通过 std::string 来传递键、值或者两者，可视为为接受 ByteArray 的方法的包装。所有数据库操作方法都返回 Status 对象，相关异常部分的简介见",{"type":166,"tag":191,"props":3228,"children":3230},{"href":3229},"#%E5%BC%82%E5%B8%B8%E4%B8%8E%E6%97%A5%E5%BF%97",[3231],{"type":172,"value":3232},"异常与日志",{"type":172,"value":3234},"小节。",{"type":166,"tag":180,"props":3236,"children":3237},{},[3238],{"type":172,"value":3239},"重载方法的实现示例如下，即先把 std::string 转回 ByteArray 再调用子类（Database 或 Snapshot）的实现。",{"type":166,"tag":246,"props":3241,"children":3243},{"code":3242,"language":249,"meta":160,"className":250,"style":160},"virtual Status Put(WriteOptions& write_options, const std::string& key, const std::string& chunk) {\n  ByteArray byte_array_key = NewDeepCopyByteArray(key.c_str(), key.size());\n  ByteArray byte_array_chunk = NewDeepCopyByteArray(chunk.c_str(), chunk.size());\n  return Put(write_options, byte_array_key, byte_array_chunk);\n}\n",[3244],{"type":166,"tag":253,"props":3245,"children":3246},{"__ignoreMap":160},[3247,3350,3406,3459,3500],{"type":166,"tag":257,"props":3248,"children":3249},{"class":259,"line":260},[3250,3255,3260,3265,3269,3274,3278,3283,3287,3291,3295,3299,3304,3308,3313,3317,3321,3325,3329,3333,3337,3342,3346],{"type":166,"tag":257,"props":3251,"children":3252},{"style":1764},[3253],{"type":172,"value":3254},"virtual",{"type":166,"tag":257,"props":3256,"children":3257},{"style":327},[3258],{"type":172,"value":3259}," Status",{"type":166,"tag":257,"props":3261,"children":3262},{"style":306},[3263],{"type":172,"value":3264}," Put",{"type":166,"tag":257,"props":3266,"children":3267},{"style":312},[3268],{"type":172,"value":394},{"type":166,"tag":257,"props":3270,"children":3271},{"style":327},[3272],{"type":172,"value":3273},"WriteOptions",{"type":166,"tag":257,"props":3275,"children":3276},{"style":1764},[3277],{"type":172,"value":2262},{"type":166,"tag":257,"props":3279,"children":3280},{"style":1173},[3281],{"type":172,"value":3282}," write_options",{"type":166,"tag":257,"props":3284,"children":3285},{"style":312},[3286],{"type":172,"value":404},{"type":166,"tag":257,"props":3288,"children":3289},{"style":1764},[3290],{"type":172,"value":2298},{"type":166,"tag":257,"props":3292,"children":3293},{"style":327},[3294],{"type":172,"value":2738},{"type":166,"tag":257,"props":3296,"children":3297},{"style":312},[3298],{"type":172,"value":335},{"type":166,"tag":257,"props":3300,"children":3301},{"style":327},[3302],{"type":172,"value":3303},"string",{"type":166,"tag":257,"props":3305,"children":3306},{"style":1764},[3307],{"type":172,"value":2262},{"type":166,"tag":257,"props":3309,"children":3310},{"style":1173},[3311],{"type":172,"value":3312}," key",{"type":166,"tag":257,"props":3314,"children":3315},{"style":312},[3316],{"type":172,"value":404},{"type":166,"tag":257,"props":3318,"children":3319},{"style":1764},[3320],{"type":172,"value":2298},{"type":166,"tag":257,"props":3322,"children":3323},{"style":327},[3324],{"type":172,"value":2738},{"type":166,"tag":257,"props":3326,"children":3327},{"style":312},[3328],{"type":172,"value":335},{"type":166,"tag":257,"props":3330,"children":3331},{"style":327},[3332],{"type":172,"value":3303},{"type":166,"tag":257,"props":3334,"children":3335},{"style":1764},[3336],{"type":172,"value":2262},{"type":166,"tag":257,"props":3338,"children":3339},{"style":1173},[3340],{"type":172,"value":3341}," chunk",{"type":166,"tag":257,"props":3343,"children":3344},{"style":312},[3345],{"type":172,"value":961},{"type":166,"tag":257,"props":3347,"children":3348},{"style":312},[3349],{"type":172,"value":320},{"type":166,"tag":257,"props":3351,"children":3352},{"class":259,"line":287},[3353,3358,3362,3367,3371,3376,3380,3384,3389,3393,3397,3402],{"type":166,"tag":257,"props":3354,"children":3355},{"style":338},[3356],{"type":172,"value":3357},"  ByteArray byte_array_key ",{"type":166,"tag":257,"props":3359,"children":3360},{"style":436},[3361],{"type":172,"value":439},{"type":166,"tag":257,"props":3363,"children":3364},{"style":306},[3365],{"type":172,"value":3366}," NewDeepCopyByteArray",{"type":166,"tag":257,"props":3368,"children":3369},{"style":312},[3370],{"type":172,"value":394},{"type":166,"tag":257,"props":3372,"children":3373},{"style":338},[3374],{"type":172,"value":3375},"key",{"type":166,"tag":257,"props":3377,"children":3378},{"style":312},[3379],{"type":172,"value":449},{"type":166,"tag":257,"props":3381,"children":3382},{"style":306},[3383],{"type":172,"value":577},{"type":166,"tag":257,"props":3385,"children":3386},{"style":312},[3387],{"type":172,"value":3388},"(),",{"type":166,"tag":257,"props":3390,"children":3391},{"style":338},[3392],{"type":172,"value":3312},{"type":166,"tag":257,"props":3394,"children":3395},{"style":312},[3396],{"type":172,"value":449},{"type":166,"tag":257,"props":3398,"children":3399},{"style":306},[3400],{"type":172,"value":3401},"size",{"type":166,"tag":257,"props":3403,"children":3404},{"style":312},[3405],{"type":172,"value":582},{"type":166,"tag":257,"props":3407,"children":3408},{"class":259,"line":296},[3409,3414,3418,3422,3426,3431,3435,3439,3443,3447,3451,3455],{"type":166,"tag":257,"props":3410,"children":3411},{"style":338},[3412],{"type":172,"value":3413},"  ByteArray byte_array_chunk ",{"type":166,"tag":257,"props":3415,"children":3416},{"style":436},[3417],{"type":172,"value":439},{"type":166,"tag":257,"props":3419,"children":3420},{"style":306},[3421],{"type":172,"value":3366},{"type":166,"tag":257,"props":3423,"children":3424},{"style":312},[3425],{"type":172,"value":394},{"type":166,"tag":257,"props":3427,"children":3428},{"style":338},[3429],{"type":172,"value":3430},"chunk",{"type":166,"tag":257,"props":3432,"children":3433},{"style":312},[3434],{"type":172,"value":449},{"type":166,"tag":257,"props":3436,"children":3437},{"style":306},[3438],{"type":172,"value":577},{"type":166,"tag":257,"props":3440,"children":3441},{"style":312},[3442],{"type":172,"value":3388},{"type":166,"tag":257,"props":3444,"children":3445},{"style":338},[3446],{"type":172,"value":3341},{"type":166,"tag":257,"props":3448,"children":3449},{"style":312},[3450],{"type":172,"value":449},{"type":166,"tag":257,"props":3452,"children":3453},{"style":306},[3454],{"type":172,"value":3401},{"type":166,"tag":257,"props":3456,"children":3457},{"style":312},[3458],{"type":172,"value":582},{"type":166,"tag":257,"props":3460,"children":3461},{"class":259,"line":323},[3462,3466,3470,3474,3478,3482,3487,3491,3496],{"type":166,"tag":257,"props":3463,"children":3464},{"style":264},[3465],{"type":172,"value":1085},{"type":166,"tag":257,"props":3467,"children":3468},{"style":306},[3469],{"type":172,"value":3264},{"type":166,"tag":257,"props":3471,"children":3472},{"style":312},[3473],{"type":172,"value":394},{"type":166,"tag":257,"props":3475,"children":3476},{"style":338},[3477],{"type":172,"value":769},{"type":166,"tag":257,"props":3479,"children":3480},{"style":312},[3481],{"type":172,"value":404},{"type":166,"tag":257,"props":3483,"children":3484},{"style":338},[3485],{"type":172,"value":3486}," byte_array_key",{"type":166,"tag":257,"props":3488,"children":3489},{"style":312},[3490],{"type":172,"value":404},{"type":166,"tag":257,"props":3492,"children":3493},{"style":338},[3494],{"type":172,"value":3495}," byte_array_chunk",{"type":166,"tag":257,"props":3497,"children":3498},{"style":312},[3499],{"type":172,"value":424},{"type":166,"tag":257,"props":3501,"children":3502},{"class":259,"line":349},[3503],{"type":166,"tag":257,"props":3504,"children":3505},{"style":312},[3506],{"type":172,"value":1103},{"type":166,"tag":1133,"props":3508,"children":3510},{"id":3509},"数据库开关",[3511],{"type":172,"value":3509},{"type":166,"tag":180,"props":3513,"children":3514},{},[3515],{"type":172,"value":3516},"数据库的开启与关闭，分别对应 Database 类的 Open 和 Close 方法。开启时，通过 stat 库函数找到数据库路径以及配置文件，使用 open 库函数获取其文件描述符。配置文件须先用 flock 锁住，使用 mmap 映射后再读取；如果没有那么分情况写入。之后，创建好 EventManager、WriteBuffer 和 StorageEngine 的实例，就完成了。关闭时过程类似，锁定住配置文件后再关闭，同时删除以上创建的实例。可以发现，资源申请全放在了 Open 中，而资源的销毁放在了 Close 中，而 Database 类析构时会自动调用 Close，所以这是一个类似 RAII 的资源管理过程。",{"type":166,"tag":246,"props":3518,"children":3520},{"code":3519,"language":249,"meta":160,"className":250,"style":160},"class Database: public KingDB {\n  virtual ~Database() { Close(); }\n  virtual Status Open() override {\n    std::string filepath_dboptions = DatabaseOptions::GetPath(dbname_);\n    fd_dboptions_ = open(filepath_dboptions.c_str(), O_RDONLY, 0644);\n    flock(fd_dboptions_, LOCK_EX | LOCK_NB);\n    Mmap mmap(filepath_dboptions, info.st_size);\n    Status status_dboptions = DatabaseOptionEncoder::DecodeFrom(mmap.datafile(), mmap.filesize(), &db_options_candidate);\n    // ...\n    em_ = new EventManager();\n    wb_ = new WriteBuffer(db_options_, em_);\n    se_ = new StorageEngine(db_options_, em_, dbname_);\n    return Status::OK(); \n  }\n  virtual void Close() override {\n    flock(fd_dboptions_, LOCK_UN);\n    close(fd_dboptions_);\n    wb_->Close();\n    se_->Close();\n    delete wb_;\n    delete se_;\n    delete em_;\n  }\n}\n",[3521],{"type":166,"tag":253,"props":3522,"children":3523},{"__ignoreMap":160},[3524,3553,3588,3617,3665,3726,3766,3809,3887,3895,3921,3964,4014,4042,4049,4076,4104,4124,4146,4166,4183,4199,4214,4221],{"type":166,"tag":257,"props":3525,"children":3526},{"class":259,"line":260},[3527,3531,3536,3540,3544,3549],{"type":166,"tag":257,"props":3528,"children":3529},{"style":300},[3530],{"type":172,"value":1677},{"type":166,"tag":257,"props":3532,"children":3533},{"style":327},[3534],{"type":172,"value":3535}," Database",{"type":166,"tag":257,"props":3537,"children":3538},{"style":312},[3539],{"type":172,"value":1362},{"type":166,"tag":257,"props":3541,"children":3542},{"style":300},[3543],{"type":172,"value":1726},{"type":166,"tag":257,"props":3545,"children":3546},{"style":327},[3547],{"type":172,"value":3548}," KingDB",{"type":166,"tag":257,"props":3550,"children":3551},{"style":312},[3552],{"type":172,"value":320},{"type":166,"tag":257,"props":3554,"children":3555},{"class":259,"line":287},[3556,3561,3566,3570,3574,3579,3583],{"type":166,"tag":257,"props":3557,"children":3558},{"style":1764},[3559],{"type":172,"value":3560},"  virtual",{"type":166,"tag":257,"props":3562,"children":3563},{"style":306},[3564],{"type":172,"value":3565}," ~Database",{"type":166,"tag":257,"props":3567,"children":3568},{"style":312},[3569],{"type":172,"value":315},{"type":166,"tag":257,"props":3571,"children":3572},{"style":312},[3573],{"type":172,"value":1786},{"type":166,"tag":257,"props":3575,"children":3576},{"style":306},[3577],{"type":172,"value":3578}," Close",{"type":166,"tag":257,"props":3580,"children":3581},{"style":312},[3582],{"type":172,"value":1753},{"type":166,"tag":257,"props":3584,"children":3585},{"style":312},[3586],{"type":172,"value":3587}," }\n",{"type":166,"tag":257,"props":3589,"children":3590},{"class":259,"line":296},[3591,3595,3599,3604,3608,3613],{"type":166,"tag":257,"props":3592,"children":3593},{"style":1764},[3594],{"type":172,"value":3560},{"type":166,"tag":257,"props":3596,"children":3597},{"style":327},[3598],{"type":172,"value":3259},{"type":166,"tag":257,"props":3600,"children":3601},{"style":306},[3602],{"type":172,"value":3603}," Open",{"type":166,"tag":257,"props":3605,"children":3606},{"style":312},[3607],{"type":172,"value":315},{"type":166,"tag":257,"props":3609,"children":3610},{"style":1764},[3611],{"type":172,"value":3612}," override",{"type":166,"tag":257,"props":3614,"children":3615},{"style":312},[3616],{"type":172,"value":320},{"type":166,"tag":257,"props":3618,"children":3619},{"class":259,"line":323},[3620,3625,3629,3634,3638,3643,3647,3652,3656,3661],{"type":166,"tag":257,"props":3621,"children":3622},{"style":327},[3623],{"type":172,"value":3624},"    std",{"type":166,"tag":257,"props":3626,"children":3627},{"style":312},[3628],{"type":172,"value":335},{"type":166,"tag":257,"props":3630,"children":3631},{"style":517},[3632],{"type":172,"value":3633},"string filepath_dboptions ",{"type":166,"tag":257,"props":3635,"children":3636},{"style":436},[3637],{"type":172,"value":439},{"type":166,"tag":257,"props":3639,"children":3640},{"style":327},[3641],{"type":172,"value":3642}," DatabaseOptions",{"type":166,"tag":257,"props":3644,"children":3645},{"style":312},[3646],{"type":172,"value":335},{"type":166,"tag":257,"props":3648,"children":3649},{"style":306},[3650],{"type":172,"value":3651},"GetPath",{"type":166,"tag":257,"props":3653,"children":3654},{"style":312},[3655],{"type":172,"value":394},{"type":166,"tag":257,"props":3657,"children":3658},{"style":517},[3659],{"type":172,"value":3660},"dbname_",{"type":166,"tag":257,"props":3662,"children":3663},{"style":312},[3664],{"type":172,"value":424},{"type":166,"tag":257,"props":3666,"children":3667},{"class":259,"line":349},[3668,3673,3677,3682,3686,3691,3695,3699,3703,3708,3712,3717,3722],{"type":166,"tag":257,"props":3669,"children":3670},{"style":517},[3671],{"type":172,"value":3672},"    fd_dboptions_ ",{"type":166,"tag":257,"props":3674,"children":3675},{"style":436},[3676],{"type":172,"value":439},{"type":166,"tag":257,"props":3678,"children":3679},{"style":306},[3680],{"type":172,"value":3681}," open",{"type":166,"tag":257,"props":3683,"children":3684},{"style":312},[3685],{"type":172,"value":394},{"type":166,"tag":257,"props":3687,"children":3688},{"style":338},[3689],{"type":172,"value":3690},"filepath_dboptions",{"type":166,"tag":257,"props":3692,"children":3693},{"style":312},[3694],{"type":172,"value":449},{"type":166,"tag":257,"props":3696,"children":3697},{"style":306},[3698],{"type":172,"value":577},{"type":166,"tag":257,"props":3700,"children":3701},{"style":312},[3702],{"type":172,"value":3388},{"type":166,"tag":257,"props":3704,"children":3705},{"style":517},[3706],{"type":172,"value":3707}," O_RDONLY",{"type":166,"tag":257,"props":3709,"children":3710},{"style":312},[3711],{"type":172,"value":404},{"type":166,"tag":257,"props":3713,"children":3715},{"style":3714},"--shiki-light:#F76D47;--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672",[3716],{"type":172,"value":1090},{"type":166,"tag":257,"props":3718,"children":3719},{"style":598},[3720],{"type":172,"value":3721},"644",{"type":166,"tag":257,"props":3723,"children":3724},{"style":312},[3725],{"type":172,"value":424},{"type":166,"tag":257,"props":3727,"children":3728},{"class":259,"line":370},[3729,3734,3738,3743,3747,3752,3757,3762],{"type":166,"tag":257,"props":3730,"children":3731},{"style":306},[3732],{"type":172,"value":3733},"    flock",{"type":166,"tag":257,"props":3735,"children":3736},{"style":312},[3737],{"type":172,"value":394},{"type":166,"tag":257,"props":3739,"children":3740},{"style":517},[3741],{"type":172,"value":3742},"fd_dboptions_",{"type":166,"tag":257,"props":3744,"children":3745},{"style":312},[3746],{"type":172,"value":404},{"type":166,"tag":257,"props":3748,"children":3749},{"style":517},[3750],{"type":172,"value":3751}," LOCK_EX ",{"type":166,"tag":257,"props":3753,"children":3754},{"style":436},[3755],{"type":172,"value":3756},"|",{"type":166,"tag":257,"props":3758,"children":3759},{"style":517},[3760],{"type":172,"value":3761}," LOCK_NB",{"type":166,"tag":257,"props":3763,"children":3764},{"style":312},[3765],{"type":172,"value":424},{"type":166,"tag":257,"props":3767,"children":3768},{"class":259,"line":427},[3769,3774,3779,3783,3787,3791,3796,3800,3805],{"type":166,"tag":257,"props":3770,"children":3771},{"style":517},[3772],{"type":172,"value":3773},"    Mmap ",{"type":166,"tag":257,"props":3775,"children":3776},{"style":306},[3777],{"type":172,"value":3778},"mmap",{"type":166,"tag":257,"props":3780,"children":3781},{"style":312},[3782],{"type":172,"value":394},{"type":166,"tag":257,"props":3784,"children":3785},{"style":517},[3786],{"type":172,"value":3690},{"type":166,"tag":257,"props":3788,"children":3789},{"style":312},[3790],{"type":172,"value":404},{"type":166,"tag":257,"props":3792,"children":3793},{"style":338},[3794],{"type":172,"value":3795}," info",{"type":166,"tag":257,"props":3797,"children":3798},{"style":312},[3799],{"type":172,"value":449},{"type":166,"tag":257,"props":3801,"children":3802},{"style":338},[3803],{"type":172,"value":3804},"st_size",{"type":166,"tag":257,"props":3806,"children":3807},{"style":312},[3808],{"type":172,"value":424},{"type":166,"tag":257,"props":3810,"children":3811},{"class":259,"line":462},[3812,3817,3821,3826,3830,3835,3839,3843,3847,3852,3856,3861,3865,3870,3874,3878,3883],{"type":166,"tag":257,"props":3813,"children":3814},{"style":517},[3815],{"type":172,"value":3816},"    Status status_dboptions ",{"type":166,"tag":257,"props":3818,"children":3819},{"style":436},[3820],{"type":172,"value":439},{"type":166,"tag":257,"props":3822,"children":3823},{"style":327},[3824],{"type":172,"value":3825}," DatabaseOptionEncoder",{"type":166,"tag":257,"props":3827,"children":3828},{"style":312},[3829],{"type":172,"value":335},{"type":166,"tag":257,"props":3831,"children":3832},{"style":306},[3833],{"type":172,"value":3834},"DecodeFrom",{"type":166,"tag":257,"props":3836,"children":3837},{"style":312},[3838],{"type":172,"value":394},{"type":166,"tag":257,"props":3840,"children":3841},{"style":338},[3842],{"type":172,"value":3778},{"type":166,"tag":257,"props":3844,"children":3845},{"style":312},[3846],{"type":172,"value":449},{"type":166,"tag":257,"props":3848,"children":3849},{"style":306},[3850],{"type":172,"value":3851},"datafile",{"type":166,"tag":257,"props":3853,"children":3854},{"style":312},[3855],{"type":172,"value":3388},{"type":166,"tag":257,"props":3857,"children":3858},{"style":338},[3859],{"type":172,"value":3860}," mmap",{"type":166,"tag":257,"props":3862,"children":3863},{"style":312},[3864],{"type":172,"value":449},{"type":166,"tag":257,"props":3866,"children":3867},{"style":306},[3868],{"type":172,"value":3869},"filesize",{"type":166,"tag":257,"props":3871,"children":3872},{"style":312},[3873],{"type":172,"value":3388},{"type":166,"tag":257,"props":3875,"children":3876},{"style":436},[3877],{"type":172,"value":892},{"type":166,"tag":257,"props":3879,"children":3880},{"style":517},[3881],{"type":172,"value":3882},"db_options_candidate",{"type":166,"tag":257,"props":3884,"children":3885},{"style":312},[3886],{"type":172,"value":424},{"type":166,"tag":257,"props":3888,"children":3889},{"class":259,"line":504},[3890],{"type":166,"tag":257,"props":3891,"children":3892},{"style":1266},[3893],{"type":172,"value":3894},"    // ...\n",{"type":166,"tag":257,"props":3896,"children":3897},{"class":259,"line":585},[3898,3903,3907,3912,3917],{"type":166,"tag":257,"props":3899,"children":3900},{"style":517},[3901],{"type":172,"value":3902},"    em_ ",{"type":166,"tag":257,"props":3904,"children":3905},{"style":436},[3906],{"type":172,"value":439},{"type":166,"tag":257,"props":3908,"children":3909},{"style":436},[3910],{"type":172,"value":3911}," new",{"type":166,"tag":257,"props":3913,"children":3914},{"style":306},[3915],{"type":172,"value":3916}," EventManager",{"type":166,"tag":257,"props":3918,"children":3919},{"style":312},[3920],{"type":172,"value":459},{"type":166,"tag":257,"props":3922,"children":3923},{"class":259,"line":608},[3924,3929,3933,3937,3942,3946,3951,3955,3960],{"type":166,"tag":257,"props":3925,"children":3926},{"style":517},[3927],{"type":172,"value":3928},"    wb_ ",{"type":166,"tag":257,"props":3930,"children":3931},{"style":436},[3932],{"type":172,"value":439},{"type":166,"tag":257,"props":3934,"children":3935},{"style":436},[3936],{"type":172,"value":3911},{"type":166,"tag":257,"props":3938,"children":3939},{"style":306},[3940],{"type":172,"value":3941}," WriteBuffer",{"type":166,"tag":257,"props":3943,"children":3944},{"style":312},[3945],{"type":172,"value":394},{"type":166,"tag":257,"props":3947,"children":3948},{"style":517},[3949],{"type":172,"value":3950},"db_options_",{"type":166,"tag":257,"props":3952,"children":3953},{"style":312},[3954],{"type":172,"value":404},{"type":166,"tag":257,"props":3956,"children":3957},{"style":517},[3958],{"type":172,"value":3959}," em_",{"type":166,"tag":257,"props":3961,"children":3962},{"style":312},[3963],{"type":172,"value":424},{"type":166,"tag":257,"props":3965,"children":3966},{"class":259,"line":617},[3967,3972,3976,3980,3985,3989,3993,3997,4001,4005,4010],{"type":166,"tag":257,"props":3968,"children":3969},{"style":517},[3970],{"type":172,"value":3971},"    se_ ",{"type":166,"tag":257,"props":3973,"children":3974},{"style":436},[3975],{"type":172,"value":439},{"type":166,"tag":257,"props":3977,"children":3978},{"style":436},[3979],{"type":172,"value":3911},{"type":166,"tag":257,"props":3981,"children":3982},{"style":306},[3983],{"type":172,"value":3984}," StorageEngine",{"type":166,"tag":257,"props":3986,"children":3987},{"style":312},[3988],{"type":172,"value":394},{"type":166,"tag":257,"props":3990,"children":3991},{"style":517},[3992],{"type":172,"value":3950},{"type":166,"tag":257,"props":3994,"children":3995},{"style":312},[3996],{"type":172,"value":404},{"type":166,"tag":257,"props":3998,"children":3999},{"style":517},[4000],{"type":172,"value":3959},{"type":166,"tag":257,"props":4002,"children":4003},{"style":312},[4004],{"type":172,"value":404},{"type":166,"tag":257,"props":4006,"children":4007},{"style":517},[4008],{"type":172,"value":4009}," dbname_",{"type":166,"tag":257,"props":4011,"children":4012},{"style":312},[4013],{"type":172,"value":424},{"type":166,"tag":257,"props":4015,"children":4016},{"class":259,"line":625},[4017,4021,4025,4029,4034,4038],{"type":166,"tag":257,"props":4018,"children":4019},{"style":264},[4020],{"type":172,"value":2497},{"type":166,"tag":257,"props":4022,"children":4023},{"style":327},[4024],{"type":172,"value":3259},{"type":166,"tag":257,"props":4026,"children":4027},{"style":312},[4028],{"type":172,"value":335},{"type":166,"tag":257,"props":4030,"children":4031},{"style":306},[4032],{"type":172,"value":4033},"OK",{"type":166,"tag":257,"props":4035,"children":4036},{"style":312},[4037],{"type":172,"value":1753},{"type":166,"tag":257,"props":4039,"children":4040},{"style":517},[4041],{"type":172,"value":1005},{"type":166,"tag":257,"props":4043,"children":4044},{"class":259,"line":668},[4045],{"type":166,"tag":257,"props":4046,"children":4047},{"style":312},[4048],{"type":172,"value":614},{"type":166,"tag":257,"props":4050,"children":4051},{"class":259,"line":709},[4052,4056,4060,4064,4068,4072],{"type":166,"tag":257,"props":4053,"children":4054},{"style":1764},[4055],{"type":172,"value":3560},{"type":166,"tag":257,"props":4057,"children":4058},{"style":300},[4059],{"type":172,"value":1772},{"type":166,"tag":257,"props":4061,"children":4062},{"style":306},[4063],{"type":172,"value":3578},{"type":166,"tag":257,"props":4065,"children":4066},{"style":312},[4067],{"type":172,"value":315},{"type":166,"tag":257,"props":4069,"children":4070},{"style":1764},[4071],{"type":172,"value":3612},{"type":166,"tag":257,"props":4073,"children":4074},{"style":312},[4075],{"type":172,"value":320},{"type":166,"tag":257,"props":4077,"children":4078},{"class":259,"line":717},[4079,4083,4087,4091,4095,4100],{"type":166,"tag":257,"props":4080,"children":4081},{"style":306},[4082],{"type":172,"value":3733},{"type":166,"tag":257,"props":4084,"children":4085},{"style":312},[4086],{"type":172,"value":394},{"type":166,"tag":257,"props":4088,"children":4089},{"style":517},[4090],{"type":172,"value":3742},{"type":166,"tag":257,"props":4092,"children":4093},{"style":312},[4094],{"type":172,"value":404},{"type":166,"tag":257,"props":4096,"children":4097},{"style":517},[4098],{"type":172,"value":4099}," LOCK_UN",{"type":166,"tag":257,"props":4101,"children":4102},{"style":312},[4103],{"type":172,"value":424},{"type":166,"tag":257,"props":4105,"children":4106},{"class":259,"line":738},[4107,4112,4116,4120],{"type":166,"tag":257,"props":4108,"children":4109},{"style":306},[4110],{"type":172,"value":4111},"    close",{"type":166,"tag":257,"props":4113,"children":4114},{"style":312},[4115],{"type":172,"value":394},{"type":166,"tag":257,"props":4117,"children":4118},{"style":517},[4119],{"type":172,"value":3742},{"type":166,"tag":257,"props":4121,"children":4122},{"style":312},[4123],{"type":172,"value":424},{"type":166,"tag":257,"props":4125,"children":4126},{"class":259,"line":794},[4127,4132,4137,4142],{"type":166,"tag":257,"props":4128,"children":4129},{"style":338},[4130],{"type":172,"value":4131},"    wb_",{"type":166,"tag":257,"props":4133,"children":4134},{"style":312},[4135],{"type":172,"value":4136},"->",{"type":166,"tag":257,"props":4138,"children":4139},{"style":306},[4140],{"type":172,"value":4141},"Close",{"type":166,"tag":257,"props":4143,"children":4144},{"style":312},[4145],{"type":172,"value":459},{"type":166,"tag":257,"props":4147,"children":4148},{"class":259,"line":802},[4149,4154,4158,4162],{"type":166,"tag":257,"props":4150,"children":4151},{"style":338},[4152],{"type":172,"value":4153},"    se_",{"type":166,"tag":257,"props":4155,"children":4156},{"style":312},[4157],{"type":172,"value":4136},{"type":166,"tag":257,"props":4159,"children":4160},{"style":306},[4161],{"type":172,"value":4141},{"type":166,"tag":257,"props":4163,"children":4164},{"style":312},[4165],{"type":172,"value":459},{"type":166,"tag":257,"props":4167,"children":4168},{"class":259,"line":823},[4169,4174,4179],{"type":166,"tag":257,"props":4170,"children":4171},{"style":436},[4172],{"type":172,"value":4173},"    delete",{"type":166,"tag":257,"props":4175,"children":4176},{"style":517},[4177],{"type":172,"value":4178}," wb_",{"type":166,"tag":257,"props":4180,"children":4181},{"style":312},[4182],{"type":172,"value":346},{"type":166,"tag":257,"props":4184,"children":4185},{"class":259,"line":844},[4186,4190,4195],{"type":166,"tag":257,"props":4187,"children":4188},{"style":436},[4189],{"type":172,"value":4173},{"type":166,"tag":257,"props":4191,"children":4192},{"style":517},[4193],{"type":172,"value":4194}," se_",{"type":166,"tag":257,"props":4196,"children":4197},{"style":312},[4198],{"type":172,"value":346},{"type":166,"tag":257,"props":4200,"children":4201},{"class":259,"line":904},[4202,4206,4210],{"type":166,"tag":257,"props":4203,"children":4204},{"style":436},[4205],{"type":172,"value":4173},{"type":166,"tag":257,"props":4207,"children":4208},{"style":517},[4209],{"type":172,"value":3959},{"type":166,"tag":257,"props":4211,"children":4212},{"style":312},[4213],{"type":172,"value":346},{"type":166,"tag":257,"props":4215,"children":4216},{"class":259,"line":968},[4217],{"type":166,"tag":257,"props":4218,"children":4219},{"style":312},[4220],{"type":172,"value":614},{"type":166,"tag":257,"props":4222,"children":4223},{"class":259,"line":1008},[4224],{"type":166,"tag":257,"props":4225,"children":4226},{"style":312},[4227],{"type":172,"value":1103},{"type":166,"tag":180,"props":4229,"children":4230},{},[4231],{"type":172,"value":4232},"因为数据库不能同时关闭或是开启，所以 Open 以及 Close 中都使用了 std::unique_lock 进行锁定。",{"type":166,"tag":246,"props":4234,"children":4236},{"code":4235,"language":249,"meta":160,"className":250,"style":160},"virtual Status Open() override {\n  std::unique_lock\u003Cstd::mutex> lock(mutex_close_);\n}\nvirtual void Close() override {\n  std::unique_lock\u003Cstd::mutex> lock(mutex_close_);\n}\n",[4237],{"type":166,"tag":253,"props":4238,"children":4239},{"__ignoreMap":160},[4240,4267,4322,4329,4356,4407],{"type":166,"tag":257,"props":4241,"children":4242},{"class":259,"line":260},[4243,4247,4251,4255,4259,4263],{"type":166,"tag":257,"props":4244,"children":4245},{"style":1764},[4246],{"type":172,"value":3254},{"type":166,"tag":257,"props":4248,"children":4249},{"style":327},[4250],{"type":172,"value":3259},{"type":166,"tag":257,"props":4252,"children":4253},{"style":306},[4254],{"type":172,"value":3603},{"type":166,"tag":257,"props":4256,"children":4257},{"style":312},[4258],{"type":172,"value":315},{"type":166,"tag":257,"props":4260,"children":4261},{"style":1764},[4262],{"type":172,"value":3612},{"type":166,"tag":257,"props":4264,"children":4265},{"style":312},[4266],{"type":172,"value":320},{"type":166,"tag":257,"props":4268,"children":4269},{"class":259,"line":287},[4270,4274,4278,4283,4287,4291,4295,4300,4304,4309,4313,4318],{"type":166,"tag":257,"props":4271,"children":4272},{"style":327},[4273],{"type":172,"value":631},{"type":166,"tag":257,"props":4275,"children":4276},{"style":312},[4277],{"type":172,"value":335},{"type":166,"tag":257,"props":4279,"children":4280},{"style":338},[4281],{"type":172,"value":4282},"unique_lock",{"type":166,"tag":257,"props":4284,"children":4285},{"style":436},[4286],{"type":172,"value":3036},{"type":166,"tag":257,"props":4288,"children":4289},{"style":327},[4290],{"type":172,"value":2708},{"type":166,"tag":257,"props":4292,"children":4293},{"style":312},[4294],{"type":172,"value":335},{"type":166,"tag":257,"props":4296,"children":4297},{"style":338},[4298],{"type":172,"value":4299},"mutex",{"type":166,"tag":257,"props":4301,"children":4302},{"style":436},[4303],{"type":172,"value":2244},{"type":166,"tag":257,"props":4305,"children":4306},{"style":306},[4307],{"type":172,"value":4308}," lock",{"type":166,"tag":257,"props":4310,"children":4311},{"style":312},[4312],{"type":172,"value":394},{"type":166,"tag":257,"props":4314,"children":4315},{"style":338},[4316],{"type":172,"value":4317},"mutex_close_",{"type":166,"tag":257,"props":4319,"children":4320},{"style":312},[4321],{"type":172,"value":424},{"type":166,"tag":257,"props":4323,"children":4324},{"class":259,"line":296},[4325],{"type":166,"tag":257,"props":4326,"children":4327},{"style":312},[4328],{"type":172,"value":1103},{"type":166,"tag":257,"props":4330,"children":4331},{"class":259,"line":323},[4332,4336,4340,4344,4348,4352],{"type":166,"tag":257,"props":4333,"children":4334},{"style":1764},[4335],{"type":172,"value":3254},{"type":166,"tag":257,"props":4337,"children":4338},{"style":300},[4339],{"type":172,"value":1772},{"type":166,"tag":257,"props":4341,"children":4342},{"style":306},[4343],{"type":172,"value":3578},{"type":166,"tag":257,"props":4345,"children":4346},{"style":312},[4347],{"type":172,"value":315},{"type":166,"tag":257,"props":4349,"children":4350},{"style":1764},[4351],{"type":172,"value":3612},{"type":166,"tag":257,"props":4353,"children":4354},{"style":312},[4355],{"type":172,"value":320},{"type":166,"tag":257,"props":4357,"children":4358},{"class":259,"line":349},[4359,4363,4367,4371,4375,4379,4383,4387,4391,4395,4399,4403],{"type":166,"tag":257,"props":4360,"children":4361},{"style":327},[4362],{"type":172,"value":631},{"type":166,"tag":257,"props":4364,"children":4365},{"style":312},[4366],{"type":172,"value":335},{"type":166,"tag":257,"props":4368,"children":4369},{"style":338},[4370],{"type":172,"value":4282},{"type":166,"tag":257,"props":4372,"children":4373},{"style":436},[4374],{"type":172,"value":3036},{"type":166,"tag":257,"props":4376,"children":4377},{"style":327},[4378],{"type":172,"value":2708},{"type":166,"tag":257,"props":4380,"children":4381},{"style":312},[4382],{"type":172,"value":335},{"type":166,"tag":257,"props":4384,"children":4385},{"style":338},[4386],{"type":172,"value":4299},{"type":166,"tag":257,"props":4388,"children":4389},{"style":436},[4390],{"type":172,"value":2244},{"type":166,"tag":257,"props":4392,"children":4393},{"style":306},[4394],{"type":172,"value":4308},{"type":166,"tag":257,"props":4396,"children":4397},{"style":312},[4398],{"type":172,"value":394},{"type":166,"tag":257,"props":4400,"children":4401},{"style":338},[4402],{"type":172,"value":4317},{"type":166,"tag":257,"props":4404,"children":4405},{"style":312},[4406],{"type":172,"value":424},{"type":166,"tag":257,"props":4408,"children":4409},{"class":259,"line":370},[4410],{"type":166,"tag":257,"props":4411,"children":4412},{"style":312},[4413],{"type":172,"value":1103},{"type":166,"tag":174,"props":4415,"children":4416},{"id":3232},[4417],{"type":172,"value":3232},{"type":166,"tag":180,"props":4419,"children":4420},{},[4421],{"type":172,"value":4422},"代码没有使用 C++ 风格的异常捕获，取而代之的是设计了状态类 Status。就像 kingdb_user 示例展示的，所有数据库操作都会返回一个状态实例，通过调用其 IsOK 方法，调用者可以判断处出操作有没有成功；如果失败了，可以使用 ToString 方法把出错原因输出。尽管这种设计会带来额外的内存开销，且使每次调用都带来轻微的性能消耗，不过这种消耗可以避免魔法数值，它将错误码和核心解耦，使代码有更佳的可读性。",{"type":166,"tag":246,"props":4424,"children":4426},{"code":4425,"language":249,"meta":160,"className":250,"style":160},"class Status {\n  // ...\n  static Status OK() { return Status(); }\n  bool IsOK() const { return (code_ == kOK); }\n  // ...\n  enum Code {\n    kOK = 0, \n    kNotFound = 1,\n    kDeleteOrder = 2,\n    kInvalidArgument = 3,\n    kIOError = 4,\n    kDone = 5,\n    kMultipartRequired = 6\n  };\n  // ...\n}\nstd::string Status::ToString() const {\n  if (message1_ == \"\") {\n    return \"OK\";\n  } else {\n    char tmp[30];\n    const char* type;\n    switch (code()) {\n      case kOK:\n        type = \"OK\";\n        break;\n      // ...\n    }\n    // ...\n    return result;\n  }\n}\n",[4427],{"type":166,"tag":253,"props":4428,"children":4429},{"__ignoreMap":160},[4430,4445,4452,4493,4548,4555,4572,4597,4618,4639,4660,4681,4702,4719,4727,4734,4741,4780,4813,4836,4851,4877,4904,4928,4945,4973,4985,4993,5001,5008,5025,5033],{"type":166,"tag":257,"props":4431,"children":4432},{"class":259,"line":260},[4433,4437,4441],{"type":166,"tag":257,"props":4434,"children":4435},{"style":300},[4436],{"type":172,"value":1677},{"type":166,"tag":257,"props":4438,"children":4439},{"style":327},[4440],{"type":172,"value":3259},{"type":166,"tag":257,"props":4442,"children":4443},{"style":312},[4444],{"type":172,"value":320},{"type":166,"tag":257,"props":4446,"children":4447},{"class":259,"line":287},[4448],{"type":166,"tag":257,"props":4449,"children":4450},{"style":1266},[4451],{"type":172,"value":1622},{"type":166,"tag":257,"props":4453,"children":4454},{"class":259,"line":296},[4455,4459,4463,4468,4472,4476,4481,4485,4489],{"type":166,"tag":257,"props":4456,"children":4457},{"style":1764},[4458],{"type":172,"value":1767},{"type":166,"tag":257,"props":4460,"children":4461},{"style":327},[4462],{"type":172,"value":3259},{"type":166,"tag":257,"props":4464,"children":4465},{"style":306},[4466],{"type":172,"value":4467}," OK",{"type":166,"tag":257,"props":4469,"children":4470},{"style":312},[4471],{"type":172,"value":315},{"type":166,"tag":257,"props":4473,"children":4474},{"style":312},[4475],{"type":172,"value":1786},{"type":166,"tag":257,"props":4477,"children":4478},{"style":264},[4479],{"type":172,"value":4480}," return",{"type":166,"tag":257,"props":4482,"children":4483},{"style":306},[4484],{"type":172,"value":3259},{"type":166,"tag":257,"props":4486,"children":4487},{"style":312},[4488],{"type":172,"value":1753},{"type":166,"tag":257,"props":4490,"children":4491},{"style":312},[4492],{"type":172,"value":3587},{"type":166,"tag":257,"props":4494,"children":4495},{"class":259,"line":323},[4496,4501,4506,4510,4514,4518,4522,4526,4531,4535,4540,4544],{"type":166,"tag":257,"props":4497,"children":4498},{"style":300},[4499],{"type":172,"value":4500},"  bool",{"type":166,"tag":257,"props":4502,"children":4503},{"style":306},[4504],{"type":172,"value":4505}," IsOK",{"type":166,"tag":257,"props":4507,"children":4508},{"style":312},[4509],{"type":172,"value":315},{"type":166,"tag":257,"props":4511,"children":4512},{"style":1764},[4513],{"type":172,"value":2298},{"type":166,"tag":257,"props":4515,"children":4516},{"style":312},[4517],{"type":172,"value":1786},{"type":166,"tag":257,"props":4519,"children":4520},{"style":264},[4521],{"type":172,"value":4480},{"type":166,"tag":257,"props":4523,"children":4524},{"style":312},[4525],{"type":172,"value":473},{"type":166,"tag":257,"props":4527,"children":4528},{"style":517},[4529],{"type":172,"value":4530},"code_ ",{"type":166,"tag":257,"props":4532,"children":4533},{"style":436},[4534],{"type":172,"value":944},{"type":166,"tag":257,"props":4536,"children":4537},{"style":517},[4538],{"type":172,"value":4539}," kOK",{"type":166,"tag":257,"props":4541,"children":4542},{"style":312},[4543],{"type":172,"value":1000},{"type":166,"tag":257,"props":4545,"children":4546},{"style":312},[4547],{"type":172,"value":3587},{"type":166,"tag":257,"props":4549,"children":4550},{"class":259,"line":349},[4551],{"type":166,"tag":257,"props":4552,"children":4553},{"style":1266},[4554],{"type":172,"value":1622},{"type":166,"tag":257,"props":4556,"children":4557},{"class":259,"line":370},[4558,4563,4568],{"type":166,"tag":257,"props":4559,"children":4560},{"style":300},[4561],{"type":172,"value":4562},"  enum",{"type":166,"tag":257,"props":4564,"children":4565},{"style":327},[4566],{"type":172,"value":4567}," Code",{"type":166,"tag":257,"props":4569,"children":4570},{"style":312},[4571],{"type":172,"value":320},{"type":166,"tag":257,"props":4573,"children":4574},{"class":259,"line":427},[4575,4581,4585,4589,4593],{"type":166,"tag":257,"props":4576,"children":4578},{"style":4577},"--shiki-light:#90A4AE;--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#F8F8F2",[4579],{"type":172,"value":4580},"    kOK",{"type":166,"tag":257,"props":4582,"children":4583},{"style":436},[4584],{"type":172,"value":1923},{"type":166,"tag":257,"props":4586,"children":4587},{"style":598},[4588],{"type":172,"value":1090},{"type":166,"tag":257,"props":4590,"children":4591},{"style":312},[4592],{"type":172,"value":404},{"type":166,"tag":257,"props":4594,"children":4595},{"style":517},[4596],{"type":172,"value":1005},{"type":166,"tag":257,"props":4598,"children":4599},{"class":259,"line":462},[4600,4605,4609,4613],{"type":166,"tag":257,"props":4601,"children":4602},{"style":4577},[4603],{"type":172,"value":4604},"    kNotFound",{"type":166,"tag":257,"props":4606,"children":4607},{"style":436},[4608],{"type":172,"value":1923},{"type":166,"tag":257,"props":4610,"children":4611},{"style":598},[4612],{"type":172,"value":2815},{"type":166,"tag":257,"props":4614,"children":4615},{"style":312},[4616],{"type":172,"value":4617},",\n",{"type":166,"tag":257,"props":4619,"children":4620},{"class":259,"line":504},[4621,4626,4630,4635],{"type":166,"tag":257,"props":4622,"children":4623},{"style":4577},[4624],{"type":172,"value":4625},"    kDeleteOrder",{"type":166,"tag":257,"props":4627,"children":4628},{"style":436},[4629],{"type":172,"value":1923},{"type":166,"tag":257,"props":4631,"children":4632},{"style":598},[4633],{"type":172,"value":4634}," 2",{"type":166,"tag":257,"props":4636,"children":4637},{"style":312},[4638],{"type":172,"value":4617},{"type":166,"tag":257,"props":4640,"children":4641},{"class":259,"line":585},[4642,4647,4651,4656],{"type":166,"tag":257,"props":4643,"children":4644},{"style":4577},[4645],{"type":172,"value":4646},"    kInvalidArgument",{"type":166,"tag":257,"props":4648,"children":4649},{"style":436},[4650],{"type":172,"value":1923},{"type":166,"tag":257,"props":4652,"children":4653},{"style":598},[4654],{"type":172,"value":4655}," 3",{"type":166,"tag":257,"props":4657,"children":4658},{"style":312},[4659],{"type":172,"value":4617},{"type":166,"tag":257,"props":4661,"children":4662},{"class":259,"line":608},[4663,4668,4672,4677],{"type":166,"tag":257,"props":4664,"children":4665},{"style":4577},[4666],{"type":172,"value":4667},"    kIOError",{"type":166,"tag":257,"props":4669,"children":4670},{"style":436},[4671],{"type":172,"value":1923},{"type":166,"tag":257,"props":4673,"children":4674},{"style":598},[4675],{"type":172,"value":4676}," 4",{"type":166,"tag":257,"props":4678,"children":4679},{"style":312},[4680],{"type":172,"value":4617},{"type":166,"tag":257,"props":4682,"children":4683},{"class":259,"line":617},[4684,4689,4693,4698],{"type":166,"tag":257,"props":4685,"children":4686},{"style":4577},[4687],{"type":172,"value":4688},"    kDone",{"type":166,"tag":257,"props":4690,"children":4691},{"style":436},[4692],{"type":172,"value":1923},{"type":166,"tag":257,"props":4694,"children":4695},{"style":598},[4696],{"type":172,"value":4697}," 5",{"type":166,"tag":257,"props":4699,"children":4700},{"style":312},[4701],{"type":172,"value":4617},{"type":166,"tag":257,"props":4703,"children":4704},{"class":259,"line":625},[4705,4710,4714],{"type":166,"tag":257,"props":4706,"children":4707},{"style":4577},[4708],{"type":172,"value":4709},"    kMultipartRequired",{"type":166,"tag":257,"props":4711,"children":4712},{"style":436},[4713],{"type":172,"value":1923},{"type":166,"tag":257,"props":4715,"children":4716},{"style":598},[4717],{"type":172,"value":4718}," 6\n",{"type":166,"tag":257,"props":4720,"children":4721},{"class":259,"line":668},[4722],{"type":166,"tag":257,"props":4723,"children":4724},{"style":312},[4725],{"type":172,"value":4726},"  };\n",{"type":166,"tag":257,"props":4728,"children":4729},{"class":259,"line":709},[4730],{"type":166,"tag":257,"props":4731,"children":4732},{"style":1266},[4733],{"type":172,"value":1622},{"type":166,"tag":257,"props":4735,"children":4736},{"class":259,"line":717},[4737],{"type":166,"tag":257,"props":4738,"children":4739},{"style":312},[4740],{"type":172,"value":1103},{"type":166,"tag":257,"props":4742,"children":4743},{"class":259,"line":738},[4744,4748,4752,4756,4760,4764,4768,4772,4776],{"type":166,"tag":257,"props":4745,"children":4746},{"style":327},[4747],{"type":172,"value":2708},{"type":166,"tag":257,"props":4749,"children":4750},{"style":312},[4751],{"type":172,"value":335},{"type":166,"tag":257,"props":4753,"children":4754},{"style":327},[4755],{"type":172,"value":3303},{"type":166,"tag":257,"props":4757,"children":4758},{"style":327},[4759],{"type":172,"value":3259},{"type":166,"tag":257,"props":4761,"children":4762},{"style":312},[4763],{"type":172,"value":335},{"type":166,"tag":257,"props":4765,"children":4766},{"style":306},[4767],{"type":172,"value":567},{"type":166,"tag":257,"props":4769,"children":4770},{"style":312},[4771],{"type":172,"value":315},{"type":166,"tag":257,"props":4773,"children":4774},{"style":1764},[4775],{"type":172,"value":2298},{"type":166,"tag":257,"props":4777,"children":4778},{"style":312},[4779],{"type":172,"value":320},{"type":166,"tag":257,"props":4781,"children":4782},{"class":259,"line":794},[4783,4787,4791,4796,4800,4805,4809],{"type":166,"tag":257,"props":4784,"children":4785},{"style":264},[4786],{"type":172,"value":468},{"type":166,"tag":257,"props":4788,"children":4789},{"style":312},[4790],{"type":172,"value":473},{"type":166,"tag":257,"props":4792,"children":4793},{"style":517},[4794],{"type":172,"value":4795},"message1_ ",{"type":166,"tag":257,"props":4797,"children":4798},{"style":436},[4799],{"type":172,"value":944},{"type":166,"tag":257,"props":4801,"children":4802},{"style":270},[4803],{"type":172,"value":4804}," \"\"",{"type":166,"tag":257,"props":4806,"children":4807},{"style":312},[4808],{"type":172,"value":961},{"type":166,"tag":257,"props":4810,"children":4811},{"style":312},[4812],{"type":172,"value":320},{"type":166,"tag":257,"props":4814,"children":4815},{"class":259,"line":802},[4816,4820,4824,4828,4832],{"type":166,"tag":257,"props":4817,"children":4818},{"style":264},[4819],{"type":172,"value":2497},{"type":166,"tag":257,"props":4821,"children":4822},{"style":270},[4823],{"type":172,"value":409},{"type":166,"tag":257,"props":4825,"children":4826},{"style":276},[4827],{"type":172,"value":4033},{"type":166,"tag":257,"props":4829,"children":4830},{"style":270},[4831],{"type":172,"value":419},{"type":166,"tag":257,"props":4833,"children":4834},{"style":312},[4835],{"type":172,"value":346},{"type":166,"tag":257,"props":4837,"children":4838},{"class":259,"line":823},[4839,4843,4847],{"type":166,"tag":257,"props":4840,"children":4841},{"style":312},[4842],{"type":172,"value":1014},{"type":166,"tag":257,"props":4844,"children":4845},{"style":264},[4846],{"type":172,"value":1019},{"type":166,"tag":257,"props":4848,"children":4849},{"style":312},[4850],{"type":172,"value":320},{"type":166,"tag":257,"props":4852,"children":4853},{"class":259,"line":844},[4854,4859,4864,4868,4873],{"type":166,"tag":257,"props":4855,"children":4856},{"style":300},[4857],{"type":172,"value":4858},"    char",{"type":166,"tag":257,"props":4860,"children":4861},{"style":338},[4862],{"type":172,"value":4863}," tmp",{"type":166,"tag":257,"props":4865,"children":4866},{"style":312},[4867],{"type":172,"value":1233},{"type":166,"tag":257,"props":4869,"children":4870},{"style":598},[4871],{"type":172,"value":4872},"30",{"type":166,"tag":257,"props":4874,"children":4875},{"style":312},[4876],{"type":172,"value":1243},{"type":166,"tag":257,"props":4878,"children":4879},{"class":259,"line":904},[4880,4885,4890,4895,4900],{"type":166,"tag":257,"props":4881,"children":4882},{"style":1764},[4883],{"type":172,"value":4884},"    const",{"type":166,"tag":257,"props":4886,"children":4887},{"style":300},[4888],{"type":172,"value":4889}," char",{"type":166,"tag":257,"props":4891,"children":4892},{"style":436},[4893],{"type":172,"value":4894},"*",{"type":166,"tag":257,"props":4896,"children":4897},{"style":517},[4898],{"type":172,"value":4899}," type",{"type":166,"tag":257,"props":4901,"children":4902},{"style":312},[4903],{"type":172,"value":346},{"type":166,"tag":257,"props":4905,"children":4906},{"class":259,"line":968},[4907,4912,4916,4920,4924],{"type":166,"tag":257,"props":4908,"children":4909},{"style":264},[4910],{"type":172,"value":4911},"    switch",{"type":166,"tag":257,"props":4913,"children":4914},{"style":312},[4915],{"type":172,"value":473},{"type":166,"tag":257,"props":4917,"children":4918},{"style":306},[4919],{"type":172,"value":253},{"type":166,"tag":257,"props":4921,"children":4922},{"style":312},[4923],{"type":172,"value":497},{"type":166,"tag":257,"props":4925,"children":4926},{"style":312},[4927],{"type":172,"value":320},{"type":166,"tag":257,"props":4929,"children":4930},{"class":259,"line":1008},[4931,4936,4940],{"type":166,"tag":257,"props":4932,"children":4933},{"style":264},[4934],{"type":172,"value":4935},"      case",{"type":166,"tag":257,"props":4937,"children":4938},{"style":517},[4939],{"type":172,"value":4539},{"type":166,"tag":257,"props":4941,"children":4942},{"style":312},[4943],{"type":172,"value":4944},":\n",{"type":166,"tag":257,"props":4946,"children":4947},{"class":259,"line":1026},[4948,4953,4957,4961,4965,4969],{"type":166,"tag":257,"props":4949,"children":4950},{"style":517},[4951],{"type":172,"value":4952},"        type ",{"type":166,"tag":257,"props":4954,"children":4955},{"style":436},[4956],{"type":172,"value":439},{"type":166,"tag":257,"props":4958,"children":4959},{"style":270},[4960],{"type":172,"value":409},{"type":166,"tag":257,"props":4962,"children":4963},{"style":276},[4964],{"type":172,"value":4033},{"type":166,"tag":257,"props":4966,"children":4967},{"style":270},[4968],{"type":172,"value":419},{"type":166,"tag":257,"props":4970,"children":4971},{"style":312},[4972],{"type":172,"value":346},{"type":166,"tag":257,"props":4974,"children":4975},{"class":259,"line":1063},[4976,4981],{"type":166,"tag":257,"props":4977,"children":4978},{"style":264},[4979],{"type":172,"value":4980},"        break",{"type":166,"tag":257,"props":4982,"children":4983},{"style":312},[4984],{"type":172,"value":346},{"type":166,"tag":257,"props":4986,"children":4987},{"class":259,"line":1071},[4988],{"type":166,"tag":257,"props":4989,"children":4990},{"style":1266},[4991],{"type":172,"value":4992},"      // ...\n",{"type":166,"tag":257,"props":4994,"children":4995},{"class":259,"line":1079},[4996],{"type":166,"tag":257,"props":4997,"children":4998},{"style":312},[4999],{"type":172,"value":5000},"    }\n",{"type":166,"tag":257,"props":5002,"children":5003},{"class":259,"line":1097},[5004],{"type":166,"tag":257,"props":5005,"children":5006},{"style":1266},[5007],{"type":172,"value":3894},{"type":166,"tag":257,"props":5009,"children":5011},{"class":259,"line":5010},30,[5012,5016,5021],{"type":166,"tag":257,"props":5013,"children":5014},{"style":264},[5015],{"type":172,"value":2497},{"type":166,"tag":257,"props":5017,"children":5018},{"style":517},[5019],{"type":172,"value":5020}," result",{"type":166,"tag":257,"props":5022,"children":5023},{"style":312},[5024],{"type":172,"value":346},{"type":166,"tag":257,"props":5026,"children":5028},{"class":259,"line":5027},31,[5029],{"type":166,"tag":257,"props":5030,"children":5031},{"style":312},[5032],{"type":172,"value":614},{"type":166,"tag":257,"props":5034,"children":5036},{"class":259,"line":5035},32,[5037],{"type":166,"tag":257,"props":5038,"children":5039},{"style":312},[5040],{"type":172,"value":1103},{"type":166,"tag":180,"props":5042,"children":5043},{},[5044],{"type":172,"value":5045},"KDB 内部代码出现异常时会使用日志将其记录下来。如果没有日志，那么在排查代码问题时简直就是噩梦。KDB 有两套日志的输出目标，分别是系统输出和标准输出设备。日志类记录输出目标、日志级别、线程锁等成员，并通过静态方法 Logv 实现记录日志。锁的最大用处是保证记录顺序。仅有当出现最高级别的日志（kLogLevelEMERG）时，才会跳过锁直接写入。出现 kLogLevelEMERG 时意味着程序遇到了紧急问题，通常会直接退出或是返回 Status 异常，所以这个时候需要及时记录。",{"type":166,"tag":180,"props":5047,"children":5048},{},[5049],{"type":172,"value":5050},"日志级别的划分参考了 Syslog：",{"type":166,"tag":207,"props":5052,"children":5053},{},[5054,5059,5064,5069,5074,5079,5084,5089,5094,5099],{"type":166,"tag":211,"props":5055,"children":5056},{},[5057],{"type":172,"value":5058},"silent: all logging is turned off",{"type":166,"tag":211,"props":5060,"children":5061},{},[5062],{"type":172,"value":5063},"emerg: system is unusable, imminent crash",{"type":166,"tag":211,"props":5065,"children":5066},{},[5067],{"type":172,"value":5068},"alert: error event, immediate action required",{"type":166,"tag":211,"props":5070,"children":5071},{},[5072],{"type":172,"value":5073},"crit: error event, immediate action required",{"type":166,"tag":211,"props":5075,"children":5076},{},[5077],{"type":172,"value":5078},"error: error event, action is required but is not urgent",{"type":166,"tag":211,"props":5080,"children":5081},{},[5082],{"type":172,"value":5083},"warn: events that can be harmful if no action is taken",{"type":166,"tag":211,"props":5085,"children":5086},{},[5087],{"type":172,"value":5088},"notice: unusual events, but no immediate action required",{"type":166,"tag":211,"props":5090,"children":5091},{},[5092],{"type":172,"value":5093},"info: normal operation events, no action required",{"type":166,"tag":211,"props":5095,"children":5096},{},[5097],{"type":172,"value":5098},"debug: events used for debugging, no action required",{"type":166,"tag":211,"props":5100,"children":5101},{},[5102],{"type":172,"value":5103},"trace: fine-grained events used for debugging, no action required",{"type":166,"tag":1133,"props":5105,"children":5107},{"id":5106},"日志调用用宏还是函数",[5108],{"type":172,"value":5106},{"type":166,"tag":180,"props":5110,"children":5111},{},[5112,5114,5120,5122,5126],{"type":172,"value":5113},"原先的提交中，日志调用被定义在了宏里，直接调用 Logger::Logv 去记录。日志宏中使用子宏 ",{"type":166,"tag":5115,"props":5116,"children":5117},"strong",{},[5118],{"type":172,"value":5119},"VA_ARGS",{"type":172,"value":5121}," 来记录可变参数。",{"type":166,"tag":5115,"props":5123,"children":5124},{},[5125],{"type":172,"value":5119},{"type":172,"value":5127}," 前面有标记黏贴运算符的原因是当日志宏的可变参数为空时，可以把末尾的逗号去掉。",{"type":166,"tag":246,"props":5129,"children":5131},{"code":5130,"language":249,"meta":160,"className":250,"style":160},"class log {\n  static void emerg(const char* logname, const char* format, ...) {\n    va_list args;\n    va_start(args, format);\n    Logger::Logv(false, Logger::kLogLevelEMERG, LOG_EMERG, logname, format, args);\n    va_end(args);\n  }\n}\n// ...\n#define LOG_EMERG(logname, fmt, ...) \\\n        Logger::Logv(false, Logger::kLogLevelEMERG, logname, fmt, ##__VA_ARGS__)\n",[5132],{"type":166,"tag":253,"props":5133,"children":5134},{"__ignoreMap":160},[5135,5151,5226,5238,5267,5349,5369,5376,5383,5390,5432],{"type":166,"tag":257,"props":5136,"children":5137},{"class":259,"line":260},[5138,5142,5147],{"type":166,"tag":257,"props":5139,"children":5140},{"style":300},[5141],{"type":172,"value":1677},{"type":166,"tag":257,"props":5143,"children":5144},{"style":327},[5145],{"type":172,"value":5146}," log",{"type":166,"tag":257,"props":5148,"children":5149},{"style":312},[5150],{"type":172,"value":320},{"type":166,"tag":257,"props":5152,"children":5153},{"class":259,"line":287},[5154,5158,5162,5167,5171,5175,5179,5183,5188,5192,5196,5200,5204,5209,5213,5218,5222],{"type":166,"tag":257,"props":5155,"children":5156},{"style":1764},[5157],{"type":172,"value":1767},{"type":166,"tag":257,"props":5159,"children":5160},{"style":300},[5161],{"type":172,"value":1772},{"type":166,"tag":257,"props":5163,"children":5164},{"style":306},[5165],{"type":172,"value":5166}," emerg",{"type":166,"tag":257,"props":5168,"children":5169},{"style":312},[5170],{"type":172,"value":394},{"type":166,"tag":257,"props":5172,"children":5173},{"style":1764},[5174],{"type":172,"value":2276},{"type":166,"tag":257,"props":5176,"children":5177},{"style":300},[5178],{"type":172,"value":4889},{"type":166,"tag":257,"props":5180,"children":5181},{"style":1764},[5182],{"type":172,"value":4894},{"type":166,"tag":257,"props":5184,"children":5185},{"style":1173},[5186],{"type":172,"value":5187}," logname",{"type":166,"tag":257,"props":5189,"children":5190},{"style":312},[5191],{"type":172,"value":404},{"type":166,"tag":257,"props":5193,"children":5194},{"style":1764},[5195],{"type":172,"value":2298},{"type":166,"tag":257,"props":5197,"children":5198},{"style":300},[5199],{"type":172,"value":4889},{"type":166,"tag":257,"props":5201,"children":5202},{"style":1764},[5203],{"type":172,"value":4894},{"type":166,"tag":257,"props":5205,"children":5206},{"style":1173},[5207],{"type":172,"value":5208}," format",{"type":166,"tag":257,"props":5210,"children":5211},{"style":312},[5212],{"type":172,"value":404},{"type":166,"tag":257,"props":5214,"children":5215},{"style":517},[5216],{"type":172,"value":5217}," ...",{"type":166,"tag":257,"props":5219,"children":5220},{"style":312},[5221],{"type":172,"value":961},{"type":166,"tag":257,"props":5223,"children":5224},{"style":312},[5225],{"type":172,"value":320},{"type":166,"tag":257,"props":5227,"children":5228},{"class":259,"line":296},[5229,5234],{"type":166,"tag":257,"props":5230,"children":5231},{"style":517},[5232],{"type":172,"value":5233},"    va_list args",{"type":166,"tag":257,"props":5235,"children":5236},{"style":312},[5237],{"type":172,"value":346},{"type":166,"tag":257,"props":5239,"children":5240},{"class":259,"line":323},[5241,5246,5250,5255,5259,5263],{"type":166,"tag":257,"props":5242,"children":5243},{"style":306},[5244],{"type":172,"value":5245},"    va_start",{"type":166,"tag":257,"props":5247,"children":5248},{"style":312},[5249],{"type":172,"value":394},{"type":166,"tag":257,"props":5251,"children":5252},{"style":517},[5253],{"type":172,"value":5254},"args",{"type":166,"tag":257,"props":5256,"children":5257},{"style":312},[5258],{"type":172,"value":404},{"type":166,"tag":257,"props":5260,"children":5261},{"style":517},[5262],{"type":172,"value":5208},{"type":166,"tag":257,"props":5264,"children":5265},{"style":312},[5266],{"type":172,"value":424},{"type":166,"tag":257,"props":5268,"children":5269},{"class":259,"line":349},[5270,5275,5279,5284,5288,5293,5297,5302,5306,5311,5315,5320,5324,5328,5332,5336,5340,5345],{"type":166,"tag":257,"props":5271,"children":5272},{"style":327},[5273],{"type":172,"value":5274},"    Logger",{"type":166,"tag":257,"props":5276,"children":5277},{"style":312},[5278],{"type":172,"value":335},{"type":166,"tag":257,"props":5280,"children":5281},{"style":306},[5282],{"type":172,"value":5283},"Logv",{"type":166,"tag":257,"props":5285,"children":5286},{"style":312},[5287],{"type":172,"value":394},{"type":166,"tag":257,"props":5289,"children":5290},{"style":2464},[5291],{"type":172,"value":5292},"false",{"type":166,"tag":257,"props":5294,"children":5295},{"style":312},[5296],{"type":172,"value":404},{"type":166,"tag":257,"props":5298,"children":5299},{"style":327},[5300],{"type":172,"value":5301}," Logger",{"type":166,"tag":257,"props":5303,"children":5304},{"style":312},[5305],{"type":172,"value":335},{"type":166,"tag":257,"props":5307,"children":5308},{"style":517},[5309],{"type":172,"value":5310},"kLogLevelEMERG",{"type":166,"tag":257,"props":5312,"children":5313},{"style":312},[5314],{"type":172,"value":404},{"type":166,"tag":257,"props":5316,"children":5317},{"style":517},[5318],{"type":172,"value":5319}," LOG_EMERG",{"type":166,"tag":257,"props":5321,"children":5322},{"style":312},[5323],{"type":172,"value":404},{"type":166,"tag":257,"props":5325,"children":5326},{"style":517},[5327],{"type":172,"value":5187},{"type":166,"tag":257,"props":5329,"children":5330},{"style":312},[5331],{"type":172,"value":404},{"type":166,"tag":257,"props":5333,"children":5334},{"style":517},[5335],{"type":172,"value":5208},{"type":166,"tag":257,"props":5337,"children":5338},{"style":312},[5339],{"type":172,"value":404},{"type":166,"tag":257,"props":5341,"children":5342},{"style":517},[5343],{"type":172,"value":5344}," args",{"type":166,"tag":257,"props":5346,"children":5347},{"style":312},[5348],{"type":172,"value":424},{"type":166,"tag":257,"props":5350,"children":5351},{"class":259,"line":370},[5352,5357,5361,5365],{"type":166,"tag":257,"props":5353,"children":5354},{"style":306},[5355],{"type":172,"value":5356},"    va_end",{"type":166,"tag":257,"props":5358,"children":5359},{"style":312},[5360],{"type":172,"value":394},{"type":166,"tag":257,"props":5362,"children":5363},{"style":517},[5364],{"type":172,"value":5254},{"type":166,"tag":257,"props":5366,"children":5367},{"style":312},[5368],{"type":172,"value":424},{"type":166,"tag":257,"props":5370,"children":5371},{"class":259,"line":427},[5372],{"type":166,"tag":257,"props":5373,"children":5374},{"style":312},[5375],{"type":172,"value":614},{"type":166,"tag":257,"props":5377,"children":5378},{"class":259,"line":462},[5379],{"type":166,"tag":257,"props":5380,"children":5381},{"style":312},[5382],{"type":172,"value":1103},{"type":166,"tag":257,"props":5384,"children":5385},{"class":259,"line":504},[5386],{"type":166,"tag":257,"props":5387,"children":5388},{"style":1266},[5389],{"type":172,"value":3078},{"type":166,"tag":257,"props":5391,"children":5392},{"class":259,"line":585},[5393,5397,5401,5405,5410,5414,5419,5423,5428],{"type":166,"tag":257,"props":5394,"children":5395},{"style":264},[5396],{"type":172,"value":1637},{"type":166,"tag":257,"props":5398,"children":5399},{"style":306},[5400],{"type":172,"value":5319},{"type":166,"tag":257,"props":5402,"children":5403},{"style":312},[5404],{"type":172,"value":394},{"type":166,"tag":257,"props":5406,"children":5407},{"style":1173},[5408],{"type":172,"value":5409},"logname",{"type":166,"tag":257,"props":5411,"children":5412},{"style":312},[5413],{"type":172,"value":404},{"type":166,"tag":257,"props":5415,"children":5416},{"style":1173},[5417],{"type":172,"value":5418}," fmt",{"type":166,"tag":257,"props":5420,"children":5421},{"style":312},[5422],{"type":172,"value":404},{"type":166,"tag":257,"props":5424,"children":5425},{"style":312},[5426],{"type":172,"value":5427}," ...)",{"type":166,"tag":257,"props":5429,"children":5430},{"style":542},[5431],{"type":172,"value":2023},{"type":166,"tag":257,"props":5433,"children":5434},{"class":259,"line":608},[5435,5440,5444,5448,5452,5456,5460,5464,5468,5472,5476,5480,5484,5488,5492,5497],{"type":166,"tag":257,"props":5436,"children":5437},{"style":327},[5438],{"type":172,"value":5439},"        Logger",{"type":166,"tag":257,"props":5441,"children":5442},{"style":312},[5443],{"type":172,"value":335},{"type":166,"tag":257,"props":5445,"children":5446},{"style":306},[5447],{"type":172,"value":5283},{"type":166,"tag":257,"props":5449,"children":5450},{"style":312},[5451],{"type":172,"value":394},{"type":166,"tag":257,"props":5453,"children":5454},{"style":2464},[5455],{"type":172,"value":5292},{"type":166,"tag":257,"props":5457,"children":5458},{"style":312},[5459],{"type":172,"value":404},{"type":166,"tag":257,"props":5461,"children":5462},{"style":327},[5463],{"type":172,"value":5301},{"type":166,"tag":257,"props":5465,"children":5466},{"style":312},[5467],{"type":172,"value":335},{"type":166,"tag":257,"props":5469,"children":5470},{"style":517},[5471],{"type":172,"value":5310},{"type":166,"tag":257,"props":5473,"children":5474},{"style":312},[5475],{"type":172,"value":404},{"type":166,"tag":257,"props":5477,"children":5478},{"style":517},[5479],{"type":172,"value":5187},{"type":166,"tag":257,"props":5481,"children":5482},{"style":312},[5483],{"type":172,"value":404},{"type":166,"tag":257,"props":5485,"children":5486},{"style":517},[5487],{"type":172,"value":5418},{"type":166,"tag":257,"props":5489,"children":5490},{"style":312},[5491],{"type":172,"value":404},{"type":166,"tag":257,"props":5493,"children":5494},{"style":338},[5495],{"type":172,"value":5496}," ##__VA_ARGS__",{"type":166,"tag":257,"props":5498,"children":5499},{"style":312},[5500],{"type":172,"value":2093},{"type":166,"tag":180,"props":5502,"children":5503},{},[5504],{"type":172,"value":5505},"尚不清楚为什么不用宏，而是使用运行时的方法调用（即 log 的 public 方法）。猜测可能是因为宏不能跨行？因为我看到了这种很长的调用。",{"type":166,"tag":246,"props":5507,"children":5509},{"code":5508,"language":249,"meta":160,"className":250,"style":160},"log::trace(\n  \"Database::PutPartValidSize()\",\n  \"[%s] size_chunk:%\" PRIu64 \" offset_chunk:%\" PRIu64,\n  key.ToString().c_str(),\n  chunk.size(),\n  offset_chunk\n);\n",[5510],{"type":166,"tag":253,"props":5511,"children":5512},{"__ignoreMap":160},[5513,5535,5556,5607,5636,5656,5664],{"type":166,"tag":257,"props":5514,"children":5515},{"class":259,"line":260},[5516,5521,5525,5530],{"type":166,"tag":257,"props":5517,"children":5518},{"style":327},[5519],{"type":172,"value":5520},"log",{"type":166,"tag":257,"props":5522,"children":5523},{"style":312},[5524],{"type":172,"value":335},{"type":166,"tag":257,"props":5526,"children":5527},{"style":306},[5528],{"type":172,"value":5529},"trace",{"type":166,"tag":257,"props":5531,"children":5532},{"style":312},[5533],{"type":172,"value":5534},"(\n",{"type":166,"tag":257,"props":5536,"children":5537},{"class":259,"line":287},[5538,5543,5548,5552],{"type":166,"tag":257,"props":5539,"children":5540},{"style":270},[5541],{"type":172,"value":5542},"  \"",{"type":166,"tag":257,"props":5544,"children":5545},{"style":276},[5546],{"type":172,"value":5547},"Database::PutPartValidSize()",{"type":166,"tag":257,"props":5549,"children":5550},{"style":270},[5551],{"type":172,"value":419},{"type":166,"tag":257,"props":5553,"children":5554},{"style":312},[5555],{"type":172,"value":4617},{"type":166,"tag":257,"props":5557,"children":5558},{"class":259,"line":296},[5559,5563,5567,5571,5576,5580,5585,5589,5594,5598,5603],{"type":166,"tag":257,"props":5560,"children":5561},{"style":270},[5562],{"type":172,"value":5542},{"type":166,"tag":257,"props":5564,"children":5565},{"style":276},[5566],{"type":172,"value":1233},{"type":166,"tag":257,"props":5568,"children":5569},{"style":536},[5570],{"type":172,"value":539},{"type":166,"tag":257,"props":5572,"children":5573},{"style":276},[5574],{"type":172,"value":5575},"] size_chunk:%",{"type":166,"tag":257,"props":5577,"children":5578},{"style":270},[5579],{"type":172,"value":419},{"type":166,"tag":257,"props":5581,"children":5582},{"style":338},[5583],{"type":172,"value":5584}," PRIu64 ",{"type":166,"tag":257,"props":5586,"children":5587},{"style":270},[5588],{"type":172,"value":419},{"type":166,"tag":257,"props":5590,"children":5591},{"style":276},[5592],{"type":172,"value":5593}," offset_chunk:%",{"type":166,"tag":257,"props":5595,"children":5596},{"style":270},[5597],{"type":172,"value":419},{"type":166,"tag":257,"props":5599,"children":5600},{"style":338},[5601],{"type":172,"value":5602}," PRIu64",{"type":166,"tag":257,"props":5604,"children":5605},{"style":312},[5606],{"type":172,"value":4617},{"type":166,"tag":257,"props":5608,"children":5609},{"class":259,"line":323},[5610,5615,5619,5623,5627,5631],{"type":166,"tag":257,"props":5611,"children":5612},{"style":338},[5613],{"type":172,"value":5614},"  key",{"type":166,"tag":257,"props":5616,"children":5617},{"style":312},[5618],{"type":172,"value":449},{"type":166,"tag":257,"props":5620,"children":5621},{"style":306},[5622],{"type":172,"value":567},{"type":166,"tag":257,"props":5624,"children":5625},{"style":312},[5626],{"type":172,"value":572},{"type":166,"tag":257,"props":5628,"children":5629},{"style":306},[5630],{"type":172,"value":577},{"type":166,"tag":257,"props":5632,"children":5633},{"style":312},[5634],{"type":172,"value":5635},"(),\n",{"type":166,"tag":257,"props":5637,"children":5638},{"class":259,"line":349},[5639,5644,5648,5652],{"type":166,"tag":257,"props":5640,"children":5641},{"style":338},[5642],{"type":172,"value":5643},"  chunk",{"type":166,"tag":257,"props":5645,"children":5646},{"style":312},[5647],{"type":172,"value":449},{"type":166,"tag":257,"props":5649,"children":5650},{"style":306},[5651],{"type":172,"value":3401},{"type":166,"tag":257,"props":5653,"children":5654},{"style":312},[5655],{"type":172,"value":5635},{"type":166,"tag":257,"props":5657,"children":5658},{"class":259,"line":370},[5659],{"type":166,"tag":257,"props":5660,"children":5661},{"style":338},[5662],{"type":172,"value":5663},"  offset_chunk\n",{"type":166,"tag":257,"props":5665,"children":5666},{"class":259,"line":427},[5667],{"type":166,"tag":257,"props":5668,"children":5669},{"style":312},[5670],{"type":172,"value":424},{"type":166,"tag":1133,"props":5672,"children":5674},{"id":5673},"日志时间",[5675],{"type":172,"value":5673},{"type":166,"tag":180,"props":5677,"children":5678},{},[5679],{"type":172,"value":5680},"使用系统输出（syslog）时不需要手动记录时间，但是把日志打印出来时却是要的。尤其是在调试时，精确时间非常有用。KDB 使用 Linux 的 timeval、tm 两个结构体，分别拿到精确时间及可读时间，再格式化输出。",{"type":166,"tag":246,"props":5682,"children":5684},{"code":5683,"language":249,"meta":160,"className":250,"style":160},"struct timeval now_tv;\ngettimeofday(&now_tv, NULL);\nconst time_t seconds = now_tv.tv_sec;\nstruct tm t;\n// 初始化 tm 时需要用到当前秒数，\n// 所以需要提前初始化 now_tv\nlocaltime_r(&seconds, &t);\np += snprintf(p, limit - p,\n              \"%04d/%02d/%02d-%02d:%02d:%02d.%06d %s %s \",\n              t.tm_year + 1900,\n              t.tm_mon + 1,\n              t.tm_mday,\n              t.tm_hour,\n              t.tm_min,\n              t.tm_sec,\n              static_cast\u003Cint>(now_tv.tv_usec), // 毫秒\n              ss.str().c_str(),\n              logname);\n",[5685],{"type":166,"tag":253,"props":5686,"children":5687},{"__ignoreMap":160},[5688,5710,5744,5782,5802,5810,5818,5856,5905,5986,6017,6045,6065,6085,6105,6125,6168,6196],{"type":166,"tag":257,"props":5689,"children":5690},{"class":259,"line":260},[5691,5696,5701,5706],{"type":166,"tag":257,"props":5692,"children":5693},{"style":300},[5694],{"type":172,"value":5695},"struct",{"type":166,"tag":257,"props":5697,"children":5698},{"style":327},[5699],{"type":172,"value":5700}," timeval",{"type":166,"tag":257,"props":5702,"children":5703},{"style":338},[5704],{"type":172,"value":5705}," now_tv",{"type":166,"tag":257,"props":5707,"children":5708},{"style":312},[5709],{"type":172,"value":346},{"type":166,"tag":257,"props":5711,"children":5712},{"class":259,"line":287},[5713,5718,5722,5726,5731,5735,5740],{"type":166,"tag":257,"props":5714,"children":5715},{"style":306},[5716],{"type":172,"value":5717},"gettimeofday",{"type":166,"tag":257,"props":5719,"children":5720},{"style":312},[5721],{"type":172,"value":394},{"type":166,"tag":257,"props":5723,"children":5724},{"style":436},[5725],{"type":172,"value":2262},{"type":166,"tag":257,"props":5727,"children":5728},{"style":338},[5729],{"type":172,"value":5730},"now_tv",{"type":166,"tag":257,"props":5732,"children":5733},{"style":312},[5734],{"type":172,"value":404},{"type":166,"tag":257,"props":5736,"children":5737},{"style":2464},[5738],{"type":172,"value":5739}," NULL",{"type":166,"tag":257,"props":5741,"children":5742},{"style":312},[5743],{"type":172,"value":424},{"type":166,"tag":257,"props":5745,"children":5746},{"class":259,"line":296},[5747,5751,5756,5761,5765,5769,5773,5778],{"type":166,"tag":257,"props":5748,"children":5749},{"style":1764},[5750],{"type":172,"value":2276},{"type":166,"tag":257,"props":5752,"children":5753},{"style":300},[5754],{"type":172,"value":5755}," time_t",{"type":166,"tag":257,"props":5757,"children":5758},{"style":338},[5759],{"type":172,"value":5760}," seconds ",{"type":166,"tag":257,"props":5762,"children":5763},{"style":436},[5764],{"type":172,"value":439},{"type":166,"tag":257,"props":5766,"children":5767},{"style":338},[5768],{"type":172,"value":5705},{"type":166,"tag":257,"props":5770,"children":5771},{"style":312},[5772],{"type":172,"value":449},{"type":166,"tag":257,"props":5774,"children":5775},{"style":338},[5776],{"type":172,"value":5777},"tv_sec",{"type":166,"tag":257,"props":5779,"children":5780},{"style":312},[5781],{"type":172,"value":346},{"type":166,"tag":257,"props":5783,"children":5784},{"class":259,"line":323},[5785,5789,5794,5798],{"type":166,"tag":257,"props":5786,"children":5787},{"style":300},[5788],{"type":172,"value":5695},{"type":166,"tag":257,"props":5790,"children":5791},{"style":327},[5792],{"type":172,"value":5793}," tm",{"type":166,"tag":257,"props":5795,"children":5796},{"style":338},[5797],{"type":172,"value":1824},{"type":166,"tag":257,"props":5799,"children":5800},{"style":312},[5801],{"type":172,"value":346},{"type":166,"tag":257,"props":5803,"children":5804},{"class":259,"line":349},[5805],{"type":166,"tag":257,"props":5806,"children":5807},{"style":1266},[5808],{"type":172,"value":5809},"// 初始化 tm 时需要用到当前秒数，\n",{"type":166,"tag":257,"props":5811,"children":5812},{"class":259,"line":370},[5813],{"type":166,"tag":257,"props":5814,"children":5815},{"style":1266},[5816],{"type":172,"value":5817},"// 所以需要提前初始化 now_tv\n",{"type":166,"tag":257,"props":5819,"children":5820},{"class":259,"line":427},[5821,5826,5830,5834,5839,5843,5847,5852],{"type":166,"tag":257,"props":5822,"children":5823},{"style":306},[5824],{"type":172,"value":5825},"localtime_r",{"type":166,"tag":257,"props":5827,"children":5828},{"style":312},[5829],{"type":172,"value":394},{"type":166,"tag":257,"props":5831,"children":5832},{"style":436},[5833],{"type":172,"value":2262},{"type":166,"tag":257,"props":5835,"children":5836},{"style":338},[5837],{"type":172,"value":5838},"seconds",{"type":166,"tag":257,"props":5840,"children":5841},{"style":312},[5842],{"type":172,"value":404},{"type":166,"tag":257,"props":5844,"children":5845},{"style":436},[5846],{"type":172,"value":892},{"type":166,"tag":257,"props":5848,"children":5849},{"style":338},[5850],{"type":172,"value":5851},"t",{"type":166,"tag":257,"props":5853,"children":5854},{"style":312},[5855],{"type":172,"value":424},{"type":166,"tag":257,"props":5857,"children":5858},{"class":259,"line":462},[5859,5864,5869,5874,5878,5882,5886,5891,5896,5901],{"type":166,"tag":257,"props":5860,"children":5861},{"style":338},[5862],{"type":172,"value":5863},"p ",{"type":166,"tag":257,"props":5865,"children":5866},{"style":436},[5867],{"type":172,"value":5868},"+=",{"type":166,"tag":257,"props":5870,"children":5871},{"style":306},[5872],{"type":172,"value":5873}," snprintf",{"type":166,"tag":257,"props":5875,"children":5876},{"style":312},[5877],{"type":172,"value":394},{"type":166,"tag":257,"props":5879,"children":5880},{"style":338},[5881],{"type":172,"value":180},{"type":166,"tag":257,"props":5883,"children":5884},{"style":312},[5885],{"type":172,"value":404},{"type":166,"tag":257,"props":5887,"children":5888},{"style":338},[5889],{"type":172,"value":5890}," limit ",{"type":166,"tag":257,"props":5892,"children":5893},{"style":436},[5894],{"type":172,"value":5895},"-",{"type":166,"tag":257,"props":5897,"children":5898},{"style":338},[5899],{"type":172,"value":5900}," p",{"type":166,"tag":257,"props":5902,"children":5903},{"style":312},[5904],{"type":172,"value":4617},{"type":166,"tag":257,"props":5906,"children":5907},{"class":259,"line":504},[5908,5913,5918,5923,5928,5932,5936,5940,5944,5948,5952,5956,5960,5964,5969,5974,5978,5982],{"type":166,"tag":257,"props":5909,"children":5910},{"style":270},[5911],{"type":172,"value":5912},"              \"",{"type":166,"tag":257,"props":5914,"children":5915},{"style":536},[5916],{"type":172,"value":5917},"%04d",{"type":166,"tag":257,"props":5919,"children":5920},{"style":276},[5921],{"type":172,"value":5922},"/",{"type":166,"tag":257,"props":5924,"children":5925},{"style":536},[5926],{"type":172,"value":5927},"%02d",{"type":166,"tag":257,"props":5929,"children":5930},{"style":276},[5931],{"type":172,"value":5922},{"type":166,"tag":257,"props":5933,"children":5934},{"style":536},[5935],{"type":172,"value":5927},{"type":166,"tag":257,"props":5937,"children":5938},{"style":276},[5939],{"type":172,"value":5895},{"type":166,"tag":257,"props":5941,"children":5942},{"style":536},[5943],{"type":172,"value":5927},{"type":166,"tag":257,"props":5945,"children":5946},{"style":276},[5947],{"type":172,"value":1362},{"type":166,"tag":257,"props":5949,"children":5950},{"style":536},[5951],{"type":172,"value":5927},{"type":166,"tag":257,"props":5953,"children":5954},{"style":276},[5955],{"type":172,"value":1362},{"type":166,"tag":257,"props":5957,"children":5958},{"style":536},[5959],{"type":172,"value":5927},{"type":166,"tag":257,"props":5961,"children":5962},{"style":276},[5963],{"type":172,"value":449},{"type":166,"tag":257,"props":5965,"children":5966},{"style":536},[5967],{"type":172,"value":5968},"%06d",{"type":166,"tag":257,"props":5970,"children":5971},{"style":536},[5972],{"type":172,"value":5973}," %s",{"type":166,"tag":257,"props":5975,"children":5976},{"style":536},[5977],{"type":172,"value":5973},{"type":166,"tag":257,"props":5979,"children":5980},{"style":270},[5981],{"type":172,"value":409},{"type":166,"tag":257,"props":5983,"children":5984},{"style":312},[5985],{"type":172,"value":4617},{"type":166,"tag":257,"props":5987,"children":5988},{"class":259,"line":585},[5989,5994,5998,6003,6008,6013],{"type":166,"tag":257,"props":5990,"children":5991},{"style":338},[5992],{"type":172,"value":5993},"              t",{"type":166,"tag":257,"props":5995,"children":5996},{"style":312},[5997],{"type":172,"value":449},{"type":166,"tag":257,"props":5999,"children":6000},{"style":338},[6001],{"type":172,"value":6002},"tm_year ",{"type":166,"tag":257,"props":6004,"children":6005},{"style":436},[6006],{"type":172,"value":6007},"+",{"type":166,"tag":257,"props":6009,"children":6010},{"style":598},[6011],{"type":172,"value":6012}," 1900",{"type":166,"tag":257,"props":6014,"children":6015},{"style":312},[6016],{"type":172,"value":4617},{"type":166,"tag":257,"props":6018,"children":6019},{"class":259,"line":608},[6020,6024,6028,6033,6037,6041],{"type":166,"tag":257,"props":6021,"children":6022},{"style":338},[6023],{"type":172,"value":5993},{"type":166,"tag":257,"props":6025,"children":6026},{"style":312},[6027],{"type":172,"value":449},{"type":166,"tag":257,"props":6029,"children":6030},{"style":338},[6031],{"type":172,"value":6032},"tm_mon ",{"type":166,"tag":257,"props":6034,"children":6035},{"style":436},[6036],{"type":172,"value":6007},{"type":166,"tag":257,"props":6038,"children":6039},{"style":598},[6040],{"type":172,"value":2815},{"type":166,"tag":257,"props":6042,"children":6043},{"style":312},[6044],{"type":172,"value":4617},{"type":166,"tag":257,"props":6046,"children":6047},{"class":259,"line":617},[6048,6052,6056,6061],{"type":166,"tag":257,"props":6049,"children":6050},{"style":338},[6051],{"type":172,"value":5993},{"type":166,"tag":257,"props":6053,"children":6054},{"style":312},[6055],{"type":172,"value":449},{"type":166,"tag":257,"props":6057,"children":6058},{"style":338},[6059],{"type":172,"value":6060},"tm_mday",{"type":166,"tag":257,"props":6062,"children":6063},{"style":312},[6064],{"type":172,"value":4617},{"type":166,"tag":257,"props":6066,"children":6067},{"class":259,"line":625},[6068,6072,6076,6081],{"type":166,"tag":257,"props":6069,"children":6070},{"style":338},[6071],{"type":172,"value":5993},{"type":166,"tag":257,"props":6073,"children":6074},{"style":312},[6075],{"type":172,"value":449},{"type":166,"tag":257,"props":6077,"children":6078},{"style":338},[6079],{"type":172,"value":6080},"tm_hour",{"type":166,"tag":257,"props":6082,"children":6083},{"style":312},[6084],{"type":172,"value":4617},{"type":166,"tag":257,"props":6086,"children":6087},{"class":259,"line":668},[6088,6092,6096,6101],{"type":166,"tag":257,"props":6089,"children":6090},{"style":338},[6091],{"type":172,"value":5993},{"type":166,"tag":257,"props":6093,"children":6094},{"style":312},[6095],{"type":172,"value":449},{"type":166,"tag":257,"props":6097,"children":6098},{"style":338},[6099],{"type":172,"value":6100},"tm_min",{"type":166,"tag":257,"props":6102,"children":6103},{"style":312},[6104],{"type":172,"value":4617},{"type":166,"tag":257,"props":6106,"children":6107},{"class":259,"line":709},[6108,6112,6116,6121],{"type":166,"tag":257,"props":6109,"children":6110},{"style":338},[6111],{"type":172,"value":5993},{"type":166,"tag":257,"props":6113,"children":6114},{"style":312},[6115],{"type":172,"value":449},{"type":166,"tag":257,"props":6117,"children":6118},{"style":338},[6119],{"type":172,"value":6120},"tm_sec",{"type":166,"tag":257,"props":6122,"children":6123},{"style":312},[6124],{"type":172,"value":4617},{"type":166,"tag":257,"props":6126,"children":6127},{"class":259,"line":717},[6128,6133,6137,6141,6145,6149,6153,6158,6163],{"type":166,"tag":257,"props":6129,"children":6130},{"style":436},[6131],{"type":172,"value":6132},"              static_cast\u003C",{"type":166,"tag":257,"props":6134,"children":6135},{"style":300},[6136],{"type":172,"value":303},{"type":166,"tag":257,"props":6138,"children":6139},{"style":436},[6140],{"type":172,"value":2244},{"type":166,"tag":257,"props":6142,"children":6143},{"style":312},[6144],{"type":172,"value":394},{"type":166,"tag":257,"props":6146,"children":6147},{"style":338},[6148],{"type":172,"value":5730},{"type":166,"tag":257,"props":6150,"children":6151},{"style":312},[6152],{"type":172,"value":449},{"type":166,"tag":257,"props":6154,"children":6155},{"style":338},[6156],{"type":172,"value":6157},"tv_usec",{"type":166,"tag":257,"props":6159,"children":6160},{"style":312},[6161],{"type":172,"value":6162},"),",{"type":166,"tag":257,"props":6164,"children":6165},{"style":1266},[6166],{"type":172,"value":6167}," // 毫秒\n",{"type":166,"tag":257,"props":6169,"children":6170},{"class":259,"line":738},[6171,6176,6180,6184,6188,6192],{"type":166,"tag":257,"props":6172,"children":6173},{"style":338},[6174],{"type":172,"value":6175},"              ss",{"type":166,"tag":257,"props":6177,"children":6178},{"style":312},[6179],{"type":172,"value":449},{"type":166,"tag":257,"props":6181,"children":6182},{"style":306},[6183],{"type":172,"value":2836},{"type":166,"tag":257,"props":6185,"children":6186},{"style":312},[6187],{"type":172,"value":572},{"type":166,"tag":257,"props":6189,"children":6190},{"style":306},[6191],{"type":172,"value":577},{"type":166,"tag":257,"props":6193,"children":6194},{"style":312},[6195],{"type":172,"value":5635},{"type":166,"tag":257,"props":6197,"children":6198},{"class":259,"line":794},[6199,6204],{"type":166,"tag":257,"props":6200,"children":6201},{"style":338},[6202],{"type":172,"value":6203},"              logname",{"type":166,"tag":257,"props":6205,"children":6206},{"style":312},[6207],{"type":172,"value":424},{"type":166,"tag":6209,"props":6210,"children":6211},"style",{},[6212],{"type":172,"value":6213},"html .light .shiki span {color: var(--shiki-light);background: var(--shiki-light-bg);font-style: var(--shiki-light-font-style);font-weight: var(--shiki-light-font-weight);text-decoration: var(--shiki-light-text-decoration);}html.light .shiki span {color: var(--shiki-light);background: var(--shiki-light-bg);font-style: var(--shiki-light-font-style);font-weight: var(--shiki-light-font-weight);text-decoration: var(--shiki-light-text-decoration);}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html .sepia .shiki span {color: var(--shiki-sepia);background: var(--shiki-sepia-bg);font-style: var(--shiki-sepia-font-style);font-weight: var(--shiki-sepia-font-weight);text-decoration: var(--shiki-sepia-text-decoration);}html.sepia .shiki span {color: var(--shiki-sepia);background: var(--shiki-sepia-bg);font-style: var(--shiki-sepia-font-style);font-weight: var(--shiki-sepia-font-weight);text-decoration: var(--shiki-sepia-text-decoration);}",{"title":160,"searchDepth":287,"depth":287,"links":6215},[6216,6217,6218,6219],{"id":176,"depth":287,"text":176},{"id":237,"depth":287,"text":237},{"id":3219,"depth":287,"text":3219},{"id":3232,"depth":287,"text":3232},"markdown","content:8.source-code:_cpp:kingdb.md","content","8.source-code/_cpp/kingdb.md","8.source-code/_cpp/kingdb","md",[6227,6231],{"_path":6228,"title":6229,"description":6230},"/source-code/_architecture/awade","Awade","中兴的一套低码系统。Jigsaw 是其前端组件库。",{"_path":6232,"title":6233,"description":160},"/source-code/_es/array-slice","Array.prototype.slice",1742745254722]