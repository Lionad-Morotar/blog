{"_path":"/maps/_workflow/package-manager/pnpm","_dir":"package-manager","_draft":false,"_partial":true,"_locale":"","title":"pnpm","description":"pnpm 是一个快速、省空间的包管理器","body":{"type":"root","children":[{"type":"element","tag":"h2","props":{"id":"api-细节和配置项"},"children":[{"type":"text","value":"API 细节和配置项"}]},{"type":"element","tag":"h4","props":{"id":"pnpm-import"},"children":[{"type":"text","value":"pnpm import"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"使用 "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"pnpm import"}]},{"type":"text","value":" 可以将 package-lock、npm-shrinkwrap 和 yarn.lock 转换为 pnpm-lock 文件。"}]},{"type":"element","tag":"h4","props":{"id":"pnpm-fetch"},"children":[{"type":"text","value":"pnpm fetch"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"pnpm fetch"}]},{"type":"text","value":" 它跳过了 package.json 文件，允许项目在只有 pnpm-lock 文件的情况下创建 .pnpm 虚拟仓库。这有利于 docker 构建，因为 package.json 经常因为非依赖变化的改动而改动，导致 docker layer 失效。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"相比 yarn 和 npm，在脱离 package.json 的情况下，单靠 package-lock（或 yarn-lock），yarn 和 npm 没有办法确定依赖版本，因为其 package-lock 中，依赖的版本号不是固定版本号。"}]},{"type":"element","tag":"h4","props":{"id":"pnpm-why"},"children":[{"type":"text","value":"pnpm why"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"使用 "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"pnpm why"}]},{"type":"text","value":" 可以列出项目内依赖了某个依赖的依赖，比如说找到项目内使用了 lodash 的包。"}]},{"type":"element","tag":"pre","props":{"code":"dependencies:\nelement-plus 2.2.20\n├── lodash 4.17.21\n└─┬ lodash-unified 1.0.3\n  └── lodash 4.17.21 peer\n...\n","language":"text","meta":"","className":["language-text"]},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"dependencies:\nelement-plus 2.2.20\n├── lodash 4.17.21\n└─┬ lodash-unified 1.0.3\n  └── lodash 4.17.21 peer\n...\n"}]}]},{"type":"element","tag":"h4","props":{"id":"pnpm-run"},"children":[{"type":"text","value":"pnpm run"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"与其它包管理器的一些区别："}]},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"pnpm run script-name"}]},{"type":"text","value":"，如果 "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"script-name"}]},{"type":"text","value":" 没有和 pnpm 内置指令冲突，则可以省略 "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"run"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"run 指令默认不会执行 pre 和 post 钩子函数，因为 pnpm 认为这使任务流更难理解"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"shell-emulator"}]},{"type":"text","value":" 选项启用后，将使用 JS 解析指令，这使得在不兼容 POSIX 的环境执行类似 "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"NODE_ENV=test node ./index"}]},{"type":"text","value":" 的指令会报错的系统也能正常运行这种指令"}]}]},{"type":"element","tag":"h4","props":{"id":"pnpm-pack"},"children":[{"type":"text","value":"pnpm pack"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"将项目打包为 tarball 压缩包（.tgz）。打包的文件范围和 pnpm publish 一样。"}]},{"type":"element","tag":"h4","props":{"id":"shared-workspace-lockfile"},"children":[{"type":"text","value":"shared-workspace-lockfile"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"在 workspace 间共享一份 package-lock 文件。这个配置开启后，所有子包的依赖都会被提升到 workspace 根目录，这带来了几个好处："}]},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"所有依赖都是单例的"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"更快的安装速度（相比 pnpm install -r）"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"修改的文件总数更少，利于 Code Review"}]}]},{"type":"element","tag":"h4","props":{"id":"shell-emulator"},"children":[{"type":"text","value":"shell-emulator"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"解析 package.json 中的 scripts 时，是否使用内置的 JS 实现的解析器，已支持跨平台语法。默认关闭。"}]},{"type":"element","tag":"h4","props":{"id":"pnpmfilecjs"},"children":[{"type":"text","value":".pnpmfile.cjs"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"使用 "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":".pnpmfile.cjs"}]},{"type":"text","value":" 文件提供的 readPackage 和 afterAllResolved 钩子函数可以分别介入依赖元信息解析（minifest）和依赖安装完准备输出 lock 文件的过程。"}]},{"type":"element","tag":"pre","props":{"code":"function readPackage(pkg, context) {\n  // Override the manifest of foo@1.x after downloading it from the registry\n  if (pkg.name === 'foo' && pkg.version.startsWith('1.')) {\n    // Replace bar@x.x.x with bar@2.0.0\n    pkg.dependencies = {\n      ...pkg.dependencies,\n      bar: '^2.0.0'\n    }\n    context.log('bar@1 => bar@2 in dependencies of foo')\n  }\n  \n  // This will change any packages using baz@x.x.x to use baz@1.2.3\n  if (pkg.dependencies.baz) {\n    pkg.dependencies.baz = '1.2.3';\n  }\n  \n  return pkg\n}\n\nmodule.exports = {\n  hooks: {\n    readPackage\n  }\n}\n","language":"js","meta":"","className":"language-js shiki shiki-themes material-theme-lighter github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-light:#9C3EDA;--shiki-light-font-style:inherit;--shiki-default:#D73A49;--shiki-default-font-style:inherit;--shiki-dark:#F97583;--shiki-dark-font-style:inherit;--shiki-sepia:#66D9EF;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"function"}]},{"type":"element","tag":"span","props":{"style":"--shiki-light:#6182B8;--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" readPackage"}]},{"type":"element","tag":"span","props":{"style":"--shiki-light:#39ADB5;--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-default:#E36209;--shiki-default-font-style:inherit;--shiki-dark:#FFAB70;--shiki-dark-font-style:inherit;--shiki-sepia:#FD971F;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"pkg"}]},{"type":"element","tag":"span","props":{"style":"--shiki-light:#39ADB5;--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":","}]},{"type":"element","tag":"span","props":{"style":"--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-default:#E36209;--shiki-default-font-style:inherit;--shiki-dark:#FFAB70;--shiki-dark-font-style:inherit;--shiki-sepia:#FD971F;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":" context"}]},{"type":"element","tag":"span","props":{"style":"--shiki-light:#39ADB5;--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")"}]},{"type":"element","tag":"span","props":{"style":"--shiki-light:#39ADB5;--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-default:#6A737D;--shiki-default-font-style:inherit;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;--shiki-sepia:#88846F;--shiki-sepia-font-style:inherit"},"children":[{"type":"text","value":"  // Override the manifest of foo@1.x after downloading it from the registry\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-default:#D73A49;--shiki-default-font-style:inherit;--shiki-dark:#F97583;--shiki-dark-font-style:inherit;--shiki-sepia:#F92672;--shiki-sepia-font-style:inherit"},"children":[{"type":"text","value":"  if"}]},{"type":"element","tag":"span","props":{"style":"--shiki-light:#E53935;--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" ("}]},{"type":"element","tag":"span","props":{"style":"--shiki-light:#90A4AE;--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"pkg"}]},{"type":"element","tag":"span","props":{"style":"--shiki-light:#39ADB5;--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-light:#90A4AE;--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"name"}]},{"type":"element","tag":"span","props":{"style":"--shiki-light:#39ADB5;--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ==="}]},{"type":"element","tag":"span","props":{"style":"--shiki-light:#39ADB5;--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" '"}]},{"type":"element","tag":"span","props":{"style":"--shiki-light:#91B859;--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"foo"}]},{"type":"element","tag":"span","props":{"style":"--shiki-light:#39ADB5;--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-light:#39ADB5;--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" &&"}]},{"type":"element","tag":"span","props":{"style":"--shiki-light:#90A4AE;--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" pkg"}]},{"type":"element","tag":"span","props":{"style":"--shiki-light:#39ADB5;--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-light:#90A4AE;--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"version"}]},{"type":"element","tag":"span","props":{"style":"--shiki-light:#39ADB5;--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-light:#6182B8;--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"startsWith"}]},{"type":"element","tag":"span","props":{"style":"--shiki-light:#E53935;--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-light:#39ADB5;--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-light:#91B859;--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"1."}]},{"type":"element","tag":"span","props":{"style":"--shiki-light:#39ADB5;--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-light:#E53935;--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")) "}]},{"type":"element","tag":"span","props":{"style":"--shiki-light:#39ADB5;--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"{\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-default:#6A737D;--shiki-default-font-style:inherit;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;--shiki-sepia:#88846F;--shiki-sepia-font-style:inherit"},"children":[{"type":"text","value":"    // Replace bar@x.x.x with bar@2.0.0\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-light:#90A4AE;--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    pkg"}]},{"type":"element","tag":"span","props":{"style":"--shiki-light:#39ADB5;--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-light:#90A4AE;--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"dependencies"}]},{"type":"element","tag":"span","props":{"style":"--shiki-light:#39ADB5;--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-light:#39ADB5;--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-light:#39ADB5;--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"      ..."}]},{"type":"element","tag":"span","props":{"style":"--shiki-light:#90A4AE;--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"pkg"}]},{"type":"element","tag":"span","props":{"style":"--shiki-light:#39ADB5;--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-light:#90A4AE;--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"dependencies"}]},{"type":"element","tag":"span","props":{"style":"--shiki-light:#39ADB5;--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-light:#E53935;--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"      bar"}]},{"type":"element","tag":"span","props":{"style":"--shiki-light:#39ADB5;--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":"}]},{"type":"element","tag":"span","props":{"style":"--shiki-light:#39ADB5;--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" '"}]},{"type":"element","tag":"span","props":{"style":"--shiki-light:#91B859;--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"^2.0.0"}]},{"type":"element","tag":"span","props":{"style":"--shiki-light:#39ADB5;--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-light:#39ADB5;--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-light:#90A4AE;--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    context"}]},{"type":"element","tag":"span","props":{"style":"--shiki-light:#39ADB5;--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-light:#6182B8;--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"log"}]},{"type":"element","tag":"span","props":{"style":"--shiki-light:#E53935;--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-light:#39ADB5;--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-light:#91B859;--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"bar@1 => bar@2 in dependencies of foo"}]},{"type":"element","tag":"span","props":{"style":"--shiki-light:#39ADB5;--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-light:#E53935;--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-light:#39ADB5;--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-light:#E53935;--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  \n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-light:#90A4AE;--shiki-light-font-style:italic;--shiki-default:#6A737D;--shiki-default-font-style:inherit;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit;--shiki-sepia:#88846F;--shiki-sepia-font-style:inherit"},"children":[{"type":"text","value":"  // This will change any packages using baz@x.x.x to use baz@1.2.3\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-default:#D73A49;--shiki-default-font-style:inherit;--shiki-dark:#F97583;--shiki-dark-font-style:inherit;--shiki-sepia:#F92672;--shiki-sepia-font-style:inherit"},"children":[{"type":"text","value":"  if"}]},{"type":"element","tag":"span","props":{"style":"--shiki-light:#E53935;--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" ("}]},{"type":"element","tag":"span","props":{"style":"--shiki-light:#90A4AE;--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"pkg"}]},{"type":"element","tag":"span","props":{"style":"--shiki-light:#39ADB5;--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-light:#90A4AE;--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"dependencies"}]},{"type":"element","tag":"span","props":{"style":"--shiki-light:#39ADB5;--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-light:#90A4AE;--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"baz"}]},{"type":"element","tag":"span","props":{"style":"--shiki-light:#E53935;--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":") "}]},{"type":"element","tag":"span","props":{"style":"--shiki-light:#39ADB5;--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"{\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-light:#90A4AE;--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    pkg"}]},{"type":"element","tag":"span","props":{"style":"--shiki-light:#39ADB5;--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-light:#90A4AE;--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"dependencies"}]},{"type":"element","tag":"span","props":{"style":"--shiki-light:#39ADB5;--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-light:#90A4AE;--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"baz"}]},{"type":"element","tag":"span","props":{"style":"--shiki-light:#39ADB5;--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-light:#39ADB5;--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" '"}]},{"type":"element","tag":"span","props":{"style":"--shiki-light:#91B859;--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"1.2.3"}]},{"type":"element","tag":"span","props":{"style":"--shiki-light:#39ADB5;--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"'"}]},{"type":"element","tag":"span","props":{"style":"--shiki-light:#39ADB5;--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":";\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-light:#39ADB5;--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-light:#E53935;--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  \n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-light:#39ADB5;--shiki-light-font-style:italic;--shiki-default:#D73A49;--shiki-default-font-style:inherit;--shiki-dark:#F97583;--shiki-dark-font-style:inherit;--shiki-sepia:#F92672;--shiki-sepia-font-style:inherit"},"children":[{"type":"text","value":"  return"}]},{"type":"element","tag":"span","props":{"style":"--shiki-light:#90A4AE;--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" pkg\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":18},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-light:#39ADB5;--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"}\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":19},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":20},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-light:#39ADB5;--shiki-light-font-style:inherit;--shiki-default:#005CC5;--shiki-default-font-style:inherit;--shiki-dark:#79B8FF;--shiki-dark-font-style:inherit;--shiki-sepia:#66D9EF;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"module"}]},{"type":"element","tag":"span","props":{"style":"--shiki-light:#39ADB5;--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-light:#39ADB5;--shiki-light-font-style:inherit;--shiki-default:#005CC5;--shiki-default-font-style:inherit;--shiki-dark:#79B8FF;--shiki-dark-font-style:inherit;--shiki-sepia:#66D9EF;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"exports"}]},{"type":"element","tag":"span","props":{"style":"--shiki-light:#39ADB5;--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-light:#39ADB5;--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":21},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-light:#E53935;--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  hooks"}]},{"type":"element","tag":"span","props":{"style":"--shiki-light:#39ADB5;--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":"}]},{"type":"element","tag":"span","props":{"style":"--shiki-light:#39ADB5;--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":22},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-light:#90A4AE;--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    readPackage\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":23},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-light:#39ADB5;--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":24},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-light:#39ADB5;--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"}\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"见："},{"type":"element","tag":"a","props":{"href":"https://pnpm.io/pnpmfile","rel":["nofollow"]},"children":[{"type":"text","value":"pnpmfile"}]}]},{"type":"element","tag":"h2","props":{"id":"原理"},"children":[{"type":"text","value":"原理"}]},{"type":"element","tag":"h4","props":{"id":"显著的优点"},"children":[{"type":"text","value":"显著的优点？"}]},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"省磁盘空间，使用软硬链接和符号链接节约空间。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"安装依赖快，因为处理链接要比处理文件快，并且每个包的解析、下载和写入磁盘这三个阶段是分离的。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"内建支持 monorepo，所有命令支持 "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"--filter"}]},{"type":"text","value":" 过滤包。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"依赖严格，避免幽灵依赖和依赖分身问题。"}]}]},{"type":"element","tag":"h4","props":{"id":"依赖的层次结构是怎样的"},"children":[{"type":"text","value":"依赖的层次结构是怎样的？"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"当项目文件读取 "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"bar"}]},{"type":"text","value":" 时，直接读取 "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"node_modules/bar"}]},{"type":"text","value":"，但它其实是 "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":".pnpm"}]},{"type":"text","value":" 文件夹下 "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"bar/node_modules/bar"}]},{"type":"text","value":" 的一个符号链接。也就是说，他的真实的地址在 "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":".pnpm"}]},{"type":"text","value":" 文件夹下。这样一来，当 "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"bar"}]},{"type":"text","value":" 读取它的依赖的时候（项目的依赖的依赖），会在 "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"bar"}]},{"type":"text","value":" 的上层目录即 "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"bar/node_modules"}]},{"type":"text","value":" 找到 "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"foo"}]},{"type":"text","value":" 这个依赖。项目文件没法读取 "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"bar/node_modules/foo"}]},{"type":"text","value":" 所以避免了幽灵依赖问题。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"bar/node_modules/foo"}]},{"type":"text","value":" 要怎么找到它的依赖呢？它的真实地址在项目 ·（和官网的图有出入），所以 foo 也只能读取它自己的子依赖，即 "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"node_modules/.pnpm/foo/node_modules"}]},{"type":"text","value":"。如果有依赖依赖了同一份（同一版本）的 "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"foo"}]},{"type":"text","value":"，那么它们的真实地址都是一样的 "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"node_modules/.pnpm/foo/node_modules/foo"}]},{"type":"text","value":"，这样就避免依赖分身问题。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"Modules Mapping in pnpm","src":"https://mgear-image.oss-cn-shanghai.aliyuncs.com/image/other/20220317192927.png"},"children":[]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"见："},{"type":"element","tag":"a","props":{"href":"https://pnpm.io/blog/2020/05/27/flat-node-modules-is-not-the-only-way","rel":["nofollow"]},"children":[{"type":"text","value":"Flat node_modules is not the only way | @pnpm"}]},{"type":"text","value":"、"},{"type":"element","tag":"a","props":{"href":"https://pnpm.io/symlinked-node-modules-structure","rel":["nofollow"]},"children":[{"type":"text","value":"Symlinked node_modules structure | @pnpm"}]}]},{"type":"element","tag":"h4","props":{"id":"如何处理同级依赖"},"children":[{"type":"text","value":"如何处理同级依赖？"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"当项目的两个包 A、B 依赖依赖了同一版本的 C，但是却安装了不同版本的 C 的同级依赖 D@1.0 和 D@1.1，这时，A 依赖的 C 的真实地址是 "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":".pnpm/C_D@1.0/node_modules/C"}]},{"type":"text","value":"，B 依赖的 C 的真实地址是 "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":".pnpm/C_D@1.1/node_modules/C"}]},{"type":"text","value":"。这样一来，两个 C 在读取其同级依赖时，分别读取了 "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":".pnpm/C_D@1.0/node_modules/D"}]},{"type":"text","value":" 和 "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":".pnpm/C_D@1.1/node_modules/D@1.0"}]},{"type":"text","value":"，分别对应真实地址 "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":".pnpm/D@1.0/node_modules/D"}]},{"type":"text","value":" 和 "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":".pnpm/D@1.1/node_modules/D"}]},{"type":"text","value":"。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"当同级依赖的深度增加时，层级结构也随之变得复杂。如果某个依赖 A 依赖了同一个 B，但是 B 子依赖 C 的版本不同（C@1.0 和 C@1.1），这样就创造出了指数级增长的软链数量。为了保证 B 能分别访问两个 C，B 的符号链接的被链接地址会有 "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":".pnpm/B_C@1.0/node_modules/B"}]},{"type":"text","value":" 和 "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":".pnpm/B_C@1.1/node_modules/B"}]},{"type":"text","value":"，而为此，A 的被链接地址也会有两个，"},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":".pnpm/A_C@1.0/node_modules/A"}]},{"type":"text","value":" 和 "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":".pnpm/A_C@1.0/node_modules/A"}]},{"type":"text","value":"。从不同的 A 的被链接地址的上级目录 "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"node_modules"}]},{"type":"text","value":" 可以读取到不同的 B 的被链目录，从不同的 B 可以读取到不同的 C。"}]},{"type":"element","tag":"pre","props":{"code":"node_modules\n└── .pnpm\n    ├── a@1.0.0_c@1.0.0\n    │   └── node_modules\n    │       ├── a\n    │       └── b -> ../../b@1.0.0_c@1.0.0/node_modules/b\n    ├── a@1.0.0_c@1.1.0\n    │   └── node_modules\n    │       ├── a\n    │       └── b -> ../../b@1.0.0_c@1.1.0/node_modules/b\n    ├── b@1.0.0_c@1.0.0\n    │   └── node_modules\n    │       ├── b\n    │       └── c -> ../../c@1.0.0/node_modules/c\n    ├── b@1.0.0_c@1.1.0\n    │   └── node_modules\n    │       ├── b\n    │       └── c -> ../../c@1.1.0/node_modules/c\n    ├── c@1.0.0\n    ├── c@1.1.0\n","language":"text","meta":"","className":["language-text"]},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"node_modules\n└── .pnpm\n    ├── a@1.0.0_c@1.0.0\n    │   └── node_modules\n    │       ├── a\n    │       └── b -> ../../b@1.0.0_c@1.0.0/node_modules/b\n    ├── a@1.0.0_c@1.1.0\n    │   └── node_modules\n    │       ├── a\n    │       └── b -> ../../b@1.0.0_c@1.1.0/node_modules/b\n    ├── b@1.0.0_c@1.0.0\n    │   └── node_modules\n    │       ├── b\n    │       └── c -> ../../c@1.0.0/node_modules/c\n    ├── b@1.0.0_c@1.1.0\n    │   └── node_modules\n    │       ├── b\n    │       └── c -> ../../c@1.1.0/node_modules/c\n    ├── c@1.0.0\n    ├── c@1.1.0\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"见："},{"type":"element","tag":"a","props":{"href":"https://pnpm.io/how-peers-are-resolved","rel":["nofollow"]},"children":[{"type":"text","value":"How peers are resolved | @pnpm"}]}]},{"type":"element","tag":"h4","props":{"id":"怎样兼容-nodejs-模块加载顺序"},"children":[{"type":"text","value":"怎样兼容 NodeJS 模块加载顺序？"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"不论系统自带的模块，NodeJS 加载模块的顺序是这样的："}]},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"读取本文件夹中 node_modules 中对应名字的文件夹的 package.json，并寻找 main 字段对应的路径"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"读取本文件夹中 node_modules 中对应名字的 js 文件"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"读取本文件夹中 node_modules 中对应名字文件夹中的 index.js 文件"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"跳出本文件夹，继续前三个步骤"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"因为项目 "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"node_modules/bar"}]},{"type":"text","value":" 是 "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":".pnpm/bar/node_modules/bar"}]},{"type":"text","value":" 的符号链接，所以项目文件可以直接读取 "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"node_modules/bar/x.js"}]},{"type":"text","value":"。同时，如果 "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"node_modules/bar/x.js"}]},{"type":"text","value":" 需要加载 "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"foo/x.js"}]},{"type":"text","value":"，那么在上述步骤的第 4 步，就能找到 "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":".pnpm/bar/node_modules/foo/x.js"}]},{"type":"text","value":" 文件。"}]},{"type":"element","tag":"h4","props":{"id":"为什么其模块层次只是比较严格的semistrict"},"children":[{"type":"text","value":"为什么其模块层次只是“比较严格的”（semistrict）？"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"由 NodeJS 模块加载规则可知，在 pnpm 创造的依赖层次下，一个依赖的子依赖间仍有相互访问的能力。"}]},{"type":"element","tag":"h4","props":{"id":"为什么能节约磁盘空间"},"children":[{"type":"text","value":"为什么能节约磁盘空间？"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"由 pnpm 创造的 node_modules 层级结构可以知道，所有依赖的符号链接的真实地址都在 "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":".pnpm/package-name/node_modules/package-name"}]},{"type":"text","value":" 这个文件夹中。这种文件夹会通过硬链接的形式链接到 "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"user-document/.pnpm-store"}]},{"type":"text","value":" 中，所以相同的包只会存一份，也就是 "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":".pnpm-store/package-name"}]},{"type":"text","value":"。"}]},{"type":"element","tag":"h4","props":{"id":"软硬链接有什么问题"},"children":[{"type":"text","value":"软硬链接有什么问题？"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"特定的软链结构会导致某些应用出现死循环"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"硬链接是同一份文件，不便调试"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"软链接在非 SSD 上的读写会有性能损耗"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"pnpm 创造的 node_modules 层级结构会破坏某些依赖依赖了相对路径的依赖的逻辑"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"见："},{"type":"element","tag":"a","props":{"href":"https://zhuanlan.zhihu.com/p/553804414","rel":["nofollow"]},"children":[{"type":"text","value":"精读 pnpm"}]}]},{"type":"element","tag":"h2","props":{"id":"常见问题"},"children":[{"type":"text","value":"常见问题"}]},{"type":"element","tag":"h4","props":{"id":"pnpm-找不到全局路径的解决方法"},"children":[{"type":"text","value":"PNPM 找不到全局路径的解决方法？"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"尽管设置了全局变量，也重新安装了最新版本 PNPM，也执行了 pnpm setup，却仍然报错找不到全局路径的临时解决方案："}]},{"type":"element","tag":"pre","props":{"code":"$PNPM_HOME=\"<path>\" | pnpm install -g xxx\n","language":"powershell","meta":"","className":"language-powershell shiki shiki-themes material-theme-lighter github-light github-dark monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-light:#39ADB5;--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"$"}]},{"type":"element","tag":"span","props":{"style":"--shiki-light:#90A4AE;--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"PNPM_HOME"}]},{"type":"element","tag":"span","props":{"style":"--shiki-light:#39ADB5;--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-light:#39ADB5;--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-light:#91B859;--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"<path>"}]},{"type":"element","tag":"span","props":{"style":"--shiki-light:#39ADB5;--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-light:#39ADB5;--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" |"}]},{"type":"element","tag":"span","props":{"style":"--shiki-light:#90A4AE;--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" pnpm install "}]},{"type":"element","tag":"span","props":{"style":"--shiki-light:#39ADB5;--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"-"}]},{"type":"element","tag":"span","props":{"style":"--shiki-light:#90A4AE;--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"g xxx\n"}]}]}]}]},{"type":"element","tag":"h4","props":{"id":"pnpm-速度变慢了"},"children":[{"type":"text","value":"PNPM 速度变慢了？"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"今天逛官网时，偶然发现 Readme 中的 benchmark 过时了。它说“要比 Yarn Classic 和 npm “快两倍以上，但是从 benchmark 来看，他要比 Yarn 和 npm 慢了不少。以后启用 NodeJS 20 以上时，如果问题得不到改善，我应该会重新选择 npm 而不是 pnpm，鉴于幽灵依赖和依赖分身带来的问题是可排查可解决的，而速度是解决不了的问题。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"pnpm vs npm vs yarn benchmark","src":"https://mgear-image.oss-cn-shanghai.aliyuncs.com/image/other/20230605235736.png"},"children":[]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"相关见："},{"type":"element","tag":"a","props":{"href":"https://github.com/pnpm/pnpm/issues/6447","rel":["nofollow"]},"children":[{"type":"text","value":"pnpm seems to be consistently slower than yarn (classic)"}]}]},{"type":"element","tag":"h4","props":{"id":"和-bun-在安装速度上的对比"},"children":[{"type":"text","value":"和 Bun 在安装速度上的对比？"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"有锁文件、本地缓存，无 node_modules 的情况下，bun 要比 pnpm 安装至少快 3 倍。"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"一个原因是 pnpm、yarn 等工具会在安装时请求最新的 metadata，而 bun 使用的 metadata 源于本地缓存的 metadata。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"另一个原因是 pnpm 在创建 node_modules 层次结构是使用了大量的 symlink，相比其他包管理工具仅使用复制或 hardlink 有更多系统调用。"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"所以如果想使 pnpm 更快的安装，可以使用 prefer-offline 选项，以及，node-linker=hoisted 也许有用。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"见："},{"type":"element","tag":"a","props":{"href":"https://github.com/pnpm/pnpm/issues/7391","rel":["nofollow"]},"children":[{"type":"text","value":"Bun.sh-like Module Resolution"}]}]},{"type":"element","tag":"h4","props":{"id":"关于-v8-版本的变化"},"children":[{"type":"text","value":"关于 V8 版本的变化？"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"resolve-peers-from-workspace-root"}]},{"type":"text","value":" is "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"true"}]},{"type":"text","value":" by default"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"auto-install-peers"}]},{"type":"text","value":" is "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"true"}]},{"type":"text","value":" by default"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"dedupe-peer-dependents"}]},{"type":"text","value":" set to true by default"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"停止 NodeJS 14 的支持"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"lockfile v6 by default"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"resolution mode（prebundle、time-based、lowest-direct）default set to lowest-based，需要注意手动升级，尤其是在没有锁文件的情况"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"only deply "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"files"}]},{"type":"text","value":" field when the field exist"}]}]},{"type":"element","tag":"h4","props":{"id":"pnp-模式下的依赖提升设置"},"children":[{"type":"text","value":"PnP 模式下的依赖提升设置？"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"默认的 node_modules 依赖的层级处于严格和不严格之间的水平（semi-strict）。使用最严格的设置需要打开 PnP 模式，因为在 monorepo 中 PnP 模式中，就算开启了 "},{"type":"element","tag":"code","props":{"className":[]},"children":[{"type":"text","value":"hoist=false"}]},{"type":"text","value":" 也不会禁用 workspace root 的依赖"}]},{"type":"element","tag":"pre","props":{"code":"node-linker=pnp\nsymlink=false\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"node-linker=pnp\nsymlink=false\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"见："},{"type":"element","tag":"a","props":{"href":"https://pnpm.io/blog/2020/10/17/node-modules-configuration-options-with-pnpm","rel":["nofollow"]},"children":[{"type":"text","value":"Node-Modules configuration options with pnpm"}]}]},{"type":"element","tag":"h4","props":{"id":"在-windows-dev-driver-上可能会碰到的问题"},"children":[{"type":"text","value":"在 Windows Dev Driver 上可能会碰到的问题？"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"2024 年初 pnpm 实现了 Dev Driver 上的 Copy on Write 功能，但可能会碰到变慢的问题。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"见："},{"type":"element","tag":"a","props":{"href":"https://github.com/pnpm/pnpm/issues/7547","rel":["nofollow"]},"children":[{"type":"text","value":"pnpm lately slow and pnpx stuck at installing deps using executable package"}]}]},{"type":"element","tag":"h4","props":{"id":"下载多份二进制代码的问题"},"children":[{"type":"text","value":"下载多份二进制代码的问题？"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"目前应该是所有包管理器都有这种问题，但是不知道怎么解决。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"sass-embedded 下载了多份二进制代码","src":"https://mgear-image.oss-cn-shanghai.aliyuncs.com/image/other/202503200412724.png"},"children":[]}]},{"type":"element","tag":"style","props":{},"children":[{"type":"text","value":"html .light .shiki span {color: var(--shiki-light);background: var(--shiki-light-bg);font-style: var(--shiki-light-font-style);font-weight: var(--shiki-light-font-weight);text-decoration: var(--shiki-light-text-decoration);}html.light .shiki span {color: var(--shiki-light);background: var(--shiki-light-bg);font-style: var(--shiki-light-font-style);font-weight: var(--shiki-light-font-weight);text-decoration: var(--shiki-light-text-decoration);}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html .sepia .shiki span {color: var(--shiki-sepia);background: var(--shiki-sepia-bg);font-style: var(--shiki-sepia-font-style);font-weight: var(--shiki-sepia-font-weight);text-decoration: var(--shiki-sepia-text-decoration);}html.sepia .shiki span {color: var(--shiki-sepia);background: var(--shiki-sepia-bg);font-style: var(--shiki-sepia-font-style);font-weight: var(--shiki-sepia-font-weight);text-decoration: var(--shiki-sepia-text-decoration);}"}]}],"toc":{"title":"","searchDepth":2,"depth":2,"links":[{"id":"api-细节和配置项","depth":2,"text":"API 细节和配置项"},{"id":"原理","depth":2,"text":"原理"},{"id":"常见问题","depth":2,"text":"常见问题"}]}},"_type":"markdown","_id":"content:6.maps:_workflow:package-manager:pnpm.md","_source":"content","_file":"6.maps/_workflow/package-manager/pnpm.md","_stem":"6.maps/_workflow/package-manager/pnpm","_extension":"md"}