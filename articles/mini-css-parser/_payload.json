[{"data":1,"prerenderedAt":4675},["Reactive",2],{"navigation":3,"/articles/mini-css-parser":383,"/articles/mini-css-parser-surround":4670},[4,32,80,96,123,129,135,366,372,378],{"title":5,"_path":6,"children":7},"心流思绪 / Heart Flows","/flows",[8,11,14,17,20,23,26,29],{"title":9,"_path":10},"📕 狮子的书单推荐","/flows/books",{"title":12,"_path":13},"🌃 长夜梦","/flows/long-night-dream",{"title":15,"_path":16},"🌌 万物联结与幸福感","/flows/everything",{"title":18,"_path":19},"⌛ 偷取时间","/flows/stealing-time-from-god",{"title":21,"_path":22},"🌆 表达和孤独","/flows/expression-and-loneliness",{"title":24,"_path":25},"🌧️ 我的腼腆","/flows/shy",{"title":27,"_path":28},"🥛 新工作，喝新饮料","/flows/drinking-while-thinking",{"title":30,"_path":31},"📝 心流归档","/flows/fold",{"title":33,"_path":34,"children":35},"技术博客 / Coder","/articles",[36,38,41,44,47,50,53,56,59,62,65,68,71,74,77],{"title":37,"_path":34},"🦁 为什么我要写博客",{"title":39,"_path":40},"🧊 模板解析器轻考古","/articles/micro-templating",{"title":42,"_path":43},"Ⓜ️ Mini CSS Parser","/articles/mini-css-parser",{"title":45,"_path":46},"🚩 向AI咨询前端问题","/articles/use-gpt-learn-complex-frontend",{"title":48,"_path":49},"⛸️ 怎样定制复杂组件的自定义滚动条？","/articles/use-scrollbars",{"title":51,"_path":52},"⚖️ 统一多组件库的层叠顺序","/articles/zindex-manager",{"title":54,"_path":55},"🕷️ 滑动验证码破解思路","/articles/crack-the-slider",{"title":57,"_path":58},"🌟 探秘 CSS 光影效果","/articles/css-light-travel",{"title":60,"_path":61},"🍲 设计模式与 JS 魔法锅","/articles/design-patterns-and-js-magic-pot",{"title":63,"_path":64},"🌐 Anysort：灵活、优雅的多属性排序","/articles/anysort-2th",{"title":66,"_path":67},"💫 CSS 幻术 | 抗锯齿","/articles/css-poaa",{"title":69,"_path":70},"❓ 用纯CSS判断鼠标进入的方向","/articles/css-judge-direction",{"title":72,"_path":73},"📝 你本可以少写些 if-else","/articles/no-more-if-else",{"title":75,"_path":76},"🚝 四十二篇系列","/articles/fourty-two",{"title":78,"_path":79},"📝 技术博客归档","/articles/fold",{"title":81,"_path":82,"children":83},"造物 / Make","/tools",[84,87,90,93],{"title":85,"_path":86},"🌐 AnySort","/tools/anysort",{"title":88,"_path":89},"⛸️ UseScrollbar","/tools/use-scrollbar",{"title":91,"_path":92},"👓 Crapto","/tools/crypto-inline",{"title":94,"_path":95},"🖨️ any-to-base64","/tools/any-to-base64",{"title":97,"_path":98,"children":99},"吉他剧场 / Music","/music",[100,102,105,108,111,114,117,120],{"title":101,"_path":98},"🎸 FingerStyle！",{"title":103,"_path":104},"🌬️ 等待的风","/music/wind",{"title":106,"_path":107},"💕 约定的海洋","/music/ocean",{"title":109,"_path":110},"🎼 Wings~You are the Hero！","/music/wings-you-are-the-hero",{"title":112,"_path":113},"🌏 残酷天使的行动纲领","/music/eva",{"title":115,"_path":116},"🏔️ 奇跡の山","/music/miracle-mountain",{"title":118,"_path":119},"🍷 Wu Wei","/music/wu-wei",{"title":121,"_path":122},"🌅 无题","/music/untitled",{"title":124,"_path":125,"children":126},"画点什么 / Paint","/paint",[127],{"title":128,"_path":125},"🚧 正在施工",{"title":130,"_path":131,"children":132},"知识地图 / Maps","/maps",[133],{"title":134,"_path":131},"🏁 知识地图",{"title":136,"_path":137,"children":138},"零散的笔记 / Gists","/gists",[139,141,144,147,150,153,156,159,162,165,168,171,174,177,180,183,186,189,192,195,198,201,204,207,210,213,216,219,222,225,228,231,234,237,240,243,246,249,252,255,258,261,264,267,270,273,276,279,282,285,288,291,294,297,300,303,306,309,312,315,318,321,324,327,330,333,336,339,342,345,348,351,354,357,360,363],{"title":140,"_path":137},"🧊 Gists",{"title":142,"_path":143},"网站的可访问性","/gists/accessibility",{"title":145,"_path":146},"图片模糊","/gists/blur",{"title":148,"_path":149},"渲染相关笔记","/gists/c4d",{"title":151,"_path":152},"CDN 问题记录","/gists/cdn",{"title":154,"_path":155},"消毒剂","/gists/cleaner",{"title":157,"_path":158},"Windows Command","/gists/cmd",{"title":160,"_path":161},"Command","/gists/command",{"title":163,"_path":164},"复杂科学","/gists/complexity-science",{"title":166,"_path":167},"宇宙","/gists/cosmos",{"title":169,"_path":170},"C++","/gists/cpp",{"title":172,"_path":173},"Data Structure","/gists/data-structure",{"title":175,"_path":176},"DEPRESSION","/gists/depression",{"title":178,"_path":179},"设计模式","/gists/design-patterns",{"title":181,"_path":182},"Developer Experience","/gists/developer-experience",{"title":184,"_path":185},"Device Metrics","/gists/device-metrix",{"title":187,"_path":188},"ECMAScript Language Specification","/gists/ecmascript-specification",{"title":190,"_path":191},"正则表达式","/gists/eegex",{"title":193,"_path":194},"Emoji","/gists/emoji",{"title":196,"_path":197},"工程","/gists/engineering",{"title":199,"_path":200},"熵","/gists/entropy",{"title":202,"_path":203},"Environment","/gists/environment",{"title":205,"_path":206},"Erlang","/gists/erlang",{"title":208,"_path":209},"逃离塔克夫","/gists/escape-from-tarkov",{"title":211,"_path":212},"ESNext (ES6-ES11)","/gists/esnext",{"title":214,"_path":215},"Eval！","/gists/eval",{"title":217,"_path":218},"Flutter","/gists/flutter",{"title":220,"_path":221},"字体","/gists/font",{"title":223,"_path":224},"JS 函数式编程","/gists/functional",{"title":226,"_path":227},"Google C++ Standard","/gists/google-cpp-standard",{"title":229,"_path":230},"双向链接完全体","/gists/graph",{"title":232,"_path":233},"Hardwares","/gists/hardwares",{"title":235,"_path":236},"哈希冲突","/gists/hash-collision",{"title":238,"_path":239},"信息设计","/gists/information-design",{"title":241,"_path":242},"InstantPage","/gists/instant.page",{"title":244,"_path":245},"ISUX 遇见大数据可视化系列","/gists/isux-data-visualization",{"title":247,"_path":248},"KVStore","/gists/key-value-db",{"title":250,"_path":251},"Kubernetes","/gists/kubernetes",{"title":253,"_path":254},"Makefile","/gists/makefile",{"title":256,"_path":257},"Markdown Inline Style","/gists/markdown-nice",{"title":259,"_path":260},"小程序","/gists/miniapp",{"title":262,"_path":263},"减小页面快照体积","/gists/minify-html",{"title":265,"_path":266},"mklink","/gists/mklink",{"title":268,"_path":269},"Mock","/gists/mock",{"title":271,"_path":272},"多端应用","/gists/multy-end-app",{"title":274,"_path":275},"神经科学","/gists/neuroscience",{"title":277,"_path":278},"OO","/gists/oo",{"title":280,"_path":281},"Opinioned Personal Folder","/gists/opinioned-personal-folder",{"title":283,"_path":284},"人物","/gists/person",{"title":286,"_path":287},"PInvoke","/gists/pinvoke",{"title":289,"_path":290},"像素","/gists/pixel",{"title":292,"_path":293},"PowerShell","/gists/powershell",{"title":295,"_path":296},"量子","/gists/quantum",{"title":298,"_path":299},"保持好奇心","/gists/questions",{"title":301,"_path":302},"React Native","/gists/react-native",{"title":304,"_path":305},"博客改版碰到的浏览器平滑滚动问题","/gists/scroll",{"title":307,"_path":308},"SEO","/gists/seo",{"title":310,"_path":311},"Shader","/gists/shader",{"title":313,"_path":314},"Shape Up","/gists/shape-up",{"title":316,"_path":317},"睡觉","/gists/sleep",{"title":319,"_path":320},"States","/gists/states",{"title":322,"_path":323},"Storage","/gists/storage",{"title":325,"_path":326},"音视频流处理","/gists/stream-cli",{"title":328,"_path":329},"Symbol","/gists/symbol",{"title":331,"_path":332},"系统论","/gists/systems-theory",{"title":334,"_path":335},"Taro","/gists/taro",{"title":337,"_path":338},"任务切片","/gists/task-slice",{"title":340,"_path":341},"技术偏好","/gists/tech-dudge",{"title":343,"_path":344},"Untitled","/gists/untitled",{"title":346,"_path":347},"可变字体","/gists/variable-font",{"title":349,"_path":350},"视觉错觉","/gists/visual-illusion",{"title":352,"_path":353},"SS(SSR)","/gists/vpn",{"title":355,"_path":356},"VS Code 插件开发","/gists/vscode-plugin",{"title":358,"_path":359},"Web Components","/gists/web-components",{"title":361,"_path":362},"Windows","/gists/windows",{"title":364,"_path":365},"查缺补漏","/gists/wrong",{"title":367,"_path":368,"children":369},"代码笔记 / Gists","/source-code",[370],{"title":371,"_path":368},"🚄 代码笔记",{"title":373,"_path":374,"children":375},"我 / Abount","/hire",[376],{"title":377,"_path":374},"📬 技术简历",{"title":379,"_path":380,"children":381},"todo","/todo",[382],{"title":379,"_path":380},{"_path":43,"_dir":384,"_draft":385,"_partial":385,"_locale":386,"title":42,"description":387,"body":388,"_type":4665,"_id":4666,"_source":4667,"_file":4668,"_extension":4669},"articles",false,"","我的项目使用 micro-app 框架作为微前端框架。使用 micro-app 时，由于开启了样式隔离功能，子应用加载的 CSS 会被解析器解析，在选择器前增加一个子应用属性选择器前缀。我碰到的问题是，如果 CSS 源码中带嵌套语法那么解析就会失败。今天借这个问题给大家简单介绍一下 CSS Parser 的基本流程。",{"type":389,"children":390,"toc":4656},"root",[391,399,405,421,838,844,919,928,941,946,952,975,980,1298,1303,1680,1708,1779,1784,1804,1829,1901,1906,1911,2196,2208,2301,2340,2357,2640,2684,3159,3200,3751,3762,3802,3807,3819,3920,3955,3975,3995,4000,4005,4299,4304,4311,4316,4321,4329,4337,4345,4353,4388,4487,4495,4508,4513,4570,4575,4588,4593,4599,4611,4650],{"type":392,"tag":393,"props":394,"children":396},"element","h2",{"id":395},"前言",[397],{"type":398,"value":395},"text",{"type":392,"tag":400,"props":401,"children":402},"p",{},[403],{"type":398,"value":404},"Vue 源码中包含 HTML Parser，随着大家在框架方向的深入学习（卷），不免要开始接触一些编译解析相关的东西。社区很多看 Vue 源码时总结的 HTML Parser 的文章，但是很少有介绍 CSS Parser 的文章。今天借着在开发时碰到的一个问题，给大家简单介绍一下 CSS Parser 的基本流程。",{"type":392,"tag":400,"props":406,"children":407},{},[408,410,419],{"type":398,"value":409},"我的项目使用 micro-app 框架作为微前端框架。使用 micro-app 时，由于开启了样式隔离功能，子应用加载的 CSS 会被解析器解析，在选择器前增加一个子应用属性选择器前缀。代码示例见下。我碰到的问题是，如果 CSS 源码中带",{"type":392,"tag":411,"props":412,"children":416},"a",{"href":413,"rel":414},"https://caniuse.com/?search=css%20nesting",[415],"nofollow",[417],{"type":398,"value":418},"嵌套语法",{"type":398,"value":420},"，那么解析就会失败。",{"type":392,"tag":422,"props":423,"children":427},"pre",{"className":424,"code":425,"language":426,"meta":386,"style":386},"language-css shiki shiki-themes material-theme-lighter github-light github-dark monokai","/* css 源代码 */\n.a {\n  z-index: 1;\n  .b {\n    z-index: 2;\n  }\n}\n\n/* 期待转化得到的代码 */\nmicro-app[name=\"test-app\"] .a {\n  z-index: 1;\n  .b {\n    z-index: 2;\n  }\n}\n\n/* 实际得到的代码 */\nmicro-app[name=\"test-app\"] .a {\n  z-index: 1;\n  .b {\n    z-index: 2;\n  } /* -> 到这里就停了 */\n","css",[428],{"type":392,"tag":429,"props":430,"children":431},"code",{"__ignoreMap":386},[432,444,465,491,511,533,542,551,561,570,631,651,667,687,695,703,711,720,768,788,804,824],{"type":392,"tag":433,"props":434,"children":437},"span",{"class":435,"line":436},"line",1,[438],{"type":392,"tag":433,"props":439,"children":441},{"style":440},"--shiki-light:#90A4AE;--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F;--shiki-light-font-style:italic;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:inherit",[442],{"type":398,"value":443},"/* css 源代码 */\n",{"type":392,"tag":433,"props":445,"children":447},{"class":435,"line":446},2,[448,454,459],{"type":392,"tag":433,"props":449,"children":451},{"style":450},"--shiki-light:#39ADB5;--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E",[452],{"type":398,"value":453},".",{"type":392,"tag":433,"props":455,"children":457},{"style":456},"--shiki-light:#E2931D;--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E",[458],{"type":398,"value":411},{"type":392,"tag":433,"props":460,"children":462},{"style":461},"--shiki-light:#39ADB5;--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2",[463],{"type":398,"value":464}," {\n",{"type":392,"tag":433,"props":466,"children":468},{"class":435,"line":467},3,[469,475,480,486],{"type":392,"tag":433,"props":470,"children":472},{"style":471},"--shiki-light:#8796B0;--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF;--shiki-light-font-style:inherit;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic",[473],{"type":398,"value":474},"  z-index",{"type":392,"tag":433,"props":476,"children":477},{"style":461},[478],{"type":398,"value":479},":",{"type":392,"tag":433,"props":481,"children":483},{"style":482},"--shiki-light:#F76D47;--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF",[484],{"type":398,"value":485}," 1",{"type":392,"tag":433,"props":487,"children":488},{"style":461},[489],{"type":398,"value":490},";\n",{"type":392,"tag":433,"props":492,"children":494},{"class":435,"line":493},4,[495,501,507],{"type":392,"tag":433,"props":496,"children":498},{"style":497},"--shiki-light:#90A4AE;--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2",[499],{"type":398,"value":500},"  .",{"type":392,"tag":433,"props":502,"children":504},{"style":503},"--shiki-light:#90A4AE;--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#F8F8F2",[505],{"type":398,"value":506},"b",{"type":392,"tag":433,"props":508,"children":509},{"style":497},[510],{"type":398,"value":464},{"type":392,"tag":433,"props":512,"children":514},{"class":435,"line":513},5,[515,520,524,529],{"type":392,"tag":433,"props":516,"children":517},{"style":471},[518],{"type":398,"value":519},"    z-index",{"type":392,"tag":433,"props":521,"children":522},{"style":461},[523],{"type":398,"value":479},{"type":392,"tag":433,"props":525,"children":526},{"style":482},[527],{"type":398,"value":528}," 2",{"type":392,"tag":433,"props":530,"children":531},{"style":461},[532],{"type":398,"value":490},{"type":392,"tag":433,"props":534,"children":536},{"class":435,"line":535},6,[537],{"type":392,"tag":433,"props":538,"children":539},{"style":461},[540],{"type":398,"value":541},"  }\n",{"type":392,"tag":433,"props":543,"children":545},{"class":435,"line":544},7,[546],{"type":392,"tag":433,"props":547,"children":548},{"style":497},[549],{"type":398,"value":550},"}\n",{"type":392,"tag":433,"props":552,"children":554},{"class":435,"line":553},8,[555],{"type":392,"tag":433,"props":556,"children":558},{"emptyLinePlaceholder":557},true,[559],{"type":398,"value":560},"\n",{"type":392,"tag":433,"props":562,"children":564},{"class":435,"line":563},9,[565],{"type":392,"tag":433,"props":566,"children":567},{"style":440},[568],{"type":398,"value":569},"/* 期待转化得到的代码 */\n",{"type":392,"tag":433,"props":571,"children":573},{"class":435,"line":572},10,[574,580,585,591,597,603,609,613,618,623,627],{"type":392,"tag":433,"props":575,"children":577},{"style":576},"--shiki-light:#E2931D;--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672",[578],{"type":398,"value":579},"micro-app",{"type":392,"tag":433,"props":581,"children":582},{"style":461},[583],{"type":398,"value":584},"[",{"type":392,"tag":433,"props":586,"children":588},{"style":587},"--shiki-light:#9C3EDA;--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E",[589],{"type":398,"value":590},"name",{"type":392,"tag":433,"props":592,"children":594},{"style":593},"--shiki-light:#39ADB5;--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672",[595],{"type":398,"value":596},"=",{"type":392,"tag":433,"props":598,"children":600},{"style":599},"--shiki-light:#39ADB5;--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74",[601],{"type":398,"value":602},"\"",{"type":392,"tag":433,"props":604,"children":606},{"style":605},"--shiki-light:#91B859;--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74",[607],{"type":398,"value":608},"test-app",{"type":392,"tag":433,"props":610,"children":611},{"style":599},[612],{"type":398,"value":602},{"type":392,"tag":433,"props":614,"children":615},{"style":461},[616],{"type":398,"value":617},"]",{"type":392,"tag":433,"props":619,"children":620},{"style":450},[621],{"type":398,"value":622}," .",{"type":392,"tag":433,"props":624,"children":625},{"style":456},[626],{"type":398,"value":411},{"type":392,"tag":433,"props":628,"children":629},{"style":461},[630],{"type":398,"value":464},{"type":392,"tag":433,"props":632,"children":634},{"class":435,"line":633},11,[635,639,643,647],{"type":392,"tag":433,"props":636,"children":637},{"style":471},[638],{"type":398,"value":474},{"type":392,"tag":433,"props":640,"children":641},{"style":461},[642],{"type":398,"value":479},{"type":392,"tag":433,"props":644,"children":645},{"style":482},[646],{"type":398,"value":485},{"type":392,"tag":433,"props":648,"children":649},{"style":461},[650],{"type":398,"value":490},{"type":392,"tag":433,"props":652,"children":654},{"class":435,"line":653},12,[655,659,663],{"type":392,"tag":433,"props":656,"children":657},{"style":497},[658],{"type":398,"value":500},{"type":392,"tag":433,"props":660,"children":661},{"style":503},[662],{"type":398,"value":506},{"type":392,"tag":433,"props":664,"children":665},{"style":497},[666],{"type":398,"value":464},{"type":392,"tag":433,"props":668,"children":670},{"class":435,"line":669},13,[671,675,679,683],{"type":392,"tag":433,"props":672,"children":673},{"style":471},[674],{"type":398,"value":519},{"type":392,"tag":433,"props":676,"children":677},{"style":461},[678],{"type":398,"value":479},{"type":392,"tag":433,"props":680,"children":681},{"style":482},[682],{"type":398,"value":528},{"type":392,"tag":433,"props":684,"children":685},{"style":461},[686],{"type":398,"value":490},{"type":392,"tag":433,"props":688,"children":690},{"class":435,"line":689},14,[691],{"type":392,"tag":433,"props":692,"children":693},{"style":461},[694],{"type":398,"value":541},{"type":392,"tag":433,"props":696,"children":698},{"class":435,"line":697},15,[699],{"type":392,"tag":433,"props":700,"children":701},{"style":497},[702],{"type":398,"value":550},{"type":392,"tag":433,"props":704,"children":706},{"class":435,"line":705},16,[707],{"type":392,"tag":433,"props":708,"children":709},{"emptyLinePlaceholder":557},[710],{"type":398,"value":560},{"type":392,"tag":433,"props":712,"children":714},{"class":435,"line":713},17,[715],{"type":392,"tag":433,"props":716,"children":717},{"style":440},[718],{"type":398,"value":719},"/* 实际得到的代码 */\n",{"type":392,"tag":433,"props":721,"children":723},{"class":435,"line":722},18,[724,728,732,736,740,744,748,752,756,760,764],{"type":392,"tag":433,"props":725,"children":726},{"style":576},[727],{"type":398,"value":579},{"type":392,"tag":433,"props":729,"children":730},{"style":461},[731],{"type":398,"value":584},{"type":392,"tag":433,"props":733,"children":734},{"style":587},[735],{"type":398,"value":590},{"type":392,"tag":433,"props":737,"children":738},{"style":593},[739],{"type":398,"value":596},{"type":392,"tag":433,"props":741,"children":742},{"style":599},[743],{"type":398,"value":602},{"type":392,"tag":433,"props":745,"children":746},{"style":605},[747],{"type":398,"value":608},{"type":392,"tag":433,"props":749,"children":750},{"style":599},[751],{"type":398,"value":602},{"type":392,"tag":433,"props":753,"children":754},{"style":461},[755],{"type":398,"value":617},{"type":392,"tag":433,"props":757,"children":758},{"style":450},[759],{"type":398,"value":622},{"type":392,"tag":433,"props":761,"children":762},{"style":456},[763],{"type":398,"value":411},{"type":392,"tag":433,"props":765,"children":766},{"style":461},[767],{"type":398,"value":464},{"type":392,"tag":433,"props":769,"children":771},{"class":435,"line":770},19,[772,776,780,784],{"type":392,"tag":433,"props":773,"children":774},{"style":471},[775],{"type":398,"value":474},{"type":392,"tag":433,"props":777,"children":778},{"style":461},[779],{"type":398,"value":479},{"type":392,"tag":433,"props":781,"children":782},{"style":482},[783],{"type":398,"value":485},{"type":392,"tag":433,"props":785,"children":786},{"style":461},[787],{"type":398,"value":490},{"type":392,"tag":433,"props":789,"children":791},{"class":435,"line":790},20,[792,796,800],{"type":392,"tag":433,"props":793,"children":794},{"style":497},[795],{"type":398,"value":500},{"type":392,"tag":433,"props":797,"children":798},{"style":503},[799],{"type":398,"value":506},{"type":392,"tag":433,"props":801,"children":802},{"style":497},[803],{"type":398,"value":464},{"type":392,"tag":433,"props":805,"children":807},{"class":435,"line":806},21,[808,812,816,820],{"type":392,"tag":433,"props":809,"children":810},{"style":471},[811],{"type":398,"value":519},{"type":392,"tag":433,"props":813,"children":814},{"style":461},[815],{"type":398,"value":479},{"type":392,"tag":433,"props":817,"children":818},{"style":482},[819],{"type":398,"value":528},{"type":392,"tag":433,"props":821,"children":822},{"style":461},[823],{"type":398,"value":490},{"type":392,"tag":433,"props":825,"children":827},{"class":435,"line":826},22,[828,833],{"type":392,"tag":433,"props":829,"children":830},{"style":461},[831],{"type":398,"value":832},"  }",{"type":392,"tag":433,"props":834,"children":835},{"style":440},[836],{"type":398,"value":837}," /* -> 到这里就停了 */\n",{"type":392,"tag":393,"props":839,"children":841},{"id":840},"css-的组成部分",[842],{"type":398,"value":843},"CSS 的组成部分",{"type":392,"tag":400,"props":845,"children":846},{},[847,849,856,858,864,866,872,874,880,882,888,890,896,898,904,917],{"type":398,"value":848},"要理解 CSS 是怎么解析的，就要先清楚 CSS 是由哪几部分组成的。由我们平常见得最多的普通 CSS 代码开始说起，见下图，基本的 CSS 代码的组成部分包含规则集（rules）、选择器（selector）、选择器（declares）、属性（property）、值（value）这五个部分。",{"type":392,"tag":850,"props":851,"children":853},"abbr",{"title":852},"rule",[854],{"type":398,"value":855},"规则",{"type":398,"value":857},"是由",{"type":392,"tag":850,"props":859,"children":861},{"title":860},"property",[862],{"type":398,"value":863},"属性",{"type":398,"value":865},"和",{"type":392,"tag":850,"props":867,"children":869},{"title":868},"value",[870],{"type":398,"value":871},"值",{"type":398,"value":873},"组成的",{"type":392,"tag":850,"props":875,"children":877},{"title":876},"declaration",[878],{"type":398,"value":879},"声明",{"type":398,"value":881},"、声明与括号形成的",{"type":392,"tag":850,"props":883,"children":885},{"title":884},"declaration block",[886],{"type":398,"value":887},"声明块",{"type":398,"value":889},"再加上",{"type":392,"tag":850,"props":891,"children":893},{"title":892},"selector",[894],{"type":398,"value":895},"选择器",{"type":398,"value":897},"组成，而一条或多条规则组合成了",{"type":392,"tag":850,"props":899,"children":901},{"title":900},"rule sets",[902],{"type":398,"value":903},"规则集",{"type":392,"tag":905,"props":906,"children":907},"sup",{},[908],{"type":392,"tag":411,"props":909,"children":914},{"href":910,"ariaDescribedBy":911,"dataFootnoteRef":386,"id":913},"#user-content-fn-css-syntax",[912],"footnote-label","user-content-fnref-css-syntax",[915],{"type":398,"value":916},"1",{"type":398,"value":918},"。",{"type":392,"tag":400,"props":920,"children":921},{},[922],{"type":392,"tag":923,"props":924,"children":927},"img",{"alt":925,"src":926},"规则&规则集","https://mgear-image.oss-cn-shanghai.aliyuncs.com/image/200621/20200625022018.png",[],{"type":392,"tag":400,"props":929,"children":930},{},[931,933,939],{"type":398,"value":932},"图中没有包含 ",{"type":392,"tag":429,"props":934,"children":936},{"className":935},[],[937],{"type":398,"value":938},"at-rule",{"type":398,"value":940}," 的部分，哦，还少了注释部分~ 由于注释是 CSS 中语法最简单的部分，我们从解析注释开始代码部分的解读吧。",{"type":392,"tag":393,"props":942,"children":944},{"id":943},"流程速览",[945],{"type":398,"value":943},{"type":392,"tag":947,"props":948,"children":950},"h4",{"id":949},"解析注释",[951],{"type":398,"value":949},{"type":392,"tag":400,"props":953,"children":954},{},[955,957,964,966,973],{"type":398,"value":956},"可能许多人不了解 CSS 的注释风格，这里先说明一下，原生 CSS 仅支持",{"type":392,"tag":411,"props":958,"children":961},{"href":959,"rel":960},"https://developer.mozilla.org/zh-CN/docs/Web/CSS/Comments",[415],[962],{"type":398,"value":963},"斜杠星号风格注释",{"type":398,"value":965},"，不支持",{"type":392,"tag":411,"props":967,"children":970},{"href":968,"rel":969},"https://segmentfault.com/a/1190000043885414",[415],[971],{"type":398,"value":972},"双斜杠注释",{"type":398,"value":974},"，所以解析器并未处理双斜杠的情况。",{"type":392,"tag":400,"props":976,"children":977},{},[978],{"type":398,"value":979},"解析注释的函数是一个 while 循环，从代码开头开始匹配，每次循环解析一条注释，直到代码开头没有注释为止。",{"type":392,"tag":422,"props":981,"children":985},{"className":982,"code":983,"language":984,"meta":386,"style":386},"language-ts shiki shiki-themes material-theme-lighter github-light github-dark monokai","class CSSParser {\n  private matchComments() {\n    while (this.matchComment());\n  }\n  private matchComment () {\n    // 快速跳过非注释部分代码\n    if (this.cssText.charAt(0) !== '/' || this.cssText.charAt(1) !== '*') {\n      return false\n    }\n    // ...\n    return true\n  }\n}\n","ts",[986],{"type":392,"tag":429,"props":987,"children":988},{"__ignoreMap":386},[989,1008,1032,1072,1079,1100,1108,1241,1255,1263,1271,1284,1291],{"type":392,"tag":433,"props":990,"children":991},{"class":435,"line":436},[992,998,1004],{"type":392,"tag":433,"props":993,"children":995},{"style":994},"--shiki-light:#9C3EDA;--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-light-font-style:inherit;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic",[996],{"type":398,"value":997},"class",{"type":392,"tag":433,"props":999,"children":1001},{"style":1000},"--shiki-light:#E2931D;--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E;--shiki-light-text-decoration:inherit;--shiki-default-text-decoration:inherit;--shiki-dark-text-decoration:inherit;--shiki-sepia-text-decoration:underline",[1002],{"type":398,"value":1003}," CSSParser",{"type":392,"tag":433,"props":1005,"children":1006},{"style":461},[1007],{"type":398,"value":464},{"type":392,"tag":433,"props":1009,"children":1010},{"class":435,"line":446},[1011,1017,1023,1028],{"type":392,"tag":433,"props":1012,"children":1014},{"style":1013},"--shiki-light:#9C3EDA;--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672",[1015],{"type":398,"value":1016},"  private",{"type":392,"tag":433,"props":1018,"children":1020},{"style":1019},"--shiki-light:#E53935;--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E",[1021],{"type":398,"value":1022}," matchComments",{"type":392,"tag":433,"props":1024,"children":1025},{"style":461},[1026],{"type":398,"value":1027},"()",{"type":392,"tag":433,"props":1029,"children":1030},{"style":461},[1031],{"type":398,"value":464},{"type":392,"tag":433,"props":1033,"children":1034},{"class":435,"line":467},[1035,1041,1047,1053,1057,1063,1068],{"type":392,"tag":433,"props":1036,"children":1038},{"style":1037},"--shiki-light:#39ADB5;--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672;--shiki-light-font-style:italic;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:inherit",[1039],{"type":398,"value":1040},"    while",{"type":392,"tag":433,"props":1042,"children":1044},{"style":1043},"--shiki-light:#E53935;--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2",[1045],{"type":398,"value":1046}," (",{"type":392,"tag":433,"props":1048,"children":1050},{"style":1049},"--shiki-light:#39ADB5;--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F",[1051],{"type":398,"value":1052},"this",{"type":392,"tag":433,"props":1054,"children":1055},{"style":461},[1056],{"type":398,"value":453},{"type":392,"tag":433,"props":1058,"children":1060},{"style":1059},"--shiki-light:#6182B8;--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E",[1061],{"type":398,"value":1062},"matchComment",{"type":392,"tag":433,"props":1064,"children":1065},{"style":1043},[1066],{"type":398,"value":1067},"())",{"type":392,"tag":433,"props":1069,"children":1070},{"style":461},[1071],{"type":398,"value":490},{"type":392,"tag":433,"props":1073,"children":1074},{"class":435,"line":493},[1075],{"type":392,"tag":433,"props":1076,"children":1077},{"style":461},[1078],{"type":398,"value":541},{"type":392,"tag":433,"props":1080,"children":1081},{"class":435,"line":513},[1082,1086,1091,1096],{"type":392,"tag":433,"props":1083,"children":1084},{"style":1013},[1085],{"type":398,"value":1016},{"type":392,"tag":433,"props":1087,"children":1088},{"style":1019},[1089],{"type":398,"value":1090}," matchComment",{"type":392,"tag":433,"props":1092,"children":1093},{"style":461},[1094],{"type":398,"value":1095}," ()",{"type":392,"tag":433,"props":1097,"children":1098},{"style":461},[1099],{"type":398,"value":464},{"type":392,"tag":433,"props":1101,"children":1102},{"class":435,"line":535},[1103],{"type":392,"tag":433,"props":1104,"children":1105},{"style":440},[1106],{"type":398,"value":1107},"    // 快速跳过非注释部分代码\n",{"type":392,"tag":433,"props":1109,"children":1110},{"class":435,"line":544},[1111,1116,1120,1124,1128,1133,1137,1142,1147,1152,1157,1162,1167,1172,1177,1182,1187,1191,1195,1199,1203,1207,1211,1215,1219,1223,1228,1232,1236],{"type":392,"tag":433,"props":1112,"children":1113},{"style":1037},[1114],{"type":398,"value":1115},"    if",{"type":392,"tag":433,"props":1117,"children":1118},{"style":1043},[1119],{"type":398,"value":1046},{"type":392,"tag":433,"props":1121,"children":1122},{"style":1049},[1123],{"type":398,"value":1052},{"type":392,"tag":433,"props":1125,"children":1126},{"style":461},[1127],{"type":398,"value":453},{"type":392,"tag":433,"props":1129,"children":1130},{"style":497},[1131],{"type":398,"value":1132},"cssText",{"type":392,"tag":433,"props":1134,"children":1135},{"style":461},[1136],{"type":398,"value":453},{"type":392,"tag":433,"props":1138,"children":1139},{"style":1059},[1140],{"type":398,"value":1141},"charAt",{"type":392,"tag":433,"props":1143,"children":1144},{"style":1043},[1145],{"type":398,"value":1146},"(",{"type":392,"tag":433,"props":1148,"children":1149},{"style":482},[1150],{"type":398,"value":1151},"0",{"type":392,"tag":433,"props":1153,"children":1154},{"style":1043},[1155],{"type":398,"value":1156},") ",{"type":392,"tag":433,"props":1158,"children":1159},{"style":593},[1160],{"type":398,"value":1161},"!==",{"type":392,"tag":433,"props":1163,"children":1164},{"style":599},[1165],{"type":398,"value":1166}," '",{"type":392,"tag":433,"props":1168,"children":1169},{"style":605},[1170],{"type":398,"value":1171},"/",{"type":392,"tag":433,"props":1173,"children":1174},{"style":599},[1175],{"type":398,"value":1176},"'",{"type":392,"tag":433,"props":1178,"children":1179},{"style":593},[1180],{"type":398,"value":1181}," ||",{"type":392,"tag":433,"props":1183,"children":1184},{"style":1049},[1185],{"type":398,"value":1186}," this",{"type":392,"tag":433,"props":1188,"children":1189},{"style":461},[1190],{"type":398,"value":453},{"type":392,"tag":433,"props":1192,"children":1193},{"style":497},[1194],{"type":398,"value":1132},{"type":392,"tag":433,"props":1196,"children":1197},{"style":461},[1198],{"type":398,"value":453},{"type":392,"tag":433,"props":1200,"children":1201},{"style":1059},[1202],{"type":398,"value":1141},{"type":392,"tag":433,"props":1204,"children":1205},{"style":1043},[1206],{"type":398,"value":1146},{"type":392,"tag":433,"props":1208,"children":1209},{"style":482},[1210],{"type":398,"value":916},{"type":392,"tag":433,"props":1212,"children":1213},{"style":1043},[1214],{"type":398,"value":1156},{"type":392,"tag":433,"props":1216,"children":1217},{"style":593},[1218],{"type":398,"value":1161},{"type":392,"tag":433,"props":1220,"children":1221},{"style":599},[1222],{"type":398,"value":1166},{"type":392,"tag":433,"props":1224,"children":1225},{"style":605},[1226],{"type":398,"value":1227},"*",{"type":392,"tag":433,"props":1229,"children":1230},{"style":599},[1231],{"type":398,"value":1176},{"type":392,"tag":433,"props":1233,"children":1234},{"style":1043},[1235],{"type":398,"value":1156},{"type":392,"tag":433,"props":1237,"children":1238},{"style":461},[1239],{"type":398,"value":1240},"{\n",{"type":392,"tag":433,"props":1242,"children":1243},{"class":435,"line":553},[1244,1249],{"type":392,"tag":433,"props":1245,"children":1246},{"style":1037},[1247],{"type":398,"value":1248},"      return",{"type":392,"tag":433,"props":1250,"children":1252},{"style":1251},"--shiki-light:#FF5370;--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF",[1253],{"type":398,"value":1254}," false\n",{"type":392,"tag":433,"props":1256,"children":1257},{"class":435,"line":563},[1258],{"type":392,"tag":433,"props":1259,"children":1260},{"style":461},[1261],{"type":398,"value":1262},"    }\n",{"type":392,"tag":433,"props":1264,"children":1265},{"class":435,"line":572},[1266],{"type":392,"tag":433,"props":1267,"children":1268},{"style":440},[1269],{"type":398,"value":1270},"    // ...\n",{"type":392,"tag":433,"props":1272,"children":1273},{"class":435,"line":633},[1274,1279],{"type":392,"tag":433,"props":1275,"children":1276},{"style":1037},[1277],{"type":398,"value":1278},"    return",{"type":392,"tag":433,"props":1280,"children":1281},{"style":1251},[1282],{"type":398,"value":1283}," true\n",{"type":392,"tag":433,"props":1285,"children":1286},{"class":435,"line":653},[1287],{"type":392,"tag":433,"props":1288,"children":1289},{"style":461},[1290],{"type":398,"value":541},{"type":392,"tag":433,"props":1292,"children":1293},{"class":435,"line":669},[1294],{"type":392,"tag":433,"props":1295,"children":1296},{"style":461},[1297],{"type":398,"value":550},{"type":392,"tag":400,"props":1299,"children":1300},{},[1301],{"type":398,"value":1302},"在选择解析注释内容的方法上，micro-app 没有使用正则，而是用了下标递增的办法。暂不清楚原因，感兴趣的小伙伴可以试试几种相关办法的性能对比。",{"type":392,"tag":422,"props":1304,"children":1306},{"className":982,"code":1305,"language":984,"meta":386,"style":386},"let i = 2\nwhile (\n  this.cssText.charAt(i) !== '' && \n  (this.cssText.charAt(i) !== '*' || this.cssText.charAt(i + 1) !== '/')\n) {\n  ++i\n}\ni += 2\n\nlet commentText = this.cssText.slice(2, i - 2)\n/* ... */\nthis.cssText = this.cssText.slice(i)\n",[1307],{"type":392,"tag":429,"props":1308,"children":1309},{"__ignoreMap":386},[1310,1332,1345,1393,1504,1515,1528,1535,1552,1559,1627,1635],{"type":392,"tag":433,"props":1311,"children":1312},{"class":435,"line":436},[1313,1318,1323,1327],{"type":392,"tag":433,"props":1314,"children":1315},{"style":994},[1316],{"type":398,"value":1317},"let",{"type":392,"tag":433,"props":1319,"children":1320},{"style":497},[1321],{"type":398,"value":1322}," i ",{"type":392,"tag":433,"props":1324,"children":1325},{"style":593},[1326],{"type":398,"value":596},{"type":392,"tag":433,"props":1328,"children":1329},{"style":482},[1330],{"type":398,"value":1331}," 2\n",{"type":392,"tag":433,"props":1333,"children":1334},{"class":435,"line":446},[1335,1340],{"type":392,"tag":433,"props":1336,"children":1337},{"style":1037},[1338],{"type":398,"value":1339},"while",{"type":392,"tag":433,"props":1341,"children":1342},{"style":497},[1343],{"type":398,"value":1344}," (\n",{"type":392,"tag":433,"props":1346,"children":1347},{"class":435,"line":467},[1348,1353,1357,1361,1365,1369,1374,1378,1383,1388],{"type":392,"tag":433,"props":1349,"children":1350},{"style":1049},[1351],{"type":398,"value":1352},"  this",{"type":392,"tag":433,"props":1354,"children":1355},{"style":461},[1356],{"type":398,"value":453},{"type":392,"tag":433,"props":1358,"children":1359},{"style":497},[1360],{"type":398,"value":1132},{"type":392,"tag":433,"props":1362,"children":1363},{"style":461},[1364],{"type":398,"value":453},{"type":392,"tag":433,"props":1366,"children":1367},{"style":1059},[1368],{"type":398,"value":1141},{"type":392,"tag":433,"props":1370,"children":1371},{"style":497},[1372],{"type":398,"value":1373},"(i) ",{"type":392,"tag":433,"props":1375,"children":1376},{"style":593},[1377],{"type":398,"value":1161},{"type":392,"tag":433,"props":1379,"children":1380},{"style":599},[1381],{"type":398,"value":1382}," ''",{"type":392,"tag":433,"props":1384,"children":1385},{"style":593},[1386],{"type":398,"value":1387}," &&",{"type":392,"tag":433,"props":1389,"children":1390},{"style":497},[1391],{"type":398,"value":1392}," \n",{"type":392,"tag":433,"props":1394,"children":1395},{"class":435,"line":493},[1396,1401,1405,1409,1413,1417,1421,1425,1429,1433,1437,1441,1445,1449,1453,1457,1461,1465,1470,1475,1479,1483,1487,1491,1495,1499],{"type":392,"tag":433,"props":1397,"children":1398},{"style":497},[1399],{"type":398,"value":1400},"  (",{"type":392,"tag":433,"props":1402,"children":1403},{"style":1049},[1404],{"type":398,"value":1052},{"type":392,"tag":433,"props":1406,"children":1407},{"style":461},[1408],{"type":398,"value":453},{"type":392,"tag":433,"props":1410,"children":1411},{"style":497},[1412],{"type":398,"value":1132},{"type":392,"tag":433,"props":1414,"children":1415},{"style":461},[1416],{"type":398,"value":453},{"type":392,"tag":433,"props":1418,"children":1419},{"style":1059},[1420],{"type":398,"value":1141},{"type":392,"tag":433,"props":1422,"children":1423},{"style":497},[1424],{"type":398,"value":1373},{"type":392,"tag":433,"props":1426,"children":1427},{"style":593},[1428],{"type":398,"value":1161},{"type":392,"tag":433,"props":1430,"children":1431},{"style":599},[1432],{"type":398,"value":1166},{"type":392,"tag":433,"props":1434,"children":1435},{"style":605},[1436],{"type":398,"value":1227},{"type":392,"tag":433,"props":1438,"children":1439},{"style":599},[1440],{"type":398,"value":1176},{"type":392,"tag":433,"props":1442,"children":1443},{"style":593},[1444],{"type":398,"value":1181},{"type":392,"tag":433,"props":1446,"children":1447},{"style":1049},[1448],{"type":398,"value":1186},{"type":392,"tag":433,"props":1450,"children":1451},{"style":461},[1452],{"type":398,"value":453},{"type":392,"tag":433,"props":1454,"children":1455},{"style":497},[1456],{"type":398,"value":1132},{"type":392,"tag":433,"props":1458,"children":1459},{"style":461},[1460],{"type":398,"value":453},{"type":392,"tag":433,"props":1462,"children":1463},{"style":1059},[1464],{"type":398,"value":1141},{"type":392,"tag":433,"props":1466,"children":1467},{"style":497},[1468],{"type":398,"value":1469},"(i ",{"type":392,"tag":433,"props":1471,"children":1472},{"style":593},[1473],{"type":398,"value":1474},"+",{"type":392,"tag":433,"props":1476,"children":1477},{"style":482},[1478],{"type":398,"value":485},{"type":392,"tag":433,"props":1480,"children":1481},{"style":497},[1482],{"type":398,"value":1156},{"type":392,"tag":433,"props":1484,"children":1485},{"style":593},[1486],{"type":398,"value":1161},{"type":392,"tag":433,"props":1488,"children":1489},{"style":599},[1490],{"type":398,"value":1166},{"type":392,"tag":433,"props":1492,"children":1493},{"style":605},[1494],{"type":398,"value":1171},{"type":392,"tag":433,"props":1496,"children":1497},{"style":599},[1498],{"type":398,"value":1176},{"type":392,"tag":433,"props":1500,"children":1501},{"style":497},[1502],{"type":398,"value":1503},")\n",{"type":392,"tag":433,"props":1505,"children":1506},{"class":435,"line":513},[1507,1511],{"type":392,"tag":433,"props":1508,"children":1509},{"style":497},[1510],{"type":398,"value":1156},{"type":392,"tag":433,"props":1512,"children":1513},{"style":461},[1514],{"type":398,"value":1240},{"type":392,"tag":433,"props":1516,"children":1517},{"class":435,"line":535},[1518,1523],{"type":392,"tag":433,"props":1519,"children":1520},{"style":593},[1521],{"type":398,"value":1522},"  ++",{"type":392,"tag":433,"props":1524,"children":1525},{"style":497},[1526],{"type":398,"value":1527},"i\n",{"type":392,"tag":433,"props":1529,"children":1530},{"class":435,"line":544},[1531],{"type":392,"tag":433,"props":1532,"children":1533},{"style":461},[1534],{"type":398,"value":550},{"type":392,"tag":433,"props":1536,"children":1537},{"class":435,"line":553},[1538,1543,1548],{"type":392,"tag":433,"props":1539,"children":1540},{"style":497},[1541],{"type":398,"value":1542},"i ",{"type":392,"tag":433,"props":1544,"children":1545},{"style":593},[1546],{"type":398,"value":1547},"+=",{"type":392,"tag":433,"props":1549,"children":1550},{"style":482},[1551],{"type":398,"value":1331},{"type":392,"tag":433,"props":1553,"children":1554},{"class":435,"line":563},[1555],{"type":392,"tag":433,"props":1556,"children":1557},{"emptyLinePlaceholder":557},[1558],{"type":398,"value":560},{"type":392,"tag":433,"props":1560,"children":1561},{"class":435,"line":572},[1562,1566,1571,1575,1579,1583,1587,1591,1596,1600,1605,1610,1614,1619,1623],{"type":392,"tag":433,"props":1563,"children":1564},{"style":994},[1565],{"type":398,"value":1317},{"type":392,"tag":433,"props":1567,"children":1568},{"style":497},[1569],{"type":398,"value":1570}," commentText ",{"type":392,"tag":433,"props":1572,"children":1573},{"style":593},[1574],{"type":398,"value":596},{"type":392,"tag":433,"props":1576,"children":1577},{"style":1049},[1578],{"type":398,"value":1186},{"type":392,"tag":433,"props":1580,"children":1581},{"style":461},[1582],{"type":398,"value":453},{"type":392,"tag":433,"props":1584,"children":1585},{"style":497},[1586],{"type":398,"value":1132},{"type":392,"tag":433,"props":1588,"children":1589},{"style":461},[1590],{"type":398,"value":453},{"type":392,"tag":433,"props":1592,"children":1593},{"style":1059},[1594],{"type":398,"value":1595},"slice",{"type":392,"tag":433,"props":1597,"children":1598},{"style":497},[1599],{"type":398,"value":1146},{"type":392,"tag":433,"props":1601,"children":1602},{"style":482},[1603],{"type":398,"value":1604},"2",{"type":392,"tag":433,"props":1606,"children":1607},{"style":461},[1608],{"type":398,"value":1609},",",{"type":392,"tag":433,"props":1611,"children":1612},{"style":497},[1613],{"type":398,"value":1322},{"type":392,"tag":433,"props":1615,"children":1616},{"style":593},[1617],{"type":398,"value":1618},"-",{"type":392,"tag":433,"props":1620,"children":1621},{"style":482},[1622],{"type":398,"value":528},{"type":392,"tag":433,"props":1624,"children":1625},{"style":497},[1626],{"type":398,"value":1503},{"type":392,"tag":433,"props":1628,"children":1629},{"class":435,"line":633},[1630],{"type":392,"tag":433,"props":1631,"children":1632},{"style":440},[1633],{"type":398,"value":1634},"/* ... */\n",{"type":392,"tag":433,"props":1636,"children":1637},{"class":435,"line":653},[1638,1642,1646,1651,1655,1659,1663,1667,1671,1675],{"type":392,"tag":433,"props":1639,"children":1640},{"style":1049},[1641],{"type":398,"value":1052},{"type":392,"tag":433,"props":1643,"children":1644},{"style":461},[1645],{"type":398,"value":453},{"type":392,"tag":433,"props":1647,"children":1648},{"style":497},[1649],{"type":398,"value":1650},"cssText ",{"type":392,"tag":433,"props":1652,"children":1653},{"style":593},[1654],{"type":398,"value":596},{"type":392,"tag":433,"props":1656,"children":1657},{"style":1049},[1658],{"type":398,"value":1186},{"type":392,"tag":433,"props":1660,"children":1661},{"style":461},[1662],{"type":398,"value":453},{"type":392,"tag":433,"props":1664,"children":1665},{"style":497},[1666],{"type":398,"value":1132},{"type":392,"tag":433,"props":1668,"children":1669},{"style":461},[1670],{"type":398,"value":453},{"type":392,"tag":433,"props":1672,"children":1673},{"style":1059},[1674],{"type":398,"value":1595},{"type":392,"tag":433,"props":1676,"children":1677},{"style":497},[1678],{"type":398,"value":1679},"(i)\n",{"type":392,"tag":400,"props":1681,"children":1682},{},[1683,1685,1691,1693,1698,1700,1706],{"type":398,"value":1684},"注释的正文结果保存在了变量 ",{"type":392,"tag":429,"props":1686,"children":1688},{"className":1687},[],[1689],{"type":398,"value":1690},"commentText",{"type":398,"value":1692}," 中，这样可以判断 ",{"type":392,"tag":429,"props":1694,"children":1696},{"className":1695},[],[1697],{"type":398,"value":1690},{"type":398,"value":1699}," 的内容来实现通过注释禁用某个选择器、禁用某行的样式隔离之类的功能。比如想让 ",{"type":392,"tag":429,"props":1701,"children":1703},{"className":1702},[],[1704],{"type":398,"value":1705},".test2",{"type":398,"value":1707}," 选择器不被 scoped 规则覆盖，我们可以在业务代码中这样写。",{"type":392,"tag":422,"props":1709,"children":1711},{"className":424,"code":1710,"language":426,"meta":386,"style":386},"/*! scopecss-disable-next-line */\n.test2 {\n  background: url(/test.png);\n}\n",[1712],{"type":392,"tag":429,"props":1713,"children":1714},{"__ignoreMap":386},[1715,1723,1739,1772],{"type":392,"tag":433,"props":1716,"children":1717},{"class":435,"line":436},[1718],{"type":392,"tag":433,"props":1719,"children":1720},{"style":440},[1721],{"type":398,"value":1722},"/*! scopecss-disable-next-line */\n",{"type":392,"tag":433,"props":1724,"children":1725},{"class":435,"line":446},[1726,1730,1735],{"type":392,"tag":433,"props":1727,"children":1728},{"style":450},[1729],{"type":398,"value":453},{"type":392,"tag":433,"props":1731,"children":1732},{"style":456},[1733],{"type":398,"value":1734},"test2",{"type":392,"tag":433,"props":1736,"children":1737},{"style":461},[1738],{"type":398,"value":464},{"type":392,"tag":433,"props":1740,"children":1741},{"class":435,"line":467},[1742,1747,1751,1757,1761,1767],{"type":392,"tag":433,"props":1743,"children":1744},{"style":471},[1745],{"type":398,"value":1746},"  background",{"type":392,"tag":433,"props":1748,"children":1749},{"style":461},[1750],{"type":398,"value":479},{"type":392,"tag":433,"props":1752,"children":1754},{"style":1753},"--shiki-light:#6182B8;--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF",[1755],{"type":398,"value":1756}," url",{"type":392,"tag":433,"props":1758,"children":1759},{"style":461},[1760],{"type":398,"value":1146},{"type":392,"tag":433,"props":1762,"children":1764},{"style":1763},"--shiki-light:#90A4AE;--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-light-font-style:italic;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic",[1765],{"type":398,"value":1766},"/test.png",{"type":392,"tag":433,"props":1768,"children":1769},{"style":461},[1770],{"type":398,"value":1771},");\n",{"type":392,"tag":433,"props":1773,"children":1774},{"class":435,"line":493},[1775],{"type":392,"tag":433,"props":1776,"children":1777},{"style":461},[1778],{"type":398,"value":550},{"type":392,"tag":947,"props":1780,"children":1782},{"id":1781},"输入输出",[1783],{"type":398,"value":1781},{"type":392,"tag":400,"props":1785,"children":1786},{},[1787,1789,1794,1796,1802],{"type":398,"value":1788},"“解析注释”中“解析”实际指对输入的 CSS 源文件待处理部分以及处理好的输出部分做出改变。这里引申出解析器里两个关键状态，",{"type":392,"tag":429,"props":1790,"children":1792},{"className":1791},[],[1793],{"type":398,"value":1132},{"type":398,"value":1795}," 和 ",{"type":392,"tag":429,"props":1797,"children":1799},{"className":1798},[],[1800],{"type":398,"value":1801},"result",{"type":398,"value":1803},"，分别代表待解析的内容和最终输出结果。",{"type":392,"tag":400,"props":1805,"children":1806},{},[1807,1812,1814,1819,1821,1827],{"type":392,"tag":429,"props":1808,"children":1810},{"className":1809},[],[1811],{"type":398,"value":1132},{"type":398,"value":1813}," 随着循环应当逐渐减小直到为空，此时代表解析完成。",{"type":392,"tag":429,"props":1815,"children":1817},{"className":1816},[],[1818],{"type":398,"value":1801},{"type":398,"value":1820}," 能被内部方法 ",{"type":392,"tag":429,"props":1822,"children":1824},{"className":1823},[],[1825],{"type":398,"value":1826},"recordResult",{"type":398,"value":1828}," 改变，比如如果要把注释的正文内容记录到输出结果，可以这样使用：",{"type":392,"tag":422,"props":1830,"children":1832},{"className":982,"code":1831,"language":984,"meta":386,"style":386},"this.recordResult(`/*${commentText}*/`)\n// 相当于：this.result += `/*${commentText}*/`\n",[1833],{"type":392,"tag":429,"props":1834,"children":1835},{"__ignoreMap":386},[1836,1893],{"type":392,"tag":433,"props":1837,"children":1838},{"class":435,"line":436},[1839,1843,1847,1851,1855,1860,1865,1871,1875,1880,1885,1889],{"type":392,"tag":433,"props":1840,"children":1841},{"style":1049},[1842],{"type":398,"value":1052},{"type":392,"tag":433,"props":1844,"children":1845},{"style":461},[1846],{"type":398,"value":453},{"type":392,"tag":433,"props":1848,"children":1849},{"style":1059},[1850],{"type":398,"value":1826},{"type":392,"tag":433,"props":1852,"children":1853},{"style":497},[1854],{"type":398,"value":1146},{"type":392,"tag":433,"props":1856,"children":1857},{"style":599},[1858],{"type":398,"value":1859},"`",{"type":392,"tag":433,"props":1861,"children":1862},{"style":605},[1863],{"type":398,"value":1864},"/*",{"type":392,"tag":433,"props":1866,"children":1868},{"style":1867},"--shiki-light:#39ADB5;--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#F92672",[1869],{"type":398,"value":1870},"${",{"type":392,"tag":433,"props":1872,"children":1873},{"style":497},[1874],{"type":398,"value":1690},{"type":392,"tag":433,"props":1876,"children":1877},{"style":1867},[1878],{"type":398,"value":1879},"}",{"type":392,"tag":433,"props":1881,"children":1882},{"style":605},[1883],{"type":398,"value":1884},"*/",{"type":392,"tag":433,"props":1886,"children":1887},{"style":599},[1888],{"type":398,"value":1859},{"type":392,"tag":433,"props":1890,"children":1891},{"style":497},[1892],{"type":398,"value":1503},{"type":392,"tag":433,"props":1894,"children":1895},{"class":435,"line":446},[1896],{"type":392,"tag":433,"props":1897,"children":1898},{"style":440},[1899],{"type":398,"value":1900},"// 相当于：this.result += `/*${commentText}*/`\n",{"type":392,"tag":947,"props":1902,"children":1904},{"id":1903},"解析规则集",[1905],{"type":398,"value":1903},{"type":392,"tag":400,"props":1907,"children":1908},{},[1909],{"type":398,"value":1910},"规则集的解析是整个解析的核心过程。原理与解析注释类似，也是一个 while 循环。每一轮循环都会尝试匹配一条规则，并且将多余的注释和空白字符匹配出来。",{"type":392,"tag":422,"props":1912,"children":1914},{"className":982,"code":1913,"language":984,"meta":386,"style":386},"private matchRules (): void {\n  this.matchLeadingSpaces()\n  this.matchComments()\n  while (\n    this.cssText.length &&\n    this.cssText.charAt(0) !== '}' &&\n    (this.matchAtRule() || this.matchStyleRule())\n  ) {\n    this.matchComments()\n    this.matchLeadingSpaces()\n  }\n}\n",[1915],{"type":392,"tag":429,"props":1916,"children":1917},{"__ignoreMap":386},[1918,1945,1966,1986,1998,2028,2083,2132,2144,2163,2182,2189],{"type":392,"tag":433,"props":1919,"children":1920},{"class":435,"line":436},[1921,1926,1931,1936,1941],{"type":392,"tag":433,"props":1922,"children":1923},{"style":497},[1924],{"type":398,"value":1925},"private ",{"type":392,"tag":433,"props":1927,"children":1928},{"style":1059},[1929],{"type":398,"value":1930},"matchRules",{"type":392,"tag":433,"props":1932,"children":1933},{"style":497},[1934],{"type":398,"value":1935}," (): ",{"type":392,"tag":433,"props":1937,"children":1938},{"style":593},[1939],{"type":398,"value":1940},"void",{"type":392,"tag":433,"props":1942,"children":1943},{"style":461},[1944],{"type":398,"value":464},{"type":392,"tag":433,"props":1946,"children":1947},{"class":435,"line":446},[1948,1952,1956,1961],{"type":392,"tag":433,"props":1949,"children":1950},{"style":1049},[1951],{"type":398,"value":1352},{"type":392,"tag":433,"props":1953,"children":1954},{"style":461},[1955],{"type":398,"value":453},{"type":392,"tag":433,"props":1957,"children":1958},{"style":1059},[1959],{"type":398,"value":1960},"matchLeadingSpaces",{"type":392,"tag":433,"props":1962,"children":1963},{"style":1043},[1964],{"type":398,"value":1965},"()\n",{"type":392,"tag":433,"props":1967,"children":1968},{"class":435,"line":467},[1969,1973,1977,1982],{"type":392,"tag":433,"props":1970,"children":1971},{"style":1049},[1972],{"type":398,"value":1352},{"type":392,"tag":433,"props":1974,"children":1975},{"style":461},[1976],{"type":398,"value":453},{"type":392,"tag":433,"props":1978,"children":1979},{"style":1059},[1980],{"type":398,"value":1981},"matchComments",{"type":392,"tag":433,"props":1983,"children":1984},{"style":1043},[1985],{"type":398,"value":1965},{"type":392,"tag":433,"props":1987,"children":1988},{"class":435,"line":493},[1989,1994],{"type":392,"tag":433,"props":1990,"children":1991},{"style":1037},[1992],{"type":398,"value":1993},"  while",{"type":392,"tag":433,"props":1995,"children":1996},{"style":1043},[1997],{"type":398,"value":1344},{"type":392,"tag":433,"props":1999,"children":2000},{"class":435,"line":513},[2001,2006,2010,2014,2018,2023],{"type":392,"tag":433,"props":2002,"children":2003},{"style":1049},[2004],{"type":398,"value":2005},"    this",{"type":392,"tag":433,"props":2007,"children":2008},{"style":461},[2009],{"type":398,"value":453},{"type":392,"tag":433,"props":2011,"children":2012},{"style":497},[2013],{"type":398,"value":1132},{"type":392,"tag":433,"props":2015,"children":2016},{"style":461},[2017],{"type":398,"value":453},{"type":392,"tag":433,"props":2019,"children":2020},{"style":503},[2021],{"type":398,"value":2022},"length",{"type":392,"tag":433,"props":2024,"children":2025},{"style":593},[2026],{"type":398,"value":2027}," &&\n",{"type":392,"tag":433,"props":2029,"children":2030},{"class":435,"line":535},[2031,2035,2039,2043,2047,2051,2055,2059,2063,2067,2071,2075,2079],{"type":392,"tag":433,"props":2032,"children":2033},{"style":1049},[2034],{"type":398,"value":2005},{"type":392,"tag":433,"props":2036,"children":2037},{"style":461},[2038],{"type":398,"value":453},{"type":392,"tag":433,"props":2040,"children":2041},{"style":497},[2042],{"type":398,"value":1132},{"type":392,"tag":433,"props":2044,"children":2045},{"style":461},[2046],{"type":398,"value":453},{"type":392,"tag":433,"props":2048,"children":2049},{"style":1059},[2050],{"type":398,"value":1141},{"type":392,"tag":433,"props":2052,"children":2053},{"style":1043},[2054],{"type":398,"value":1146},{"type":392,"tag":433,"props":2056,"children":2057},{"style":482},[2058],{"type":398,"value":1151},{"type":392,"tag":433,"props":2060,"children":2061},{"style":1043},[2062],{"type":398,"value":1156},{"type":392,"tag":433,"props":2064,"children":2065},{"style":593},[2066],{"type":398,"value":1161},{"type":392,"tag":433,"props":2068,"children":2069},{"style":599},[2070],{"type":398,"value":1166},{"type":392,"tag":433,"props":2072,"children":2073},{"style":605},[2074],{"type":398,"value":1879},{"type":392,"tag":433,"props":2076,"children":2077},{"style":599},[2078],{"type":398,"value":1176},{"type":392,"tag":433,"props":2080,"children":2081},{"style":593},[2082],{"type":398,"value":2027},{"type":392,"tag":433,"props":2084,"children":2085},{"class":435,"line":544},[2086,2091,2095,2099,2104,2109,2114,2118,2122,2127],{"type":392,"tag":433,"props":2087,"children":2088},{"style":1043},[2089],{"type":398,"value":2090},"    (",{"type":392,"tag":433,"props":2092,"children":2093},{"style":1049},[2094],{"type":398,"value":1052},{"type":392,"tag":433,"props":2096,"children":2097},{"style":461},[2098],{"type":398,"value":453},{"type":392,"tag":433,"props":2100,"children":2101},{"style":1059},[2102],{"type":398,"value":2103},"matchAtRule",{"type":392,"tag":433,"props":2105,"children":2106},{"style":1043},[2107],{"type":398,"value":2108},"() ",{"type":392,"tag":433,"props":2110,"children":2111},{"style":593},[2112],{"type":398,"value":2113},"||",{"type":392,"tag":433,"props":2115,"children":2116},{"style":1049},[2117],{"type":398,"value":1186},{"type":392,"tag":433,"props":2119,"children":2120},{"style":461},[2121],{"type":398,"value":453},{"type":392,"tag":433,"props":2123,"children":2124},{"style":1059},[2125],{"type":398,"value":2126},"matchStyleRule",{"type":392,"tag":433,"props":2128,"children":2129},{"style":1043},[2130],{"type":398,"value":2131},"())\n",{"type":392,"tag":433,"props":2133,"children":2134},{"class":435,"line":553},[2135,2140],{"type":392,"tag":433,"props":2136,"children":2137},{"style":1043},[2138],{"type":398,"value":2139},"  ) ",{"type":392,"tag":433,"props":2141,"children":2142},{"style":461},[2143],{"type":398,"value":1240},{"type":392,"tag":433,"props":2145,"children":2146},{"class":435,"line":563},[2147,2151,2155,2159],{"type":392,"tag":433,"props":2148,"children":2149},{"style":1049},[2150],{"type":398,"value":2005},{"type":392,"tag":433,"props":2152,"children":2153},{"style":461},[2154],{"type":398,"value":453},{"type":392,"tag":433,"props":2156,"children":2157},{"style":1059},[2158],{"type":398,"value":1981},{"type":392,"tag":433,"props":2160,"children":2161},{"style":1043},[2162],{"type":398,"value":1965},{"type":392,"tag":433,"props":2164,"children":2165},{"class":435,"line":572},[2166,2170,2174,2178],{"type":392,"tag":433,"props":2167,"children":2168},{"style":1049},[2169],{"type":398,"value":2005},{"type":392,"tag":433,"props":2171,"children":2172},{"style":461},[2173],{"type":398,"value":453},{"type":392,"tag":433,"props":2175,"children":2176},{"style":1059},[2177],{"type":398,"value":1960},{"type":392,"tag":433,"props":2179,"children":2180},{"style":1043},[2181],{"type":398,"value":1965},{"type":392,"tag":433,"props":2183,"children":2184},{"class":435,"line":633},[2185],{"type":392,"tag":433,"props":2186,"children":2187},{"style":461},[2188],{"type":398,"value":541},{"type":392,"tag":433,"props":2190,"children":2191},{"class":435,"line":653},[2192],{"type":392,"tag":433,"props":2193,"children":2194},{"style":461},[2195],{"type":398,"value":550},{"type":392,"tag":400,"props":2197,"children":2198},{},[2199,2201,2206],{"type":398,"value":2200},"匹配注释我们知道它是使用了下标递增 + Slice 的方法，匹配空白这里则是用的一个非常简单的正则。见下 ",{"type":392,"tag":429,"props":2202,"children":2204},{"className":2203},[],[2205],{"type":398,"value":1960},{"type":398,"value":2207}," 函数。",{"type":392,"tag":422,"props":2209,"children":2211},{"className":982,"code":2210,"language":984,"meta":386,"style":386},"private matchLeadingSpaces (): void {\n  this.commonMatch(/^\\s*/, false)\n}\n",[2212],{"type":392,"tag":429,"props":2213,"children":2214},{"__ignoreMap":386},[2215,2238,2294],{"type":392,"tag":433,"props":2216,"children":2217},{"class":435,"line":436},[2218,2222,2226,2230,2234],{"type":392,"tag":433,"props":2219,"children":2220},{"style":497},[2221],{"type":398,"value":1925},{"type":392,"tag":433,"props":2223,"children":2224},{"style":1059},[2225],{"type":398,"value":1960},{"type":392,"tag":433,"props":2227,"children":2228},{"style":497},[2229],{"type":398,"value":1935},{"type":392,"tag":433,"props":2231,"children":2232},{"style":593},[2233],{"type":398,"value":1940},{"type":392,"tag":433,"props":2235,"children":2236},{"style":461},[2237],{"type":398,"value":464},{"type":392,"tag":433,"props":2239,"children":2240},{"class":435,"line":446},[2241,2245,2249,2254,2258,2262,2267,2273,2277,2281,2285,2290],{"type":392,"tag":433,"props":2242,"children":2243},{"style":1049},[2244],{"type":398,"value":1352},{"type":392,"tag":433,"props":2246,"children":2247},{"style":461},[2248],{"type":398,"value":453},{"type":392,"tag":433,"props":2250,"children":2251},{"style":1059},[2252],{"type":398,"value":2253},"commonMatch",{"type":392,"tag":433,"props":2255,"children":2256},{"style":1043},[2257],{"type":398,"value":1146},{"type":392,"tag":433,"props":2259,"children":2260},{"style":599},[2261],{"type":398,"value":1171},{"type":392,"tag":433,"props":2263,"children":2264},{"style":1037},[2265],{"type":398,"value":2266},"^",{"type":392,"tag":433,"props":2268,"children":2270},{"style":2269},"--shiki-light:#91B859;--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF",[2271],{"type":398,"value":2272},"\\s",{"type":392,"tag":433,"props":2274,"children":2275},{"style":593},[2276],{"type":398,"value":1227},{"type":392,"tag":433,"props":2278,"children":2279},{"style":599},[2280],{"type":398,"value":1171},{"type":392,"tag":433,"props":2282,"children":2283},{"style":461},[2284],{"type":398,"value":1609},{"type":392,"tag":433,"props":2286,"children":2287},{"style":1251},[2288],{"type":398,"value":2289}," false",{"type":392,"tag":433,"props":2291,"children":2292},{"style":1043},[2293],{"type":398,"value":1503},{"type":392,"tag":433,"props":2295,"children":2296},{"class":435,"line":467},[2297],{"type":392,"tag":433,"props":2298,"children":2299},{"style":461},[2300],{"type":398,"value":550},{"type":392,"tag":400,"props":2302,"children":2303},{},[2304,2306,2311,2313,2318,2319,2324,2326,2331,2333,2338],{"type":398,"value":2305},"可以想象，",{"type":392,"tag":429,"props":2307,"children":2309},{"className":2308},[],[2310],{"type":398,"value":2253},{"type":398,"value":2312}," 应当会对状态 ",{"type":392,"tag":429,"props":2314,"children":2316},{"className":2315},[],[2317],{"type":398,"value":1132},{"type":398,"value":1795},{"type":392,"tag":429,"props":2320,"children":2322},{"className":2321},[],[2323],{"type":398,"value":1801},{"type":398,"value":2325}," 做一些操作。实际上，commonMatch 两个参数分别是用于匹配 ",{"type":392,"tag":429,"props":2327,"children":2329},{"className":2328},[],[2330],{"type":398,"value":1132},{"type":398,"value":2332}," 的正则，及跳过标记。如果在待匹配内容中匹配到了字符串，便把匹配的内容从中移除；跳过标记则意味着当确认跳过时，匹配的内容将不会被记录到输出结果中。以上面的 ",{"type":392,"tag":429,"props":2334,"children":2336},{"className":2335},[],[2337],{"type":398,"value":1960},{"type":398,"value":2339}," 函数举例，如果在待匹配内容中匹配到空白字符，那么会将其丢弃不做处理。",{"type":392,"tag":400,"props":2341,"children":2342},{},[2343,2348,2350,2355],{"type":392,"tag":429,"props":2344,"children":2346},{"className":2345},[],[2347],{"type":398,"value":2253},{"type":398,"value":2349}," 可谓是解析器匹配逻辑的核心，只要理解了它，那么我们回到上面提到的样式规则匹配 ",{"type":392,"tag":429,"props":2351,"children":2353},{"className":2352},[],[2354],{"type":398,"value":2126},{"type":398,"value":2356},"，会发现其过程非常简单。简单来说只有三步，匹配选择器、记录解析后的选择器、解析（并记录）声明。结束条件只有成功解析以及选择器解析报错或声明解析报错。",{"type":392,"tag":422,"props":2358,"children":2360},{"className":982,"code":2359,"language":984,"meta":386,"style":386},"private matchStyleRule (): boolean | void {\n  const selectors = this.formatSelector(true)\n  this.scopecssDisableNextLine = false\n  if (!selectors) return parseError('selector missing', this.linkPath)\n  this.recordResult(selectors)\n  this.matchComments()\n  this.styleDeclarations()\n  this.matchLeadingSpaces()\n  return true\n}\n",[2361],{"type":392,"tag":429,"props":2362,"children":2363},{"__ignoreMap":386},[2364,2394,2438,2462,2536,2563,2582,2602,2621,2633],{"type":392,"tag":433,"props":2365,"children":2366},{"class":435,"line":436},[2367,2371,2375,2380,2385,2390],{"type":392,"tag":433,"props":2368,"children":2369},{"style":497},[2370],{"type":398,"value":1925},{"type":392,"tag":433,"props":2372,"children":2373},{"style":1059},[2374],{"type":398,"value":2126},{"type":392,"tag":433,"props":2376,"children":2377},{"style":497},[2378],{"type":398,"value":2379}," (): boolean ",{"type":392,"tag":433,"props":2381,"children":2382},{"style":593},[2383],{"type":398,"value":2384},"|",{"type":392,"tag":433,"props":2386,"children":2387},{"style":593},[2388],{"type":398,"value":2389}," void",{"type":392,"tag":433,"props":2391,"children":2392},{"style":461},[2393],{"type":398,"value":464},{"type":392,"tag":433,"props":2395,"children":2396},{"class":435,"line":446},[2397,2402,2407,2412,2416,2420,2425,2429,2434],{"type":392,"tag":433,"props":2398,"children":2399},{"style":994},[2400],{"type":398,"value":2401},"  const",{"type":392,"tag":433,"props":2403,"children":2404},{"style":503},[2405],{"type":398,"value":2406}," selectors",{"type":392,"tag":433,"props":2408,"children":2409},{"style":593},[2410],{"type":398,"value":2411}," =",{"type":392,"tag":433,"props":2413,"children":2414},{"style":1049},[2415],{"type":398,"value":1186},{"type":392,"tag":433,"props":2417,"children":2418},{"style":461},[2419],{"type":398,"value":453},{"type":392,"tag":433,"props":2421,"children":2422},{"style":1059},[2423],{"type":398,"value":2424},"formatSelector",{"type":392,"tag":433,"props":2426,"children":2427},{"style":1043},[2428],{"type":398,"value":1146},{"type":392,"tag":433,"props":2430,"children":2431},{"style":1251},[2432],{"type":398,"value":2433},"true",{"type":392,"tag":433,"props":2435,"children":2436},{"style":1043},[2437],{"type":398,"value":1503},{"type":392,"tag":433,"props":2439,"children":2440},{"class":435,"line":467},[2441,2445,2449,2454,2458],{"type":392,"tag":433,"props":2442,"children":2443},{"style":1049},[2444],{"type":398,"value":1352},{"type":392,"tag":433,"props":2446,"children":2447},{"style":461},[2448],{"type":398,"value":453},{"type":392,"tag":433,"props":2450,"children":2451},{"style":497},[2452],{"type":398,"value":2453},"scopecssDisableNextLine",{"type":392,"tag":433,"props":2455,"children":2456},{"style":593},[2457],{"type":398,"value":2411},{"type":392,"tag":433,"props":2459,"children":2460},{"style":1251},[2461],{"type":398,"value":1254},{"type":392,"tag":433,"props":2463,"children":2464},{"class":435,"line":493},[2465,2470,2474,2479,2484,2488,2493,2498,2502,2506,2511,2515,2519,2523,2527,2532],{"type":392,"tag":433,"props":2466,"children":2467},{"style":1037},[2468],{"type":398,"value":2469},"  if",{"type":392,"tag":433,"props":2471,"children":2472},{"style":1043},[2473],{"type":398,"value":1046},{"type":392,"tag":433,"props":2475,"children":2476},{"style":593},[2477],{"type":398,"value":2478},"!",{"type":392,"tag":433,"props":2480,"children":2481},{"style":497},[2482],{"type":398,"value":2483},"selectors",{"type":392,"tag":433,"props":2485,"children":2486},{"style":1043},[2487],{"type":398,"value":1156},{"type":392,"tag":433,"props":2489,"children":2490},{"style":1037},[2491],{"type":398,"value":2492},"return",{"type":392,"tag":433,"props":2494,"children":2495},{"style":1059},[2496],{"type":398,"value":2497}," parseError",{"type":392,"tag":433,"props":2499,"children":2500},{"style":1043},[2501],{"type":398,"value":1146},{"type":392,"tag":433,"props":2503,"children":2504},{"style":599},[2505],{"type":398,"value":1176},{"type":392,"tag":433,"props":2507,"children":2508},{"style":605},[2509],{"type":398,"value":2510},"selector missing",{"type":392,"tag":433,"props":2512,"children":2513},{"style":599},[2514],{"type":398,"value":1176},{"type":392,"tag":433,"props":2516,"children":2517},{"style":461},[2518],{"type":398,"value":1609},{"type":392,"tag":433,"props":2520,"children":2521},{"style":1049},[2522],{"type":398,"value":1186},{"type":392,"tag":433,"props":2524,"children":2525},{"style":461},[2526],{"type":398,"value":453},{"type":392,"tag":433,"props":2528,"children":2529},{"style":497},[2530],{"type":398,"value":2531},"linkPath",{"type":392,"tag":433,"props":2533,"children":2534},{"style":1043},[2535],{"type":398,"value":1503},{"type":392,"tag":433,"props":2537,"children":2538},{"class":435,"line":513},[2539,2543,2547,2551,2555,2559],{"type":392,"tag":433,"props":2540,"children":2541},{"style":1049},[2542],{"type":398,"value":1352},{"type":392,"tag":433,"props":2544,"children":2545},{"style":461},[2546],{"type":398,"value":453},{"type":392,"tag":433,"props":2548,"children":2549},{"style":1059},[2550],{"type":398,"value":1826},{"type":392,"tag":433,"props":2552,"children":2553},{"style":1043},[2554],{"type":398,"value":1146},{"type":392,"tag":433,"props":2556,"children":2557},{"style":497},[2558],{"type":398,"value":2483},{"type":392,"tag":433,"props":2560,"children":2561},{"style":1043},[2562],{"type":398,"value":1503},{"type":392,"tag":433,"props":2564,"children":2565},{"class":435,"line":535},[2566,2570,2574,2578],{"type":392,"tag":433,"props":2567,"children":2568},{"style":1049},[2569],{"type":398,"value":1352},{"type":392,"tag":433,"props":2571,"children":2572},{"style":461},[2573],{"type":398,"value":453},{"type":392,"tag":433,"props":2575,"children":2576},{"style":1059},[2577],{"type":398,"value":1981},{"type":392,"tag":433,"props":2579,"children":2580},{"style":1043},[2581],{"type":398,"value":1965},{"type":392,"tag":433,"props":2583,"children":2584},{"class":435,"line":544},[2585,2589,2593,2598],{"type":392,"tag":433,"props":2586,"children":2587},{"style":1049},[2588],{"type":398,"value":1352},{"type":392,"tag":433,"props":2590,"children":2591},{"style":461},[2592],{"type":398,"value":453},{"type":392,"tag":433,"props":2594,"children":2595},{"style":1059},[2596],{"type":398,"value":2597},"styleDeclarations",{"type":392,"tag":433,"props":2599,"children":2600},{"style":1043},[2601],{"type":398,"value":1965},{"type":392,"tag":433,"props":2603,"children":2604},{"class":435,"line":553},[2605,2609,2613,2617],{"type":392,"tag":433,"props":2606,"children":2607},{"style":1049},[2608],{"type":398,"value":1352},{"type":392,"tag":433,"props":2610,"children":2611},{"style":461},[2612],{"type":398,"value":453},{"type":392,"tag":433,"props":2614,"children":2615},{"style":1059},[2616],{"type":398,"value":1960},{"type":392,"tag":433,"props":2618,"children":2619},{"style":1043},[2620],{"type":398,"value":1965},{"type":392,"tag":433,"props":2622,"children":2623},{"class":435,"line":563},[2624,2629],{"type":392,"tag":433,"props":2625,"children":2626},{"style":1037},[2627],{"type":398,"value":2628},"  return",{"type":392,"tag":433,"props":2630,"children":2631},{"style":1251},[2632],{"type":398,"value":1283},{"type":392,"tag":433,"props":2634,"children":2635},{"class":435,"line":572},[2636],{"type":392,"tag":433,"props":2637,"children":2638},{"style":461},[2639],{"type":398,"value":550},{"type":392,"tag":400,"props":2641,"children":2642},{},[2643,2645,2651,2653,2659,2661,2667,2669,2674,2676,2682],{"type":398,"value":2644},"首先是匹配选择器的部分。以 ",{"type":392,"tag":429,"props":2646,"children":2648},{"className":2647},[],[2649],{"type":398,"value":2650},".a,.b{color:red}",{"type":398,"value":2652}," 为例，首先匹配出",{"type":392,"tag":429,"props":2654,"children":2656},{"className":2655},[],[2657],{"type":398,"value":2658},"{",{"type":398,"value":2660},"字符前的部分即",{"type":392,"tag":429,"props":2662,"children":2664},{"className":2663},[],[2665],{"type":398,"value":2666},".a,.b",{"type":398,"value":2668},"作为选择器的正文，然后使用",{"type":392,"tag":429,"props":2670,"children":2672},{"className":2671},[],[2673],{"type":398,"value":1609},{"type":398,"value":2675},"分割选择器，并给选择器加上 prefix，最终返回",{"type":392,"tag":429,"props":2677,"children":2679},{"className":2678},[],[2680],{"type":398,"value":2681},"micro-app[name=\"subapp\"] .a, micro-app[name=\"subapp\"] .b",{"type":398,"value":2683},"。刚才提到可以在业务代码中使用注释给特定选择器禁用 prefix 前缀，相关的代码的实现也在这个函数中。",{"type":392,"tag":422,"props":2685,"children":2687},{"className":982,"code":2686,"language":984,"meta":386,"style":386},"const selectors = this.formatSelector()\n\nprivate formatSelector (skip: boolean): false | string {\n  // 匹配选择器正文\n  const m = this.commonMatch(/^[^{]+/, skip)\n  return m[0].replace(/(^|,[\\n\\s]*)([^,]+)/g, (_, separator, selector) => {\n    // 如果检测到选择器被禁用则跳过添加前缀步骤\n    if (...) {\n      const prefix = this.prefix // micro-app[name=\"subapp\"]\n      selector = prefix + ' ' + selector\n    }\n    return separator + selector\n  })\n}\n",[2688],{"type":392,"tag":429,"props":2689,"children":2690},{"__ignoreMap":386},[2691,2723,2730,2765,2773,2851,3010,3018,3042,3077,3115,3122,3141,3152],{"type":392,"tag":433,"props":2692,"children":2693},{"class":435,"line":436},[2694,2699,2703,2707,2711,2715,2719],{"type":392,"tag":433,"props":2695,"children":2696},{"style":994},[2697],{"type":398,"value":2698},"const",{"type":392,"tag":433,"props":2700,"children":2701},{"style":503},[2702],{"type":398,"value":2406},{"type":392,"tag":433,"props":2704,"children":2705},{"style":593},[2706],{"type":398,"value":2411},{"type":392,"tag":433,"props":2708,"children":2709},{"style":1049},[2710],{"type":398,"value":1186},{"type":392,"tag":433,"props":2712,"children":2713},{"style":461},[2714],{"type":398,"value":453},{"type":392,"tag":433,"props":2716,"children":2717},{"style":1059},[2718],{"type":398,"value":2424},{"type":392,"tag":433,"props":2720,"children":2721},{"style":497},[2722],{"type":398,"value":1965},{"type":392,"tag":433,"props":2724,"children":2725},{"class":435,"line":446},[2726],{"type":392,"tag":433,"props":2727,"children":2728},{"emptyLinePlaceholder":557},[2729],{"type":398,"value":560},{"type":392,"tag":433,"props":2731,"children":2732},{"class":435,"line":467},[2733,2737,2741,2746,2751,2756,2761],{"type":392,"tag":433,"props":2734,"children":2735},{"style":497},[2736],{"type":398,"value":1925},{"type":392,"tag":433,"props":2738,"children":2739},{"style":1059},[2740],{"type":398,"value":2424},{"type":392,"tag":433,"props":2742,"children":2743},{"style":497},[2744],{"type":398,"value":2745}," (skip: boolean): ",{"type":392,"tag":433,"props":2747,"children":2748},{"style":1251},[2749],{"type":398,"value":2750},"false",{"type":392,"tag":433,"props":2752,"children":2753},{"style":593},[2754],{"type":398,"value":2755}," |",{"type":392,"tag":433,"props":2757,"children":2758},{"style":497},[2759],{"type":398,"value":2760}," string ",{"type":392,"tag":433,"props":2762,"children":2763},{"style":461},[2764],{"type":398,"value":1240},{"type":392,"tag":433,"props":2766,"children":2767},{"class":435,"line":493},[2768],{"type":392,"tag":433,"props":2769,"children":2770},{"style":440},[2771],{"type":398,"value":2772},"  // 匹配选择器正文\n",{"type":392,"tag":433,"props":2774,"children":2775},{"class":435,"line":513},[2776,2780,2785,2789,2793,2797,2801,2805,2809,2813,2818,2822,2826,2830,2834,2838,2842,2847],{"type":392,"tag":433,"props":2777,"children":2778},{"style":994},[2779],{"type":398,"value":2401},{"type":392,"tag":433,"props":2781,"children":2782},{"style":503},[2783],{"type":398,"value":2784}," m",{"type":392,"tag":433,"props":2786,"children":2787},{"style":593},[2788],{"type":398,"value":2411},{"type":392,"tag":433,"props":2790,"children":2791},{"style":1049},[2792],{"type":398,"value":1186},{"type":392,"tag":433,"props":2794,"children":2795},{"style":461},[2796],{"type":398,"value":453},{"type":392,"tag":433,"props":2798,"children":2799},{"style":1059},[2800],{"type":398,"value":2253},{"type":392,"tag":433,"props":2802,"children":2803},{"style":1043},[2804],{"type":398,"value":1146},{"type":392,"tag":433,"props":2806,"children":2807},{"style":599},[2808],{"type":398,"value":1171},{"type":392,"tag":433,"props":2810,"children":2811},{"style":1037},[2812],{"type":398,"value":2266},{"type":392,"tag":433,"props":2814,"children":2816},{"style":2815},"--shiki-light:#39ADB5;--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF",[2817],{"type":398,"value":584},{"type":392,"tag":433,"props":2819,"children":2820},{"style":593},[2821],{"type":398,"value":2266},{"type":392,"tag":433,"props":2823,"children":2824},{"style":2269},[2825],{"type":398,"value":2658},{"type":392,"tag":433,"props":2827,"children":2828},{"style":2815},[2829],{"type":398,"value":617},{"type":392,"tag":433,"props":2831,"children":2832},{"style":593},[2833],{"type":398,"value":1474},{"type":392,"tag":433,"props":2835,"children":2836},{"style":599},[2837],{"type":398,"value":1171},{"type":392,"tag":433,"props":2839,"children":2840},{"style":461},[2841],{"type":398,"value":1609},{"type":392,"tag":433,"props":2843,"children":2844},{"style":497},[2845],{"type":398,"value":2846}," skip",{"type":392,"tag":433,"props":2848,"children":2849},{"style":1043},[2850],{"type":398,"value":1503},{"type":392,"tag":433,"props":2852,"children":2853},{"class":435,"line":535},[2854,2858,2862,2866,2870,2874,2878,2883,2887,2891,2896,2900,2904,2909,2913,2918,2922,2926,2931,2935,2939,2943,2947,2951,2956,2960,2966,2970,2974,2979,2983,2988,2992,2997,3001,3006],{"type":392,"tag":433,"props":2855,"children":2856},{"style":1037},[2857],{"type":398,"value":2628},{"type":392,"tag":433,"props":2859,"children":2860},{"style":497},[2861],{"type":398,"value":2784},{"type":392,"tag":433,"props":2863,"children":2864},{"style":1043},[2865],{"type":398,"value":584},{"type":392,"tag":433,"props":2867,"children":2868},{"style":482},[2869],{"type":398,"value":1151},{"type":392,"tag":433,"props":2871,"children":2872},{"style":1043},[2873],{"type":398,"value":617},{"type":392,"tag":433,"props":2875,"children":2876},{"style":461},[2877],{"type":398,"value":453},{"type":392,"tag":433,"props":2879,"children":2880},{"style":1059},[2881],{"type":398,"value":2882},"replace",{"type":392,"tag":433,"props":2884,"children":2885},{"style":1043},[2886],{"type":398,"value":1146},{"type":392,"tag":433,"props":2888,"children":2889},{"style":599},[2890],{"type":398,"value":1171},{"type":392,"tag":433,"props":2892,"children":2894},{"style":2893},"--shiki-light:#39ADB5;--shiki-default:#032F62;--shiki-dark:#DBEDFF;--shiki-sepia:#E6DB74",[2895],{"type":398,"value":1146},{"type":392,"tag":433,"props":2897,"children":2898},{"style":1037},[2899],{"type":398,"value":2266},{"type":392,"tag":433,"props":2901,"children":2902},{"style":593},[2903],{"type":398,"value":2384},{"type":392,"tag":433,"props":2905,"children":2907},{"style":2906},"--shiki-light:#91B859;--shiki-default:#032F62;--shiki-dark:#DBEDFF;--shiki-sepia:#E6DB74",[2908],{"type":398,"value":1609},{"type":392,"tag":433,"props":2910,"children":2911},{"style":2815},[2912],{"type":398,"value":584},{"type":392,"tag":433,"props":2914,"children":2915},{"style":2269},[2916],{"type":398,"value":2917},"\\n\\s",{"type":392,"tag":433,"props":2919,"children":2920},{"style":2815},[2921],{"type":398,"value":617},{"type":392,"tag":433,"props":2923,"children":2924},{"style":593},[2925],{"type":398,"value":1227},{"type":392,"tag":433,"props":2927,"children":2928},{"style":2893},[2929],{"type":398,"value":2930},")(",{"type":392,"tag":433,"props":2932,"children":2933},{"style":2815},[2934],{"type":398,"value":584},{"type":392,"tag":433,"props":2936,"children":2937},{"style":593},[2938],{"type":398,"value":2266},{"type":392,"tag":433,"props":2940,"children":2941},{"style":2269},[2942],{"type":398,"value":1609},{"type":392,"tag":433,"props":2944,"children":2945},{"style":2815},[2946],{"type":398,"value":617},{"type":392,"tag":433,"props":2948,"children":2949},{"style":593},[2950],{"type":398,"value":1474},{"type":392,"tag":433,"props":2952,"children":2953},{"style":2893},[2954],{"type":398,"value":2955},")",{"type":392,"tag":433,"props":2957,"children":2958},{"style":599},[2959],{"type":398,"value":1171},{"type":392,"tag":433,"props":2961,"children":2963},{"style":2962},"--shiki-light:#F76D47;--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672",[2964],{"type":398,"value":2965},"g",{"type":392,"tag":433,"props":2967,"children":2968},{"style":461},[2969],{"type":398,"value":1609},{"type":392,"tag":433,"props":2971,"children":2972},{"style":461},[2973],{"type":398,"value":1046},{"type":392,"tag":433,"props":2975,"children":2976},{"style":1763},[2977],{"type":398,"value":2978},"_",{"type":392,"tag":433,"props":2980,"children":2981},{"style":461},[2982],{"type":398,"value":1609},{"type":392,"tag":433,"props":2984,"children":2985},{"style":1763},[2986],{"type":398,"value":2987}," separator",{"type":392,"tag":433,"props":2989,"children":2990},{"style":461},[2991],{"type":398,"value":1609},{"type":392,"tag":433,"props":2993,"children":2994},{"style":1763},[2995],{"type":398,"value":2996}," selector",{"type":392,"tag":433,"props":2998,"children":2999},{"style":461},[3000],{"type":398,"value":2955},{"type":392,"tag":433,"props":3002,"children":3003},{"style":994},[3004],{"type":398,"value":3005}," =>",{"type":392,"tag":433,"props":3007,"children":3008},{"style":461},[3009],{"type":398,"value":464},{"type":392,"tag":433,"props":3011,"children":3012},{"class":435,"line":544},[3013],{"type":392,"tag":433,"props":3014,"children":3015},{"style":440},[3016],{"type":398,"value":3017},"    // 如果检测到选择器被禁用则跳过添加前缀步骤\n",{"type":392,"tag":433,"props":3019,"children":3020},{"class":435,"line":553},[3021,3025,3029,3034,3038],{"type":392,"tag":433,"props":3022,"children":3023},{"style":1037},[3024],{"type":398,"value":1115},{"type":392,"tag":433,"props":3026,"children":3027},{"style":1043},[3028],{"type":398,"value":1046},{"type":392,"tag":433,"props":3030,"children":3031},{"style":593},[3032],{"type":398,"value":3033},"...",{"type":392,"tag":433,"props":3035,"children":3036},{"style":1043},[3037],{"type":398,"value":1156},{"type":392,"tag":433,"props":3039,"children":3040},{"style":461},[3041],{"type":398,"value":1240},{"type":392,"tag":433,"props":3043,"children":3044},{"class":435,"line":563},[3045,3050,3055,3059,3063,3067,3072],{"type":392,"tag":433,"props":3046,"children":3047},{"style":994},[3048],{"type":398,"value":3049},"      const",{"type":392,"tag":433,"props":3051,"children":3052},{"style":503},[3053],{"type":398,"value":3054}," prefix",{"type":392,"tag":433,"props":3056,"children":3057},{"style":593},[3058],{"type":398,"value":2411},{"type":392,"tag":433,"props":3060,"children":3061},{"style":1049},[3062],{"type":398,"value":1186},{"type":392,"tag":433,"props":3064,"children":3065},{"style":461},[3066],{"type":398,"value":453},{"type":392,"tag":433,"props":3068,"children":3069},{"style":497},[3070],{"type":398,"value":3071},"prefix",{"type":392,"tag":433,"props":3073,"children":3074},{"style":440},[3075],{"type":398,"value":3076}," // micro-app[name=\"subapp\"]\n",{"type":392,"tag":433,"props":3078,"children":3079},{"class":435,"line":572},[3080,3085,3089,3093,3098,3102,3106,3110],{"type":392,"tag":433,"props":3081,"children":3082},{"style":497},[3083],{"type":398,"value":3084},"      selector",{"type":392,"tag":433,"props":3086,"children":3087},{"style":593},[3088],{"type":398,"value":2411},{"type":392,"tag":433,"props":3090,"children":3091},{"style":497},[3092],{"type":398,"value":3054},{"type":392,"tag":433,"props":3094,"children":3095},{"style":593},[3096],{"type":398,"value":3097}," +",{"type":392,"tag":433,"props":3099,"children":3100},{"style":599},[3101],{"type":398,"value":1166},{"type":392,"tag":433,"props":3103,"children":3104},{"style":599},[3105],{"type":398,"value":1166},{"type":392,"tag":433,"props":3107,"children":3108},{"style":593},[3109],{"type":398,"value":3097},{"type":392,"tag":433,"props":3111,"children":3112},{"style":497},[3113],{"type":398,"value":3114}," selector\n",{"type":392,"tag":433,"props":3116,"children":3117},{"class":435,"line":633},[3118],{"type":392,"tag":433,"props":3119,"children":3120},{"style":461},[3121],{"type":398,"value":1262},{"type":392,"tag":433,"props":3123,"children":3124},{"class":435,"line":653},[3125,3129,3133,3137],{"type":392,"tag":433,"props":3126,"children":3127},{"style":1037},[3128],{"type":398,"value":1278},{"type":392,"tag":433,"props":3130,"children":3131},{"style":497},[3132],{"type":398,"value":2987},{"type":392,"tag":433,"props":3134,"children":3135},{"style":593},[3136],{"type":398,"value":3097},{"type":392,"tag":433,"props":3138,"children":3139},{"style":497},[3140],{"type":398,"value":3114},{"type":392,"tag":433,"props":3142,"children":3143},{"class":435,"line":669},[3144,3148],{"type":392,"tag":433,"props":3145,"children":3146},{"style":461},[3147],{"type":398,"value":832},{"type":392,"tag":433,"props":3149,"children":3150},{"style":1043},[3151],{"type":398,"value":1503},{"type":392,"tag":433,"props":3153,"children":3154},{"class":435,"line":689},[3155],{"type":392,"tag":433,"props":3156,"children":3157},{"style":461},[3158],{"type":398,"value":550},{"type":392,"tag":400,"props":3160,"children":3161},{},[3162,3164,3169,3171,3176,3178,3183,3185,3190,3192,3199],{"type":398,"value":3163},"匹配完选择器后，声明便是剩下的包含在左右花括号的内容。匹配过程是一个递归，以遇到",{"type":392,"tag":429,"props":3165,"children":3167},{"className":3166},[],[3168],{"type":398,"value":1879},{"type":398,"value":3170},"作为结束条件。如果遇到斜杠",{"type":392,"tag":429,"props":3172,"children":3174},{"className":3173},[],[3175],{"type":398,"value":1171},{"type":398,"value":3177},"，则尝试停止声明匹配并开始注释匹配。总之，",{"type":392,"tag":429,"props":3179,"children":3181},{"className":3180},[],[3182],{"type":398,"value":1879},{"type":398,"value":3184},"之前的内容都作为当前选择器的声明，添加到",{"type":392,"tag":429,"props":3186,"children":3188},{"className":3187},[],[3189],{"type":398,"value":1132},{"type":398,"value":3191},"中。micro-app 框架会对 CSS 资源中的 URL 补全为主应用的完整路径这个功能也是在这个函数中实现，有兴趣的话可以查看其",{"type":392,"tag":411,"props":3193,"children":3196},{"href":3194,"rel":3195},"https://github.com/micro-zoe/micro-app/blob/dev/src/sandbox/scoped_css.ts",[415],[3197],{"type":398,"value":3198},"完整代码",{"type":398,"value":918},{"type":392,"tag":422,"props":3201,"children":3203},{"className":982,"code":3202,"language":984,"meta":386,"style":386},"private matchAllDeclarations (): void {\n  let cssValue = (this.commonMatch(/^[^}/])*/, true) as RegExpExecArray)[0]\n  this.recordResult(cssValue)\n\n  // 递归退出条件\n  if (!this.cssText) return\n  if (this.cssText.charAt(0) === '}') return\n\n  // extract comments in declarations\n  if (this.cssText.charAt(0) === '/' && this.cssText.charAt(1) === '*') {\n    this.matchComments()\n  } else {\n    // 如果不是注释则忽略中断，继续匹配声明\n    this.commonMatch(/\\/+/)\n  }\n\n  return this.matchAllDeclarations()\n}\n",[3204],{"type":392,"tag":429,"props":3205,"children":3206},{"__ignoreMap":386},[3207,3231,3342,3370,3377,3385,3421,3489,3496,3504,3623,3642,3658,3666,3707,3714,3721,3744],{"type":392,"tag":433,"props":3208,"children":3209},{"class":435,"line":436},[3210,3214,3219,3223,3227],{"type":392,"tag":433,"props":3211,"children":3212},{"style":497},[3213],{"type":398,"value":1925},{"type":392,"tag":433,"props":3215,"children":3216},{"style":1059},[3217],{"type":398,"value":3218},"matchAllDeclarations",{"type":392,"tag":433,"props":3220,"children":3221},{"style":497},[3222],{"type":398,"value":1935},{"type":392,"tag":433,"props":3224,"children":3225},{"style":593},[3226],{"type":398,"value":1940},{"type":392,"tag":433,"props":3228,"children":3229},{"style":461},[3230],{"type":398,"value":464},{"type":392,"tag":433,"props":3232,"children":3233},{"class":435,"line":446},[3234,3239,3244,3248,3252,3256,3260,3264,3268,3272,3276,3280,3284,3289,3293,3297,3301,3305,3309,3314,3318,3323,3328,3333,3337],{"type":392,"tag":433,"props":3235,"children":3236},{"style":994},[3237],{"type":398,"value":3238},"  let",{"type":392,"tag":433,"props":3240,"children":3241},{"style":497},[3242],{"type":398,"value":3243}," cssValue",{"type":392,"tag":433,"props":3245,"children":3246},{"style":593},[3247],{"type":398,"value":2411},{"type":392,"tag":433,"props":3249,"children":3250},{"style":1043},[3251],{"type":398,"value":1046},{"type":392,"tag":433,"props":3253,"children":3254},{"style":1049},[3255],{"type":398,"value":1052},{"type":392,"tag":433,"props":3257,"children":3258},{"style":461},[3259],{"type":398,"value":453},{"type":392,"tag":433,"props":3261,"children":3262},{"style":1059},[3263],{"type":398,"value":2253},{"type":392,"tag":433,"props":3265,"children":3266},{"style":1043},[3267],{"type":398,"value":1146},{"type":392,"tag":433,"props":3269,"children":3270},{"style":599},[3271],{"type":398,"value":1171},{"type":392,"tag":433,"props":3273,"children":3274},{"style":1037},[3275],{"type":398,"value":2266},{"type":392,"tag":433,"props":3277,"children":3278},{"style":2815},[3279],{"type":398,"value":584},{"type":392,"tag":433,"props":3281,"children":3282},{"style":593},[3283],{"type":398,"value":2266},{"type":392,"tag":433,"props":3285,"children":3286},{"style":2269},[3287],{"type":398,"value":3288},"}/",{"type":392,"tag":433,"props":3290,"children":3291},{"style":2815},[3292],{"type":398,"value":617},{"type":392,"tag":433,"props":3294,"children":3295},{"style":2906},[3296],{"type":398,"value":2955},{"type":392,"tag":433,"props":3298,"children":3299},{"style":593},[3300],{"type":398,"value":1227},{"type":392,"tag":433,"props":3302,"children":3303},{"style":599},[3304],{"type":398,"value":1171},{"type":392,"tag":433,"props":3306,"children":3307},{"style":461},[3308],{"type":398,"value":1609},{"type":392,"tag":433,"props":3310,"children":3311},{"style":1251},[3312],{"type":398,"value":3313}," true",{"type":392,"tag":433,"props":3315,"children":3316},{"style":1043},[3317],{"type":398,"value":1156},{"type":392,"tag":433,"props":3319,"children":3320},{"style":1037},[3321],{"type":398,"value":3322},"as",{"type":392,"tag":433,"props":3324,"children":3325},{"style":1000},[3326],{"type":398,"value":3327}," RegExpExecArray",{"type":392,"tag":433,"props":3329,"children":3330},{"style":1043},[3331],{"type":398,"value":3332},")[",{"type":392,"tag":433,"props":3334,"children":3335},{"style":482},[3336],{"type":398,"value":1151},{"type":392,"tag":433,"props":3338,"children":3339},{"style":1043},[3340],{"type":398,"value":3341},"]\n",{"type":392,"tag":433,"props":3343,"children":3344},{"class":435,"line":467},[3345,3349,3353,3357,3361,3366],{"type":392,"tag":433,"props":3346,"children":3347},{"style":1049},[3348],{"type":398,"value":1352},{"type":392,"tag":433,"props":3350,"children":3351},{"style":461},[3352],{"type":398,"value":453},{"type":392,"tag":433,"props":3354,"children":3355},{"style":1059},[3356],{"type":398,"value":1826},{"type":392,"tag":433,"props":3358,"children":3359},{"style":1043},[3360],{"type":398,"value":1146},{"type":392,"tag":433,"props":3362,"children":3363},{"style":497},[3364],{"type":398,"value":3365},"cssValue",{"type":392,"tag":433,"props":3367,"children":3368},{"style":1043},[3369],{"type":398,"value":1503},{"type":392,"tag":433,"props":3371,"children":3372},{"class":435,"line":493},[3373],{"type":392,"tag":433,"props":3374,"children":3375},{"emptyLinePlaceholder":557},[3376],{"type":398,"value":560},{"type":392,"tag":433,"props":3378,"children":3379},{"class":435,"line":513},[3380],{"type":392,"tag":433,"props":3381,"children":3382},{"style":440},[3383],{"type":398,"value":3384},"  // 递归退出条件\n",{"type":392,"tag":433,"props":3386,"children":3387},{"class":435,"line":535},[3388,3392,3396,3400,3404,3408,3412,3416],{"type":392,"tag":433,"props":3389,"children":3390},{"style":1037},[3391],{"type":398,"value":2469},{"type":392,"tag":433,"props":3393,"children":3394},{"style":1043},[3395],{"type":398,"value":1046},{"type":392,"tag":433,"props":3397,"children":3398},{"style":593},[3399],{"type":398,"value":2478},{"type":392,"tag":433,"props":3401,"children":3402},{"style":1049},[3403],{"type":398,"value":1052},{"type":392,"tag":433,"props":3405,"children":3406},{"style":461},[3407],{"type":398,"value":453},{"type":392,"tag":433,"props":3409,"children":3410},{"style":497},[3411],{"type":398,"value":1132},{"type":392,"tag":433,"props":3413,"children":3414},{"style":1043},[3415],{"type":398,"value":1156},{"type":392,"tag":433,"props":3417,"children":3418},{"style":1037},[3419],{"type":398,"value":3420},"return\n",{"type":392,"tag":433,"props":3422,"children":3423},{"class":435,"line":544},[3424,3428,3432,3436,3440,3444,3448,3452,3456,3460,3464,3469,3473,3477,3481,3485],{"type":392,"tag":433,"props":3425,"children":3426},{"style":1037},[3427],{"type":398,"value":2469},{"type":392,"tag":433,"props":3429,"children":3430},{"style":1043},[3431],{"type":398,"value":1046},{"type":392,"tag":433,"props":3433,"children":3434},{"style":1049},[3435],{"type":398,"value":1052},{"type":392,"tag":433,"props":3437,"children":3438},{"style":461},[3439],{"type":398,"value":453},{"type":392,"tag":433,"props":3441,"children":3442},{"style":497},[3443],{"type":398,"value":1132},{"type":392,"tag":433,"props":3445,"children":3446},{"style":461},[3447],{"type":398,"value":453},{"type":392,"tag":433,"props":3449,"children":3450},{"style":1059},[3451],{"type":398,"value":1141},{"type":392,"tag":433,"props":3453,"children":3454},{"style":1043},[3455],{"type":398,"value":1146},{"type":392,"tag":433,"props":3457,"children":3458},{"style":482},[3459],{"type":398,"value":1151},{"type":392,"tag":433,"props":3461,"children":3462},{"style":1043},[3463],{"type":398,"value":1156},{"type":392,"tag":433,"props":3465,"children":3466},{"style":593},[3467],{"type":398,"value":3468},"===",{"type":392,"tag":433,"props":3470,"children":3471},{"style":599},[3472],{"type":398,"value":1166},{"type":392,"tag":433,"props":3474,"children":3475},{"style":605},[3476],{"type":398,"value":1879},{"type":392,"tag":433,"props":3478,"children":3479},{"style":599},[3480],{"type":398,"value":1176},{"type":392,"tag":433,"props":3482,"children":3483},{"style":1043},[3484],{"type":398,"value":1156},{"type":392,"tag":433,"props":3486,"children":3487},{"style":1037},[3488],{"type":398,"value":3420},{"type":392,"tag":433,"props":3490,"children":3491},{"class":435,"line":553},[3492],{"type":392,"tag":433,"props":3493,"children":3494},{"emptyLinePlaceholder":557},[3495],{"type":398,"value":560},{"type":392,"tag":433,"props":3497,"children":3498},{"class":435,"line":563},[3499],{"type":392,"tag":433,"props":3500,"children":3501},{"style":440},[3502],{"type":398,"value":3503},"  // extract comments in declarations\n",{"type":392,"tag":433,"props":3505,"children":3506},{"class":435,"line":572},[3507,3511,3515,3519,3523,3527,3531,3535,3539,3543,3547,3551,3555,3559,3563,3567,3571,3575,3579,3583,3587,3591,3595,3599,3603,3607,3611,3615,3619],{"type":392,"tag":433,"props":3508,"children":3509},{"style":1037},[3510],{"type":398,"value":2469},{"type":392,"tag":433,"props":3512,"children":3513},{"style":1043},[3514],{"type":398,"value":1046},{"type":392,"tag":433,"props":3516,"children":3517},{"style":1049},[3518],{"type":398,"value":1052},{"type":392,"tag":433,"props":3520,"children":3521},{"style":461},[3522],{"type":398,"value":453},{"type":392,"tag":433,"props":3524,"children":3525},{"style":497},[3526],{"type":398,"value":1132},{"type":392,"tag":433,"props":3528,"children":3529},{"style":461},[3530],{"type":398,"value":453},{"type":392,"tag":433,"props":3532,"children":3533},{"style":1059},[3534],{"type":398,"value":1141},{"type":392,"tag":433,"props":3536,"children":3537},{"style":1043},[3538],{"type":398,"value":1146},{"type":392,"tag":433,"props":3540,"children":3541},{"style":482},[3542],{"type":398,"value":1151},{"type":392,"tag":433,"props":3544,"children":3545},{"style":1043},[3546],{"type":398,"value":1156},{"type":392,"tag":433,"props":3548,"children":3549},{"style":593},[3550],{"type":398,"value":3468},{"type":392,"tag":433,"props":3552,"children":3553},{"style":599},[3554],{"type":398,"value":1166},{"type":392,"tag":433,"props":3556,"children":3557},{"style":605},[3558],{"type":398,"value":1171},{"type":392,"tag":433,"props":3560,"children":3561},{"style":599},[3562],{"type":398,"value":1176},{"type":392,"tag":433,"props":3564,"children":3565},{"style":593},[3566],{"type":398,"value":1387},{"type":392,"tag":433,"props":3568,"children":3569},{"style":1049},[3570],{"type":398,"value":1186},{"type":392,"tag":433,"props":3572,"children":3573},{"style":461},[3574],{"type":398,"value":453},{"type":392,"tag":433,"props":3576,"children":3577},{"style":497},[3578],{"type":398,"value":1132},{"type":392,"tag":433,"props":3580,"children":3581},{"style":461},[3582],{"type":398,"value":453},{"type":392,"tag":433,"props":3584,"children":3585},{"style":1059},[3586],{"type":398,"value":1141},{"type":392,"tag":433,"props":3588,"children":3589},{"style":1043},[3590],{"type":398,"value":1146},{"type":392,"tag":433,"props":3592,"children":3593},{"style":482},[3594],{"type":398,"value":916},{"type":392,"tag":433,"props":3596,"children":3597},{"style":1043},[3598],{"type":398,"value":1156},{"type":392,"tag":433,"props":3600,"children":3601},{"style":593},[3602],{"type":398,"value":3468},{"type":392,"tag":433,"props":3604,"children":3605},{"style":599},[3606],{"type":398,"value":1166},{"type":392,"tag":433,"props":3608,"children":3609},{"style":605},[3610],{"type":398,"value":1227},{"type":392,"tag":433,"props":3612,"children":3613},{"style":599},[3614],{"type":398,"value":1176},{"type":392,"tag":433,"props":3616,"children":3617},{"style":1043},[3618],{"type":398,"value":1156},{"type":392,"tag":433,"props":3620,"children":3621},{"style":461},[3622],{"type":398,"value":1240},{"type":392,"tag":433,"props":3624,"children":3625},{"class":435,"line":633},[3626,3630,3634,3638],{"type":392,"tag":433,"props":3627,"children":3628},{"style":1049},[3629],{"type":398,"value":2005},{"type":392,"tag":433,"props":3631,"children":3632},{"style":461},[3633],{"type":398,"value":453},{"type":392,"tag":433,"props":3635,"children":3636},{"style":1059},[3637],{"type":398,"value":1981},{"type":392,"tag":433,"props":3639,"children":3640},{"style":1043},[3641],{"type":398,"value":1965},{"type":392,"tag":433,"props":3643,"children":3644},{"class":435,"line":653},[3645,3649,3654],{"type":392,"tag":433,"props":3646,"children":3647},{"style":461},[3648],{"type":398,"value":832},{"type":392,"tag":433,"props":3650,"children":3651},{"style":1037},[3652],{"type":398,"value":3653}," else",{"type":392,"tag":433,"props":3655,"children":3656},{"style":461},[3657],{"type":398,"value":464},{"type":392,"tag":433,"props":3659,"children":3660},{"class":435,"line":669},[3661],{"type":392,"tag":433,"props":3662,"children":3663},{"style":440},[3664],{"type":398,"value":3665},"    // 如果不是注释则忽略中断，继续匹配声明\n",{"type":392,"tag":433,"props":3667,"children":3668},{"class":435,"line":689},[3669,3673,3677,3681,3685,3689,3695,3699,3703],{"type":392,"tag":433,"props":3670,"children":3671},{"style":1049},[3672],{"type":398,"value":2005},{"type":392,"tag":433,"props":3674,"children":3675},{"style":461},[3676],{"type":398,"value":453},{"type":392,"tag":433,"props":3678,"children":3679},{"style":1059},[3680],{"type":398,"value":2253},{"type":392,"tag":433,"props":3682,"children":3683},{"style":1043},[3684],{"type":398,"value":1146},{"type":392,"tag":433,"props":3686,"children":3687},{"style":599},[3688],{"type":398,"value":1171},{"type":392,"tag":433,"props":3690,"children":3692},{"style":3691},"--shiki-light:#90A4AE;--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#AE81FF;--shiki-light-font-weight:inherit;--shiki-default-font-weight:bold;--shiki-dark-font-weight:bold;--shiki-sepia-font-weight:inherit",[3693],{"type":398,"value":3694},"\\/",{"type":392,"tag":433,"props":3696,"children":3697},{"style":593},[3698],{"type":398,"value":1474},{"type":392,"tag":433,"props":3700,"children":3701},{"style":599},[3702],{"type":398,"value":1171},{"type":392,"tag":433,"props":3704,"children":3705},{"style":1043},[3706],{"type":398,"value":1503},{"type":392,"tag":433,"props":3708,"children":3709},{"class":435,"line":697},[3710],{"type":392,"tag":433,"props":3711,"children":3712},{"style":461},[3713],{"type":398,"value":541},{"type":392,"tag":433,"props":3715,"children":3716},{"class":435,"line":705},[3717],{"type":392,"tag":433,"props":3718,"children":3719},{"emptyLinePlaceholder":557},[3720],{"type":398,"value":560},{"type":392,"tag":433,"props":3722,"children":3723},{"class":435,"line":713},[3724,3728,3732,3736,3740],{"type":392,"tag":433,"props":3725,"children":3726},{"style":1037},[3727],{"type":398,"value":2628},{"type":392,"tag":433,"props":3729,"children":3730},{"style":1049},[3731],{"type":398,"value":1186},{"type":392,"tag":433,"props":3733,"children":3734},{"style":461},[3735],{"type":398,"value":453},{"type":392,"tag":433,"props":3737,"children":3738},{"style":1059},[3739],{"type":398,"value":3218},{"type":392,"tag":433,"props":3741,"children":3742},{"style":1043},[3743],{"type":398,"value":1965},{"type":392,"tag":433,"props":3745,"children":3746},{"class":435,"line":722},[3747],{"type":392,"tag":433,"props":3748,"children":3749},{"style":461},[3750],{"type":398,"value":550},{"type":392,"tag":947,"props":3752,"children":3754},{"id":3753},"解析at-rule",[3755,3757],{"type":398,"value":3756},"解析",{"type":392,"tag":429,"props":3758,"children":3760},{"className":3759},[],[3761],{"type":398,"value":938},{"type":392,"tag":400,"props":3763,"children":3764},{},[3765,3767,3773,3775,3781,3782,3788,3790,3801],{"type":398,"value":3766},"流程中最繁琐的部分，是匹配 ",{"type":392,"tag":429,"props":3768,"children":3770},{"className":3769},[],[3771],{"type":398,"value":3772},"@media",{"type":398,"value":3774},"、",{"type":392,"tag":429,"props":3776,"children":3778},{"className":3777},[],[3779],{"type":398,"value":3780},"@import",{"type":398,"value":3774},{"type":392,"tag":429,"props":3783,"children":3785},{"className":3784},[],[3786],{"type":398,"value":3787},"@charset",{"type":398,"value":3789}," 等 ",{"type":392,"tag":411,"props":3791,"children":3794},{"href":3792,"rel":3793},"https://developer.mozilla.org/zh-CN/docs/Web/CSS/At-rule",[415],[3795],{"type":392,"tag":429,"props":3796,"children":3798},{"className":3797},[],[3799],{"type":398,"value":3800},"at-rules",{"type":398,"value":918},{"type":392,"tag":400,"props":3803,"children":3804},{},[3805],{"type":398,"value":3806},"每一种规则的语法都不同，要怎么处理才合适呢？",{"type":392,"tag":400,"props":3808,"children":3809},{},[3810,3812,3817],{"type":398,"value":3811},"这里，micro-app 把 ",{"type":392,"tag":429,"props":3813,"children":3815},{"className":3814},[],[3816],{"type":398,"value":938},{"type":398,"value":3818}," 分为了三组：",{"type":392,"tag":3820,"props":3821,"children":3822},"ol",{},[3823,3857,3889],{"type":392,"tag":3824,"props":3825,"children":3826},"li",{},[3827,3829,3835,3837,3842,3843,3848,3849,3855],{"type":398,"value":3828},"类似 ",{"type":392,"tag":429,"props":3830,"children":3832},{"className":3831},[],[3833],{"type":398,"value":3834},"@charset \"utf-8\";",{"type":398,"value":3836}," 为一组，包括 ",{"type":392,"tag":429,"props":3838,"children":3840},{"className":3839},[],[3841],{"type":398,"value":3780},{"type":398,"value":3774},{"type":392,"tag":429,"props":3844,"children":3846},{"className":3845},[],[3847],{"type":398,"value":3787},{"type":398,"value":3774},{"type":392,"tag":429,"props":3850,"children":3852},{"className":3851},[],[3853],{"type":398,"value":3854},"@namespace",{"type":398,"value":3856}," 等。",{"type":392,"tag":3824,"props":3858,"children":3859},{},[3860,3861,3867,3868,3874,3875,3881,3882,3888],{"type":398,"value":3828},{"type":392,"tag":429,"props":3862,"children":3864},{"className":3863},[],[3865],{"type":398,"value":3866},"@media (w \u003C 100px) { .selector { xxx: xxx } }",{"type":398,"value":3836},{"type":392,"tag":429,"props":3869,"children":3871},{"className":3870},[],[3872],{"type":398,"value":3873},"@supports",{"type":398,"value":3774},{"type":392,"tag":429,"props":3876,"children":3878},{"className":3877},[],[3879],{"type":398,"value":3880},"@font-face",{"type":398,"value":3774},{"type":392,"tag":429,"props":3883,"children":3885},{"className":3884},[],[3886],{"type":398,"value":3887},"@document",{"type":398,"value":3856},{"type":392,"tag":3824,"props":3890,"children":3891},{},[3892,3893,3899,3900,3905,3906,3912,3913,3919],{"type":398,"value":3828},{"type":392,"tag":429,"props":3894,"children":3896},{"className":3895},[],[3897],{"type":398,"value":3898},"@font-face { unicode-range: 'xxx' }",{"type":398,"value":3836},{"type":392,"tag":429,"props":3901,"children":3903},{"className":3902},[],[3904],{"type":398,"value":3880},{"type":398,"value":3774},{"type":392,"tag":429,"props":3907,"children":3909},{"className":3908},[],[3910],{"type":398,"value":3911},"@page",{"type":398,"value":3774},{"type":392,"tag":429,"props":3914,"children":3916},{"className":3915},[],[3917],{"type":398,"value":3918},"@key-frames",{"type":398,"value":3856},{"type":392,"tag":400,"props":3921,"children":3922},{},[3923,3925,3930,3932,3938,3940,3946,3948,3953],{"type":398,"value":3924},"第一组，",{"type":392,"tag":429,"props":3926,"children":3928},{"className":3927},[],[3929],{"type":398,"value":3787},{"type":398,"value":3931}," 所在的第一组规则的规则正文内容从 ",{"type":392,"tag":429,"props":3933,"children":3935},{"className":3934},[],[3936],{"type":398,"value":3937},"@",{"type":398,"value":3939}," 开始到 ",{"type":392,"tag":429,"props":3941,"children":3943},{"className":3942},[],[3944],{"type":398,"value":3945},";",{"type":398,"value":3947}," 结束，比如 ",{"type":392,"tag":429,"props":3949,"children":3951},{"className":3950},[],[3952],{"type":398,"value":3834},{"type":398,"value":3954}," 就是一条完整的声明；",{"type":392,"tag":400,"props":3956,"children":3957},{},[3958,3960,3966,3968,3973],{"type":398,"value":3959},"第二组，",{"type":392,"tag":429,"props":3961,"children":3963},{"className":3962},[],[3964],{"type":398,"value":3965},"@media () {}",{"type":398,"value":3967}," 的花括号部分可能包含选择器，所以其正文内容需要重新进入 ",{"type":392,"tag":429,"props":3969,"children":3971},{"className":3970},[],[3972],{"type":398,"value":1930},{"type":398,"value":3974}," 匹配选择器以及声明。",{"type":392,"tag":400,"props":3976,"children":3977},{},[3978,3980,3986,3988,3993],{"type":398,"value":3979},"第三组，",{"type":392,"tag":429,"props":3981,"children":3983},{"className":3982},[],[3984],{"type":398,"value":3985},"@font-face {}",{"type":398,"value":3987}," 的花括号部分仅包含声明，不包含选择器，所以只需要进入 ",{"type":392,"tag":429,"props":3989,"children":3991},{"className":3990},[],[3992],{"type":398,"value":3218},{"type":398,"value":3994}," 匹配声明即可。",{"type":392,"tag":393,"props":3996,"children":3998},{"id":3997},"解决问题",[3999],{"type":398,"value":3997},{"type":392,"tag":400,"props":4001,"children":4002},{},[4003],{"type":398,"value":4004},"回到文章开头的问题，如果要给这个 CSS Parser 增加原生的嵌套功能，见下代码，可以仅用十行简单实现。",{"type":392,"tag":422,"props":4006,"children":4010},{"className":4007,"code":4008,"language":4009,"meta":386,"style":386},"language-diff shiki shiki-themes material-theme-lighter github-light github-dark monokai","+ private matchAllDeclarations (nesting = 0): void {\n  let cssValue = (this.commonMatch(/^[^}/])*/, true) as RegExpExecArray)[0]\n  this.recordResult(cssValue)\n\n  // 递归退出条件\n  if (!this.cssText) return\n-  if (this.cssText.charAt(0) === '}') return\n+  if (this.cssText.charAt(0) === '}') {\n+    if (!nesting) return\n+    this.commonMatch(/}+\\s*/)\n+    return this.matchAllDeclarations(nesting - 1)\n+  }\n\n  // extract comments in declarations\n  if (this.cssText.charAt(0) === '/' && this.cssText.charAt(1) === '*') {\n    this.matchComments()\n  } else {\n    // 如果不是注释则忽略中断，继续匹配声明\n    this.commonMatch(/\\/+/)\n  }\n\n+ if (this.cssText.charAt(0) === '{') {\n+   this.commonMatch(/{+\\s*/)\n+   nesting++\n+ }\n\n- return this.matchAllDeclarations()\n+ return this.matchAllDeclarations(nesting)\n}\n","diff",[4011],{"type":392,"tag":429,"props":4012,"children":4013},{"__ignoreMap":386},[4014,4028,4036,4044,4051,4058,4066,4080,4092,4104,4116,4128,4139,4146,4153,4161,4169,4177,4184,4192,4199,4206,4218,4231,4244,4257,4265,4278,4291],{"type":392,"tag":433,"props":4015,"children":4016},{"class":435,"line":436},[4017,4022],{"type":392,"tag":433,"props":4018,"children":4020},{"style":4019},"--shiki-light:#39ADB5;--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#A6E22E",[4021],{"type":398,"value":1474},{"type":392,"tag":433,"props":4023,"children":4025},{"style":4024},"--shiki-light:#91B859;--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#A6E22E",[4026],{"type":398,"value":4027}," private matchAllDeclarations (nesting = 0): void {\n",{"type":392,"tag":433,"props":4029,"children":4030},{"class":435,"line":446},[4031],{"type":392,"tag":433,"props":4032,"children":4033},{"style":497},[4034],{"type":398,"value":4035},"  let cssValue = (this.commonMatch(/^[^}/])*/, true) as RegExpExecArray)[0]\n",{"type":392,"tag":433,"props":4037,"children":4038},{"class":435,"line":467},[4039],{"type":392,"tag":433,"props":4040,"children":4041},{"style":497},[4042],{"type":398,"value":4043},"  this.recordResult(cssValue)\n",{"type":392,"tag":433,"props":4045,"children":4046},{"class":435,"line":493},[4047],{"type":392,"tag":433,"props":4048,"children":4049},{"emptyLinePlaceholder":557},[4050],{"type":398,"value":560},{"type":392,"tag":433,"props":4052,"children":4053},{"class":435,"line":513},[4054],{"type":392,"tag":433,"props":4055,"children":4056},{"style":497},[4057],{"type":398,"value":3384},{"type":392,"tag":433,"props":4059,"children":4060},{"class":435,"line":535},[4061],{"type":392,"tag":433,"props":4062,"children":4063},{"style":497},[4064],{"type":398,"value":4065},"  if (!this.cssText) return\n",{"type":392,"tag":433,"props":4067,"children":4068},{"class":435,"line":544},[4069,4074],{"type":392,"tag":433,"props":4070,"children":4072},{"style":4071},"--shiki-light:#39ADB5;--shiki-default:#B31D28;--shiki-dark:#FDAEB7;--shiki-sepia:#F92672",[4073],{"type":398,"value":1618},{"type":392,"tag":433,"props":4075,"children":4077},{"style":4076},"--shiki-light:#E53935;--shiki-default:#B31D28;--shiki-dark:#FDAEB7;--shiki-sepia:#F92672",[4078],{"type":398,"value":4079},"  if (this.cssText.charAt(0) === '}') return\n",{"type":392,"tag":433,"props":4081,"children":4082},{"class":435,"line":553},[4083,4087],{"type":392,"tag":433,"props":4084,"children":4085},{"style":4019},[4086],{"type":398,"value":1474},{"type":392,"tag":433,"props":4088,"children":4089},{"style":4024},[4090],{"type":398,"value":4091},"  if (this.cssText.charAt(0) === '}') {\n",{"type":392,"tag":433,"props":4093,"children":4094},{"class":435,"line":563},[4095,4099],{"type":392,"tag":433,"props":4096,"children":4097},{"style":4019},[4098],{"type":398,"value":1474},{"type":392,"tag":433,"props":4100,"children":4101},{"style":4024},[4102],{"type":398,"value":4103},"    if (!nesting) return\n",{"type":392,"tag":433,"props":4105,"children":4106},{"class":435,"line":572},[4107,4111],{"type":392,"tag":433,"props":4108,"children":4109},{"style":4019},[4110],{"type":398,"value":1474},{"type":392,"tag":433,"props":4112,"children":4113},{"style":4024},[4114],{"type":398,"value":4115},"    this.commonMatch(/}+\\s*/)\n",{"type":392,"tag":433,"props":4117,"children":4118},{"class":435,"line":633},[4119,4123],{"type":392,"tag":433,"props":4120,"children":4121},{"style":4019},[4122],{"type":398,"value":1474},{"type":392,"tag":433,"props":4124,"children":4125},{"style":4024},[4126],{"type":398,"value":4127},"    return this.matchAllDeclarations(nesting - 1)\n",{"type":392,"tag":433,"props":4129,"children":4130},{"class":435,"line":653},[4131,4135],{"type":392,"tag":433,"props":4132,"children":4133},{"style":4019},[4134],{"type":398,"value":1474},{"type":392,"tag":433,"props":4136,"children":4137},{"style":4024},[4138],{"type":398,"value":541},{"type":392,"tag":433,"props":4140,"children":4141},{"class":435,"line":669},[4142],{"type":392,"tag":433,"props":4143,"children":4144},{"emptyLinePlaceholder":557},[4145],{"type":398,"value":560},{"type":392,"tag":433,"props":4147,"children":4148},{"class":435,"line":689},[4149],{"type":392,"tag":433,"props":4150,"children":4151},{"style":497},[4152],{"type":398,"value":3503},{"type":392,"tag":433,"props":4154,"children":4155},{"class":435,"line":697},[4156],{"type":392,"tag":433,"props":4157,"children":4158},{"style":497},[4159],{"type":398,"value":4160},"  if (this.cssText.charAt(0) === '/' && this.cssText.charAt(1) === '*') {\n",{"type":392,"tag":433,"props":4162,"children":4163},{"class":435,"line":705},[4164],{"type":392,"tag":433,"props":4165,"children":4166},{"style":497},[4167],{"type":398,"value":4168},"    this.matchComments()\n",{"type":392,"tag":433,"props":4170,"children":4171},{"class":435,"line":713},[4172],{"type":392,"tag":433,"props":4173,"children":4174},{"style":497},[4175],{"type":398,"value":4176},"  } else {\n",{"type":392,"tag":433,"props":4178,"children":4179},{"class":435,"line":722},[4180],{"type":392,"tag":433,"props":4181,"children":4182},{"style":497},[4183],{"type":398,"value":3665},{"type":392,"tag":433,"props":4185,"children":4186},{"class":435,"line":770},[4187],{"type":392,"tag":433,"props":4188,"children":4189},{"style":497},[4190],{"type":398,"value":4191},"    this.commonMatch(/\\/+/)\n",{"type":392,"tag":433,"props":4193,"children":4194},{"class":435,"line":790},[4195],{"type":392,"tag":433,"props":4196,"children":4197},{"style":497},[4198],{"type":398,"value":541},{"type":392,"tag":433,"props":4200,"children":4201},{"class":435,"line":806},[4202],{"type":392,"tag":433,"props":4203,"children":4204},{"emptyLinePlaceholder":557},[4205],{"type":398,"value":560},{"type":392,"tag":433,"props":4207,"children":4208},{"class":435,"line":826},[4209,4213],{"type":392,"tag":433,"props":4210,"children":4211},{"style":4019},[4212],{"type":398,"value":1474},{"type":392,"tag":433,"props":4214,"children":4215},{"style":4024},[4216],{"type":398,"value":4217}," if (this.cssText.charAt(0) === '{') {\n",{"type":392,"tag":433,"props":4219,"children":4221},{"class":435,"line":4220},23,[4222,4226],{"type":392,"tag":433,"props":4223,"children":4224},{"style":4019},[4225],{"type":398,"value":1474},{"type":392,"tag":433,"props":4227,"children":4228},{"style":4024},[4229],{"type":398,"value":4230},"   this.commonMatch(/{+\\s*/)\n",{"type":392,"tag":433,"props":4232,"children":4234},{"class":435,"line":4233},24,[4235,4239],{"type":392,"tag":433,"props":4236,"children":4237},{"style":4019},[4238],{"type":398,"value":1474},{"type":392,"tag":433,"props":4240,"children":4241},{"style":4024},[4242],{"type":398,"value":4243},"   nesting++\n",{"type":392,"tag":433,"props":4245,"children":4247},{"class":435,"line":4246},25,[4248,4252],{"type":392,"tag":433,"props":4249,"children":4250},{"style":4019},[4251],{"type":398,"value":1474},{"type":392,"tag":433,"props":4253,"children":4254},{"style":4024},[4255],{"type":398,"value":4256}," }\n",{"type":392,"tag":433,"props":4258,"children":4260},{"class":435,"line":4259},26,[4261],{"type":392,"tag":433,"props":4262,"children":4263},{"emptyLinePlaceholder":557},[4264],{"type":398,"value":560},{"type":392,"tag":433,"props":4266,"children":4268},{"class":435,"line":4267},27,[4269,4273],{"type":392,"tag":433,"props":4270,"children":4271},{"style":4071},[4272],{"type":398,"value":1618},{"type":392,"tag":433,"props":4274,"children":4275},{"style":4076},[4276],{"type":398,"value":4277}," return this.matchAllDeclarations()\n",{"type":392,"tag":433,"props":4279,"children":4281},{"class":435,"line":4280},28,[4282,4286],{"type":392,"tag":433,"props":4283,"children":4284},{"style":4019},[4285],{"type":398,"value":1474},{"type":392,"tag":433,"props":4287,"children":4288},{"style":4024},[4289],{"type":398,"value":4290}," return this.matchAllDeclarations(nesting)\n",{"type":392,"tag":433,"props":4292,"children":4294},{"class":435,"line":4293},29,[4295],{"type":392,"tag":433,"props":4296,"children":4297},{"style":497},[4298],{"type":398,"value":550},{"type":392,"tag":400,"props":4300,"children":4301},{},[4302],{"type":398,"value":4303},"最终 CSS Nesting 解析成功。",{"type":392,"tag":400,"props":4305,"children":4306},{},[4307],{"type":392,"tag":923,"props":4308,"children":4310},{"alt":1801,"src":4309},"https://mgear-image.oss-cn-shanghai.aliyuncs.com/image/other/20230804025910.png",[],{"type":392,"tag":393,"props":4312,"children":4314},{"id":4313},"结语",[4315],{"type":398,"value":4313},{"type":392,"tag":400,"props":4317,"children":4318},{},[4319],{"type":398,"value":4320},"整个 CSS Parser 的代码简单，功能强悍，耐人寻味。不过有许多边界条件没有处理好，尤其是引入了使用注释禁用样式隔离功能后，匹配注释变得更复杂且易错了。",{"type":392,"tag":3820,"props":4322,"children":4323},{},[4324],{"type":392,"tag":3824,"props":4325,"children":4326},{},[4327],{"type":398,"value":4328},"注释不能和选择器等混用（以下 result 文件代表解析结果）。",{"type":392,"tag":400,"props":4330,"children":4331},{},[4332],{"type":392,"tag":923,"props":4333,"children":4336},{"alt":4334,"src":4335},"comment in selectors","https://mgear-image.oss-cn-shanghai.aliyuncs.com/image/other/9d2b75bda238f9bbe24825a793f0f715.png",[],{"type":392,"tag":3820,"props":4338,"children":4339},{"start":446},[4340],{"type":392,"tag":3824,"props":4341,"children":4342},{},[4343],{"type":398,"value":4344},"CSS 字符串值可能意外启用编译器的特殊功能。",{"type":392,"tag":400,"props":4346,"children":4347},{},[4348],{"type":392,"tag":923,"props":4349,"children":4352},{"alt":4350,"src":4351},"special comment in string value","https://mgear-image.oss-cn-shanghai.aliyuncs.com/image/other/20230803225103.png",[],{"type":392,"tag":3820,"props":4354,"children":4355},{"start":467},[4356],{"type":392,"tag":3824,"props":4357,"children":4358},{},[4359,4361,4367,4369,4380,4382,4387],{"type":398,"value":4360},"错误的 ",{"type":392,"tag":429,"props":4362,"children":4364},{"className":4363},[],[4365],{"type":398,"value":4366},"@host",{"type":398,"value":4368}," 规则匹配。猜测是想匹配 ",{"type":392,"tag":411,"props":4370,"children":4373},{"href":4371,"rel":4372},"https://drafts.csswg.org/css-scoping/#host-selector",[415],[4374],{"type":392,"tag":429,"props":4375,"children":4377},{"className":4376},[],[4378],{"type":398,"value":4379},":host",{"type":398,"value":4381}," 但是手滑写成了 ",{"type":392,"tag":429,"props":4383,"children":4385},{"className":4384},[],[4386],{"type":398,"value":4366},{"type":398,"value":918},{"type":392,"tag":422,"props":4389,"children":4391},{"className":982,"code":4390,"language":984,"meta":386,"style":386},"private hostRule =\n  this.createMatcherForRuleWithChildRule(\n    /^@host\\s*/,\n    '@host'\n  )\n",[4392],{"type":392,"tag":429,"props":4393,"children":4394},{"__ignoreMap":386},[4395,4408,4429,4462,4479],{"type":392,"tag":433,"props":4396,"children":4397},{"class":435,"line":436},[4398,4403],{"type":392,"tag":433,"props":4399,"children":4400},{"style":497},[4401],{"type":398,"value":4402},"private hostRule ",{"type":392,"tag":433,"props":4404,"children":4405},{"style":593},[4406],{"type":398,"value":4407},"=\n",{"type":392,"tag":433,"props":4409,"children":4410},{"class":435,"line":446},[4411,4415,4419,4424],{"type":392,"tag":433,"props":4412,"children":4413},{"style":1049},[4414],{"type":398,"value":1352},{"type":392,"tag":433,"props":4416,"children":4417},{"style":461},[4418],{"type":398,"value":453},{"type":392,"tag":433,"props":4420,"children":4421},{"style":1059},[4422],{"type":398,"value":4423},"createMatcherForRuleWithChildRule",{"type":392,"tag":433,"props":4425,"children":4426},{"style":497},[4427],{"type":398,"value":4428},"(\n",{"type":392,"tag":433,"props":4430,"children":4431},{"class":435,"line":467},[4432,4437,4441,4445,4449,4453,4457],{"type":392,"tag":433,"props":4433,"children":4434},{"style":599},[4435],{"type":398,"value":4436},"    /",{"type":392,"tag":433,"props":4438,"children":4439},{"style":1037},[4440],{"type":398,"value":2266},{"type":392,"tag":433,"props":4442,"children":4443},{"style":2906},[4444],{"type":398,"value":4366},{"type":392,"tag":433,"props":4446,"children":4447},{"style":2269},[4448],{"type":398,"value":2272},{"type":392,"tag":433,"props":4450,"children":4451},{"style":593},[4452],{"type":398,"value":1227},{"type":392,"tag":433,"props":4454,"children":4455},{"style":599},[4456],{"type":398,"value":1171},{"type":392,"tag":433,"props":4458,"children":4459},{"style":461},[4460],{"type":398,"value":4461},",\n",{"type":392,"tag":433,"props":4463,"children":4464},{"class":435,"line":493},[4465,4470,4474],{"type":392,"tag":433,"props":4466,"children":4467},{"style":599},[4468],{"type":398,"value":4469},"    '",{"type":392,"tag":433,"props":4471,"children":4472},{"style":605},[4473],{"type":398,"value":4366},{"type":392,"tag":433,"props":4475,"children":4476},{"style":599},[4477],{"type":398,"value":4478},"'\n",{"type":392,"tag":433,"props":4480,"children":4481},{"class":435,"line":513},[4482],{"type":392,"tag":433,"props":4483,"children":4484},{"style":497},[4485],{"type":398,"value":4486},"  )\n",{"type":392,"tag":400,"props":4488,"children":4489},{},[4490],{"type":392,"tag":923,"props":4491,"children":4494},{"alt":4492,"src":4493},"error @host rule","https://mgear-image.oss-cn-shanghai.aliyuncs.com/image/other/20230803235802.png",[],{"type":392,"tag":400,"props":4496,"children":4497},{},[4498,4500,4507],{"type":398,"value":4499},"在实际项目中，考虑到性能和可维护性的平衡，为了使代码不变得过于复杂，没有必要去完善“边界功能”。运行时的解析应当尽量简单且运行快速，并保持一定的容错：不规范的 CSS 代码在浏览器中本身就能运行，再者，解析器是一个容易带来代码性能和体积瓶颈的地方，要不然 VueJS 也不会分全局构建和运行时",{"type":392,"tag":411,"props":4501,"children":4504},{"href":4502,"rel":4503},"https://www.jsdelivr.com/package/npm/vue?tab=files&path=dist",[415],[4505],{"type":398,"value":4506},"两个版本的编译产物",{"type":398,"value":918},{"type":392,"tag":400,"props":4509,"children":4510},{},[4511],{"type":398,"value":4512},"鉴于 CSS 在部分语法上的灵活性，如果从降低维护难度的角度考虑优化这个 CSS Parser，可能从以下方向：",{"type":392,"tag":4514,"props":4515,"children":4516},"ul",{},[4517,4552],{"type":392,"tag":3824,"props":4518,"children":4519},{},[4520,4522,4527,4529,4535,4537,4542,4544,4551],{"type":398,"value":4521},"在规则匹配部分使用黑名单机制而不是白名单匹配。就 ",{"type":392,"tag":429,"props":4523,"children":4525},{"className":4524},[],[4526],{"type":398,"value":938},{"type":398,"value":4528}," 等灵活语法而言，如果浏览器支持新的 ",{"type":392,"tag":429,"props":4530,"children":4532},{"className":4531},[],[4533],{"type":398,"value":4534},"@xxx",{"type":398,"value":4536}," 语法，黑名单机制编写的代码不需要对 ",{"type":392,"tag":429,"props":4538,"children":4540},{"className":4539},[],[4541],{"type":398,"value":4534},{"type":398,"value":4543}," 做额外处理；而白名单机制需要",{"type":392,"tag":411,"props":4545,"children":4548},{"href":4546,"rel":4547},"https://github.com/micro-zoe/micro-app/commit/b83c4600102e0db6f591bacbdc592bea8f1d5bb8",[415],[4549],{"type":398,"value":4550},"手动处理",{"type":398,"value":918},{"type":392,"tag":3824,"props":4553,"children":4554},{},[4555,4557,4568],{"type":398,"value":4556},"在复杂的解析器部分使用外部依赖，如使用类似 ",{"type":392,"tag":411,"props":4558,"children":4561},{"href":4559,"rel":4560},"https://www.npmjs.com/package/lightningcss-wasm/v/1.16.0",[415],[4562],{"type":392,"tag":429,"props":4563,"children":4565},{"className":4564},[],[4566],{"type":398,"value":4567},"lightingcss-wasm",{"type":398,"value":4569}," 等方案。",{"type":392,"tag":400,"props":4571,"children":4572},{},[4573],{"type":398,"value":4574},"关于样式隔离，作者两年前专门写了文章介绍，不过时效性稍有不足，没有涉及解析器的具体流程，写得更多是解析器在整个微前端框架中的作用，也可作为补充阅读。",{"type":392,"tag":4514,"props":4576,"children":4577},{},[4578],{"type":392,"tag":3824,"props":4579,"children":4580},{},[4581],{"type":392,"tag":411,"props":4582,"children":4585},{"href":4583,"rel":4584},"https://github.com/micro-zoe/micro-app/issues/20",[415],[4586],{"type":398,"value":4587},"从零开始写一个微前端框架-样式隔离篇",{"type":392,"tag":400,"props":4589,"children":4590},{},[4591],{"type":398,"value":4592},"最后，微前端框架中的 CSS 的有很多中实施办法，采用一些办法可以抛弃运行时解析。em... 也许以后有机会聊一聊（咕一咕）。",{"type":392,"tag":393,"props":4594,"children":4596},{"id":4595},"增订-2024年1月28日",[4597],{"type":398,"value":4598},"增订 | 2024年1月28日",{"type":392,"tag":400,"props":4600,"children":4601},{},[4602,4604],{"type":398,"value":4603},"相关实现和测试用例见",{"type":392,"tag":411,"props":4605,"children":4608},{"href":4606,"rel":4607},"https://github.com/micro-zoe/micro-app/issues/868?_issue=nesting",[415],[4609],{"type":398,"value":4610},"这个 Issue",{"type":392,"tag":4612,"props":4613,"children":4616},"section",{"className":4614,"dataFootnotes":386},[4615],"footnotes",[4617,4624],{"type":392,"tag":393,"props":4618,"children":4621},{"className":4619,"id":912},[4620],"sr-only",[4622],{"type":398,"value":4623},"Footnotes",{"type":392,"tag":3820,"props":4625,"children":4626},{},[4627],{"type":392,"tag":3824,"props":4628,"children":4630},{"id":4629},"user-content-fn-css-syntax",[4631,4633,4639,4641],{"type":398,"value":4632},"比较完整的 CSS 语法参见：",{"type":392,"tag":411,"props":4634,"children":4637},{"href":4635,"rel":4636},"https://developer.mozilla.org/zh-CN/docs/Web/CSS/Syntax",[415],[4638],{"type":398,"value":4635},{"type":398,"value":4640}," ",{"type":392,"tag":411,"props":4642,"children":4647},{"href":4643,"ariaLabel":4644,"className":4645,"dataFootnoteBackref":386},"#user-content-fnref-css-syntax","Back to reference 1",[4646],"data-footnote-backref",[4648],{"type":398,"value":4649},"↩",{"type":392,"tag":4651,"props":4652,"children":4653},"style",{},[4654],{"type":398,"value":4655},"html .light .shiki span {color: var(--shiki-light);background: var(--shiki-light-bg);font-style: var(--shiki-light-font-style);font-weight: var(--shiki-light-font-weight);text-decoration: var(--shiki-light-text-decoration);}html.light .shiki span {color: var(--shiki-light);background: var(--shiki-light-bg);font-style: var(--shiki-light-font-style);font-weight: var(--shiki-light-font-weight);text-decoration: var(--shiki-light-text-decoration);}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html .sepia .shiki span {color: var(--shiki-sepia);background: var(--shiki-sepia-bg);font-style: var(--shiki-sepia-font-style);font-weight: var(--shiki-sepia-font-weight);text-decoration: var(--shiki-sepia-text-decoration);}html.sepia .shiki span {color: var(--shiki-sepia);background: var(--shiki-sepia-bg);font-style: var(--shiki-sepia-font-style);font-weight: var(--shiki-sepia-font-weight);text-decoration: var(--shiki-sepia-text-decoration);}",{"title":386,"searchDepth":446,"depth":446,"links":4657},[4658,4659,4660,4661,4662,4663,4664],{"id":395,"depth":446,"text":395},{"id":840,"depth":446,"text":843},{"id":943,"depth":446,"text":943},{"id":3997,"depth":446,"text":3997},{"id":4313,"depth":446,"text":4313},{"id":4595,"depth":446,"text":4598},{"id":912,"depth":446,"text":4623},"markdown","content:2.articles:1.mini-css-parser.md","content","2.articles/1.mini-css-parser.md","md",[4671,4673],{"_path":40,"title":39,"description":4672},"忍者秘籍中提到的模板解析器，很短但支持变量和 if 等语句，还是 15 年前的代码！",{"_path":46,"title":45,"description":4674},"在两个纯知识面的问题上，受到了 GPT 的碾压",1708107553984]