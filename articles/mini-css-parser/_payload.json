[{"data":1,"prerenderedAt":4678},["Reactive",2],{"navigation":3,"/articles/mini-css-parser":386,"/articles/mini-css-parser-surround":4673},[4,32,80,96,123,129,135,369,375,381],{"title":5,"_path":6,"children":7},"心流思绪 / Heart Flows","/flows",[8,11,14,17,20,23,26,29],{"title":9,"_path":10},"📕 狮子的书单推荐","/flows/books",{"title":12,"_path":13},"🌃 长夜梦","/flows/long-night-dream",{"title":15,"_path":16},"🌌 万物联结与幸福感","/flows/everything",{"title":18,"_path":19},"⌛ 偷取时间","/flows/stealing-time-from-god",{"title":21,"_path":22},"🌆 表达和孤独","/flows/expression-and-loneliness",{"title":24,"_path":25},"🌧️ 我的腼腆","/flows/shy",{"title":27,"_path":28},"🥛 新工作，喝新饮料","/flows/drinking-while-thinking",{"title":30,"_path":31},"📝 心流归档","/flows/fold",{"title":33,"_path":34,"children":35},"技术博客 / Coder","/articles",[36,38,41,44,47,50,53,56,59,62,65,68,71,74,77],{"title":37,"_path":34},"🦁 为什么我要写博客",{"title":39,"_path":40},"🧊 模板解析器轻考古","/articles/micro-templating",{"title":42,"_path":43},"Ⓜ️ Mini CSS Parser","/articles/mini-css-parser",{"title":45,"_path":46},"🚩 向AI咨询前端问题","/articles/use-gpt-learn-complex-frontend",{"title":48,"_path":49},"⛸️ 怎样定制复杂组件的自定义滚动条？","/articles/use-scrollbars",{"title":51,"_path":52},"⚖️ 统一多组件库的层叠顺序","/articles/zindex-manager",{"title":54,"_path":55},"🕷️ 滑动验证码破解思路","/articles/crack-the-slider",{"title":57,"_path":58},"🌟 探秘 CSS 光影效果","/articles/css-light-travel",{"title":60,"_path":61},"🍲 设计模式与 JS 魔法锅","/articles/design-patterns-and-js-magic-pot",{"title":63,"_path":64},"🌐 Anysort：灵活、优雅的多属性排序","/articles/anysort-2th",{"title":66,"_path":67},"💫 CSS 幻术 | 抗锯齿","/articles/css-poaa",{"title":69,"_path":70},"❓ 用纯CSS判断鼠标进入的方向","/articles/css-judge-direction",{"title":72,"_path":73},"📝 你本可以少写些 if-else","/articles/no-more-if-else",{"title":75,"_path":76},"🚝 四十二篇系列","/articles/fourty-two",{"title":78,"_path":79},"📝 技术博客归档","/articles/fold",{"title":81,"_path":82,"children":83},"造物 / Make","/tools",[84,87,90,93],{"title":85,"_path":86},"🌐 AnySort","/tools/anysort",{"title":88,"_path":89},"⛸️ UseScrollbar","/tools/use-scrollbar",{"title":91,"_path":92},"👓 Crapto","/tools/crypto-inline",{"title":94,"_path":95},"🖨️ any-to-base64","/tools/any-to-base64",{"title":97,"_path":98,"children":99},"吉他剧场 / Music","/music",[100,102,105,108,111,114,117,120],{"title":101,"_path":98},"🎸 FingerStyle！",{"title":103,"_path":104},"🌬️ 等待的风","/music/wind",{"title":106,"_path":107},"💕 约定的海洋","/music/ocean",{"title":109,"_path":110},"🎼 Wings~You are the Hero！","/music/wings-you-are-the-hero",{"title":112,"_path":113},"🌏 残酷天使的行动纲领","/music/eva",{"title":115,"_path":116},"🏔️ 奇跡の山","/music/miracle-mountain",{"title":118,"_path":119},"🍷 Wu Wei","/music/wu-wei",{"title":121,"_path":122},"🌅 无题","/music/untitled",{"title":124,"_path":125,"children":126},"画点什么 / Paint","/paint",[127],{"title":128,"_path":125},"🚧 正在施工",{"title":130,"_path":131,"children":132},"知识地图 / Maps","/maps",[133],{"title":134,"_path":131},"🏁 知识地图",{"title":136,"_path":137,"children":138},"零散的笔记 / Gists","/gists",[139,141,144,147,150,153,156,159,162,165,168,171,174,177,180,183,186,189,192,195,198,201,204,207,210,213,216,219,222,225,228,231,234,237,240,243,246,249,252,255,258,261,264,267,270,273,276,279,282,285,288,291,294,297,300,303,306,309,312,315,318,321,324,327,330,333,336,339,342,345,348,351,354,357,360,363,366],{"title":140,"_path":137},"🧊 Gists",{"title":142,"_path":143},"网站的可访问性","/gists/accessibility",{"title":145,"_path":146},"Bit","/gists/bit",{"title":148,"_path":149},"图片模糊","/gists/blur",{"title":151,"_path":152},"渲染相关笔记","/gists/c4d",{"title":154,"_path":155},"CDN 问题记录","/gists/cdn",{"title":157,"_path":158},"消毒剂","/gists/cleaner",{"title":160,"_path":161},"Windows Command","/gists/cmd",{"title":163,"_path":164},"Command","/gists/command",{"title":166,"_path":167},"复杂科学","/gists/complexity-science",{"title":169,"_path":170},"宇宙","/gists/cosmos",{"title":172,"_path":173},"C++","/gists/cpp",{"title":175,"_path":176},"Data Structure","/gists/data-structure",{"title":178,"_path":179},"DEPRESSION","/gists/depression",{"title":181,"_path":182},"设计模式","/gists/design-patterns",{"title":184,"_path":185},"Developer Experience","/gists/developer-experience",{"title":187,"_path":188},"Device Metrics","/gists/device-metrix",{"title":190,"_path":191},"ECMAScript Language Specification","/gists/ecmascript-specification",{"title":193,"_path":194},"正则表达式","/gists/eegex",{"title":196,"_path":197},"Emoji","/gists/emoji",{"title":199,"_path":200},"工程","/gists/engineering",{"title":202,"_path":203},"熵","/gists/entropy",{"title":205,"_path":206},"Environment","/gists/environment",{"title":208,"_path":209},"Erlang","/gists/erlang",{"title":211,"_path":212},"逃离塔克夫","/gists/escape-from-tarkov",{"title":214,"_path":215},"ESNext (ES6-ES11)","/gists/esnext",{"title":217,"_path":218},"Eval！","/gists/eval",{"title":220,"_path":221},"Flutter","/gists/flutter",{"title":223,"_path":224},"字体","/gists/font",{"title":226,"_path":227},"JS 函数式编程","/gists/functional",{"title":229,"_path":230},"Google C++ Standard","/gists/google-cpp-standard",{"title":232,"_path":233},"双向链接完全体","/gists/graph",{"title":235,"_path":236},"Hardwares","/gists/hardwares",{"title":238,"_path":239},"哈希冲突","/gists/hash-collision",{"title":241,"_path":242},"信息设计","/gists/information-design",{"title":244,"_path":245},"InstantPage","/gists/instant.page",{"title":247,"_path":248},"ISUX 遇见大数据可视化系列","/gists/isux-data-visualization",{"title":250,"_path":251},"KVStore","/gists/key-value-db",{"title":253,"_path":254},"Kubernetes","/gists/kubernetes",{"title":256,"_path":257},"Makefile","/gists/makefile",{"title":259,"_path":260},"Markdown Inline Style","/gists/markdown-nice",{"title":262,"_path":263},"小程序","/gists/miniapp",{"title":265,"_path":266},"减小页面快照体积","/gists/minify-html",{"title":268,"_path":269},"mklink","/gists/mklink",{"title":271,"_path":272},"Mock","/gists/mock",{"title":274,"_path":275},"多端应用","/gists/multy-end-app",{"title":277,"_path":278},"神经科学","/gists/neuroscience",{"title":280,"_path":281},"OO","/gists/oo",{"title":283,"_path":284},"Opinioned Personal Folder","/gists/opinioned-personal-folder",{"title":286,"_path":287},"人物","/gists/person",{"title":289,"_path":290},"PInvoke","/gists/pinvoke",{"title":292,"_path":293},"像素","/gists/pixel",{"title":295,"_path":296},"PowerShell","/gists/powershell",{"title":298,"_path":299},"量子","/gists/quantum",{"title":301,"_path":302},"保持好奇心","/gists/questions",{"title":304,"_path":305},"React Native","/gists/react-native",{"title":307,"_path":308},"博客改版碰到的浏览器平滑滚动问题","/gists/scroll",{"title":310,"_path":311},"SEO","/gists/seo",{"title":313,"_path":314},"Shader","/gists/shader",{"title":316,"_path":317},"Shape Up","/gists/shape-up",{"title":319,"_path":320},"睡觉","/gists/sleep",{"title":322,"_path":323},"States","/gists/states",{"title":325,"_path":326},"Storage","/gists/storage",{"title":328,"_path":329},"音视频流处理","/gists/stream-cli",{"title":331,"_path":332},"Symbol","/gists/symbol",{"title":334,"_path":335},"系统论","/gists/systems-theory",{"title":337,"_path":338},"Taro","/gists/taro",{"title":340,"_path":341},"任务切片","/gists/task-slice",{"title":343,"_path":344},"技术偏好","/gists/tech-dudge",{"title":346,"_path":347},"Untitled","/gists/untitled",{"title":349,"_path":350},"可变字体","/gists/variable-font",{"title":352,"_path":353},"视觉错觉","/gists/visual-illusion",{"title":355,"_path":356},"SS(SSR)","/gists/vpn",{"title":358,"_path":359},"VS Code 插件开发","/gists/vscode-plugin",{"title":361,"_path":362},"Web Components","/gists/web-components",{"title":364,"_path":365},"Windows","/gists/windows",{"title":367,"_path":368},"查缺补漏","/gists/wrong",{"title":370,"_path":371,"children":372},"代码笔记 / Gists","/source-code",[373],{"title":374,"_path":371},"🚄 代码笔记",{"title":376,"_path":377,"children":378},"我 / Abount","/hire",[379],{"title":380,"_path":377},"📬 技术简历",{"title":382,"_path":383,"children":384},"todo","/todo",[385],{"title":382,"_path":383},{"_path":43,"_dir":387,"_draft":388,"_partial":388,"_locale":389,"title":42,"description":390,"body":391,"_type":4668,"_id":4669,"_source":4670,"_file":4671,"_extension":4672},"articles",false,"","我的项目使用 micro-app 框架作为微前端框架。使用 micro-app 时，由于开启了样式隔离功能，子应用加载的 CSS 会被解析器解析，在选择器前增加一个子应用属性选择器前缀。我碰到的问题是，如果 CSS 源码中带嵌套语法那么解析就会失败。今天借这个问题给大家简单介绍一下 CSS Parser 的基本流程。",{"type":392,"children":393,"toc":4659},"root",[394,402,408,424,841,847,922,931,944,949,955,978,983,1301,1306,1683,1711,1782,1787,1807,1832,1904,1909,1914,2199,2211,2304,2343,2360,2643,2687,3162,3203,3754,3765,3805,3810,3822,3923,3958,3978,3998,4003,4008,4302,4307,4314,4319,4324,4332,4340,4348,4356,4391,4490,4498,4511,4516,4573,4578,4591,4596,4602,4614,4653],{"type":395,"tag":396,"props":397,"children":399},"element","h2",{"id":398},"前言",[400],{"type":401,"value":398},"text",{"type":395,"tag":403,"props":404,"children":405},"p",{},[406],{"type":401,"value":407},"Vue 源码中包含 HTML Parser，随着大家在框架方向的深入学习（卷），不免要开始接触一些编译解析相关的东西。社区很多看 Vue 源码时总结的 HTML Parser 的文章，但是很少有介绍 CSS Parser 的文章。今天借着在开发时碰到的一个问题，给大家简单介绍一下 CSS Parser 的基本流程。",{"type":395,"tag":403,"props":409,"children":410},{},[411,413,422],{"type":401,"value":412},"我的项目使用 micro-app 框架作为微前端框架。使用 micro-app 时，由于开启了样式隔离功能，子应用加载的 CSS 会被解析器解析，在选择器前增加一个子应用属性选择器前缀。代码示例见下。我碰到的问题是，如果 CSS 源码中带",{"type":395,"tag":414,"props":415,"children":419},"a",{"href":416,"rel":417},"https://caniuse.com/?search=css%20nesting",[418],"nofollow",[420],{"type":401,"value":421},"嵌套语法",{"type":401,"value":423},"，那么解析就会失败。",{"type":395,"tag":425,"props":426,"children":430},"pre",{"className":427,"code":428,"language":429,"meta":389,"style":389},"language-css shiki shiki-themes material-theme-lighter github-light github-dark monokai","/* css 源代码 */\n.a {\n  z-index: 1;\n  .b {\n    z-index: 2;\n  }\n}\n\n/* 期待转化得到的代码 */\nmicro-app[name=\"test-app\"] .a {\n  z-index: 1;\n  .b {\n    z-index: 2;\n  }\n}\n\n/* 实际得到的代码 */\nmicro-app[name=\"test-app\"] .a {\n  z-index: 1;\n  .b {\n    z-index: 2;\n  } /* -> 到这里就停了 */\n","css",[431],{"type":395,"tag":432,"props":433,"children":434},"code",{"__ignoreMap":389},[435,447,468,494,514,536,545,554,564,573,634,654,670,690,698,706,714,723,771,791,807,827],{"type":395,"tag":436,"props":437,"children":440},"span",{"class":438,"line":439},"line",1,[441],{"type":395,"tag":436,"props":442,"children":444},{"style":443},"--shiki-light:#90A4AE;--shiki-default:#6A737D;--shiki-dark:#6A737D;--shiki-sepia:#88846F;--shiki-light-font-style:italic;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:inherit",[445],{"type":401,"value":446},"/* css 源代码 */\n",{"type":395,"tag":436,"props":448,"children":450},{"class":438,"line":449},2,[451,457,462],{"type":395,"tag":436,"props":452,"children":454},{"style":453},"--shiki-light:#39ADB5;--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E",[455],{"type":401,"value":456},".",{"type":395,"tag":436,"props":458,"children":460},{"style":459},"--shiki-light:#E2931D;--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E",[461],{"type":401,"value":414},{"type":395,"tag":436,"props":463,"children":465},{"style":464},"--shiki-light:#39ADB5;--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2",[466],{"type":401,"value":467}," {\n",{"type":395,"tag":436,"props":469,"children":471},{"class":438,"line":470},3,[472,478,483,489],{"type":395,"tag":436,"props":473,"children":475},{"style":474},"--shiki-light:#8796B0;--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF;--shiki-light-font-style:inherit;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic",[476],{"type":401,"value":477},"  z-index",{"type":395,"tag":436,"props":479,"children":480},{"style":464},[481],{"type":401,"value":482},":",{"type":395,"tag":436,"props":484,"children":486},{"style":485},"--shiki-light:#F76D47;--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF",[487],{"type":401,"value":488}," 1",{"type":395,"tag":436,"props":490,"children":491},{"style":464},[492],{"type":401,"value":493},";\n",{"type":395,"tag":436,"props":495,"children":497},{"class":438,"line":496},4,[498,504,510],{"type":395,"tag":436,"props":499,"children":501},{"style":500},"--shiki-light:#90A4AE;--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2",[502],{"type":401,"value":503},"  .",{"type":395,"tag":436,"props":505,"children":507},{"style":506},"--shiki-light:#90A4AE;--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#F8F8F2",[508],{"type":401,"value":509},"b",{"type":395,"tag":436,"props":511,"children":512},{"style":500},[513],{"type":401,"value":467},{"type":395,"tag":436,"props":515,"children":517},{"class":438,"line":516},5,[518,523,527,532],{"type":395,"tag":436,"props":519,"children":520},{"style":474},[521],{"type":401,"value":522},"    z-index",{"type":395,"tag":436,"props":524,"children":525},{"style":464},[526],{"type":401,"value":482},{"type":395,"tag":436,"props":528,"children":529},{"style":485},[530],{"type":401,"value":531}," 2",{"type":395,"tag":436,"props":533,"children":534},{"style":464},[535],{"type":401,"value":493},{"type":395,"tag":436,"props":537,"children":539},{"class":438,"line":538},6,[540],{"type":395,"tag":436,"props":541,"children":542},{"style":464},[543],{"type":401,"value":544},"  }\n",{"type":395,"tag":436,"props":546,"children":548},{"class":438,"line":547},7,[549],{"type":395,"tag":436,"props":550,"children":551},{"style":500},[552],{"type":401,"value":553},"}\n",{"type":395,"tag":436,"props":555,"children":557},{"class":438,"line":556},8,[558],{"type":395,"tag":436,"props":559,"children":561},{"emptyLinePlaceholder":560},true,[562],{"type":401,"value":563},"\n",{"type":395,"tag":436,"props":565,"children":567},{"class":438,"line":566},9,[568],{"type":395,"tag":436,"props":569,"children":570},{"style":443},[571],{"type":401,"value":572},"/* 期待转化得到的代码 */\n",{"type":395,"tag":436,"props":574,"children":576},{"class":438,"line":575},10,[577,583,588,594,600,606,612,616,621,626,630],{"type":395,"tag":436,"props":578,"children":580},{"style":579},"--shiki-light:#E2931D;--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#F92672",[581],{"type":401,"value":582},"micro-app",{"type":395,"tag":436,"props":584,"children":585},{"style":464},[586],{"type":401,"value":587},"[",{"type":395,"tag":436,"props":589,"children":591},{"style":590},"--shiki-light:#9C3EDA;--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E",[592],{"type":401,"value":593},"name",{"type":395,"tag":436,"props":595,"children":597},{"style":596},"--shiki-light:#39ADB5;--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672",[598],{"type":401,"value":599},"=",{"type":395,"tag":436,"props":601,"children":603},{"style":602},"--shiki-light:#39ADB5;--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74",[604],{"type":401,"value":605},"\"",{"type":395,"tag":436,"props":607,"children":609},{"style":608},"--shiki-light:#91B859;--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#E6DB74",[610],{"type":401,"value":611},"test-app",{"type":395,"tag":436,"props":613,"children":614},{"style":602},[615],{"type":401,"value":605},{"type":395,"tag":436,"props":617,"children":618},{"style":464},[619],{"type":401,"value":620},"]",{"type":395,"tag":436,"props":622,"children":623},{"style":453},[624],{"type":401,"value":625}," .",{"type":395,"tag":436,"props":627,"children":628},{"style":459},[629],{"type":401,"value":414},{"type":395,"tag":436,"props":631,"children":632},{"style":464},[633],{"type":401,"value":467},{"type":395,"tag":436,"props":635,"children":637},{"class":438,"line":636},11,[638,642,646,650],{"type":395,"tag":436,"props":639,"children":640},{"style":474},[641],{"type":401,"value":477},{"type":395,"tag":436,"props":643,"children":644},{"style":464},[645],{"type":401,"value":482},{"type":395,"tag":436,"props":647,"children":648},{"style":485},[649],{"type":401,"value":488},{"type":395,"tag":436,"props":651,"children":652},{"style":464},[653],{"type":401,"value":493},{"type":395,"tag":436,"props":655,"children":657},{"class":438,"line":656},12,[658,662,666],{"type":395,"tag":436,"props":659,"children":660},{"style":500},[661],{"type":401,"value":503},{"type":395,"tag":436,"props":663,"children":664},{"style":506},[665],{"type":401,"value":509},{"type":395,"tag":436,"props":667,"children":668},{"style":500},[669],{"type":401,"value":467},{"type":395,"tag":436,"props":671,"children":673},{"class":438,"line":672},13,[674,678,682,686],{"type":395,"tag":436,"props":675,"children":676},{"style":474},[677],{"type":401,"value":522},{"type":395,"tag":436,"props":679,"children":680},{"style":464},[681],{"type":401,"value":482},{"type":395,"tag":436,"props":683,"children":684},{"style":485},[685],{"type":401,"value":531},{"type":395,"tag":436,"props":687,"children":688},{"style":464},[689],{"type":401,"value":493},{"type":395,"tag":436,"props":691,"children":693},{"class":438,"line":692},14,[694],{"type":395,"tag":436,"props":695,"children":696},{"style":464},[697],{"type":401,"value":544},{"type":395,"tag":436,"props":699,"children":701},{"class":438,"line":700},15,[702],{"type":395,"tag":436,"props":703,"children":704},{"style":500},[705],{"type":401,"value":553},{"type":395,"tag":436,"props":707,"children":709},{"class":438,"line":708},16,[710],{"type":395,"tag":436,"props":711,"children":712},{"emptyLinePlaceholder":560},[713],{"type":401,"value":563},{"type":395,"tag":436,"props":715,"children":717},{"class":438,"line":716},17,[718],{"type":395,"tag":436,"props":719,"children":720},{"style":443},[721],{"type":401,"value":722},"/* 实际得到的代码 */\n",{"type":395,"tag":436,"props":724,"children":726},{"class":438,"line":725},18,[727,731,735,739,743,747,751,755,759,763,767],{"type":395,"tag":436,"props":728,"children":729},{"style":579},[730],{"type":401,"value":582},{"type":395,"tag":436,"props":732,"children":733},{"style":464},[734],{"type":401,"value":587},{"type":395,"tag":436,"props":736,"children":737},{"style":590},[738],{"type":401,"value":593},{"type":395,"tag":436,"props":740,"children":741},{"style":596},[742],{"type":401,"value":599},{"type":395,"tag":436,"props":744,"children":745},{"style":602},[746],{"type":401,"value":605},{"type":395,"tag":436,"props":748,"children":749},{"style":608},[750],{"type":401,"value":611},{"type":395,"tag":436,"props":752,"children":753},{"style":602},[754],{"type":401,"value":605},{"type":395,"tag":436,"props":756,"children":757},{"style":464},[758],{"type":401,"value":620},{"type":395,"tag":436,"props":760,"children":761},{"style":453},[762],{"type":401,"value":625},{"type":395,"tag":436,"props":764,"children":765},{"style":459},[766],{"type":401,"value":414},{"type":395,"tag":436,"props":768,"children":769},{"style":464},[770],{"type":401,"value":467},{"type":395,"tag":436,"props":772,"children":774},{"class":438,"line":773},19,[775,779,783,787],{"type":395,"tag":436,"props":776,"children":777},{"style":474},[778],{"type":401,"value":477},{"type":395,"tag":436,"props":780,"children":781},{"style":464},[782],{"type":401,"value":482},{"type":395,"tag":436,"props":784,"children":785},{"style":485},[786],{"type":401,"value":488},{"type":395,"tag":436,"props":788,"children":789},{"style":464},[790],{"type":401,"value":493},{"type":395,"tag":436,"props":792,"children":794},{"class":438,"line":793},20,[795,799,803],{"type":395,"tag":436,"props":796,"children":797},{"style":500},[798],{"type":401,"value":503},{"type":395,"tag":436,"props":800,"children":801},{"style":506},[802],{"type":401,"value":509},{"type":395,"tag":436,"props":804,"children":805},{"style":500},[806],{"type":401,"value":467},{"type":395,"tag":436,"props":808,"children":810},{"class":438,"line":809},21,[811,815,819,823],{"type":395,"tag":436,"props":812,"children":813},{"style":474},[814],{"type":401,"value":522},{"type":395,"tag":436,"props":816,"children":817},{"style":464},[818],{"type":401,"value":482},{"type":395,"tag":436,"props":820,"children":821},{"style":485},[822],{"type":401,"value":531},{"type":395,"tag":436,"props":824,"children":825},{"style":464},[826],{"type":401,"value":493},{"type":395,"tag":436,"props":828,"children":830},{"class":438,"line":829},22,[831,836],{"type":395,"tag":436,"props":832,"children":833},{"style":464},[834],{"type":401,"value":835},"  }",{"type":395,"tag":436,"props":837,"children":838},{"style":443},[839],{"type":401,"value":840}," /* -> 到这里就停了 */\n",{"type":395,"tag":396,"props":842,"children":844},{"id":843},"css-的组成部分",[845],{"type":401,"value":846},"CSS 的组成部分",{"type":395,"tag":403,"props":848,"children":849},{},[850,852,859,861,867,869,875,877,883,885,891,893,899,901,907,920],{"type":401,"value":851},"要理解 CSS 是怎么解析的，就要先清楚 CSS 是由哪几部分组成的。由我们平常见得最多的普通 CSS 代码开始说起，见下图，基本的 CSS 代码的组成部分包含规则集（rules）、选择器（selector）、选择器（declares）、属性（property）、值（value）这五个部分。",{"type":395,"tag":853,"props":854,"children":856},"abbr",{"title":855},"rule",[857],{"type":401,"value":858},"规则",{"type":401,"value":860},"是由",{"type":395,"tag":853,"props":862,"children":864},{"title":863},"property",[865],{"type":401,"value":866},"属性",{"type":401,"value":868},"和",{"type":395,"tag":853,"props":870,"children":872},{"title":871},"value",[873],{"type":401,"value":874},"值",{"type":401,"value":876},"组成的",{"type":395,"tag":853,"props":878,"children":880},{"title":879},"declaration",[881],{"type":401,"value":882},"声明",{"type":401,"value":884},"、声明与括号形成的",{"type":395,"tag":853,"props":886,"children":888},{"title":887},"declaration block",[889],{"type":401,"value":890},"声明块",{"type":401,"value":892},"再加上",{"type":395,"tag":853,"props":894,"children":896},{"title":895},"selector",[897],{"type":401,"value":898},"选择器",{"type":401,"value":900},"组成，而一条或多条规则组合成了",{"type":395,"tag":853,"props":902,"children":904},{"title":903},"rule sets",[905],{"type":401,"value":906},"规则集",{"type":395,"tag":908,"props":909,"children":910},"sup",{},[911],{"type":395,"tag":414,"props":912,"children":917},{"href":913,"ariaDescribedBy":914,"dataFootnoteRef":389,"id":916},"#user-content-fn-css-syntax",[915],"footnote-label","user-content-fnref-css-syntax",[918],{"type":401,"value":919},"1",{"type":401,"value":921},"。",{"type":395,"tag":403,"props":923,"children":924},{},[925],{"type":395,"tag":926,"props":927,"children":930},"img",{"alt":928,"src":929},"规则&规则集","https://mgear-image.oss-cn-shanghai.aliyuncs.com/image/200621/20200625022018.png",[],{"type":395,"tag":403,"props":932,"children":933},{},[934,936,942],{"type":401,"value":935},"图中没有包含 ",{"type":395,"tag":432,"props":937,"children":939},{"className":938},[],[940],{"type":401,"value":941},"at-rule",{"type":401,"value":943}," 的部分，哦，还少了注释部分~ 由于注释是 CSS 中语法最简单的部分，我们从解析注释开始代码部分的解读吧。",{"type":395,"tag":396,"props":945,"children":947},{"id":946},"流程速览",[948],{"type":401,"value":946},{"type":395,"tag":950,"props":951,"children":953},"h4",{"id":952},"解析注释",[954],{"type":401,"value":952},{"type":395,"tag":403,"props":956,"children":957},{},[958,960,967,969,976],{"type":401,"value":959},"可能许多人不了解 CSS 的注释风格，这里先说明一下，原生 CSS 仅支持",{"type":395,"tag":414,"props":961,"children":964},{"href":962,"rel":963},"https://developer.mozilla.org/zh-CN/docs/Web/CSS/Comments",[418],[965],{"type":401,"value":966},"斜杠星号风格注释",{"type":401,"value":968},"，不支持",{"type":395,"tag":414,"props":970,"children":973},{"href":971,"rel":972},"https://segmentfault.com/a/1190000043885414",[418],[974],{"type":401,"value":975},"双斜杠注释",{"type":401,"value":977},"，所以解析器并未处理双斜杠的情况。",{"type":395,"tag":403,"props":979,"children":980},{},[981],{"type":401,"value":982},"解析注释的函数是一个 while 循环，从代码开头开始匹配，每次循环解析一条注释，直到代码开头没有注释为止。",{"type":395,"tag":425,"props":984,"children":988},{"className":985,"code":986,"language":987,"meta":389,"style":389},"language-ts shiki shiki-themes material-theme-lighter github-light github-dark monokai","class CSSParser {\n  private matchComments() {\n    while (this.matchComment());\n  }\n  private matchComment () {\n    // 快速跳过非注释部分代码\n    if (this.cssText.charAt(0) !== '/' || this.cssText.charAt(1) !== '*') {\n      return false\n    }\n    // ...\n    return true\n  }\n}\n","ts",[989],{"type":395,"tag":432,"props":990,"children":991},{"__ignoreMap":389},[992,1011,1035,1075,1082,1103,1111,1244,1258,1266,1274,1287,1294],{"type":395,"tag":436,"props":993,"children":994},{"class":438,"line":439},[995,1001,1007],{"type":395,"tag":436,"props":996,"children":998},{"style":997},"--shiki-light:#9C3EDA;--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#66D9EF;--shiki-light-font-style:inherit;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic",[999],{"type":401,"value":1000},"class",{"type":395,"tag":436,"props":1002,"children":1004},{"style":1003},"--shiki-light:#E2931D;--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E;--shiki-light-text-decoration:inherit;--shiki-default-text-decoration:inherit;--shiki-dark-text-decoration:inherit;--shiki-sepia-text-decoration:underline",[1005],{"type":401,"value":1006}," CSSParser",{"type":395,"tag":436,"props":1008,"children":1009},{"style":464},[1010],{"type":401,"value":467},{"type":395,"tag":436,"props":1012,"children":1013},{"class":438,"line":449},[1014,1020,1026,1031],{"type":395,"tag":436,"props":1015,"children":1017},{"style":1016},"--shiki-light:#9C3EDA;--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672",[1018],{"type":401,"value":1019},"  private",{"type":395,"tag":436,"props":1021,"children":1023},{"style":1022},"--shiki-light:#E53935;--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E",[1024],{"type":401,"value":1025}," matchComments",{"type":395,"tag":436,"props":1027,"children":1028},{"style":464},[1029],{"type":401,"value":1030},"()",{"type":395,"tag":436,"props":1032,"children":1033},{"style":464},[1034],{"type":401,"value":467},{"type":395,"tag":436,"props":1036,"children":1037},{"class":438,"line":470},[1038,1044,1050,1056,1060,1066,1071],{"type":395,"tag":436,"props":1039,"children":1041},{"style":1040},"--shiki-light:#39ADB5;--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672;--shiki-light-font-style:italic;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:inherit",[1042],{"type":401,"value":1043},"    while",{"type":395,"tag":436,"props":1045,"children":1047},{"style":1046},"--shiki-light:#E53935;--shiki-default:#24292E;--shiki-dark:#E1E4E8;--shiki-sepia:#F8F8F2",[1048],{"type":401,"value":1049}," (",{"type":395,"tag":436,"props":1051,"children":1053},{"style":1052},"--shiki-light:#39ADB5;--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#FD971F",[1054],{"type":401,"value":1055},"this",{"type":395,"tag":436,"props":1057,"children":1058},{"style":464},[1059],{"type":401,"value":456},{"type":395,"tag":436,"props":1061,"children":1063},{"style":1062},"--shiki-light:#6182B8;--shiki-default:#6F42C1;--shiki-dark:#B392F0;--shiki-sepia:#A6E22E",[1064],{"type":401,"value":1065},"matchComment",{"type":395,"tag":436,"props":1067,"children":1068},{"style":1046},[1069],{"type":401,"value":1070},"())",{"type":395,"tag":436,"props":1072,"children":1073},{"style":464},[1074],{"type":401,"value":493},{"type":395,"tag":436,"props":1076,"children":1077},{"class":438,"line":496},[1078],{"type":395,"tag":436,"props":1079,"children":1080},{"style":464},[1081],{"type":401,"value":544},{"type":395,"tag":436,"props":1083,"children":1084},{"class":438,"line":516},[1085,1089,1094,1099],{"type":395,"tag":436,"props":1086,"children":1087},{"style":1016},[1088],{"type":401,"value":1019},{"type":395,"tag":436,"props":1090,"children":1091},{"style":1022},[1092],{"type":401,"value":1093}," matchComment",{"type":395,"tag":436,"props":1095,"children":1096},{"style":464},[1097],{"type":401,"value":1098}," ()",{"type":395,"tag":436,"props":1100,"children":1101},{"style":464},[1102],{"type":401,"value":467},{"type":395,"tag":436,"props":1104,"children":1105},{"class":438,"line":538},[1106],{"type":395,"tag":436,"props":1107,"children":1108},{"style":443},[1109],{"type":401,"value":1110},"    // 快速跳过非注释部分代码\n",{"type":395,"tag":436,"props":1112,"children":1113},{"class":438,"line":547},[1114,1119,1123,1127,1131,1136,1140,1145,1150,1155,1160,1165,1170,1175,1180,1185,1190,1194,1198,1202,1206,1210,1214,1218,1222,1226,1231,1235,1239],{"type":395,"tag":436,"props":1115,"children":1116},{"style":1040},[1117],{"type":401,"value":1118},"    if",{"type":395,"tag":436,"props":1120,"children":1121},{"style":1046},[1122],{"type":401,"value":1049},{"type":395,"tag":436,"props":1124,"children":1125},{"style":1052},[1126],{"type":401,"value":1055},{"type":395,"tag":436,"props":1128,"children":1129},{"style":464},[1130],{"type":401,"value":456},{"type":395,"tag":436,"props":1132,"children":1133},{"style":500},[1134],{"type":401,"value":1135},"cssText",{"type":395,"tag":436,"props":1137,"children":1138},{"style":464},[1139],{"type":401,"value":456},{"type":395,"tag":436,"props":1141,"children":1142},{"style":1062},[1143],{"type":401,"value":1144},"charAt",{"type":395,"tag":436,"props":1146,"children":1147},{"style":1046},[1148],{"type":401,"value":1149},"(",{"type":395,"tag":436,"props":1151,"children":1152},{"style":485},[1153],{"type":401,"value":1154},"0",{"type":395,"tag":436,"props":1156,"children":1157},{"style":1046},[1158],{"type":401,"value":1159},") ",{"type":395,"tag":436,"props":1161,"children":1162},{"style":596},[1163],{"type":401,"value":1164},"!==",{"type":395,"tag":436,"props":1166,"children":1167},{"style":602},[1168],{"type":401,"value":1169}," '",{"type":395,"tag":436,"props":1171,"children":1172},{"style":608},[1173],{"type":401,"value":1174},"/",{"type":395,"tag":436,"props":1176,"children":1177},{"style":602},[1178],{"type":401,"value":1179},"'",{"type":395,"tag":436,"props":1181,"children":1182},{"style":596},[1183],{"type":401,"value":1184}," ||",{"type":395,"tag":436,"props":1186,"children":1187},{"style":1052},[1188],{"type":401,"value":1189}," this",{"type":395,"tag":436,"props":1191,"children":1192},{"style":464},[1193],{"type":401,"value":456},{"type":395,"tag":436,"props":1195,"children":1196},{"style":500},[1197],{"type":401,"value":1135},{"type":395,"tag":436,"props":1199,"children":1200},{"style":464},[1201],{"type":401,"value":456},{"type":395,"tag":436,"props":1203,"children":1204},{"style":1062},[1205],{"type":401,"value":1144},{"type":395,"tag":436,"props":1207,"children":1208},{"style":1046},[1209],{"type":401,"value":1149},{"type":395,"tag":436,"props":1211,"children":1212},{"style":485},[1213],{"type":401,"value":919},{"type":395,"tag":436,"props":1215,"children":1216},{"style":1046},[1217],{"type":401,"value":1159},{"type":395,"tag":436,"props":1219,"children":1220},{"style":596},[1221],{"type":401,"value":1164},{"type":395,"tag":436,"props":1223,"children":1224},{"style":602},[1225],{"type":401,"value":1169},{"type":395,"tag":436,"props":1227,"children":1228},{"style":608},[1229],{"type":401,"value":1230},"*",{"type":395,"tag":436,"props":1232,"children":1233},{"style":602},[1234],{"type":401,"value":1179},{"type":395,"tag":436,"props":1236,"children":1237},{"style":1046},[1238],{"type":401,"value":1159},{"type":395,"tag":436,"props":1240,"children":1241},{"style":464},[1242],{"type":401,"value":1243},"{\n",{"type":395,"tag":436,"props":1245,"children":1246},{"class":438,"line":556},[1247,1252],{"type":395,"tag":436,"props":1248,"children":1249},{"style":1040},[1250],{"type":401,"value":1251},"      return",{"type":395,"tag":436,"props":1253,"children":1255},{"style":1254},"--shiki-light:#FF5370;--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF",[1256],{"type":401,"value":1257}," false\n",{"type":395,"tag":436,"props":1259,"children":1260},{"class":438,"line":566},[1261],{"type":395,"tag":436,"props":1262,"children":1263},{"style":464},[1264],{"type":401,"value":1265},"    }\n",{"type":395,"tag":436,"props":1267,"children":1268},{"class":438,"line":575},[1269],{"type":395,"tag":436,"props":1270,"children":1271},{"style":443},[1272],{"type":401,"value":1273},"    // ...\n",{"type":395,"tag":436,"props":1275,"children":1276},{"class":438,"line":636},[1277,1282],{"type":395,"tag":436,"props":1278,"children":1279},{"style":1040},[1280],{"type":401,"value":1281},"    return",{"type":395,"tag":436,"props":1283,"children":1284},{"style":1254},[1285],{"type":401,"value":1286}," true\n",{"type":395,"tag":436,"props":1288,"children":1289},{"class":438,"line":656},[1290],{"type":395,"tag":436,"props":1291,"children":1292},{"style":464},[1293],{"type":401,"value":544},{"type":395,"tag":436,"props":1295,"children":1296},{"class":438,"line":672},[1297],{"type":395,"tag":436,"props":1298,"children":1299},{"style":464},[1300],{"type":401,"value":553},{"type":395,"tag":403,"props":1302,"children":1303},{},[1304],{"type":401,"value":1305},"在选择解析注释内容的方法上，micro-app 没有使用正则，而是用了下标递增的办法。暂不清楚原因，感兴趣的小伙伴可以试试几种相关办法的性能对比。",{"type":395,"tag":425,"props":1307,"children":1309},{"className":985,"code":1308,"language":987,"meta":389,"style":389},"let i = 2\nwhile (\n  this.cssText.charAt(i) !== '' && \n  (this.cssText.charAt(i) !== '*' || this.cssText.charAt(i + 1) !== '/')\n) {\n  ++i\n}\ni += 2\n\nlet commentText = this.cssText.slice(2, i - 2)\n/* ... */\nthis.cssText = this.cssText.slice(i)\n",[1310],{"type":395,"tag":432,"props":1311,"children":1312},{"__ignoreMap":389},[1313,1335,1348,1396,1507,1518,1531,1538,1555,1562,1630,1638],{"type":395,"tag":436,"props":1314,"children":1315},{"class":438,"line":439},[1316,1321,1326,1330],{"type":395,"tag":436,"props":1317,"children":1318},{"style":997},[1319],{"type":401,"value":1320},"let",{"type":395,"tag":436,"props":1322,"children":1323},{"style":500},[1324],{"type":401,"value":1325}," i ",{"type":395,"tag":436,"props":1327,"children":1328},{"style":596},[1329],{"type":401,"value":599},{"type":395,"tag":436,"props":1331,"children":1332},{"style":485},[1333],{"type":401,"value":1334}," 2\n",{"type":395,"tag":436,"props":1336,"children":1337},{"class":438,"line":449},[1338,1343],{"type":395,"tag":436,"props":1339,"children":1340},{"style":1040},[1341],{"type":401,"value":1342},"while",{"type":395,"tag":436,"props":1344,"children":1345},{"style":500},[1346],{"type":401,"value":1347}," (\n",{"type":395,"tag":436,"props":1349,"children":1350},{"class":438,"line":470},[1351,1356,1360,1364,1368,1372,1377,1381,1386,1391],{"type":395,"tag":436,"props":1352,"children":1353},{"style":1052},[1354],{"type":401,"value":1355},"  this",{"type":395,"tag":436,"props":1357,"children":1358},{"style":464},[1359],{"type":401,"value":456},{"type":395,"tag":436,"props":1361,"children":1362},{"style":500},[1363],{"type":401,"value":1135},{"type":395,"tag":436,"props":1365,"children":1366},{"style":464},[1367],{"type":401,"value":456},{"type":395,"tag":436,"props":1369,"children":1370},{"style":1062},[1371],{"type":401,"value":1144},{"type":395,"tag":436,"props":1373,"children":1374},{"style":500},[1375],{"type":401,"value":1376},"(i) ",{"type":395,"tag":436,"props":1378,"children":1379},{"style":596},[1380],{"type":401,"value":1164},{"type":395,"tag":436,"props":1382,"children":1383},{"style":602},[1384],{"type":401,"value":1385}," ''",{"type":395,"tag":436,"props":1387,"children":1388},{"style":596},[1389],{"type":401,"value":1390}," &&",{"type":395,"tag":436,"props":1392,"children":1393},{"style":500},[1394],{"type":401,"value":1395}," \n",{"type":395,"tag":436,"props":1397,"children":1398},{"class":438,"line":496},[1399,1404,1408,1412,1416,1420,1424,1428,1432,1436,1440,1444,1448,1452,1456,1460,1464,1468,1473,1478,1482,1486,1490,1494,1498,1502],{"type":395,"tag":436,"props":1400,"children":1401},{"style":500},[1402],{"type":401,"value":1403},"  (",{"type":395,"tag":436,"props":1405,"children":1406},{"style":1052},[1407],{"type":401,"value":1055},{"type":395,"tag":436,"props":1409,"children":1410},{"style":464},[1411],{"type":401,"value":456},{"type":395,"tag":436,"props":1413,"children":1414},{"style":500},[1415],{"type":401,"value":1135},{"type":395,"tag":436,"props":1417,"children":1418},{"style":464},[1419],{"type":401,"value":456},{"type":395,"tag":436,"props":1421,"children":1422},{"style":1062},[1423],{"type":401,"value":1144},{"type":395,"tag":436,"props":1425,"children":1426},{"style":500},[1427],{"type":401,"value":1376},{"type":395,"tag":436,"props":1429,"children":1430},{"style":596},[1431],{"type":401,"value":1164},{"type":395,"tag":436,"props":1433,"children":1434},{"style":602},[1435],{"type":401,"value":1169},{"type":395,"tag":436,"props":1437,"children":1438},{"style":608},[1439],{"type":401,"value":1230},{"type":395,"tag":436,"props":1441,"children":1442},{"style":602},[1443],{"type":401,"value":1179},{"type":395,"tag":436,"props":1445,"children":1446},{"style":596},[1447],{"type":401,"value":1184},{"type":395,"tag":436,"props":1449,"children":1450},{"style":1052},[1451],{"type":401,"value":1189},{"type":395,"tag":436,"props":1453,"children":1454},{"style":464},[1455],{"type":401,"value":456},{"type":395,"tag":436,"props":1457,"children":1458},{"style":500},[1459],{"type":401,"value":1135},{"type":395,"tag":436,"props":1461,"children":1462},{"style":464},[1463],{"type":401,"value":456},{"type":395,"tag":436,"props":1465,"children":1466},{"style":1062},[1467],{"type":401,"value":1144},{"type":395,"tag":436,"props":1469,"children":1470},{"style":500},[1471],{"type":401,"value":1472},"(i ",{"type":395,"tag":436,"props":1474,"children":1475},{"style":596},[1476],{"type":401,"value":1477},"+",{"type":395,"tag":436,"props":1479,"children":1480},{"style":485},[1481],{"type":401,"value":488},{"type":395,"tag":436,"props":1483,"children":1484},{"style":500},[1485],{"type":401,"value":1159},{"type":395,"tag":436,"props":1487,"children":1488},{"style":596},[1489],{"type":401,"value":1164},{"type":395,"tag":436,"props":1491,"children":1492},{"style":602},[1493],{"type":401,"value":1169},{"type":395,"tag":436,"props":1495,"children":1496},{"style":608},[1497],{"type":401,"value":1174},{"type":395,"tag":436,"props":1499,"children":1500},{"style":602},[1501],{"type":401,"value":1179},{"type":395,"tag":436,"props":1503,"children":1504},{"style":500},[1505],{"type":401,"value":1506},")\n",{"type":395,"tag":436,"props":1508,"children":1509},{"class":438,"line":516},[1510,1514],{"type":395,"tag":436,"props":1511,"children":1512},{"style":500},[1513],{"type":401,"value":1159},{"type":395,"tag":436,"props":1515,"children":1516},{"style":464},[1517],{"type":401,"value":1243},{"type":395,"tag":436,"props":1519,"children":1520},{"class":438,"line":538},[1521,1526],{"type":395,"tag":436,"props":1522,"children":1523},{"style":596},[1524],{"type":401,"value":1525},"  ++",{"type":395,"tag":436,"props":1527,"children":1528},{"style":500},[1529],{"type":401,"value":1530},"i\n",{"type":395,"tag":436,"props":1532,"children":1533},{"class":438,"line":547},[1534],{"type":395,"tag":436,"props":1535,"children":1536},{"style":464},[1537],{"type":401,"value":553},{"type":395,"tag":436,"props":1539,"children":1540},{"class":438,"line":556},[1541,1546,1551],{"type":395,"tag":436,"props":1542,"children":1543},{"style":500},[1544],{"type":401,"value":1545},"i ",{"type":395,"tag":436,"props":1547,"children":1548},{"style":596},[1549],{"type":401,"value":1550},"+=",{"type":395,"tag":436,"props":1552,"children":1553},{"style":485},[1554],{"type":401,"value":1334},{"type":395,"tag":436,"props":1556,"children":1557},{"class":438,"line":566},[1558],{"type":395,"tag":436,"props":1559,"children":1560},{"emptyLinePlaceholder":560},[1561],{"type":401,"value":563},{"type":395,"tag":436,"props":1563,"children":1564},{"class":438,"line":575},[1565,1569,1574,1578,1582,1586,1590,1594,1599,1603,1608,1613,1617,1622,1626],{"type":395,"tag":436,"props":1566,"children":1567},{"style":997},[1568],{"type":401,"value":1320},{"type":395,"tag":436,"props":1570,"children":1571},{"style":500},[1572],{"type":401,"value":1573}," commentText ",{"type":395,"tag":436,"props":1575,"children":1576},{"style":596},[1577],{"type":401,"value":599},{"type":395,"tag":436,"props":1579,"children":1580},{"style":1052},[1581],{"type":401,"value":1189},{"type":395,"tag":436,"props":1583,"children":1584},{"style":464},[1585],{"type":401,"value":456},{"type":395,"tag":436,"props":1587,"children":1588},{"style":500},[1589],{"type":401,"value":1135},{"type":395,"tag":436,"props":1591,"children":1592},{"style":464},[1593],{"type":401,"value":456},{"type":395,"tag":436,"props":1595,"children":1596},{"style":1062},[1597],{"type":401,"value":1598},"slice",{"type":395,"tag":436,"props":1600,"children":1601},{"style":500},[1602],{"type":401,"value":1149},{"type":395,"tag":436,"props":1604,"children":1605},{"style":485},[1606],{"type":401,"value":1607},"2",{"type":395,"tag":436,"props":1609,"children":1610},{"style":464},[1611],{"type":401,"value":1612},",",{"type":395,"tag":436,"props":1614,"children":1615},{"style":500},[1616],{"type":401,"value":1325},{"type":395,"tag":436,"props":1618,"children":1619},{"style":596},[1620],{"type":401,"value":1621},"-",{"type":395,"tag":436,"props":1623,"children":1624},{"style":485},[1625],{"type":401,"value":531},{"type":395,"tag":436,"props":1627,"children":1628},{"style":500},[1629],{"type":401,"value":1506},{"type":395,"tag":436,"props":1631,"children":1632},{"class":438,"line":636},[1633],{"type":395,"tag":436,"props":1634,"children":1635},{"style":443},[1636],{"type":401,"value":1637},"/* ... */\n",{"type":395,"tag":436,"props":1639,"children":1640},{"class":438,"line":656},[1641,1645,1649,1654,1658,1662,1666,1670,1674,1678],{"type":395,"tag":436,"props":1642,"children":1643},{"style":1052},[1644],{"type":401,"value":1055},{"type":395,"tag":436,"props":1646,"children":1647},{"style":464},[1648],{"type":401,"value":456},{"type":395,"tag":436,"props":1650,"children":1651},{"style":500},[1652],{"type":401,"value":1653},"cssText ",{"type":395,"tag":436,"props":1655,"children":1656},{"style":596},[1657],{"type":401,"value":599},{"type":395,"tag":436,"props":1659,"children":1660},{"style":1052},[1661],{"type":401,"value":1189},{"type":395,"tag":436,"props":1663,"children":1664},{"style":464},[1665],{"type":401,"value":456},{"type":395,"tag":436,"props":1667,"children":1668},{"style":500},[1669],{"type":401,"value":1135},{"type":395,"tag":436,"props":1671,"children":1672},{"style":464},[1673],{"type":401,"value":456},{"type":395,"tag":436,"props":1675,"children":1676},{"style":1062},[1677],{"type":401,"value":1598},{"type":395,"tag":436,"props":1679,"children":1680},{"style":500},[1681],{"type":401,"value":1682},"(i)\n",{"type":395,"tag":403,"props":1684,"children":1685},{},[1686,1688,1694,1696,1701,1703,1709],{"type":401,"value":1687},"注释的正文结果保存在了变量 ",{"type":395,"tag":432,"props":1689,"children":1691},{"className":1690},[],[1692],{"type":401,"value":1693},"commentText",{"type":401,"value":1695}," 中，这样可以判断 ",{"type":395,"tag":432,"props":1697,"children":1699},{"className":1698},[],[1700],{"type":401,"value":1693},{"type":401,"value":1702}," 的内容来实现通过注释禁用某个选择器、禁用某行的样式隔离之类的功能。比如想让 ",{"type":395,"tag":432,"props":1704,"children":1706},{"className":1705},[],[1707],{"type":401,"value":1708},".test2",{"type":401,"value":1710}," 选择器不被 scoped 规则覆盖，我们可以在业务代码中这样写。",{"type":395,"tag":425,"props":1712,"children":1714},{"className":427,"code":1713,"language":429,"meta":389,"style":389},"/*! scopecss-disable-next-line */\n.test2 {\n  background: url(/test.png);\n}\n",[1715],{"type":395,"tag":432,"props":1716,"children":1717},{"__ignoreMap":389},[1718,1726,1742,1775],{"type":395,"tag":436,"props":1719,"children":1720},{"class":438,"line":439},[1721],{"type":395,"tag":436,"props":1722,"children":1723},{"style":443},[1724],{"type":401,"value":1725},"/*! scopecss-disable-next-line */\n",{"type":395,"tag":436,"props":1727,"children":1728},{"class":438,"line":449},[1729,1733,1738],{"type":395,"tag":436,"props":1730,"children":1731},{"style":453},[1732],{"type":401,"value":456},{"type":395,"tag":436,"props":1734,"children":1735},{"style":459},[1736],{"type":401,"value":1737},"test2",{"type":395,"tag":436,"props":1739,"children":1740},{"style":464},[1741],{"type":401,"value":467},{"type":395,"tag":436,"props":1743,"children":1744},{"class":438,"line":470},[1745,1750,1754,1760,1764,1770],{"type":395,"tag":436,"props":1746,"children":1747},{"style":474},[1748],{"type":401,"value":1749},"  background",{"type":395,"tag":436,"props":1751,"children":1752},{"style":464},[1753],{"type":401,"value":482},{"type":395,"tag":436,"props":1755,"children":1757},{"style":1756},"--shiki-light:#6182B8;--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#66D9EF",[1758],{"type":401,"value":1759}," url",{"type":395,"tag":436,"props":1761,"children":1762},{"style":464},[1763],{"type":401,"value":1149},{"type":395,"tag":436,"props":1765,"children":1767},{"style":1766},"--shiki-light:#90A4AE;--shiki-default:#E36209;--shiki-dark:#FFAB70;--shiki-sepia:#FD971F;--shiki-light-font-style:italic;--shiki-default-font-style:inherit;--shiki-dark-font-style:inherit;--shiki-sepia-font-style:italic",[1768],{"type":401,"value":1769},"/test.png",{"type":395,"tag":436,"props":1771,"children":1772},{"style":464},[1773],{"type":401,"value":1774},");\n",{"type":395,"tag":436,"props":1776,"children":1777},{"class":438,"line":496},[1778],{"type":395,"tag":436,"props":1779,"children":1780},{"style":464},[1781],{"type":401,"value":553},{"type":395,"tag":950,"props":1783,"children":1785},{"id":1784},"输入输出",[1786],{"type":401,"value":1784},{"type":395,"tag":403,"props":1788,"children":1789},{},[1790,1792,1797,1799,1805],{"type":401,"value":1791},"“解析注释”中“解析”实际指对输入的 CSS 源文件待处理部分以及处理好的输出部分做出改变。这里引申出解析器里两个关键状态，",{"type":395,"tag":432,"props":1793,"children":1795},{"className":1794},[],[1796],{"type":401,"value":1135},{"type":401,"value":1798}," 和 ",{"type":395,"tag":432,"props":1800,"children":1802},{"className":1801},[],[1803],{"type":401,"value":1804},"result",{"type":401,"value":1806},"，分别代表待解析的内容和最终输出结果。",{"type":395,"tag":403,"props":1808,"children":1809},{},[1810,1815,1817,1822,1824,1830],{"type":395,"tag":432,"props":1811,"children":1813},{"className":1812},[],[1814],{"type":401,"value":1135},{"type":401,"value":1816}," 随着循环应当逐渐减小直到为空，此时代表解析完成。",{"type":395,"tag":432,"props":1818,"children":1820},{"className":1819},[],[1821],{"type":401,"value":1804},{"type":401,"value":1823}," 能被内部方法 ",{"type":395,"tag":432,"props":1825,"children":1827},{"className":1826},[],[1828],{"type":401,"value":1829},"recordResult",{"type":401,"value":1831}," 改变，比如如果要把注释的正文内容记录到输出结果，可以这样使用：",{"type":395,"tag":425,"props":1833,"children":1835},{"className":985,"code":1834,"language":987,"meta":389,"style":389},"this.recordResult(`/*${commentText}*/`)\n// 相当于：this.result += `/*${commentText}*/`\n",[1836],{"type":395,"tag":432,"props":1837,"children":1838},{"__ignoreMap":389},[1839,1896],{"type":395,"tag":436,"props":1840,"children":1841},{"class":438,"line":439},[1842,1846,1850,1854,1858,1863,1868,1874,1878,1883,1888,1892],{"type":395,"tag":436,"props":1843,"children":1844},{"style":1052},[1845],{"type":401,"value":1055},{"type":395,"tag":436,"props":1847,"children":1848},{"style":464},[1849],{"type":401,"value":456},{"type":395,"tag":436,"props":1851,"children":1852},{"style":1062},[1853],{"type":401,"value":1829},{"type":395,"tag":436,"props":1855,"children":1856},{"style":500},[1857],{"type":401,"value":1149},{"type":395,"tag":436,"props":1859,"children":1860},{"style":602},[1861],{"type":401,"value":1862},"`",{"type":395,"tag":436,"props":1864,"children":1865},{"style":608},[1866],{"type":401,"value":1867},"/*",{"type":395,"tag":436,"props":1869,"children":1871},{"style":1870},"--shiki-light:#39ADB5;--shiki-default:#032F62;--shiki-dark:#9ECBFF;--shiki-sepia:#F92672",[1872],{"type":401,"value":1873},"${",{"type":395,"tag":436,"props":1875,"children":1876},{"style":500},[1877],{"type":401,"value":1693},{"type":395,"tag":436,"props":1879,"children":1880},{"style":1870},[1881],{"type":401,"value":1882},"}",{"type":395,"tag":436,"props":1884,"children":1885},{"style":608},[1886],{"type":401,"value":1887},"*/",{"type":395,"tag":436,"props":1889,"children":1890},{"style":602},[1891],{"type":401,"value":1862},{"type":395,"tag":436,"props":1893,"children":1894},{"style":500},[1895],{"type":401,"value":1506},{"type":395,"tag":436,"props":1897,"children":1898},{"class":438,"line":449},[1899],{"type":395,"tag":436,"props":1900,"children":1901},{"style":443},[1902],{"type":401,"value":1903},"// 相当于：this.result += `/*${commentText}*/`\n",{"type":395,"tag":950,"props":1905,"children":1907},{"id":1906},"解析规则集",[1908],{"type":401,"value":1906},{"type":395,"tag":403,"props":1910,"children":1911},{},[1912],{"type":401,"value":1913},"规则集的解析是整个解析的核心过程。原理与解析注释类似，也是一个 while 循环。每一轮循环都会尝试匹配一条规则，并且将多余的注释和空白字符匹配出来。",{"type":395,"tag":425,"props":1915,"children":1917},{"className":985,"code":1916,"language":987,"meta":389,"style":389},"private matchRules (): void {\n  this.matchLeadingSpaces()\n  this.matchComments()\n  while (\n    this.cssText.length &&\n    this.cssText.charAt(0) !== '}' &&\n    (this.matchAtRule() || this.matchStyleRule())\n  ) {\n    this.matchComments()\n    this.matchLeadingSpaces()\n  }\n}\n",[1918],{"type":395,"tag":432,"props":1919,"children":1920},{"__ignoreMap":389},[1921,1948,1969,1989,2001,2031,2086,2135,2147,2166,2185,2192],{"type":395,"tag":436,"props":1922,"children":1923},{"class":438,"line":439},[1924,1929,1934,1939,1944],{"type":395,"tag":436,"props":1925,"children":1926},{"style":500},[1927],{"type":401,"value":1928},"private ",{"type":395,"tag":436,"props":1930,"children":1931},{"style":1062},[1932],{"type":401,"value":1933},"matchRules",{"type":395,"tag":436,"props":1935,"children":1936},{"style":500},[1937],{"type":401,"value":1938}," (): ",{"type":395,"tag":436,"props":1940,"children":1941},{"style":596},[1942],{"type":401,"value":1943},"void",{"type":395,"tag":436,"props":1945,"children":1946},{"style":464},[1947],{"type":401,"value":467},{"type":395,"tag":436,"props":1949,"children":1950},{"class":438,"line":449},[1951,1955,1959,1964],{"type":395,"tag":436,"props":1952,"children":1953},{"style":1052},[1954],{"type":401,"value":1355},{"type":395,"tag":436,"props":1956,"children":1957},{"style":464},[1958],{"type":401,"value":456},{"type":395,"tag":436,"props":1960,"children":1961},{"style":1062},[1962],{"type":401,"value":1963},"matchLeadingSpaces",{"type":395,"tag":436,"props":1965,"children":1966},{"style":1046},[1967],{"type":401,"value":1968},"()\n",{"type":395,"tag":436,"props":1970,"children":1971},{"class":438,"line":470},[1972,1976,1980,1985],{"type":395,"tag":436,"props":1973,"children":1974},{"style":1052},[1975],{"type":401,"value":1355},{"type":395,"tag":436,"props":1977,"children":1978},{"style":464},[1979],{"type":401,"value":456},{"type":395,"tag":436,"props":1981,"children":1982},{"style":1062},[1983],{"type":401,"value":1984},"matchComments",{"type":395,"tag":436,"props":1986,"children":1987},{"style":1046},[1988],{"type":401,"value":1968},{"type":395,"tag":436,"props":1990,"children":1991},{"class":438,"line":496},[1992,1997],{"type":395,"tag":436,"props":1993,"children":1994},{"style":1040},[1995],{"type":401,"value":1996},"  while",{"type":395,"tag":436,"props":1998,"children":1999},{"style":1046},[2000],{"type":401,"value":1347},{"type":395,"tag":436,"props":2002,"children":2003},{"class":438,"line":516},[2004,2009,2013,2017,2021,2026],{"type":395,"tag":436,"props":2005,"children":2006},{"style":1052},[2007],{"type":401,"value":2008},"    this",{"type":395,"tag":436,"props":2010,"children":2011},{"style":464},[2012],{"type":401,"value":456},{"type":395,"tag":436,"props":2014,"children":2015},{"style":500},[2016],{"type":401,"value":1135},{"type":395,"tag":436,"props":2018,"children":2019},{"style":464},[2020],{"type":401,"value":456},{"type":395,"tag":436,"props":2022,"children":2023},{"style":506},[2024],{"type":401,"value":2025},"length",{"type":395,"tag":436,"props":2027,"children":2028},{"style":596},[2029],{"type":401,"value":2030}," &&\n",{"type":395,"tag":436,"props":2032,"children":2033},{"class":438,"line":538},[2034,2038,2042,2046,2050,2054,2058,2062,2066,2070,2074,2078,2082],{"type":395,"tag":436,"props":2035,"children":2036},{"style":1052},[2037],{"type":401,"value":2008},{"type":395,"tag":436,"props":2039,"children":2040},{"style":464},[2041],{"type":401,"value":456},{"type":395,"tag":436,"props":2043,"children":2044},{"style":500},[2045],{"type":401,"value":1135},{"type":395,"tag":436,"props":2047,"children":2048},{"style":464},[2049],{"type":401,"value":456},{"type":395,"tag":436,"props":2051,"children":2052},{"style":1062},[2053],{"type":401,"value":1144},{"type":395,"tag":436,"props":2055,"children":2056},{"style":1046},[2057],{"type":401,"value":1149},{"type":395,"tag":436,"props":2059,"children":2060},{"style":485},[2061],{"type":401,"value":1154},{"type":395,"tag":436,"props":2063,"children":2064},{"style":1046},[2065],{"type":401,"value":1159},{"type":395,"tag":436,"props":2067,"children":2068},{"style":596},[2069],{"type":401,"value":1164},{"type":395,"tag":436,"props":2071,"children":2072},{"style":602},[2073],{"type":401,"value":1169},{"type":395,"tag":436,"props":2075,"children":2076},{"style":608},[2077],{"type":401,"value":1882},{"type":395,"tag":436,"props":2079,"children":2080},{"style":602},[2081],{"type":401,"value":1179},{"type":395,"tag":436,"props":2083,"children":2084},{"style":596},[2085],{"type":401,"value":2030},{"type":395,"tag":436,"props":2087,"children":2088},{"class":438,"line":547},[2089,2094,2098,2102,2107,2112,2117,2121,2125,2130],{"type":395,"tag":436,"props":2090,"children":2091},{"style":1046},[2092],{"type":401,"value":2093},"    (",{"type":395,"tag":436,"props":2095,"children":2096},{"style":1052},[2097],{"type":401,"value":1055},{"type":395,"tag":436,"props":2099,"children":2100},{"style":464},[2101],{"type":401,"value":456},{"type":395,"tag":436,"props":2103,"children":2104},{"style":1062},[2105],{"type":401,"value":2106},"matchAtRule",{"type":395,"tag":436,"props":2108,"children":2109},{"style":1046},[2110],{"type":401,"value":2111},"() ",{"type":395,"tag":436,"props":2113,"children":2114},{"style":596},[2115],{"type":401,"value":2116},"||",{"type":395,"tag":436,"props":2118,"children":2119},{"style":1052},[2120],{"type":401,"value":1189},{"type":395,"tag":436,"props":2122,"children":2123},{"style":464},[2124],{"type":401,"value":456},{"type":395,"tag":436,"props":2126,"children":2127},{"style":1062},[2128],{"type":401,"value":2129},"matchStyleRule",{"type":395,"tag":436,"props":2131,"children":2132},{"style":1046},[2133],{"type":401,"value":2134},"())\n",{"type":395,"tag":436,"props":2136,"children":2137},{"class":438,"line":556},[2138,2143],{"type":395,"tag":436,"props":2139,"children":2140},{"style":1046},[2141],{"type":401,"value":2142},"  ) ",{"type":395,"tag":436,"props":2144,"children":2145},{"style":464},[2146],{"type":401,"value":1243},{"type":395,"tag":436,"props":2148,"children":2149},{"class":438,"line":566},[2150,2154,2158,2162],{"type":395,"tag":436,"props":2151,"children":2152},{"style":1052},[2153],{"type":401,"value":2008},{"type":395,"tag":436,"props":2155,"children":2156},{"style":464},[2157],{"type":401,"value":456},{"type":395,"tag":436,"props":2159,"children":2160},{"style":1062},[2161],{"type":401,"value":1984},{"type":395,"tag":436,"props":2163,"children":2164},{"style":1046},[2165],{"type":401,"value":1968},{"type":395,"tag":436,"props":2167,"children":2168},{"class":438,"line":575},[2169,2173,2177,2181],{"type":395,"tag":436,"props":2170,"children":2171},{"style":1052},[2172],{"type":401,"value":2008},{"type":395,"tag":436,"props":2174,"children":2175},{"style":464},[2176],{"type":401,"value":456},{"type":395,"tag":436,"props":2178,"children":2179},{"style":1062},[2180],{"type":401,"value":1963},{"type":395,"tag":436,"props":2182,"children":2183},{"style":1046},[2184],{"type":401,"value":1968},{"type":395,"tag":436,"props":2186,"children":2187},{"class":438,"line":636},[2188],{"type":395,"tag":436,"props":2189,"children":2190},{"style":464},[2191],{"type":401,"value":544},{"type":395,"tag":436,"props":2193,"children":2194},{"class":438,"line":656},[2195],{"type":395,"tag":436,"props":2196,"children":2197},{"style":464},[2198],{"type":401,"value":553},{"type":395,"tag":403,"props":2200,"children":2201},{},[2202,2204,2209],{"type":401,"value":2203},"匹配注释我们知道它是使用了下标递增 + Slice 的方法，匹配空白这里则是用的一个非常简单的正则。见下 ",{"type":395,"tag":432,"props":2205,"children":2207},{"className":2206},[],[2208],{"type":401,"value":1963},{"type":401,"value":2210}," 函数。",{"type":395,"tag":425,"props":2212,"children":2214},{"className":985,"code":2213,"language":987,"meta":389,"style":389},"private matchLeadingSpaces (): void {\n  this.commonMatch(/^\\s*/, false)\n}\n",[2215],{"type":395,"tag":432,"props":2216,"children":2217},{"__ignoreMap":389},[2218,2241,2297],{"type":395,"tag":436,"props":2219,"children":2220},{"class":438,"line":439},[2221,2225,2229,2233,2237],{"type":395,"tag":436,"props":2222,"children":2223},{"style":500},[2224],{"type":401,"value":1928},{"type":395,"tag":436,"props":2226,"children":2227},{"style":1062},[2228],{"type":401,"value":1963},{"type":395,"tag":436,"props":2230,"children":2231},{"style":500},[2232],{"type":401,"value":1938},{"type":395,"tag":436,"props":2234,"children":2235},{"style":596},[2236],{"type":401,"value":1943},{"type":395,"tag":436,"props":2238,"children":2239},{"style":464},[2240],{"type":401,"value":467},{"type":395,"tag":436,"props":2242,"children":2243},{"class":438,"line":449},[2244,2248,2252,2257,2261,2265,2270,2276,2280,2284,2288,2293],{"type":395,"tag":436,"props":2245,"children":2246},{"style":1052},[2247],{"type":401,"value":1355},{"type":395,"tag":436,"props":2249,"children":2250},{"style":464},[2251],{"type":401,"value":456},{"type":395,"tag":436,"props":2253,"children":2254},{"style":1062},[2255],{"type":401,"value":2256},"commonMatch",{"type":395,"tag":436,"props":2258,"children":2259},{"style":1046},[2260],{"type":401,"value":1149},{"type":395,"tag":436,"props":2262,"children":2263},{"style":602},[2264],{"type":401,"value":1174},{"type":395,"tag":436,"props":2266,"children":2267},{"style":1040},[2268],{"type":401,"value":2269},"^",{"type":395,"tag":436,"props":2271,"children":2273},{"style":2272},"--shiki-light:#91B859;--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF",[2274],{"type":401,"value":2275},"\\s",{"type":395,"tag":436,"props":2277,"children":2278},{"style":596},[2279],{"type":401,"value":1230},{"type":395,"tag":436,"props":2281,"children":2282},{"style":602},[2283],{"type":401,"value":1174},{"type":395,"tag":436,"props":2285,"children":2286},{"style":464},[2287],{"type":401,"value":1612},{"type":395,"tag":436,"props":2289,"children":2290},{"style":1254},[2291],{"type":401,"value":2292}," false",{"type":395,"tag":436,"props":2294,"children":2295},{"style":1046},[2296],{"type":401,"value":1506},{"type":395,"tag":436,"props":2298,"children":2299},{"class":438,"line":470},[2300],{"type":395,"tag":436,"props":2301,"children":2302},{"style":464},[2303],{"type":401,"value":553},{"type":395,"tag":403,"props":2305,"children":2306},{},[2307,2309,2314,2316,2321,2322,2327,2329,2334,2336,2341],{"type":401,"value":2308},"可以想象，",{"type":395,"tag":432,"props":2310,"children":2312},{"className":2311},[],[2313],{"type":401,"value":2256},{"type":401,"value":2315}," 应当会对状态 ",{"type":395,"tag":432,"props":2317,"children":2319},{"className":2318},[],[2320],{"type":401,"value":1135},{"type":401,"value":1798},{"type":395,"tag":432,"props":2323,"children":2325},{"className":2324},[],[2326],{"type":401,"value":1804},{"type":401,"value":2328}," 做一些操作。实际上，commonMatch 两个参数分别是用于匹配 ",{"type":395,"tag":432,"props":2330,"children":2332},{"className":2331},[],[2333],{"type":401,"value":1135},{"type":401,"value":2335}," 的正则，及跳过标记。如果在待匹配内容中匹配到了字符串，便把匹配的内容从中移除；跳过标记则意味着当确认跳过时，匹配的内容将不会被记录到输出结果中。以上面的 ",{"type":395,"tag":432,"props":2337,"children":2339},{"className":2338},[],[2340],{"type":401,"value":1963},{"type":401,"value":2342}," 函数举例，如果在待匹配内容中匹配到空白字符，那么会将其丢弃不做处理。",{"type":395,"tag":403,"props":2344,"children":2345},{},[2346,2351,2353,2358],{"type":395,"tag":432,"props":2347,"children":2349},{"className":2348},[],[2350],{"type":401,"value":2256},{"type":401,"value":2352}," 可谓是解析器匹配逻辑的核心，只要理解了它，那么我们回到上面提到的样式规则匹配 ",{"type":395,"tag":432,"props":2354,"children":2356},{"className":2355},[],[2357],{"type":401,"value":2129},{"type":401,"value":2359},"，会发现其过程非常简单。简单来说只有三步，匹配选择器、记录解析后的选择器、解析（并记录）声明。结束条件只有成功解析以及选择器解析报错或声明解析报错。",{"type":395,"tag":425,"props":2361,"children":2363},{"className":985,"code":2362,"language":987,"meta":389,"style":389},"private matchStyleRule (): boolean | void {\n  const selectors = this.formatSelector(true)\n  this.scopecssDisableNextLine = false\n  if (!selectors) return parseError('selector missing', this.linkPath)\n  this.recordResult(selectors)\n  this.matchComments()\n  this.styleDeclarations()\n  this.matchLeadingSpaces()\n  return true\n}\n",[2364],{"type":395,"tag":432,"props":2365,"children":2366},{"__ignoreMap":389},[2367,2397,2441,2465,2539,2566,2585,2605,2624,2636],{"type":395,"tag":436,"props":2368,"children":2369},{"class":438,"line":439},[2370,2374,2378,2383,2388,2393],{"type":395,"tag":436,"props":2371,"children":2372},{"style":500},[2373],{"type":401,"value":1928},{"type":395,"tag":436,"props":2375,"children":2376},{"style":1062},[2377],{"type":401,"value":2129},{"type":395,"tag":436,"props":2379,"children":2380},{"style":500},[2381],{"type":401,"value":2382}," (): boolean ",{"type":395,"tag":436,"props":2384,"children":2385},{"style":596},[2386],{"type":401,"value":2387},"|",{"type":395,"tag":436,"props":2389,"children":2390},{"style":596},[2391],{"type":401,"value":2392}," void",{"type":395,"tag":436,"props":2394,"children":2395},{"style":464},[2396],{"type":401,"value":467},{"type":395,"tag":436,"props":2398,"children":2399},{"class":438,"line":449},[2400,2405,2410,2415,2419,2423,2428,2432,2437],{"type":395,"tag":436,"props":2401,"children":2402},{"style":997},[2403],{"type":401,"value":2404},"  const",{"type":395,"tag":436,"props":2406,"children":2407},{"style":506},[2408],{"type":401,"value":2409}," selectors",{"type":395,"tag":436,"props":2411,"children":2412},{"style":596},[2413],{"type":401,"value":2414}," =",{"type":395,"tag":436,"props":2416,"children":2417},{"style":1052},[2418],{"type":401,"value":1189},{"type":395,"tag":436,"props":2420,"children":2421},{"style":464},[2422],{"type":401,"value":456},{"type":395,"tag":436,"props":2424,"children":2425},{"style":1062},[2426],{"type":401,"value":2427},"formatSelector",{"type":395,"tag":436,"props":2429,"children":2430},{"style":1046},[2431],{"type":401,"value":1149},{"type":395,"tag":436,"props":2433,"children":2434},{"style":1254},[2435],{"type":401,"value":2436},"true",{"type":395,"tag":436,"props":2438,"children":2439},{"style":1046},[2440],{"type":401,"value":1506},{"type":395,"tag":436,"props":2442,"children":2443},{"class":438,"line":470},[2444,2448,2452,2457,2461],{"type":395,"tag":436,"props":2445,"children":2446},{"style":1052},[2447],{"type":401,"value":1355},{"type":395,"tag":436,"props":2449,"children":2450},{"style":464},[2451],{"type":401,"value":456},{"type":395,"tag":436,"props":2453,"children":2454},{"style":500},[2455],{"type":401,"value":2456},"scopecssDisableNextLine",{"type":395,"tag":436,"props":2458,"children":2459},{"style":596},[2460],{"type":401,"value":2414},{"type":395,"tag":436,"props":2462,"children":2463},{"style":1254},[2464],{"type":401,"value":1257},{"type":395,"tag":436,"props":2466,"children":2467},{"class":438,"line":496},[2468,2473,2477,2482,2487,2491,2496,2501,2505,2509,2514,2518,2522,2526,2530,2535],{"type":395,"tag":436,"props":2469,"children":2470},{"style":1040},[2471],{"type":401,"value":2472},"  if",{"type":395,"tag":436,"props":2474,"children":2475},{"style":1046},[2476],{"type":401,"value":1049},{"type":395,"tag":436,"props":2478,"children":2479},{"style":596},[2480],{"type":401,"value":2481},"!",{"type":395,"tag":436,"props":2483,"children":2484},{"style":500},[2485],{"type":401,"value":2486},"selectors",{"type":395,"tag":436,"props":2488,"children":2489},{"style":1046},[2490],{"type":401,"value":1159},{"type":395,"tag":436,"props":2492,"children":2493},{"style":1040},[2494],{"type":401,"value":2495},"return",{"type":395,"tag":436,"props":2497,"children":2498},{"style":1062},[2499],{"type":401,"value":2500}," parseError",{"type":395,"tag":436,"props":2502,"children":2503},{"style":1046},[2504],{"type":401,"value":1149},{"type":395,"tag":436,"props":2506,"children":2507},{"style":602},[2508],{"type":401,"value":1179},{"type":395,"tag":436,"props":2510,"children":2511},{"style":608},[2512],{"type":401,"value":2513},"selector missing",{"type":395,"tag":436,"props":2515,"children":2516},{"style":602},[2517],{"type":401,"value":1179},{"type":395,"tag":436,"props":2519,"children":2520},{"style":464},[2521],{"type":401,"value":1612},{"type":395,"tag":436,"props":2523,"children":2524},{"style":1052},[2525],{"type":401,"value":1189},{"type":395,"tag":436,"props":2527,"children":2528},{"style":464},[2529],{"type":401,"value":456},{"type":395,"tag":436,"props":2531,"children":2532},{"style":500},[2533],{"type":401,"value":2534},"linkPath",{"type":395,"tag":436,"props":2536,"children":2537},{"style":1046},[2538],{"type":401,"value":1506},{"type":395,"tag":436,"props":2540,"children":2541},{"class":438,"line":516},[2542,2546,2550,2554,2558,2562],{"type":395,"tag":436,"props":2543,"children":2544},{"style":1052},[2545],{"type":401,"value":1355},{"type":395,"tag":436,"props":2547,"children":2548},{"style":464},[2549],{"type":401,"value":456},{"type":395,"tag":436,"props":2551,"children":2552},{"style":1062},[2553],{"type":401,"value":1829},{"type":395,"tag":436,"props":2555,"children":2556},{"style":1046},[2557],{"type":401,"value":1149},{"type":395,"tag":436,"props":2559,"children":2560},{"style":500},[2561],{"type":401,"value":2486},{"type":395,"tag":436,"props":2563,"children":2564},{"style":1046},[2565],{"type":401,"value":1506},{"type":395,"tag":436,"props":2567,"children":2568},{"class":438,"line":538},[2569,2573,2577,2581],{"type":395,"tag":436,"props":2570,"children":2571},{"style":1052},[2572],{"type":401,"value":1355},{"type":395,"tag":436,"props":2574,"children":2575},{"style":464},[2576],{"type":401,"value":456},{"type":395,"tag":436,"props":2578,"children":2579},{"style":1062},[2580],{"type":401,"value":1984},{"type":395,"tag":436,"props":2582,"children":2583},{"style":1046},[2584],{"type":401,"value":1968},{"type":395,"tag":436,"props":2586,"children":2587},{"class":438,"line":547},[2588,2592,2596,2601],{"type":395,"tag":436,"props":2589,"children":2590},{"style":1052},[2591],{"type":401,"value":1355},{"type":395,"tag":436,"props":2593,"children":2594},{"style":464},[2595],{"type":401,"value":456},{"type":395,"tag":436,"props":2597,"children":2598},{"style":1062},[2599],{"type":401,"value":2600},"styleDeclarations",{"type":395,"tag":436,"props":2602,"children":2603},{"style":1046},[2604],{"type":401,"value":1968},{"type":395,"tag":436,"props":2606,"children":2607},{"class":438,"line":556},[2608,2612,2616,2620],{"type":395,"tag":436,"props":2609,"children":2610},{"style":1052},[2611],{"type":401,"value":1355},{"type":395,"tag":436,"props":2613,"children":2614},{"style":464},[2615],{"type":401,"value":456},{"type":395,"tag":436,"props":2617,"children":2618},{"style":1062},[2619],{"type":401,"value":1963},{"type":395,"tag":436,"props":2621,"children":2622},{"style":1046},[2623],{"type":401,"value":1968},{"type":395,"tag":436,"props":2625,"children":2626},{"class":438,"line":566},[2627,2632],{"type":395,"tag":436,"props":2628,"children":2629},{"style":1040},[2630],{"type":401,"value":2631},"  return",{"type":395,"tag":436,"props":2633,"children":2634},{"style":1254},[2635],{"type":401,"value":1286},{"type":395,"tag":436,"props":2637,"children":2638},{"class":438,"line":575},[2639],{"type":395,"tag":436,"props":2640,"children":2641},{"style":464},[2642],{"type":401,"value":553},{"type":395,"tag":403,"props":2644,"children":2645},{},[2646,2648,2654,2656,2662,2664,2670,2672,2677,2679,2685],{"type":401,"value":2647},"首先是匹配选择器的部分。以 ",{"type":395,"tag":432,"props":2649,"children":2651},{"className":2650},[],[2652],{"type":401,"value":2653},".a,.b{color:red}",{"type":401,"value":2655}," 为例，首先匹配出",{"type":395,"tag":432,"props":2657,"children":2659},{"className":2658},[],[2660],{"type":401,"value":2661},"{",{"type":401,"value":2663},"字符前的部分即",{"type":395,"tag":432,"props":2665,"children":2667},{"className":2666},[],[2668],{"type":401,"value":2669},".a,.b",{"type":401,"value":2671},"作为选择器的正文，然后使用",{"type":395,"tag":432,"props":2673,"children":2675},{"className":2674},[],[2676],{"type":401,"value":1612},{"type":401,"value":2678},"分割选择器，并给选择器加上 prefix，最终返回",{"type":395,"tag":432,"props":2680,"children":2682},{"className":2681},[],[2683],{"type":401,"value":2684},"micro-app[name=\"subapp\"] .a, micro-app[name=\"subapp\"] .b",{"type":401,"value":2686},"。刚才提到可以在业务代码中使用注释给特定选择器禁用 prefix 前缀，相关的代码的实现也在这个函数中。",{"type":395,"tag":425,"props":2688,"children":2690},{"className":985,"code":2689,"language":987,"meta":389,"style":389},"const selectors = this.formatSelector()\n\nprivate formatSelector (skip: boolean): false | string {\n  // 匹配选择器正文\n  const m = this.commonMatch(/^[^{]+/, skip)\n  return m[0].replace(/(^|,[\\n\\s]*)([^,]+)/g, (_, separator, selector) => {\n    // 如果检测到选择器被禁用则跳过添加前缀步骤\n    if (...) {\n      const prefix = this.prefix // micro-app[name=\"subapp\"]\n      selector = prefix + ' ' + selector\n    }\n    return separator + selector\n  })\n}\n",[2691],{"type":395,"tag":432,"props":2692,"children":2693},{"__ignoreMap":389},[2694,2726,2733,2768,2776,2854,3013,3021,3045,3080,3118,3125,3144,3155],{"type":395,"tag":436,"props":2695,"children":2696},{"class":438,"line":439},[2697,2702,2706,2710,2714,2718,2722],{"type":395,"tag":436,"props":2698,"children":2699},{"style":997},[2700],{"type":401,"value":2701},"const",{"type":395,"tag":436,"props":2703,"children":2704},{"style":506},[2705],{"type":401,"value":2409},{"type":395,"tag":436,"props":2707,"children":2708},{"style":596},[2709],{"type":401,"value":2414},{"type":395,"tag":436,"props":2711,"children":2712},{"style":1052},[2713],{"type":401,"value":1189},{"type":395,"tag":436,"props":2715,"children":2716},{"style":464},[2717],{"type":401,"value":456},{"type":395,"tag":436,"props":2719,"children":2720},{"style":1062},[2721],{"type":401,"value":2427},{"type":395,"tag":436,"props":2723,"children":2724},{"style":500},[2725],{"type":401,"value":1968},{"type":395,"tag":436,"props":2727,"children":2728},{"class":438,"line":449},[2729],{"type":395,"tag":436,"props":2730,"children":2731},{"emptyLinePlaceholder":560},[2732],{"type":401,"value":563},{"type":395,"tag":436,"props":2734,"children":2735},{"class":438,"line":470},[2736,2740,2744,2749,2754,2759,2764],{"type":395,"tag":436,"props":2737,"children":2738},{"style":500},[2739],{"type":401,"value":1928},{"type":395,"tag":436,"props":2741,"children":2742},{"style":1062},[2743],{"type":401,"value":2427},{"type":395,"tag":436,"props":2745,"children":2746},{"style":500},[2747],{"type":401,"value":2748}," (skip: boolean): ",{"type":395,"tag":436,"props":2750,"children":2751},{"style":1254},[2752],{"type":401,"value":2753},"false",{"type":395,"tag":436,"props":2755,"children":2756},{"style":596},[2757],{"type":401,"value":2758}," |",{"type":395,"tag":436,"props":2760,"children":2761},{"style":500},[2762],{"type":401,"value":2763}," string ",{"type":395,"tag":436,"props":2765,"children":2766},{"style":464},[2767],{"type":401,"value":1243},{"type":395,"tag":436,"props":2769,"children":2770},{"class":438,"line":496},[2771],{"type":395,"tag":436,"props":2772,"children":2773},{"style":443},[2774],{"type":401,"value":2775},"  // 匹配选择器正文\n",{"type":395,"tag":436,"props":2777,"children":2778},{"class":438,"line":516},[2779,2783,2788,2792,2796,2800,2804,2808,2812,2816,2821,2825,2829,2833,2837,2841,2845,2850],{"type":395,"tag":436,"props":2780,"children":2781},{"style":997},[2782],{"type":401,"value":2404},{"type":395,"tag":436,"props":2784,"children":2785},{"style":506},[2786],{"type":401,"value":2787}," m",{"type":395,"tag":436,"props":2789,"children":2790},{"style":596},[2791],{"type":401,"value":2414},{"type":395,"tag":436,"props":2793,"children":2794},{"style":1052},[2795],{"type":401,"value":1189},{"type":395,"tag":436,"props":2797,"children":2798},{"style":464},[2799],{"type":401,"value":456},{"type":395,"tag":436,"props":2801,"children":2802},{"style":1062},[2803],{"type":401,"value":2256},{"type":395,"tag":436,"props":2805,"children":2806},{"style":1046},[2807],{"type":401,"value":1149},{"type":395,"tag":436,"props":2809,"children":2810},{"style":602},[2811],{"type":401,"value":1174},{"type":395,"tag":436,"props":2813,"children":2814},{"style":1040},[2815],{"type":401,"value":2269},{"type":395,"tag":436,"props":2817,"children":2819},{"style":2818},"--shiki-light:#39ADB5;--shiki-default:#005CC5;--shiki-dark:#79B8FF;--shiki-sepia:#AE81FF",[2820],{"type":401,"value":587},{"type":395,"tag":436,"props":2822,"children":2823},{"style":596},[2824],{"type":401,"value":2269},{"type":395,"tag":436,"props":2826,"children":2827},{"style":2272},[2828],{"type":401,"value":2661},{"type":395,"tag":436,"props":2830,"children":2831},{"style":2818},[2832],{"type":401,"value":620},{"type":395,"tag":436,"props":2834,"children":2835},{"style":596},[2836],{"type":401,"value":1477},{"type":395,"tag":436,"props":2838,"children":2839},{"style":602},[2840],{"type":401,"value":1174},{"type":395,"tag":436,"props":2842,"children":2843},{"style":464},[2844],{"type":401,"value":1612},{"type":395,"tag":436,"props":2846,"children":2847},{"style":500},[2848],{"type":401,"value":2849}," skip",{"type":395,"tag":436,"props":2851,"children":2852},{"style":1046},[2853],{"type":401,"value":1506},{"type":395,"tag":436,"props":2855,"children":2856},{"class":438,"line":538},[2857,2861,2865,2869,2873,2877,2881,2886,2890,2894,2899,2903,2907,2912,2916,2921,2925,2929,2934,2938,2942,2946,2950,2954,2959,2963,2969,2973,2977,2982,2986,2991,2995,3000,3004,3009],{"type":395,"tag":436,"props":2858,"children":2859},{"style":1040},[2860],{"type":401,"value":2631},{"type":395,"tag":436,"props":2862,"children":2863},{"style":500},[2864],{"type":401,"value":2787},{"type":395,"tag":436,"props":2866,"children":2867},{"style":1046},[2868],{"type":401,"value":587},{"type":395,"tag":436,"props":2870,"children":2871},{"style":485},[2872],{"type":401,"value":1154},{"type":395,"tag":436,"props":2874,"children":2875},{"style":1046},[2876],{"type":401,"value":620},{"type":395,"tag":436,"props":2878,"children":2879},{"style":464},[2880],{"type":401,"value":456},{"type":395,"tag":436,"props":2882,"children":2883},{"style":1062},[2884],{"type":401,"value":2885},"replace",{"type":395,"tag":436,"props":2887,"children":2888},{"style":1046},[2889],{"type":401,"value":1149},{"type":395,"tag":436,"props":2891,"children":2892},{"style":602},[2893],{"type":401,"value":1174},{"type":395,"tag":436,"props":2895,"children":2897},{"style":2896},"--shiki-light:#39ADB5;--shiki-default:#032F62;--shiki-dark:#DBEDFF;--shiki-sepia:#E6DB74",[2898],{"type":401,"value":1149},{"type":395,"tag":436,"props":2900,"children":2901},{"style":1040},[2902],{"type":401,"value":2269},{"type":395,"tag":436,"props":2904,"children":2905},{"style":596},[2906],{"type":401,"value":2387},{"type":395,"tag":436,"props":2908,"children":2910},{"style":2909},"--shiki-light:#91B859;--shiki-default:#032F62;--shiki-dark:#DBEDFF;--shiki-sepia:#E6DB74",[2911],{"type":401,"value":1612},{"type":395,"tag":436,"props":2913,"children":2914},{"style":2818},[2915],{"type":401,"value":587},{"type":395,"tag":436,"props":2917,"children":2918},{"style":2272},[2919],{"type":401,"value":2920},"\\n\\s",{"type":395,"tag":436,"props":2922,"children":2923},{"style":2818},[2924],{"type":401,"value":620},{"type":395,"tag":436,"props":2926,"children":2927},{"style":596},[2928],{"type":401,"value":1230},{"type":395,"tag":436,"props":2930,"children":2931},{"style":2896},[2932],{"type":401,"value":2933},")(",{"type":395,"tag":436,"props":2935,"children":2936},{"style":2818},[2937],{"type":401,"value":587},{"type":395,"tag":436,"props":2939,"children":2940},{"style":596},[2941],{"type":401,"value":2269},{"type":395,"tag":436,"props":2943,"children":2944},{"style":2272},[2945],{"type":401,"value":1612},{"type":395,"tag":436,"props":2947,"children":2948},{"style":2818},[2949],{"type":401,"value":620},{"type":395,"tag":436,"props":2951,"children":2952},{"style":596},[2953],{"type":401,"value":1477},{"type":395,"tag":436,"props":2955,"children":2956},{"style":2896},[2957],{"type":401,"value":2958},")",{"type":395,"tag":436,"props":2960,"children":2961},{"style":602},[2962],{"type":401,"value":1174},{"type":395,"tag":436,"props":2964,"children":2966},{"style":2965},"--shiki-light:#F76D47;--shiki-default:#D73A49;--shiki-dark:#F97583;--shiki-sepia:#F92672",[2967],{"type":401,"value":2968},"g",{"type":395,"tag":436,"props":2970,"children":2971},{"style":464},[2972],{"type":401,"value":1612},{"type":395,"tag":436,"props":2974,"children":2975},{"style":464},[2976],{"type":401,"value":1049},{"type":395,"tag":436,"props":2978,"children":2979},{"style":1766},[2980],{"type":401,"value":2981},"_",{"type":395,"tag":436,"props":2983,"children":2984},{"style":464},[2985],{"type":401,"value":1612},{"type":395,"tag":436,"props":2987,"children":2988},{"style":1766},[2989],{"type":401,"value":2990}," separator",{"type":395,"tag":436,"props":2992,"children":2993},{"style":464},[2994],{"type":401,"value":1612},{"type":395,"tag":436,"props":2996,"children":2997},{"style":1766},[2998],{"type":401,"value":2999}," selector",{"type":395,"tag":436,"props":3001,"children":3002},{"style":464},[3003],{"type":401,"value":2958},{"type":395,"tag":436,"props":3005,"children":3006},{"style":997},[3007],{"type":401,"value":3008}," =>",{"type":395,"tag":436,"props":3010,"children":3011},{"style":464},[3012],{"type":401,"value":467},{"type":395,"tag":436,"props":3014,"children":3015},{"class":438,"line":547},[3016],{"type":395,"tag":436,"props":3017,"children":3018},{"style":443},[3019],{"type":401,"value":3020},"    // 如果检测到选择器被禁用则跳过添加前缀步骤\n",{"type":395,"tag":436,"props":3022,"children":3023},{"class":438,"line":556},[3024,3028,3032,3037,3041],{"type":395,"tag":436,"props":3025,"children":3026},{"style":1040},[3027],{"type":401,"value":1118},{"type":395,"tag":436,"props":3029,"children":3030},{"style":1046},[3031],{"type":401,"value":1049},{"type":395,"tag":436,"props":3033,"children":3034},{"style":596},[3035],{"type":401,"value":3036},"...",{"type":395,"tag":436,"props":3038,"children":3039},{"style":1046},[3040],{"type":401,"value":1159},{"type":395,"tag":436,"props":3042,"children":3043},{"style":464},[3044],{"type":401,"value":1243},{"type":395,"tag":436,"props":3046,"children":3047},{"class":438,"line":566},[3048,3053,3058,3062,3066,3070,3075],{"type":395,"tag":436,"props":3049,"children":3050},{"style":997},[3051],{"type":401,"value":3052},"      const",{"type":395,"tag":436,"props":3054,"children":3055},{"style":506},[3056],{"type":401,"value":3057}," prefix",{"type":395,"tag":436,"props":3059,"children":3060},{"style":596},[3061],{"type":401,"value":2414},{"type":395,"tag":436,"props":3063,"children":3064},{"style":1052},[3065],{"type":401,"value":1189},{"type":395,"tag":436,"props":3067,"children":3068},{"style":464},[3069],{"type":401,"value":456},{"type":395,"tag":436,"props":3071,"children":3072},{"style":500},[3073],{"type":401,"value":3074},"prefix",{"type":395,"tag":436,"props":3076,"children":3077},{"style":443},[3078],{"type":401,"value":3079}," // micro-app[name=\"subapp\"]\n",{"type":395,"tag":436,"props":3081,"children":3082},{"class":438,"line":575},[3083,3088,3092,3096,3101,3105,3109,3113],{"type":395,"tag":436,"props":3084,"children":3085},{"style":500},[3086],{"type":401,"value":3087},"      selector",{"type":395,"tag":436,"props":3089,"children":3090},{"style":596},[3091],{"type":401,"value":2414},{"type":395,"tag":436,"props":3093,"children":3094},{"style":500},[3095],{"type":401,"value":3057},{"type":395,"tag":436,"props":3097,"children":3098},{"style":596},[3099],{"type":401,"value":3100}," +",{"type":395,"tag":436,"props":3102,"children":3103},{"style":602},[3104],{"type":401,"value":1169},{"type":395,"tag":436,"props":3106,"children":3107},{"style":602},[3108],{"type":401,"value":1169},{"type":395,"tag":436,"props":3110,"children":3111},{"style":596},[3112],{"type":401,"value":3100},{"type":395,"tag":436,"props":3114,"children":3115},{"style":500},[3116],{"type":401,"value":3117}," selector\n",{"type":395,"tag":436,"props":3119,"children":3120},{"class":438,"line":636},[3121],{"type":395,"tag":436,"props":3122,"children":3123},{"style":464},[3124],{"type":401,"value":1265},{"type":395,"tag":436,"props":3126,"children":3127},{"class":438,"line":656},[3128,3132,3136,3140],{"type":395,"tag":436,"props":3129,"children":3130},{"style":1040},[3131],{"type":401,"value":1281},{"type":395,"tag":436,"props":3133,"children":3134},{"style":500},[3135],{"type":401,"value":2990},{"type":395,"tag":436,"props":3137,"children":3138},{"style":596},[3139],{"type":401,"value":3100},{"type":395,"tag":436,"props":3141,"children":3142},{"style":500},[3143],{"type":401,"value":3117},{"type":395,"tag":436,"props":3145,"children":3146},{"class":438,"line":672},[3147,3151],{"type":395,"tag":436,"props":3148,"children":3149},{"style":464},[3150],{"type":401,"value":835},{"type":395,"tag":436,"props":3152,"children":3153},{"style":1046},[3154],{"type":401,"value":1506},{"type":395,"tag":436,"props":3156,"children":3157},{"class":438,"line":692},[3158],{"type":395,"tag":436,"props":3159,"children":3160},{"style":464},[3161],{"type":401,"value":553},{"type":395,"tag":403,"props":3163,"children":3164},{},[3165,3167,3172,3174,3179,3181,3186,3188,3193,3195,3202],{"type":401,"value":3166},"匹配完选择器后，声明便是剩下的包含在左右花括号的内容。匹配过程是一个递归，以遇到",{"type":395,"tag":432,"props":3168,"children":3170},{"className":3169},[],[3171],{"type":401,"value":1882},{"type":401,"value":3173},"作为结束条件。如果遇到斜杠",{"type":395,"tag":432,"props":3175,"children":3177},{"className":3176},[],[3178],{"type":401,"value":1174},{"type":401,"value":3180},"，则尝试停止声明匹配并开始注释匹配。总之，",{"type":395,"tag":432,"props":3182,"children":3184},{"className":3183},[],[3185],{"type":401,"value":1882},{"type":401,"value":3187},"之前的内容都作为当前选择器的声明，添加到",{"type":395,"tag":432,"props":3189,"children":3191},{"className":3190},[],[3192],{"type":401,"value":1135},{"type":401,"value":3194},"中。micro-app 框架会对 CSS 资源中的 URL 补全为主应用的完整路径这个功能也是在这个函数中实现，有兴趣的话可以查看其",{"type":395,"tag":414,"props":3196,"children":3199},{"href":3197,"rel":3198},"https://github.com/micro-zoe/micro-app/blob/dev/src/sandbox/scoped_css.ts",[418],[3200],{"type":401,"value":3201},"完整代码",{"type":401,"value":921},{"type":395,"tag":425,"props":3204,"children":3206},{"className":985,"code":3205,"language":987,"meta":389,"style":389},"private matchAllDeclarations (): void {\n  let cssValue = (this.commonMatch(/^[^}/])*/, true) as RegExpExecArray)[0]\n  this.recordResult(cssValue)\n\n  // 递归退出条件\n  if (!this.cssText) return\n  if (this.cssText.charAt(0) === '}') return\n\n  // extract comments in declarations\n  if (this.cssText.charAt(0) === '/' && this.cssText.charAt(1) === '*') {\n    this.matchComments()\n  } else {\n    // 如果不是注释则忽略中断，继续匹配声明\n    this.commonMatch(/\\/+/)\n  }\n\n  return this.matchAllDeclarations()\n}\n",[3207],{"type":395,"tag":432,"props":3208,"children":3209},{"__ignoreMap":389},[3210,3234,3345,3373,3380,3388,3424,3492,3499,3507,3626,3645,3661,3669,3710,3717,3724,3747],{"type":395,"tag":436,"props":3211,"children":3212},{"class":438,"line":439},[3213,3217,3222,3226,3230],{"type":395,"tag":436,"props":3214,"children":3215},{"style":500},[3216],{"type":401,"value":1928},{"type":395,"tag":436,"props":3218,"children":3219},{"style":1062},[3220],{"type":401,"value":3221},"matchAllDeclarations",{"type":395,"tag":436,"props":3223,"children":3224},{"style":500},[3225],{"type":401,"value":1938},{"type":395,"tag":436,"props":3227,"children":3228},{"style":596},[3229],{"type":401,"value":1943},{"type":395,"tag":436,"props":3231,"children":3232},{"style":464},[3233],{"type":401,"value":467},{"type":395,"tag":436,"props":3235,"children":3236},{"class":438,"line":449},[3237,3242,3247,3251,3255,3259,3263,3267,3271,3275,3279,3283,3287,3292,3296,3300,3304,3308,3312,3317,3321,3326,3331,3336,3340],{"type":395,"tag":436,"props":3238,"children":3239},{"style":997},[3240],{"type":401,"value":3241},"  let",{"type":395,"tag":436,"props":3243,"children":3244},{"style":500},[3245],{"type":401,"value":3246}," cssValue",{"type":395,"tag":436,"props":3248,"children":3249},{"style":596},[3250],{"type":401,"value":2414},{"type":395,"tag":436,"props":3252,"children":3253},{"style":1046},[3254],{"type":401,"value":1049},{"type":395,"tag":436,"props":3256,"children":3257},{"style":1052},[3258],{"type":401,"value":1055},{"type":395,"tag":436,"props":3260,"children":3261},{"style":464},[3262],{"type":401,"value":456},{"type":395,"tag":436,"props":3264,"children":3265},{"style":1062},[3266],{"type":401,"value":2256},{"type":395,"tag":436,"props":3268,"children":3269},{"style":1046},[3270],{"type":401,"value":1149},{"type":395,"tag":436,"props":3272,"children":3273},{"style":602},[3274],{"type":401,"value":1174},{"type":395,"tag":436,"props":3276,"children":3277},{"style":1040},[3278],{"type":401,"value":2269},{"type":395,"tag":436,"props":3280,"children":3281},{"style":2818},[3282],{"type":401,"value":587},{"type":395,"tag":436,"props":3284,"children":3285},{"style":596},[3286],{"type":401,"value":2269},{"type":395,"tag":436,"props":3288,"children":3289},{"style":2272},[3290],{"type":401,"value":3291},"}/",{"type":395,"tag":436,"props":3293,"children":3294},{"style":2818},[3295],{"type":401,"value":620},{"type":395,"tag":436,"props":3297,"children":3298},{"style":2909},[3299],{"type":401,"value":2958},{"type":395,"tag":436,"props":3301,"children":3302},{"style":596},[3303],{"type":401,"value":1230},{"type":395,"tag":436,"props":3305,"children":3306},{"style":602},[3307],{"type":401,"value":1174},{"type":395,"tag":436,"props":3309,"children":3310},{"style":464},[3311],{"type":401,"value":1612},{"type":395,"tag":436,"props":3313,"children":3314},{"style":1254},[3315],{"type":401,"value":3316}," true",{"type":395,"tag":436,"props":3318,"children":3319},{"style":1046},[3320],{"type":401,"value":1159},{"type":395,"tag":436,"props":3322,"children":3323},{"style":1040},[3324],{"type":401,"value":3325},"as",{"type":395,"tag":436,"props":3327,"children":3328},{"style":1003},[3329],{"type":401,"value":3330}," RegExpExecArray",{"type":395,"tag":436,"props":3332,"children":3333},{"style":1046},[3334],{"type":401,"value":3335},")[",{"type":395,"tag":436,"props":3337,"children":3338},{"style":485},[3339],{"type":401,"value":1154},{"type":395,"tag":436,"props":3341,"children":3342},{"style":1046},[3343],{"type":401,"value":3344},"]\n",{"type":395,"tag":436,"props":3346,"children":3347},{"class":438,"line":470},[3348,3352,3356,3360,3364,3369],{"type":395,"tag":436,"props":3349,"children":3350},{"style":1052},[3351],{"type":401,"value":1355},{"type":395,"tag":436,"props":3353,"children":3354},{"style":464},[3355],{"type":401,"value":456},{"type":395,"tag":436,"props":3357,"children":3358},{"style":1062},[3359],{"type":401,"value":1829},{"type":395,"tag":436,"props":3361,"children":3362},{"style":1046},[3363],{"type":401,"value":1149},{"type":395,"tag":436,"props":3365,"children":3366},{"style":500},[3367],{"type":401,"value":3368},"cssValue",{"type":395,"tag":436,"props":3370,"children":3371},{"style":1046},[3372],{"type":401,"value":1506},{"type":395,"tag":436,"props":3374,"children":3375},{"class":438,"line":496},[3376],{"type":395,"tag":436,"props":3377,"children":3378},{"emptyLinePlaceholder":560},[3379],{"type":401,"value":563},{"type":395,"tag":436,"props":3381,"children":3382},{"class":438,"line":516},[3383],{"type":395,"tag":436,"props":3384,"children":3385},{"style":443},[3386],{"type":401,"value":3387},"  // 递归退出条件\n",{"type":395,"tag":436,"props":3389,"children":3390},{"class":438,"line":538},[3391,3395,3399,3403,3407,3411,3415,3419],{"type":395,"tag":436,"props":3392,"children":3393},{"style":1040},[3394],{"type":401,"value":2472},{"type":395,"tag":436,"props":3396,"children":3397},{"style":1046},[3398],{"type":401,"value":1049},{"type":395,"tag":436,"props":3400,"children":3401},{"style":596},[3402],{"type":401,"value":2481},{"type":395,"tag":436,"props":3404,"children":3405},{"style":1052},[3406],{"type":401,"value":1055},{"type":395,"tag":436,"props":3408,"children":3409},{"style":464},[3410],{"type":401,"value":456},{"type":395,"tag":436,"props":3412,"children":3413},{"style":500},[3414],{"type":401,"value":1135},{"type":395,"tag":436,"props":3416,"children":3417},{"style":1046},[3418],{"type":401,"value":1159},{"type":395,"tag":436,"props":3420,"children":3421},{"style":1040},[3422],{"type":401,"value":3423},"return\n",{"type":395,"tag":436,"props":3425,"children":3426},{"class":438,"line":547},[3427,3431,3435,3439,3443,3447,3451,3455,3459,3463,3467,3472,3476,3480,3484,3488],{"type":395,"tag":436,"props":3428,"children":3429},{"style":1040},[3430],{"type":401,"value":2472},{"type":395,"tag":436,"props":3432,"children":3433},{"style":1046},[3434],{"type":401,"value":1049},{"type":395,"tag":436,"props":3436,"children":3437},{"style":1052},[3438],{"type":401,"value":1055},{"type":395,"tag":436,"props":3440,"children":3441},{"style":464},[3442],{"type":401,"value":456},{"type":395,"tag":436,"props":3444,"children":3445},{"style":500},[3446],{"type":401,"value":1135},{"type":395,"tag":436,"props":3448,"children":3449},{"style":464},[3450],{"type":401,"value":456},{"type":395,"tag":436,"props":3452,"children":3453},{"style":1062},[3454],{"type":401,"value":1144},{"type":395,"tag":436,"props":3456,"children":3457},{"style":1046},[3458],{"type":401,"value":1149},{"type":395,"tag":436,"props":3460,"children":3461},{"style":485},[3462],{"type":401,"value":1154},{"type":395,"tag":436,"props":3464,"children":3465},{"style":1046},[3466],{"type":401,"value":1159},{"type":395,"tag":436,"props":3468,"children":3469},{"style":596},[3470],{"type":401,"value":3471},"===",{"type":395,"tag":436,"props":3473,"children":3474},{"style":602},[3475],{"type":401,"value":1169},{"type":395,"tag":436,"props":3477,"children":3478},{"style":608},[3479],{"type":401,"value":1882},{"type":395,"tag":436,"props":3481,"children":3482},{"style":602},[3483],{"type":401,"value":1179},{"type":395,"tag":436,"props":3485,"children":3486},{"style":1046},[3487],{"type":401,"value":1159},{"type":395,"tag":436,"props":3489,"children":3490},{"style":1040},[3491],{"type":401,"value":3423},{"type":395,"tag":436,"props":3493,"children":3494},{"class":438,"line":556},[3495],{"type":395,"tag":436,"props":3496,"children":3497},{"emptyLinePlaceholder":560},[3498],{"type":401,"value":563},{"type":395,"tag":436,"props":3500,"children":3501},{"class":438,"line":566},[3502],{"type":395,"tag":436,"props":3503,"children":3504},{"style":443},[3505],{"type":401,"value":3506},"  // extract comments in declarations\n",{"type":395,"tag":436,"props":3508,"children":3509},{"class":438,"line":575},[3510,3514,3518,3522,3526,3530,3534,3538,3542,3546,3550,3554,3558,3562,3566,3570,3574,3578,3582,3586,3590,3594,3598,3602,3606,3610,3614,3618,3622],{"type":395,"tag":436,"props":3511,"children":3512},{"style":1040},[3513],{"type":401,"value":2472},{"type":395,"tag":436,"props":3515,"children":3516},{"style":1046},[3517],{"type":401,"value":1049},{"type":395,"tag":436,"props":3519,"children":3520},{"style":1052},[3521],{"type":401,"value":1055},{"type":395,"tag":436,"props":3523,"children":3524},{"style":464},[3525],{"type":401,"value":456},{"type":395,"tag":436,"props":3527,"children":3528},{"style":500},[3529],{"type":401,"value":1135},{"type":395,"tag":436,"props":3531,"children":3532},{"style":464},[3533],{"type":401,"value":456},{"type":395,"tag":436,"props":3535,"children":3536},{"style":1062},[3537],{"type":401,"value":1144},{"type":395,"tag":436,"props":3539,"children":3540},{"style":1046},[3541],{"type":401,"value":1149},{"type":395,"tag":436,"props":3543,"children":3544},{"style":485},[3545],{"type":401,"value":1154},{"type":395,"tag":436,"props":3547,"children":3548},{"style":1046},[3549],{"type":401,"value":1159},{"type":395,"tag":436,"props":3551,"children":3552},{"style":596},[3553],{"type":401,"value":3471},{"type":395,"tag":436,"props":3555,"children":3556},{"style":602},[3557],{"type":401,"value":1169},{"type":395,"tag":436,"props":3559,"children":3560},{"style":608},[3561],{"type":401,"value":1174},{"type":395,"tag":436,"props":3563,"children":3564},{"style":602},[3565],{"type":401,"value":1179},{"type":395,"tag":436,"props":3567,"children":3568},{"style":596},[3569],{"type":401,"value":1390},{"type":395,"tag":436,"props":3571,"children":3572},{"style":1052},[3573],{"type":401,"value":1189},{"type":395,"tag":436,"props":3575,"children":3576},{"style":464},[3577],{"type":401,"value":456},{"type":395,"tag":436,"props":3579,"children":3580},{"style":500},[3581],{"type":401,"value":1135},{"type":395,"tag":436,"props":3583,"children":3584},{"style":464},[3585],{"type":401,"value":456},{"type":395,"tag":436,"props":3587,"children":3588},{"style":1062},[3589],{"type":401,"value":1144},{"type":395,"tag":436,"props":3591,"children":3592},{"style":1046},[3593],{"type":401,"value":1149},{"type":395,"tag":436,"props":3595,"children":3596},{"style":485},[3597],{"type":401,"value":919},{"type":395,"tag":436,"props":3599,"children":3600},{"style":1046},[3601],{"type":401,"value":1159},{"type":395,"tag":436,"props":3603,"children":3604},{"style":596},[3605],{"type":401,"value":3471},{"type":395,"tag":436,"props":3607,"children":3608},{"style":602},[3609],{"type":401,"value":1169},{"type":395,"tag":436,"props":3611,"children":3612},{"style":608},[3613],{"type":401,"value":1230},{"type":395,"tag":436,"props":3615,"children":3616},{"style":602},[3617],{"type":401,"value":1179},{"type":395,"tag":436,"props":3619,"children":3620},{"style":1046},[3621],{"type":401,"value":1159},{"type":395,"tag":436,"props":3623,"children":3624},{"style":464},[3625],{"type":401,"value":1243},{"type":395,"tag":436,"props":3627,"children":3628},{"class":438,"line":636},[3629,3633,3637,3641],{"type":395,"tag":436,"props":3630,"children":3631},{"style":1052},[3632],{"type":401,"value":2008},{"type":395,"tag":436,"props":3634,"children":3635},{"style":464},[3636],{"type":401,"value":456},{"type":395,"tag":436,"props":3638,"children":3639},{"style":1062},[3640],{"type":401,"value":1984},{"type":395,"tag":436,"props":3642,"children":3643},{"style":1046},[3644],{"type":401,"value":1968},{"type":395,"tag":436,"props":3646,"children":3647},{"class":438,"line":656},[3648,3652,3657],{"type":395,"tag":436,"props":3649,"children":3650},{"style":464},[3651],{"type":401,"value":835},{"type":395,"tag":436,"props":3653,"children":3654},{"style":1040},[3655],{"type":401,"value":3656}," else",{"type":395,"tag":436,"props":3658,"children":3659},{"style":464},[3660],{"type":401,"value":467},{"type":395,"tag":436,"props":3662,"children":3663},{"class":438,"line":672},[3664],{"type":395,"tag":436,"props":3665,"children":3666},{"style":443},[3667],{"type":401,"value":3668},"    // 如果不是注释则忽略中断，继续匹配声明\n",{"type":395,"tag":436,"props":3670,"children":3671},{"class":438,"line":692},[3672,3676,3680,3684,3688,3692,3698,3702,3706],{"type":395,"tag":436,"props":3673,"children":3674},{"style":1052},[3675],{"type":401,"value":2008},{"type":395,"tag":436,"props":3677,"children":3678},{"style":464},[3679],{"type":401,"value":456},{"type":395,"tag":436,"props":3681,"children":3682},{"style":1062},[3683],{"type":401,"value":2256},{"type":395,"tag":436,"props":3685,"children":3686},{"style":1046},[3687],{"type":401,"value":1149},{"type":395,"tag":436,"props":3689,"children":3690},{"style":602},[3691],{"type":401,"value":1174},{"type":395,"tag":436,"props":3693,"children":3695},{"style":3694},"--shiki-light:#90A4AE;--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#AE81FF;--shiki-light-font-weight:inherit;--shiki-default-font-weight:bold;--shiki-dark-font-weight:bold;--shiki-sepia-font-weight:inherit",[3696],{"type":401,"value":3697},"\\/",{"type":395,"tag":436,"props":3699,"children":3700},{"style":596},[3701],{"type":401,"value":1477},{"type":395,"tag":436,"props":3703,"children":3704},{"style":602},[3705],{"type":401,"value":1174},{"type":395,"tag":436,"props":3707,"children":3708},{"style":1046},[3709],{"type":401,"value":1506},{"type":395,"tag":436,"props":3711,"children":3712},{"class":438,"line":700},[3713],{"type":395,"tag":436,"props":3714,"children":3715},{"style":464},[3716],{"type":401,"value":544},{"type":395,"tag":436,"props":3718,"children":3719},{"class":438,"line":708},[3720],{"type":395,"tag":436,"props":3721,"children":3722},{"emptyLinePlaceholder":560},[3723],{"type":401,"value":563},{"type":395,"tag":436,"props":3725,"children":3726},{"class":438,"line":716},[3727,3731,3735,3739,3743],{"type":395,"tag":436,"props":3728,"children":3729},{"style":1040},[3730],{"type":401,"value":2631},{"type":395,"tag":436,"props":3732,"children":3733},{"style":1052},[3734],{"type":401,"value":1189},{"type":395,"tag":436,"props":3736,"children":3737},{"style":464},[3738],{"type":401,"value":456},{"type":395,"tag":436,"props":3740,"children":3741},{"style":1062},[3742],{"type":401,"value":3221},{"type":395,"tag":436,"props":3744,"children":3745},{"style":1046},[3746],{"type":401,"value":1968},{"type":395,"tag":436,"props":3748,"children":3749},{"class":438,"line":725},[3750],{"type":395,"tag":436,"props":3751,"children":3752},{"style":464},[3753],{"type":401,"value":553},{"type":395,"tag":950,"props":3755,"children":3757},{"id":3756},"解析at-rule",[3758,3760],{"type":401,"value":3759},"解析",{"type":395,"tag":432,"props":3761,"children":3763},{"className":3762},[],[3764],{"type":401,"value":941},{"type":395,"tag":403,"props":3766,"children":3767},{},[3768,3770,3776,3778,3784,3785,3791,3793,3804],{"type":401,"value":3769},"流程中最繁琐的部分，是匹配 ",{"type":395,"tag":432,"props":3771,"children":3773},{"className":3772},[],[3774],{"type":401,"value":3775},"@media",{"type":401,"value":3777},"、",{"type":395,"tag":432,"props":3779,"children":3781},{"className":3780},[],[3782],{"type":401,"value":3783},"@import",{"type":401,"value":3777},{"type":395,"tag":432,"props":3786,"children":3788},{"className":3787},[],[3789],{"type":401,"value":3790},"@charset",{"type":401,"value":3792}," 等 ",{"type":395,"tag":414,"props":3794,"children":3797},{"href":3795,"rel":3796},"https://developer.mozilla.org/zh-CN/docs/Web/CSS/At-rule",[418],[3798],{"type":395,"tag":432,"props":3799,"children":3801},{"className":3800},[],[3802],{"type":401,"value":3803},"at-rules",{"type":401,"value":921},{"type":395,"tag":403,"props":3806,"children":3807},{},[3808],{"type":401,"value":3809},"每一种规则的语法都不同，要怎么处理才合适呢？",{"type":395,"tag":403,"props":3811,"children":3812},{},[3813,3815,3820],{"type":401,"value":3814},"这里，micro-app 把 ",{"type":395,"tag":432,"props":3816,"children":3818},{"className":3817},[],[3819],{"type":401,"value":941},{"type":401,"value":3821}," 分为了三组：",{"type":395,"tag":3823,"props":3824,"children":3825},"ol",{},[3826,3860,3892],{"type":395,"tag":3827,"props":3828,"children":3829},"li",{},[3830,3832,3838,3840,3845,3846,3851,3852,3858],{"type":401,"value":3831},"类似 ",{"type":395,"tag":432,"props":3833,"children":3835},{"className":3834},[],[3836],{"type":401,"value":3837},"@charset \"utf-8\";",{"type":401,"value":3839}," 为一组，包括 ",{"type":395,"tag":432,"props":3841,"children":3843},{"className":3842},[],[3844],{"type":401,"value":3783},{"type":401,"value":3777},{"type":395,"tag":432,"props":3847,"children":3849},{"className":3848},[],[3850],{"type":401,"value":3790},{"type":401,"value":3777},{"type":395,"tag":432,"props":3853,"children":3855},{"className":3854},[],[3856],{"type":401,"value":3857},"@namespace",{"type":401,"value":3859}," 等。",{"type":395,"tag":3827,"props":3861,"children":3862},{},[3863,3864,3870,3871,3877,3878,3884,3885,3891],{"type":401,"value":3831},{"type":395,"tag":432,"props":3865,"children":3867},{"className":3866},[],[3868],{"type":401,"value":3869},"@media (w \u003C 100px) { .selector { xxx: xxx } }",{"type":401,"value":3839},{"type":395,"tag":432,"props":3872,"children":3874},{"className":3873},[],[3875],{"type":401,"value":3876},"@supports",{"type":401,"value":3777},{"type":395,"tag":432,"props":3879,"children":3881},{"className":3880},[],[3882],{"type":401,"value":3883},"@font-face",{"type":401,"value":3777},{"type":395,"tag":432,"props":3886,"children":3888},{"className":3887},[],[3889],{"type":401,"value":3890},"@document",{"type":401,"value":3859},{"type":395,"tag":3827,"props":3893,"children":3894},{},[3895,3896,3902,3903,3908,3909,3915,3916,3922],{"type":401,"value":3831},{"type":395,"tag":432,"props":3897,"children":3899},{"className":3898},[],[3900],{"type":401,"value":3901},"@font-face { unicode-range: 'xxx' }",{"type":401,"value":3839},{"type":395,"tag":432,"props":3904,"children":3906},{"className":3905},[],[3907],{"type":401,"value":3883},{"type":401,"value":3777},{"type":395,"tag":432,"props":3910,"children":3912},{"className":3911},[],[3913],{"type":401,"value":3914},"@page",{"type":401,"value":3777},{"type":395,"tag":432,"props":3917,"children":3919},{"className":3918},[],[3920],{"type":401,"value":3921},"@key-frames",{"type":401,"value":3859},{"type":395,"tag":403,"props":3924,"children":3925},{},[3926,3928,3933,3935,3941,3943,3949,3951,3956],{"type":401,"value":3927},"第一组，",{"type":395,"tag":432,"props":3929,"children":3931},{"className":3930},[],[3932],{"type":401,"value":3790},{"type":401,"value":3934}," 所在的第一组规则的规则正文内容从 ",{"type":395,"tag":432,"props":3936,"children":3938},{"className":3937},[],[3939],{"type":401,"value":3940},"@",{"type":401,"value":3942}," 开始到 ",{"type":395,"tag":432,"props":3944,"children":3946},{"className":3945},[],[3947],{"type":401,"value":3948},";",{"type":401,"value":3950}," 结束，比如 ",{"type":395,"tag":432,"props":3952,"children":3954},{"className":3953},[],[3955],{"type":401,"value":3837},{"type":401,"value":3957}," 就是一条完整的声明；",{"type":395,"tag":403,"props":3959,"children":3960},{},[3961,3963,3969,3971,3976],{"type":401,"value":3962},"第二组，",{"type":395,"tag":432,"props":3964,"children":3966},{"className":3965},[],[3967],{"type":401,"value":3968},"@media () {}",{"type":401,"value":3970}," 的花括号部分可能包含选择器，所以其正文内容需要重新进入 ",{"type":395,"tag":432,"props":3972,"children":3974},{"className":3973},[],[3975],{"type":401,"value":1933},{"type":401,"value":3977}," 匹配选择器以及声明。",{"type":395,"tag":403,"props":3979,"children":3980},{},[3981,3983,3989,3991,3996],{"type":401,"value":3982},"第三组，",{"type":395,"tag":432,"props":3984,"children":3986},{"className":3985},[],[3987],{"type":401,"value":3988},"@font-face {}",{"type":401,"value":3990}," 的花括号部分仅包含声明，不包含选择器，所以只需要进入 ",{"type":395,"tag":432,"props":3992,"children":3994},{"className":3993},[],[3995],{"type":401,"value":3221},{"type":401,"value":3997}," 匹配声明即可。",{"type":395,"tag":396,"props":3999,"children":4001},{"id":4000},"解决问题",[4002],{"type":401,"value":4000},{"type":395,"tag":403,"props":4004,"children":4005},{},[4006],{"type":401,"value":4007},"回到文章开头的问题，如果要给这个 CSS Parser 增加原生的嵌套功能，见下代码，可以仅用十行简单实现。",{"type":395,"tag":425,"props":4009,"children":4013},{"className":4010,"code":4011,"language":4012,"meta":389,"style":389},"language-diff shiki shiki-themes material-theme-lighter github-light github-dark monokai","+ private matchAllDeclarations (nesting = 0): void {\n  let cssValue = (this.commonMatch(/^[^}/])*/, true) as RegExpExecArray)[0]\n  this.recordResult(cssValue)\n\n  // 递归退出条件\n  if (!this.cssText) return\n-  if (this.cssText.charAt(0) === '}') return\n+  if (this.cssText.charAt(0) === '}') {\n+    if (!nesting) return\n+    this.commonMatch(/}+\\s*/)\n+    return this.matchAllDeclarations(nesting - 1)\n+  }\n\n  // extract comments in declarations\n  if (this.cssText.charAt(0) === '/' && this.cssText.charAt(1) === '*') {\n    this.matchComments()\n  } else {\n    // 如果不是注释则忽略中断，继续匹配声明\n    this.commonMatch(/\\/+/)\n  }\n\n+ if (this.cssText.charAt(0) === '{') {\n+   this.commonMatch(/{+\\s*/)\n+   nesting++\n+ }\n\n- return this.matchAllDeclarations()\n+ return this.matchAllDeclarations(nesting)\n}\n","diff",[4014],{"type":395,"tag":432,"props":4015,"children":4016},{"__ignoreMap":389},[4017,4031,4039,4047,4054,4061,4069,4083,4095,4107,4119,4131,4142,4149,4156,4164,4172,4180,4187,4195,4202,4209,4221,4234,4247,4260,4268,4281,4294],{"type":395,"tag":436,"props":4018,"children":4019},{"class":438,"line":439},[4020,4025],{"type":395,"tag":436,"props":4021,"children":4023},{"style":4022},"--shiki-light:#39ADB5;--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#A6E22E",[4024],{"type":401,"value":1477},{"type":395,"tag":436,"props":4026,"children":4028},{"style":4027},"--shiki-light:#91B859;--shiki-default:#22863A;--shiki-dark:#85E89D;--shiki-sepia:#A6E22E",[4029],{"type":401,"value":4030}," private matchAllDeclarations (nesting = 0): void {\n",{"type":395,"tag":436,"props":4032,"children":4033},{"class":438,"line":449},[4034],{"type":395,"tag":436,"props":4035,"children":4036},{"style":500},[4037],{"type":401,"value":4038},"  let cssValue = (this.commonMatch(/^[^}/])*/, true) as RegExpExecArray)[0]\n",{"type":395,"tag":436,"props":4040,"children":4041},{"class":438,"line":470},[4042],{"type":395,"tag":436,"props":4043,"children":4044},{"style":500},[4045],{"type":401,"value":4046},"  this.recordResult(cssValue)\n",{"type":395,"tag":436,"props":4048,"children":4049},{"class":438,"line":496},[4050],{"type":395,"tag":436,"props":4051,"children":4052},{"emptyLinePlaceholder":560},[4053],{"type":401,"value":563},{"type":395,"tag":436,"props":4055,"children":4056},{"class":438,"line":516},[4057],{"type":395,"tag":436,"props":4058,"children":4059},{"style":500},[4060],{"type":401,"value":3387},{"type":395,"tag":436,"props":4062,"children":4063},{"class":438,"line":538},[4064],{"type":395,"tag":436,"props":4065,"children":4066},{"style":500},[4067],{"type":401,"value":4068},"  if (!this.cssText) return\n",{"type":395,"tag":436,"props":4070,"children":4071},{"class":438,"line":547},[4072,4077],{"type":395,"tag":436,"props":4073,"children":4075},{"style":4074},"--shiki-light:#39ADB5;--shiki-default:#B31D28;--shiki-dark:#FDAEB7;--shiki-sepia:#F92672",[4076],{"type":401,"value":1621},{"type":395,"tag":436,"props":4078,"children":4080},{"style":4079},"--shiki-light:#E53935;--shiki-default:#B31D28;--shiki-dark:#FDAEB7;--shiki-sepia:#F92672",[4081],{"type":401,"value":4082},"  if (this.cssText.charAt(0) === '}') return\n",{"type":395,"tag":436,"props":4084,"children":4085},{"class":438,"line":556},[4086,4090],{"type":395,"tag":436,"props":4087,"children":4088},{"style":4022},[4089],{"type":401,"value":1477},{"type":395,"tag":436,"props":4091,"children":4092},{"style":4027},[4093],{"type":401,"value":4094},"  if (this.cssText.charAt(0) === '}') {\n",{"type":395,"tag":436,"props":4096,"children":4097},{"class":438,"line":566},[4098,4102],{"type":395,"tag":436,"props":4099,"children":4100},{"style":4022},[4101],{"type":401,"value":1477},{"type":395,"tag":436,"props":4103,"children":4104},{"style":4027},[4105],{"type":401,"value":4106},"    if (!nesting) return\n",{"type":395,"tag":436,"props":4108,"children":4109},{"class":438,"line":575},[4110,4114],{"type":395,"tag":436,"props":4111,"children":4112},{"style":4022},[4113],{"type":401,"value":1477},{"type":395,"tag":436,"props":4115,"children":4116},{"style":4027},[4117],{"type":401,"value":4118},"    this.commonMatch(/}+\\s*/)\n",{"type":395,"tag":436,"props":4120,"children":4121},{"class":438,"line":636},[4122,4126],{"type":395,"tag":436,"props":4123,"children":4124},{"style":4022},[4125],{"type":401,"value":1477},{"type":395,"tag":436,"props":4127,"children":4128},{"style":4027},[4129],{"type":401,"value":4130},"    return this.matchAllDeclarations(nesting - 1)\n",{"type":395,"tag":436,"props":4132,"children":4133},{"class":438,"line":656},[4134,4138],{"type":395,"tag":436,"props":4135,"children":4136},{"style":4022},[4137],{"type":401,"value":1477},{"type":395,"tag":436,"props":4139,"children":4140},{"style":4027},[4141],{"type":401,"value":544},{"type":395,"tag":436,"props":4143,"children":4144},{"class":438,"line":672},[4145],{"type":395,"tag":436,"props":4146,"children":4147},{"emptyLinePlaceholder":560},[4148],{"type":401,"value":563},{"type":395,"tag":436,"props":4150,"children":4151},{"class":438,"line":692},[4152],{"type":395,"tag":436,"props":4153,"children":4154},{"style":500},[4155],{"type":401,"value":3506},{"type":395,"tag":436,"props":4157,"children":4158},{"class":438,"line":700},[4159],{"type":395,"tag":436,"props":4160,"children":4161},{"style":500},[4162],{"type":401,"value":4163},"  if (this.cssText.charAt(0) === '/' && this.cssText.charAt(1) === '*') {\n",{"type":395,"tag":436,"props":4165,"children":4166},{"class":438,"line":708},[4167],{"type":395,"tag":436,"props":4168,"children":4169},{"style":500},[4170],{"type":401,"value":4171},"    this.matchComments()\n",{"type":395,"tag":436,"props":4173,"children":4174},{"class":438,"line":716},[4175],{"type":395,"tag":436,"props":4176,"children":4177},{"style":500},[4178],{"type":401,"value":4179},"  } else {\n",{"type":395,"tag":436,"props":4181,"children":4182},{"class":438,"line":725},[4183],{"type":395,"tag":436,"props":4184,"children":4185},{"style":500},[4186],{"type":401,"value":3668},{"type":395,"tag":436,"props":4188,"children":4189},{"class":438,"line":773},[4190],{"type":395,"tag":436,"props":4191,"children":4192},{"style":500},[4193],{"type":401,"value":4194},"    this.commonMatch(/\\/+/)\n",{"type":395,"tag":436,"props":4196,"children":4197},{"class":438,"line":793},[4198],{"type":395,"tag":436,"props":4199,"children":4200},{"style":500},[4201],{"type":401,"value":544},{"type":395,"tag":436,"props":4203,"children":4204},{"class":438,"line":809},[4205],{"type":395,"tag":436,"props":4206,"children":4207},{"emptyLinePlaceholder":560},[4208],{"type":401,"value":563},{"type":395,"tag":436,"props":4210,"children":4211},{"class":438,"line":829},[4212,4216],{"type":395,"tag":436,"props":4213,"children":4214},{"style":4022},[4215],{"type":401,"value":1477},{"type":395,"tag":436,"props":4217,"children":4218},{"style":4027},[4219],{"type":401,"value":4220}," if (this.cssText.charAt(0) === '{') {\n",{"type":395,"tag":436,"props":4222,"children":4224},{"class":438,"line":4223},23,[4225,4229],{"type":395,"tag":436,"props":4226,"children":4227},{"style":4022},[4228],{"type":401,"value":1477},{"type":395,"tag":436,"props":4230,"children":4231},{"style":4027},[4232],{"type":401,"value":4233},"   this.commonMatch(/{+\\s*/)\n",{"type":395,"tag":436,"props":4235,"children":4237},{"class":438,"line":4236},24,[4238,4242],{"type":395,"tag":436,"props":4239,"children":4240},{"style":4022},[4241],{"type":401,"value":1477},{"type":395,"tag":436,"props":4243,"children":4244},{"style":4027},[4245],{"type":401,"value":4246},"   nesting++\n",{"type":395,"tag":436,"props":4248,"children":4250},{"class":438,"line":4249},25,[4251,4255],{"type":395,"tag":436,"props":4252,"children":4253},{"style":4022},[4254],{"type":401,"value":1477},{"type":395,"tag":436,"props":4256,"children":4257},{"style":4027},[4258],{"type":401,"value":4259}," }\n",{"type":395,"tag":436,"props":4261,"children":4263},{"class":438,"line":4262},26,[4264],{"type":395,"tag":436,"props":4265,"children":4266},{"emptyLinePlaceholder":560},[4267],{"type":401,"value":563},{"type":395,"tag":436,"props":4269,"children":4271},{"class":438,"line":4270},27,[4272,4276],{"type":395,"tag":436,"props":4273,"children":4274},{"style":4074},[4275],{"type":401,"value":1621},{"type":395,"tag":436,"props":4277,"children":4278},{"style":4079},[4279],{"type":401,"value":4280}," return this.matchAllDeclarations()\n",{"type":395,"tag":436,"props":4282,"children":4284},{"class":438,"line":4283},28,[4285,4289],{"type":395,"tag":436,"props":4286,"children":4287},{"style":4022},[4288],{"type":401,"value":1477},{"type":395,"tag":436,"props":4290,"children":4291},{"style":4027},[4292],{"type":401,"value":4293}," return this.matchAllDeclarations(nesting)\n",{"type":395,"tag":436,"props":4295,"children":4297},{"class":438,"line":4296},29,[4298],{"type":395,"tag":436,"props":4299,"children":4300},{"style":500},[4301],{"type":401,"value":553},{"type":395,"tag":403,"props":4303,"children":4304},{},[4305],{"type":401,"value":4306},"最终 CSS Nesting 解析成功。",{"type":395,"tag":403,"props":4308,"children":4309},{},[4310],{"type":395,"tag":926,"props":4311,"children":4313},{"alt":1804,"src":4312},"https://mgear-image.oss-cn-shanghai.aliyuncs.com/image/other/20230804025910.png",[],{"type":395,"tag":396,"props":4315,"children":4317},{"id":4316},"结语",[4318],{"type":401,"value":4316},{"type":395,"tag":403,"props":4320,"children":4321},{},[4322],{"type":401,"value":4323},"整个 CSS Parser 的代码简单，功能强悍，耐人寻味。不过有许多边界条件没有处理好，尤其是引入了使用注释禁用样式隔离功能后，匹配注释变得更复杂且易错了。",{"type":395,"tag":3823,"props":4325,"children":4326},{},[4327],{"type":395,"tag":3827,"props":4328,"children":4329},{},[4330],{"type":401,"value":4331},"注释不能和选择器等混用（以下 result 文件代表解析结果）。",{"type":395,"tag":403,"props":4333,"children":4334},{},[4335],{"type":395,"tag":926,"props":4336,"children":4339},{"alt":4337,"src":4338},"comment in selectors","https://mgear-image.oss-cn-shanghai.aliyuncs.com/image/other/9d2b75bda238f9bbe24825a793f0f715.png",[],{"type":395,"tag":3823,"props":4341,"children":4342},{"start":449},[4343],{"type":395,"tag":3827,"props":4344,"children":4345},{},[4346],{"type":401,"value":4347},"CSS 字符串值可能意外启用编译器的特殊功能。",{"type":395,"tag":403,"props":4349,"children":4350},{},[4351],{"type":395,"tag":926,"props":4352,"children":4355},{"alt":4353,"src":4354},"special comment in string value","https://mgear-image.oss-cn-shanghai.aliyuncs.com/image/other/20230803225103.png",[],{"type":395,"tag":3823,"props":4357,"children":4358},{"start":470},[4359],{"type":395,"tag":3827,"props":4360,"children":4361},{},[4362,4364,4370,4372,4383,4385,4390],{"type":401,"value":4363},"错误的 ",{"type":395,"tag":432,"props":4365,"children":4367},{"className":4366},[],[4368],{"type":401,"value":4369},"@host",{"type":401,"value":4371}," 规则匹配。猜测是想匹配 ",{"type":395,"tag":414,"props":4373,"children":4376},{"href":4374,"rel":4375},"https://drafts.csswg.org/css-scoping/#host-selector",[418],[4377],{"type":395,"tag":432,"props":4378,"children":4380},{"className":4379},[],[4381],{"type":401,"value":4382},":host",{"type":401,"value":4384}," 但是手滑写成了 ",{"type":395,"tag":432,"props":4386,"children":4388},{"className":4387},[],[4389],{"type":401,"value":4369},{"type":401,"value":921},{"type":395,"tag":425,"props":4392,"children":4394},{"className":985,"code":4393,"language":987,"meta":389,"style":389},"private hostRule =\n  this.createMatcherForRuleWithChildRule(\n    /^@host\\s*/,\n    '@host'\n  )\n",[4395],{"type":395,"tag":432,"props":4396,"children":4397},{"__ignoreMap":389},[4398,4411,4432,4465,4482],{"type":395,"tag":436,"props":4399,"children":4400},{"class":438,"line":439},[4401,4406],{"type":395,"tag":436,"props":4402,"children":4403},{"style":500},[4404],{"type":401,"value":4405},"private hostRule ",{"type":395,"tag":436,"props":4407,"children":4408},{"style":596},[4409],{"type":401,"value":4410},"=\n",{"type":395,"tag":436,"props":4412,"children":4413},{"class":438,"line":449},[4414,4418,4422,4427],{"type":395,"tag":436,"props":4415,"children":4416},{"style":1052},[4417],{"type":401,"value":1355},{"type":395,"tag":436,"props":4419,"children":4420},{"style":464},[4421],{"type":401,"value":456},{"type":395,"tag":436,"props":4423,"children":4424},{"style":1062},[4425],{"type":401,"value":4426},"createMatcherForRuleWithChildRule",{"type":395,"tag":436,"props":4428,"children":4429},{"style":500},[4430],{"type":401,"value":4431},"(\n",{"type":395,"tag":436,"props":4433,"children":4434},{"class":438,"line":470},[4435,4440,4444,4448,4452,4456,4460],{"type":395,"tag":436,"props":4436,"children":4437},{"style":602},[4438],{"type":401,"value":4439},"    /",{"type":395,"tag":436,"props":4441,"children":4442},{"style":1040},[4443],{"type":401,"value":2269},{"type":395,"tag":436,"props":4445,"children":4446},{"style":2909},[4447],{"type":401,"value":4369},{"type":395,"tag":436,"props":4449,"children":4450},{"style":2272},[4451],{"type":401,"value":2275},{"type":395,"tag":436,"props":4453,"children":4454},{"style":596},[4455],{"type":401,"value":1230},{"type":395,"tag":436,"props":4457,"children":4458},{"style":602},[4459],{"type":401,"value":1174},{"type":395,"tag":436,"props":4461,"children":4462},{"style":464},[4463],{"type":401,"value":4464},",\n",{"type":395,"tag":436,"props":4466,"children":4467},{"class":438,"line":496},[4468,4473,4477],{"type":395,"tag":436,"props":4469,"children":4470},{"style":602},[4471],{"type":401,"value":4472},"    '",{"type":395,"tag":436,"props":4474,"children":4475},{"style":608},[4476],{"type":401,"value":4369},{"type":395,"tag":436,"props":4478,"children":4479},{"style":602},[4480],{"type":401,"value":4481},"'\n",{"type":395,"tag":436,"props":4483,"children":4484},{"class":438,"line":516},[4485],{"type":395,"tag":436,"props":4486,"children":4487},{"style":500},[4488],{"type":401,"value":4489},"  )\n",{"type":395,"tag":403,"props":4491,"children":4492},{},[4493],{"type":395,"tag":926,"props":4494,"children":4497},{"alt":4495,"src":4496},"error @host rule","https://mgear-image.oss-cn-shanghai.aliyuncs.com/image/other/20230803235802.png",[],{"type":395,"tag":403,"props":4499,"children":4500},{},[4501,4503,4510],{"type":401,"value":4502},"在实际项目中，考虑到性能和可维护性的平衡，为了使代码不变得过于复杂，没有必要去完善“边界功能”。运行时的解析应当尽量简单且运行快速，并保持一定的容错：不规范的 CSS 代码在浏览器中本身就能运行，再者，解析器是一个容易带来代码性能和体积瓶颈的地方，要不然 VueJS 也不会分全局构建和运行时",{"type":395,"tag":414,"props":4504,"children":4507},{"href":4505,"rel":4506},"https://www.jsdelivr.com/package/npm/vue?tab=files&path=dist",[418],[4508],{"type":401,"value":4509},"两个版本的编译产物",{"type":401,"value":921},{"type":395,"tag":403,"props":4512,"children":4513},{},[4514],{"type":401,"value":4515},"鉴于 CSS 在部分语法上的灵活性，如果从降低维护难度的角度考虑优化这个 CSS Parser，可能从以下方向：",{"type":395,"tag":4517,"props":4518,"children":4519},"ul",{},[4520,4555],{"type":395,"tag":3827,"props":4521,"children":4522},{},[4523,4525,4530,4532,4538,4540,4545,4547,4554],{"type":401,"value":4524},"在规则匹配部分使用黑名单机制而不是白名单匹配。就 ",{"type":395,"tag":432,"props":4526,"children":4528},{"className":4527},[],[4529],{"type":401,"value":941},{"type":401,"value":4531}," 等灵活语法而言，如果浏览器支持新的 ",{"type":395,"tag":432,"props":4533,"children":4535},{"className":4534},[],[4536],{"type":401,"value":4537},"@xxx",{"type":401,"value":4539}," 语法，黑名单机制编写的代码不需要对 ",{"type":395,"tag":432,"props":4541,"children":4543},{"className":4542},[],[4544],{"type":401,"value":4537},{"type":401,"value":4546}," 做额外处理；而白名单机制需要",{"type":395,"tag":414,"props":4548,"children":4551},{"href":4549,"rel":4550},"https://github.com/micro-zoe/micro-app/commit/b83c4600102e0db6f591bacbdc592bea8f1d5bb8",[418],[4552],{"type":401,"value":4553},"手动处理",{"type":401,"value":921},{"type":395,"tag":3827,"props":4556,"children":4557},{},[4558,4560,4571],{"type":401,"value":4559},"在复杂的解析器部分使用外部依赖，如使用类似 ",{"type":395,"tag":414,"props":4561,"children":4564},{"href":4562,"rel":4563},"https://www.npmjs.com/package/lightningcss-wasm/v/1.16.0",[418],[4565],{"type":395,"tag":432,"props":4566,"children":4568},{"className":4567},[],[4569],{"type":401,"value":4570},"lightingcss-wasm",{"type":401,"value":4572}," 等方案。",{"type":395,"tag":403,"props":4574,"children":4575},{},[4576],{"type":401,"value":4577},"关于样式隔离，作者两年前专门写了文章介绍，不过时效性稍有不足，没有涉及解析器的具体流程，写得更多是解析器在整个微前端框架中的作用，也可作为补充阅读。",{"type":395,"tag":4517,"props":4579,"children":4580},{},[4581],{"type":395,"tag":3827,"props":4582,"children":4583},{},[4584],{"type":395,"tag":414,"props":4585,"children":4588},{"href":4586,"rel":4587},"https://github.com/micro-zoe/micro-app/issues/20",[418],[4589],{"type":401,"value":4590},"从零开始写一个微前端框架-样式隔离篇",{"type":395,"tag":403,"props":4592,"children":4593},{},[4594],{"type":401,"value":4595},"最后，微前端框架中的 CSS 的有很多中实施办法，采用一些办法可以抛弃运行时解析。em... 也许以后有机会聊一聊（咕一咕）。",{"type":395,"tag":396,"props":4597,"children":4599},{"id":4598},"增订-2024年1月28日",[4600],{"type":401,"value":4601},"增订 | 2024年1月28日",{"type":395,"tag":403,"props":4603,"children":4604},{},[4605,4607],{"type":401,"value":4606},"相关实现和测试用例见",{"type":395,"tag":414,"props":4608,"children":4611},{"href":4609,"rel":4610},"https://github.com/micro-zoe/micro-app/issues/868?_issue=nesting",[418],[4612],{"type":401,"value":4613},"这个 Issue",{"type":395,"tag":4615,"props":4616,"children":4619},"section",{"className":4617,"dataFootnotes":389},[4618],"footnotes",[4620,4627],{"type":395,"tag":396,"props":4621,"children":4624},{"className":4622,"id":915},[4623],"sr-only",[4625],{"type":401,"value":4626},"Footnotes",{"type":395,"tag":3823,"props":4628,"children":4629},{},[4630],{"type":395,"tag":3827,"props":4631,"children":4633},{"id":4632},"user-content-fn-css-syntax",[4634,4636,4642,4644],{"type":401,"value":4635},"比较完整的 CSS 语法参见：",{"type":395,"tag":414,"props":4637,"children":4640},{"href":4638,"rel":4639},"https://developer.mozilla.org/zh-CN/docs/Web/CSS/Syntax",[418],[4641],{"type":401,"value":4638},{"type":401,"value":4643}," ",{"type":395,"tag":414,"props":4645,"children":4650},{"href":4646,"ariaLabel":4647,"className":4648,"dataFootnoteBackref":389},"#user-content-fnref-css-syntax","Back to reference 1",[4649],"data-footnote-backref",[4651],{"type":401,"value":4652},"↩",{"type":395,"tag":4654,"props":4655,"children":4656},"style",{},[4657],{"type":401,"value":4658},"html .light .shiki span {color: var(--shiki-light);background: var(--shiki-light-bg);font-style: var(--shiki-light-font-style);font-weight: var(--shiki-light-font-weight);text-decoration: var(--shiki-light-text-decoration);}html.light .shiki span {color: var(--shiki-light);background: var(--shiki-light-bg);font-style: var(--shiki-light-font-style);font-weight: var(--shiki-light-font-weight);text-decoration: var(--shiki-light-text-decoration);}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html .sepia .shiki span {color: var(--shiki-sepia);background: var(--shiki-sepia-bg);font-style: var(--shiki-sepia-font-style);font-weight: var(--shiki-sepia-font-weight);text-decoration: var(--shiki-sepia-text-decoration);}html.sepia .shiki span {color: var(--shiki-sepia);background: var(--shiki-sepia-bg);font-style: var(--shiki-sepia-font-style);font-weight: var(--shiki-sepia-font-weight);text-decoration: var(--shiki-sepia-text-decoration);}",{"title":389,"searchDepth":449,"depth":449,"links":4660},[4661,4662,4663,4664,4665,4666,4667],{"id":398,"depth":449,"text":398},{"id":843,"depth":449,"text":846},{"id":946,"depth":449,"text":946},{"id":4000,"depth":449,"text":4000},{"id":4316,"depth":449,"text":4316},{"id":4598,"depth":449,"text":4601},{"id":915,"depth":449,"text":4626},"markdown","content:2.articles:1.mini-css-parser.md","content","2.articles/1.mini-css-parser.md","md",[4674,4676],{"_path":40,"title":39,"description":4675},"忍者秘籍中提到的模板解析器，很短但支持变量和 if 等语句，还是 15 年前的代码！",{"_path":46,"title":45,"description":4677},"在两个纯知识面的问题上，受到了 GPT 的碾压",1710257705287]