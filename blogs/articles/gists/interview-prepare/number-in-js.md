# JS中的数值

## 定点数与浮点数

计算机的数值分为整型和小数两种，其中小数又可以再分为定点数和浮点数。

定点数即按照标准约定把小数点储存在特定位置之间。如果我们约定存在 8 位微机中的第 4 位和第 5 位之间，那么数值 1.23 可以理解为，前 4 位存储整数部分，后 4 位存储小数部分。同时，小数点并未真正的储存在计算机中。

![Fixed Point](https://cdn.jsdelivr.net/gh/Lionad-Morotar/blog-cdn/image/other/20200722031423.png)

既然顶点数的小数点位置是固定的，那么浮点数很好理解，即小数点位置不定。如下图，两个数的值其实是一样的，只不过小数点的位置有些不同。我们把这种数值表示法叫做浮点数。

![1.2*100 === 12 * 10](https://cdn.jsdelivr.net/gh/Lionad-Morotar/blog-cdn/image/other/20200722031938.png)

## IEEE-754

在 IEEE-754 标准之前，浮点数有多种实现方法，并没有一个广泛使用的标准供所有计算机遵循。经过几十年的验证，IEEE-754 成为了最为广泛使用的一种浮点数运算标准。双精度浮点数便是其定义的一种用于表示浮点数值的方式。双精度是指使用 64 位（8字节）来存储一个浮点数，用图片表示如下：

![IEEE-754 Double](https://cdn.jsdelivr.net/gh/Lionad-Morotar/blog-cdn/image/other/20200721223451.png)

从图中可以发现，64 位被划分为了 sign、exponent 和 mantissa 三个域，意义分别如下：

* sign：阶符位，0 表示数值位正，1 表示数值为负。
* exponent：阶码位，使用补码表示。
* mantissa：尾数位，用来表示精确度。

按照 IEEE-754 标准，数字的真实值，可以这个公式来表示：

$$\boxed{Value = (-1)^{S} * 1.M * 2^E}$$

可以发现，$1.Mantissa * 2^{Exponent}$ 是数值位的二进制科学计数表示法。因为二进制科学计数法的数值部分的第一位一定是 1，所以 Mantissa 部分省略了这个 1。如 1.2 存储时只储存 2，计算机若读取该值，默认会加上前面的 1。这样做可以使 Mantissa 部分多出一位有效数字，所以可以提高浮点数的精度。

不过，在上面这个公式的基础上，IEEE-754 定义了四个特例：

  * 阶符为 0，阶码全为 1：表示正无穷大；
  * 阶符为 1，阶码全为 1：表示负无穷大；
  * 阶符为 0，阶码全为 0：表示 $0$；
  * 阶符为 1，阶码全为 0：表示 $NaN$；

## 精度丢失问题

为什么使用 IEEE-754 计算，会出现 $(0.1 + 0.2 == 0.3) == False$ 的问题呢？

我们还得回到具体数值得浮点数的加法运算中，才能了解原因。

先将数字 $(0.1)_{10}$ 转换为双精度浮点数：

1. 是正数，阶符为 $0$；
2. 转换为二进制，得：$(0.0\lgroup0011\circlearrowright\rgroup)_{2}$[^mathjax]
3. 使用科学计数法表示，得：$1.1\lgroup0011\circlearrowright\rgroup * 2^{-4}$
4. 得双精度浮点数：${0 \above{1pt} Sign * 1}{001111111011 \above{1pt} Exponent * 11} {100110\;...\;011001 \above{1pt} Mantissa * 52}$[^0.1]

然后将数字 $(0.2)_{10}$ 转换为双精度浮点数：

1. 是正数，阶符为 $0$；
2. 转换为二进制，得：$(0.\lgroup0011\circlearrowright\rgroup)_{2}$
3. 使用科学计数法表示，得：$1.1\lgroup0011\circlearrowright\rgroup * 2^{-3}$
4. 得双精度浮点数：${0 \above{1pt} Sign * 1}{001111111100 \above{1pt} Exponent * 11} {100110\;...\;011001 \above{1pt} Mantissa * 52}$[^0.2]



## 阅读更多

[^mathjax]: 我的 Mathjax 解析不了上划线，所以不能用标准的数学符号表示无限循环小数。所以这里用一种假的表示方式替代。
[^0.1]: ${0 \above{1pt} Sign * 1}{001111111011 \above{1pt} Exponent * 11} {1001100110011001100110011001100110011001100110011001 \above{1pt} Mantissa * 52}$
[^0.2]: ${0 \above{1pt} Sign * 1}{001111111100 \above{1pt} Exponent * 11} {1001100110011001100110011001100110011001100110011001 \above{1pt} Mantissa * 52}$